<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>commander_v1.0.cpp</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>commander_v1.0.cpp</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span><span class="cm">/****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *   Copyright (C) 2013-2014 PX4 Development Team. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> *</span>
<span class="cm"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="cm"> *    notice, this list of conditions and the following disclaimer.</span>
<span class="cm"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<span class="cm"> *    notice, this list of conditions and the following disclaimer in</span>
<span class="cm"> *    the documentation and/or other materials provided with the</span>
<span class="cm"> *    distribution.</span>
<span class="cm"> * 3. Neither the name PX4 nor the names of its contributors may be</span>
<span class="cm"> *    used to endorse or promote products derived from this software</span>
<span class="cm"> *    without specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="cm"> * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="cm"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span>
<span class="cm"> * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE</span>
<span class="cm"> * COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<span class="cm"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span>
<span class="cm"> * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</span>
<span class="cm"> * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</span>
<span class="cm"> * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
<span class="cm"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN</span>
<span class="cm"> * ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<span class="cm"> * POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> *</span>
<span class="cm"> ****************************************************************************/</span>

<span class="cm">/**</span>
<span class="cm"> * @file commander.cpp</span>
<span class="cm"> * Main fail-safe handling.</span>
<span class="cm"> *</span>
<span class="cm"> * @author Petri Tanskanen &lt;petri.tanskanen@inf.ethz.ch&gt;</span>
<span class="cm"> * @author Lorenz Meier &lt;lm@inf.ethz.ch&gt;</span>
<span class="cm"> * @author Thomas Gubler &lt;thomasgubler@student.ethz.ch&gt;</span>
<span class="cm"> * @author Julian Oes &lt;julian@oes.ch&gt;</span>
<span class="cm"> * @author Anton Babushkin &lt;anton.babushkin@me.com&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include</span> <span class="cpf">&lt;nuttx/config.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;systemlib/err.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;systemlib/circuit_breaker.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;debug.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/prctl.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;math.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;poll.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;float.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;uORB/uORB.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/sensor_combined.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/battery_status.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/manual_control_setpoint.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/offboard_control_setpoint.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/home_position.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/vehicle_global_position.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/vehicle_local_position.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/position_setpoint_triplet.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/vehicle_gps_position.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/vehicle_command.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/subsystem_info.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/actuator_controls.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/actuator_armed.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/parameter_update.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/differential_pressure.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/safety.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/system_power.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/mission.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/mission_result.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/telemetry_status.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;drivers/drv_led.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;drivers/drv_hrt.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;drivers/drv_tone_alarm.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;mavlink/mavlink_log.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;systemlib/param/param.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;systemlib/systemlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;systemlib/err.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;systemlib/cpuload.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;systemlib/rc_check.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;geo/geo.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;systemlib/state_table.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;dataman/dataman.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&quot;px4_custom_mode.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;commander_helper.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;state_machine_helper.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;calibration_routines.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;accelerometer_calibration.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;gyro_calibration.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;mag_calibration.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;baro_calibration.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;rc_calibration.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;airspeed_calibration.h&quot;</span><span class="cp"></span>

<span class="cm">/* oddly, ERROR is not defined for c++ */</span>
<span class="cp">#ifdef ERROR</span>
<span class="cp"># undef ERROR</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">ERROR</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">system_load_s</span> <span class="n">system_load</span><span class="p">;</span>

<span class="cm">/* Decouple update interval and hysteris counters, all depends on intervals */</span>
<span class="cp">#define COMMANDER_MONITORING_INTERVAL 50000</span>
<span class="cp">#define COMMANDER_MONITORING_LOOPSPERMSEC (1/(COMMANDER_MONITORING_INTERVAL/1000.0f))</span>

<span class="cp">#define MAVLINK_OPEN_INTERVAL 50000</span>

<span class="cp">#define STICK_ON_OFF_LIMIT 0.9f</span>
<span class="cp">#define STICK_ON_OFF_HYSTERESIS_TIME_MS 1000</span>
<span class="cp">#define STICK_ON_OFF_COUNTER_LIMIT (STICK_ON_OFF_HYSTERESIS_TIME_MS*COMMANDER_MONITORING_LOOPSPERMSEC)</span>

<span class="cp">#define POSITION_TIMEOUT		(2 * 1000 * 1000)	</span><span class="cm">/**&lt; consider the local or global position estimate invalid after 600ms */</span><span class="cp"></span>
<span class="cp">#define FAILSAFE_DEFAULT_TIMEOUT	(3 * 1000 * 1000)	</span><span class="cm">/**&lt; hysteresis time - the failsafe will trigger after 3 seconds in this state */</span><span class="cp"></span>
<span class="cp">#define OFFBOARD_TIMEOUT		500000</span>
<span class="cp">#define DIFFPRESS_TIMEOUT		2000000</span>

<span class="cp">#define PRINT_INTERVAL	5000000</span>
<span class="cp">#define PRINT_MODE_REJECT_INTERVAL	2000000</span>

<span class="k">enum</span> <span class="n">MAV_MODE_FLAG</span> <span class="p">{</span>
	<span class="n">MAV_MODE_FLAG_CUSTOM_MODE_ENABLED</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="cm">/* 0b00000001 Reserved for future use. | */</span>
	<span class="n">MAV_MODE_FLAG_TEST_ENABLED</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="cm">/* 0b00000010 system has a test mode enabled. This flag is intended for temporary system tests and should not be used for stable implementations. | */</span>
	<span class="n">MAV_MODE_FLAG_AUTO_ENABLED</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="cm">/* 0b00000100 autonomous mode enabled, system finds its own goal positions. Guided flag can be set or not, depends on the actual implementation. | */</span>
	<span class="n">MAV_MODE_FLAG_GUIDED_ENABLED</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="cm">/* 0b00001000 guided mode enabled, system flies MISSIONs / mission items. | */</span>
	<span class="n">MAV_MODE_FLAG_STABILIZE_ENABLED</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="cm">/* 0b00010000 system stabilizes electronically its attitude (and optionally position). It needs however further control inputs to move around. | */</span>
	<span class="n">MAV_MODE_FLAG_HIL_ENABLED</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span> <span class="cm">/* 0b00100000 hardware in the loop simulation. All motors / actuators are blocked, but internal software is full operational. | */</span>
	<span class="n">MAV_MODE_FLAG_MANUAL_INPUT_ENABLED</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span> <span class="cm">/* 0b01000000 remote control input is enabled. | */</span>
	<span class="n">MAV_MODE_FLAG_SAFETY_ARMED</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span> <span class="cm">/* 0b10000000 MAV safety set to armed. Motors are enabled / running / can start. Ready to fly. | */</span>
	<span class="n">MAV_MODE_FLAG_ENUM_END</span> <span class="o">=</span> <span class="mi">129</span><span class="p">,</span> <span class="cm">/*  | */</span>
<span class="p">};</span>

<span class="cm">/* Mavlink file descriptors */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mavlink_fd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/* flags */</span>
<span class="k">static</span> <span class="kt">bool</span> <span class="n">commander_initialized</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="k">static</span> <span class="k">volatile</span> <span class="kt">bool</span> <span class="n">thread_should_exit</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>		<span class="cm">/**&lt; daemon exit flag */</span>
<span class="k">static</span> <span class="k">volatile</span> <span class="kt">bool</span> <span class="n">thread_running</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>		<span class="cm">/**&lt; daemon status flag */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">daemon_task</span><span class="p">;</span>				<span class="cm">/**&lt; Handle of daemon task / thread */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">leds_counter</span><span class="p">;</span>
<span class="cm">/* To remember when last notification was sent */</span>
<span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">last_print_mode_reject_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cm">/* if connected via USB */</span>
<span class="k">static</span> <span class="kt">bool</span> <span class="n">on_usb_power</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">float</span> <span class="n">takeoff_alt</span> <span class="o">=</span> <span class="mf">5.0f</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">parachute_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">float</span> <span class="n">eph_threshold</span> <span class="o">=</span> <span class="mf">5.0f</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">float</span> <span class="n">epv_threshold</span> <span class="o">=</span> <span class="mf">10.0f</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vehicle_status_s</span> <span class="n">status</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">actuator_armed_s</span> <span class="n">armed</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">safety_s</span> <span class="n">safety</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">vehicle_control_mode_s</span> <span class="n">control_mode</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">offboard_control_setpoint_s</span> <span class="n">sp_offboard</span><span class="p">;</span>

<span class="cm">/* tasks waiting for low prio thread */</span>
<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
	<span class="n">LOW_PRIO_TASK_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">LOW_PRIO_TASK_PARAM_SAVE</span><span class="p">,</span>
	<span class="n">LOW_PRIO_TASK_PARAM_LOAD</span><span class="p">,</span>
	<span class="n">LOW_PRIO_TASK_GYRO_CALIBRATION</span><span class="p">,</span>
	<span class="n">LOW_PRIO_TASK_MAG_CALIBRATION</span><span class="p">,</span>
	<span class="n">LOW_PRIO_TASK_ALTITUDE_CALIBRATION</span><span class="p">,</span>
	<span class="n">LOW_PRIO_TASK_RC_CALIBRATION</span><span class="p">,</span>
	<span class="n">LOW_PRIO_TASK_ACCEL_CALIBRATION</span><span class="p">,</span>
	<span class="n">LOW_PRIO_TASK_AIRSPEED_CALIBRATION</span>
<span class="p">}</span> <span class="n">low_prio_task_t</span><span class="p">;</span>

<span class="k">static</span> <span class="n">low_prio_task_t</span> <span class="n">low_prio_task</span> <span class="o">=</span> <span class="n">LOW_PRIO_TASK_NONE</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * The daemon app only briefly exists to start</span>
<span class="cm"> * the background job. The stack size assigned in the</span>
<span class="cm"> * Makefile does only apply to this management task.</span>
<span class="cm"> *</span>
<span class="cm"> * The actual stack size should be set in the call</span>
<span class="cm"> * to task_create().</span>
<span class="cm"> *</span>
<span class="cm"> * @ingroup apps</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="n">__EXPORT</span> <span class="kt">int</span> <span class="n">commander_main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[]);</span>

<span class="cm">/**</span>
<span class="cm"> * Print the correct usage.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">usage</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">reason</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * React to commands that are sent e.g. from the mavlink module.</span>
<span class="cm"> */</span>
<span class="kt">bool</span> <span class="nf">handle_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">vehicle_status_s</span> <span class="o">*</span><span class="n">status</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">safety_s</span> <span class="o">*</span><span class="n">safety</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vehicle_command_s</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">actuator_armed_s</span> <span class="o">*</span><span class="n">armed</span><span class="p">,</span> <span class="k">struct</span> <span class="n">home_position_s</span> <span class="o">*</span><span class="n">home</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vehicle_global_position_s</span> <span class="o">*</span><span class="n">global_pos</span><span class="p">,</span>
		    <span class="n">orb_advert_t</span> <span class="o">*</span><span class="n">home_pub</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * Mainloop of commander.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">commander_thread_main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[]);</span>

<span class="kt">void</span> <span class="nf">control_status_leds</span><span class="p">(</span><span class="n">vehicle_status_s</span> <span class="o">*</span><span class="n">status</span><span class="p">,</span> <span class="k">const</span> <span class="n">actuator_armed_s</span> <span class="o">*</span><span class="n">actuator_armed</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">changed</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">check_valid</span><span class="p">(</span><span class="n">hrt_abstime</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">hrt_abstime</span> <span class="n">timeout</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">valid_in</span><span class="p">,</span> <span class="kt">bool</span> <span class="o">*</span><span class="n">valid_out</span><span class="p">,</span> <span class="kt">bool</span> <span class="o">*</span><span class="n">changed</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">check_mode_switches</span><span class="p">(</span><span class="k">struct</span> <span class="n">manual_control_setpoint_s</span> <span class="o">*</span><span class="n">sp_man</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vehicle_status_s</span> <span class="o">*</span><span class="n">status</span><span class="p">);</span>

<span class="n">transition_result_t</span> <span class="nf">set_main_state_rc</span><span class="p">(</span><span class="k">struct</span> <span class="n">vehicle_status_s</span> <span class="o">*</span><span class="n">status</span><span class="p">,</span> <span class="k">struct</span> <span class="n">manual_control_setpoint_s</span> <span class="o">*</span><span class="n">sp_man</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">set_control_mode</span><span class="p">();</span>

<span class="kt">void</span> <span class="nf">print_reject_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">vehicle_status_s</span> <span class="o">*</span><span class="n">current_status</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">print_reject_arm</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">print_status</span><span class="p">();</span>

<span class="n">transition_result_t</span> <span class="nf">check_navigation_state_machine</span><span class="p">(</span><span class="k">struct</span> <span class="n">vehicle_status_s</span> <span class="o">*</span><span class="n">status</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">vehicle_control_mode_s</span> <span class="o">*</span><span class="n">control_mode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vehicle_local_position_s</span> <span class="o">*</span><span class="n">local_pos</span><span class="p">);</span>

<span class="n">transition_result_t</span> <span class="nf">arm_disarm</span><span class="p">(</span><span class="kt">bool</span> <span class="n">arm</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">mavlink_fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">armedBy</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * Loop that runs at a lower rate and priority for calibration and parameter tasks.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="o">*</span><span class="nf">commander_low_prio_loop</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">answer_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">vehicle_command_s</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="k">enum</span> <span class="n">VEHICLE_CMD_RESULT</span> <span class="n">result</span><span class="p">);</span>


<span class="kt">int</span> <span class="nf">commander_main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usage</span><span class="p">(</span><span class="s">&quot;missing command&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;start&quot;</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">thread_running</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;commander already running&quot;</span><span class="p">);</span>
			<span class="cm">/* this is not an error */</span>
			<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">thread_should_exit</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">daemon_task</span> <span class="o">=</span> <span class="n">task_spawn_cmd</span><span class="p">(</span><span class="s">&quot;commander&quot;</span><span class="p">,</span>
					     <span class="n">SCHED_DEFAULT</span><span class="p">,</span>
					     <span class="n">SCHED_PRIORITY_MAX</span> <span class="o">-</span> <span class="mi">40</span><span class="p">,</span>
					     <span class="mi">2950</span><span class="p">,</span>
					     <span class="n">commander_thread_main</span><span class="p">,</span>
					     <span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="nb">NULL</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">thread_running</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;stop&quot;</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">thread_running</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">errx</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;commander already stopped&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">thread_should_exit</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">thread_running</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usleep</span><span class="p">(</span><span class="mi">200000</span><span class="p">);</span>
			<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;terminated.&quot;</span><span class="p">);</span>

		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* commands needing the app to run below */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">thread_running</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">commander not started&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;status&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">print_status</span><span class="p">();</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;check&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">mavlink_fd_local</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">MAVLINK_LOG_DEVICE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">checkres</span> <span class="o">=</span> <span class="n">prearm_check</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="n">mavlink_fd_local</span><span class="p">);</span>
		<span class="n">close</span><span class="p">(</span><span class="n">mavlink_fd_local</span><span class="p">);</span>
		<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;FINAL RESULT: %s&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">checkres</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;OK&quot;</span> <span class="o">:</span> <span class="s">&quot;FAILED&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;arm&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">arm_disarm</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;command line&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;disarm&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">arm_disarm</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;command line&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">usage</span><span class="p">(</span><span class="s">&quot;unrecognized command&quot;</span><span class="p">);</span>
	<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">usage</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;usage: daemon {start|stop|status} [-p &lt;additional params&gt;]</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">print_status</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;type: %s&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">is_rotary_wing</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;ROTARY&quot;</span> <span class="o">:</span> <span class="s">&quot;PLANE&quot;</span><span class="p">);</span>
	<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;usb powered: %s&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">on_usb_power</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>
	<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;avionics rail: %6.2f V&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">status</span><span class="p">.</span><span class="n">avionics_power_rail_voltage</span><span class="p">);</span>

	<span class="cm">/* read all relevant states */</span>
	<span class="kt">int</span> <span class="n">state_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_status</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">vehicle_status_s</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_status</span><span class="p">),</span> <span class="n">state_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">);</span>

	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">armed_str</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">arming_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="nl">ARMING_STATE_INIT</span><span class="p">:</span>
		<span class="n">armed_str</span> <span class="o">=</span> <span class="s">&quot;INIT&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="nl">ARMING_STATE_STANDBY</span><span class="p">:</span>
		<span class="n">armed_str</span> <span class="o">=</span> <span class="s">&quot;STANDBY&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="nl">ARMING_STATE_ARMED</span><span class="p">:</span>
		<span class="n">armed_str</span> <span class="o">=</span> <span class="s">&quot;ARMED&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="nl">ARMING_STATE_ARMED_ERROR</span><span class="p">:</span>
		<span class="n">armed_str</span> <span class="o">=</span> <span class="s">&quot;ARMED_ERROR&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="nl">ARMING_STATE_STANDBY_ERROR</span><span class="p">:</span>
		<span class="n">armed_str</span> <span class="o">=</span> <span class="s">&quot;STANDBY_ERROR&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="nl">ARMING_STATE_REBOOT</span><span class="p">:</span>
		<span class="n">armed_str</span> <span class="o">=</span> <span class="s">&quot;REBOOT&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="nl">ARMING_STATE_IN_AIR_RESTORE</span><span class="p">:</span>
		<span class="n">armed_str</span> <span class="o">=</span> <span class="s">&quot;IN_AIR_RESTORE&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">default</span><span class="o">:</span>
		<span class="n">armed_str</span> <span class="o">=</span> <span class="s">&quot;ERR: UNKNOWN STATE&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">close</span><span class="p">(</span><span class="n">state_sub</span><span class="p">);</span>


	<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;arming: %s&quot;</span><span class="p">,</span> <span class="n">armed_str</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">orb_advert_t</span> <span class="n">status_pub</span><span class="p">;</span>

<span class="n">transition_result_t</span> <span class="nf">arm_disarm</span><span class="p">(</span><span class="kt">bool</span> <span class="n">arm</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">mavlink_fd_local</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">armedBy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">transition_result_t</span> <span class="n">arming_res</span> <span class="o">=</span> <span class="n">TRANSITION_NOT_CHANGED</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>Transition the armed state. By passing mavlink_fd to arming_state_transition it will
output appropriate error messages if the state cannot transition.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="n">arming_res</span> <span class="o">=</span> <span class="n">arming_state_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">safety</span><span class="p">,</span> <span class="n">arm</span> <span class="o">?</span> <span class="nl">ARMING_STATE_ARMED</span> <span class="p">:</span> <span class="n">ARMING_STATE_STANDBY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">armed</span><span class="p">,</span>
					     <span class="nb">true</span> <span class="cm">/* fRunPreArmChecks */</span><span class="p">,</span> <span class="n">mavlink_fd_local</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arming_res</span> <span class="o">==</span> <span class="n">TRANSITION_CHANGED</span> <span class="o">&amp;&amp;</span> <span class="n">mavlink_fd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mavlink_log_info</span><span class="p">(</span><span class="n">mavlink_fd_local</span><span class="p">,</span> <span class="s">&quot;[cmd] %s by %s&quot;</span><span class="p">,</span> <span class="n">arm</span> <span class="o">?</span> <span class="s">&quot;ARMED&quot;</span> <span class="o">:</span> <span class="s">&quot;DISARMED&quot;</span><span class="p">,</span> <span class="n">armedBy</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">arming_res</span> <span class="o">==</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tune_negative</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">arming_res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="nf">handle_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">vehicle_status_s</span> <span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">safety_s</span> <span class="o">*</span><span class="n">safety_local</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">vehicle_command_s</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">actuator_armed_s</span> <span class="o">*</span><span class="n">armed_local</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">home_position_s</span> <span class="o">*</span><span class="n">home</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vehicle_global_position_s</span> <span class="o">*</span><span class="n">global_pos</span><span class="p">,</span> <span class="n">orb_advert_t</span> <span class="o">*</span><span class="n">home_pub</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* only handle commands that are meant to be handled by this system and component */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">target_system</span> <span class="o">!=</span> <span class="n">status_local</span><span class="o">-&gt;</span><span class="n">system_id</span> <span class="o">||</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">target_component</span> <span class="o">!=</span> <span class="n">status_local</span><span class="o">-&gt;</span><span class="n">component_id</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">target_component</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span> <span class="c1">// component_id 0: valid for all components</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* result of the command */</span>
	<span class="k">enum</span> <span class="n">VEHICLE_CMD_RESULT</span> <span class="n">cmd_result</span> <span class="o">=</span> <span class="n">VEHICLE_CMD_RESULT_UNSUPPORTED</span><span class="p">;</span>

	<span class="cm">/* request to set different system mode */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="nl">VEHICLE_CMD_DO_SET_MODE</span><span class="p">:</span> <span class="p">{</span>
			<span class="kt">uint8_t</span> <span class="n">base_mode</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param1</span><span class="p">;</span>
			<span class="kt">uint8_t</span> <span class="n">custom_main_mode</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param2</span><span class="p">;</span>

			<span class="n">transition_result_t</span> <span class="n">arming_ret</span> <span class="o">=</span> <span class="n">TRANSITION_NOT_CHANGED</span><span class="p">;</span>

			<span class="n">transition_result_t</span> <span class="n">main_ret</span> <span class="o">=</span> <span class="n">TRANSITION_NOT_CHANGED</span><span class="p">;</span>

			<span class="cm">/* set HIL state */</span>
			<span class="n">hil_state_t</span> <span class="n">new_hil_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">base_mode</span> <span class="o">&amp;</span> <span class="n">MAV_MODE_FLAG_HIL_ENABLED</span><span class="p">)</span> <span class="o">?</span> <span class="nl">HIL_STATE_ON</span> <span class="p">:</span> <span class="n">HIL_STATE_OFF</span><span class="p">;</span>
			<span class="n">transition_result_t</span> <span class="n">hil_ret</span> <span class="o">=</span> <span class="n">hil_state_transition</span><span class="p">(</span><span class="n">new_hil_state</span><span class="p">,</span> <span class="n">status_pub</span><span class="p">,</span> <span class="n">status_local</span><span class="p">,</span> <span class="n">mavlink_fd</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>Transition the arming state</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="n">arming_ret</span> <span class="o">=</span> <span class="n">arm_disarm</span><span class="p">(</span><span class="n">base_mode</span> <span class="o">&amp;</span> <span class="n">MAV_MODE_FLAG_SAFETY_ARMED</span><span class="p">,</span> <span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;set mode command&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">base_mode</span> <span class="o">&amp;</span> <span class="n">MAV_MODE_FLAG_CUSTOM_MODE_ENABLED</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* use autopilot-specific mode */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">custom_main_mode</span> <span class="o">==</span> <span class="n">PX4_CUSTOM_MAIN_MODE_MANUAL</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* MANUAL */</span>
					<span class="n">main_ret</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">MAIN_STATE_MANUAL</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">custom_main_mode</span> <span class="o">==</span> <span class="n">PX4_CUSTOM_MAIN_MODE_ALTCTL</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* ALTCTL */</span>
					<span class="n">main_ret</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">MAIN_STATE_ALTCTL</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">custom_main_mode</span> <span class="o">==</span> <span class="n">PX4_CUSTOM_MAIN_MODE_POSCTL</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* POSCTL */</span>
					<span class="n">main_ret</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">MAIN_STATE_POSCTL</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">custom_main_mode</span> <span class="o">==</span> <span class="n">PX4_CUSTOM_MAIN_MODE_AUTO</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* AUTO */</span>
					<span class="n">main_ret</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">MAIN_STATE_AUTO_MISSION</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">custom_main_mode</span> <span class="o">==</span> <span class="n">PX4_CUSTOM_MAIN_MODE_ACRO</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* ACRO */</span>
					<span class="n">main_ret</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">MAIN_STATE_ACRO</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">custom_main_mode</span> <span class="o">==</span> <span class="n">PX4_CUSTOM_MAIN_MODE_OFFBOARD</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* OFFBOARD */</span>
					<span class="n">main_ret</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">MAIN_STATE_OFFBOARD</span><span class="p">);</span>
				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* use base mode */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">base_mode</span> <span class="o">&amp;</span> <span class="n">MAV_MODE_FLAG_AUTO_ENABLED</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* AUTO */</span>
					<span class="n">main_ret</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">MAIN_STATE_AUTO_MISSION</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">base_mode</span> <span class="o">&amp;</span> <span class="n">MAV_MODE_FLAG_MANUAL_INPUT_ENABLED</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">base_mode</span> <span class="o">&amp;</span> <span class="n">MAV_MODE_FLAG_GUIDED_ENABLED</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* POSCTL */</span>
						<span class="n">main_ret</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">MAIN_STATE_POSCTL</span><span class="p">);</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">base_mode</span> <span class="o">&amp;</span> <span class="n">MAV_MODE_FLAG_STABILIZE_ENABLED</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* MANUAL */</span>
						<span class="n">main_ret</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">MAIN_STATE_MANUAL</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">hil_ret</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span> <span class="o">&amp;&amp;</span> <span class="n">arming_ret</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span> <span class="o">&amp;&amp;</span> <span class="n">main_ret</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">VEHICLE_CMD_RESULT_TEMPORARILY_REJECTED</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="nl">VEHICLE_CMD_COMPONENT_ARM_DISARM</span><span class="p">:</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>Adhere to MAVLink specs, but base on knowledge that these fundamentally encode ints
for logic state parameters</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param1</span> <span class="o">+</span> <span class="mf">0.5f</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param1</span> <span class="o">+</span> <span class="mf">0.5f</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;Unsupported ARM_DISARM param: %.3f&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param1</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

				<span class="kt">bool</span> <span class="n">cmd_arms</span> <span class="o">=</span> <span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param1</span> <span class="o">+</span> <span class="mf">0.5f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>Flick to inair restore first if this comes from an onboard system</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>				<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">source_system</span> <span class="o">==</span> <span class="n">status_local</span><span class="o">-&gt;</span><span class="n">system_id</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">source_component</span> <span class="o">==</span> <span class="n">status_local</span><span class="o">-&gt;</span><span class="n">component_id</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">status_local</span><span class="o">-&gt;</span><span class="n">arming_state</span> <span class="o">=</span> <span class="n">ARMING_STATE_IN_AIR_RESTORE</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">transition_result_t</span> <span class="n">arming_res</span> <span class="o">=</span> <span class="n">arm_disarm</span><span class="p">(</span><span class="n">cmd_arms</span><span class="p">,</span> <span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;arm/disarm component command&quot;</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">arming_res</span> <span class="o">==</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;REJECTING component arm cmd&quot;</span><span class="p">);</span>
					<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">VEHICLE_CMD_RESULT_TEMPORARILY_REJECTED</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="nl">VEHICLE_CMD_OVERRIDE_GOTO</span><span class="p">:</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>TODO listen vehicle_command topic directly from navigator (?)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>Increase by 0.5f and rely on the integer cast
implicit floor(). This is the <em>safest</em> way to
convert from floats representing small ints to actual ints.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mav_goto</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param1</span> <span class="o">+</span> <span class="mf">0.5f</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mav_goto</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">// MAV_GOTO_DO_HOLD</span>
				<span class="n">status_local</span><span class="o">-&gt;</span><span class="n">nav_state</span> <span class="o">=</span> <span class="n">NAVIGATION_STATE_AUTO_LOITER</span><span class="p">;</span>
				<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;Pause mission cmd&quot;</span><span class="p">);</span>
				<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mav_goto</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="c1">// MAV_GOTO_DO_CONTINUE</span>
				<span class="n">status_local</span><span class="o">-&gt;</span><span class="n">nav_state</span> <span class="o">=</span> <span class="n">NAVIGATION_STATE_AUTO_MISSION</span><span class="p">;</span>
				<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;Continue mission cmd&quot;</span><span class="p">);</span>
				<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;REJ CMD: %.1f %.1f %.1f %.1f %.1f %.1f %.1f %.1f&quot;</span><span class="p">,</span>
						     <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param1</span><span class="p">,</span>
						     <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param2</span><span class="p">,</span>
						     <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param3</span><span class="p">,</span>
						     <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param4</span><span class="p">,</span>
						     <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param5</span><span class="p">,</span>
						     <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param6</span><span class="p">,</span>
						     <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param7</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* Flight termination */</span>
	<span class="k">case</span> <span class="nl">VEHICLE_CMD_DO_FLIGHTTERMINATION</span><span class="p">:</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param1</span> <span class="o">&gt;</span> <span class="mf">0.5f</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>XXX update state machine?</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>				<span class="n">armed_local</span><span class="o">-&gt;</span><span class="n">force_failsafe</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;forcing failsafe (termination)&quot;</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">armed_local</span><span class="o">-&gt;</span><span class="n">force_failsafe</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;disabling failsafe (termination)&quot;</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* param2 is currently used for other failsafe modes */</span>
			<span class="n">status_local</span><span class="o">-&gt;</span><span class="n">engine_failure_cmd</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">status_local</span><span class="o">-&gt;</span><span class="n">data_link_lost_cmd</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">status_local</span><span class="o">-&gt;</span><span class="n">gps_failure_cmd</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">status_local</span><span class="o">-&gt;</span><span class="n">rc_signal_lost_cmd</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param2</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* reset all commanded failure modes */</span>
				<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;reset all non-flighttermination failsafe commands&quot;</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* trigger engine failure mode */</span>
				<span class="n">status_local</span><span class="o">-&gt;</span><span class="n">engine_failure_cmd</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;engine failure mode commanded&quot;</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param2</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* trigger data link loss mode */</span>
				<span class="n">status_local</span><span class="o">-&gt;</span><span class="n">data_link_lost_cmd</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;data link loss mode commanded&quot;</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param2</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* trigger gps loss mode */</span>
				<span class="n">status_local</span><span class="o">-&gt;</span><span class="n">gps_failure_cmd</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;gps loss mode commanded&quot;</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param2</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* trigger rc loss mode */</span>
				<span class="n">status_local</span><span class="o">-&gt;</span><span class="n">rc_signal_lost_cmd</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;rc loss mode commanded&quot;</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="nl">VEHICLE_CMD_DO_SET_HOME</span><span class="p">:</span> <span class="p">{</span>
			<span class="kt">bool</span> <span class="n">use_current</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param1</span> <span class="o">&gt;</span> <span class="mf">0.5f</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">use_current</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* use current position */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status_local</span><span class="o">-&gt;</span><span class="n">condition_global_position_valid</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">home</span><span class="o">-&gt;</span><span class="n">lat</span> <span class="o">=</span> <span class="n">global_pos</span><span class="o">-&gt;</span><span class="n">lat</span><span class="p">;</span>
					<span class="n">home</span><span class="o">-&gt;</span><span class="n">lon</span> <span class="o">=</span> <span class="n">global_pos</span><span class="o">-&gt;</span><span class="n">lon</span><span class="p">;</span>
					<span class="n">home</span><span class="o">-&gt;</span><span class="n">alt</span> <span class="o">=</span> <span class="n">global_pos</span><span class="o">-&gt;</span><span class="n">alt</span><span class="p">;</span>

					<span class="n">home</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>

					<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">VEHICLE_CMD_RESULT_TEMPORARILY_REJECTED</span><span class="p">;</span>
				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* use specified position */</span>
				<span class="n">home</span><span class="o">-&gt;</span><span class="n">lat</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param5</span><span class="p">;</span>
				<span class="n">home</span><span class="o">-&gt;</span><span class="n">lon</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param6</span><span class="p">;</span>
				<span class="n">home</span><span class="o">-&gt;</span><span class="n">alt</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param7</span><span class="p">;</span>

				<span class="n">home</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>

				<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cmd_result</span> <span class="o">==</span> <span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;home: lat = %.7f, lon = %.7f, alt = %.2f &quot;</span><span class="p">,</span> <span class="n">home</span><span class="o">-&gt;</span><span class="n">lat</span><span class="p">,</span> <span class="n">home</span><span class="o">-&gt;</span><span class="n">lon</span><span class="p">,</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">home</span><span class="o">-&gt;</span><span class="n">alt</span><span class="p">);</span>
				<span class="n">mavlink_log_info</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;[cmd] home: %.7f, %.7f, %.2f&quot;</span><span class="p">,</span> <span class="n">home</span><span class="o">-&gt;</span><span class="n">lat</span><span class="p">,</span> <span class="n">home</span><span class="o">-&gt;</span><span class="n">lon</span><span class="p">,</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">home</span><span class="o">-&gt;</span><span class="n">alt</span><span class="p">);</span>

				<span class="cm">/* announce new home position */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">home_pub</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">orb_publish</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">home_position</span><span class="p">),</span> <span class="o">*</span><span class="n">home_pub</span><span class="p">,</span> <span class="n">home</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">home_pub</span> <span class="o">=</span> <span class="n">orb_advertise</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">home_position</span><span class="p">),</span> <span class="n">home</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="cm">/* mark home position as set */</span>
				<span class="n">status_local</span><span class="o">-&gt;</span><span class="n">condition_home_position_valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="nl">VEHICLE_CMD_NAV_GUIDED_ENABLE</span><span class="p">:</span> <span class="p">{</span>
			<span class="n">transition_result_t</span> <span class="n">res</span> <span class="o">=</span> <span class="n">TRANSITION_DENIED</span><span class="p">;</span>
			<span class="k">static</span> <span class="n">main_state_t</span> <span class="n">main_state_pre_offboard</span> <span class="o">=</span> <span class="n">MAIN_STATE_MANUAL</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status_local</span><span class="o">-&gt;</span><span class="n">main_state</span> <span class="o">!=</span> <span class="n">MAIN_STATE_OFFBOARD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">main_state_pre_offboard</span> <span class="o">=</span> <span class="n">status_local</span><span class="o">-&gt;</span><span class="n">main_state</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">param1</span> <span class="o">&gt;</span> <span class="mf">0.5f</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">MAIN_STATE_OFFBOARD</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">print_reject_mode</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="s">&quot;OFFBOARD&quot;</span><span class="p">);</span>
					<span class="n">status_local</span><span class="o">-&gt;</span><span class="n">offboard_control_set_by_command</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* Set flag that offboard was set via command, main state is not overridden by rc */</span>
					<span class="n">status_local</span><span class="o">-&gt;</span><span class="n">offboard_control_set_by_command</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* If the mavlink command is used to enable or disable offboard control:</span>
<span class="cm">				 * switch back to previous mode when disabling */</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">main_state_pre_offboard</span><span class="p">);</span>
				<span class="n">status_local</span><span class="o">-&gt;</span><span class="n">offboard_control_set_by_command</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="nl">VEHICLE_CMD_PREFLIGHT_REBOOT_SHUTDOWN</span><span class="p">:</span>
	<span class="k">case</span> <span class="nl">VEHICLE_CMD_PREFLIGHT_CALIBRATION</span><span class="p">:</span>
	<span class="k">case</span> <span class="nl">VEHICLE_CMD_PREFLIGHT_SET_SENSOR_OFFSETS</span><span class="p">:</span>
	<span class="k">case</span> <span class="nl">VEHICLE_CMD_PREFLIGHT_STORAGE</span><span class="p">:</span>
	<span class="k">case</span> <span class="nl">VEHICLE_CMD_CUSTOM_0</span><span class="p">:</span>
	<span class="k">case</span> <span class="nl">VEHICLE_CMD_CUSTOM_1</span><span class="p">:</span>
	<span class="k">case</span> <span class="nl">VEHICLE_CMD_CUSTOM_2</span><span class="p">:</span>
	<span class="k">case</span> <span class="nl">VEHICLE_CMD_PAYLOAD_PREPARE_DEPLOY</span><span class="p">:</span>
	<span class="k">case</span> <span class="nl">VEHICLE_CMD_PAYLOAD_CONTROL_DEPLOY</span><span class="p">:</span>
		<span class="cm">/* ignore commands that handled in low prio loop */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">default</span><span class="o">:</span>
		<span class="cm">/* Warn about unsupported commands, this makes sense because only commands</span>
<span class="cm">		 * to this component ID (or all) are passed by mavlink. */</span>
		<span class="n">answer_command</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">VEHICLE_CMD_RESULT_UNSUPPORTED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_result</span> <span class="o">!=</span> <span class="n">VEHICLE_CMD_RESULT_UNSUPPORTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* already warned about unsupported commands in &quot;default&quot; case */</span>
		<span class="n">answer_command</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cmd_result</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* send any requested ACKs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">confirmation</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">cmd_result</span> <span class="o">!=</span> <span class="n">VEHICLE_CMD_RESULT_UNSUPPORTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* send acknowledge command */</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>XXX TODO</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">commander_thread_main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="cm">/* not yet initialized */</span>
	<span class="n">commander_initialized</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="kt">bool</span> <span class="n">arm_tune_played</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">bool</span> <span class="n">was_armed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* set parameters */</span>
	<span class="n">param_t</span> <span class="n">_param_sys_type</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;MAV_TYPE&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_system_id</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;MAV_SYS_ID&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_component_id</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;MAV_COMP_ID&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_takeoff_alt</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;NAV_TAKEOFF_ALT&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_enable_parachute</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;NAV_PARACHUTE_EN&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_enable_datalink_loss</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_DL_LOSS_EN&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_datalink_loss_timeout</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_DL_LOSS_T&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_rc_loss_timeout</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_RC_LOSS_T&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_datalink_regain_timeout</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_DL_REG_T&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_ef_throttle_thres</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_EF_THROT&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_ef_current2throttle_thres</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_EF_C2T&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_ef_time_thres</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_EF_TIME&quot;</span><span class="p">);</span>

	<span class="cm">/* welcome user */</span>
	<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;starting&quot;</span><span class="p">);</span>

	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">main_states_str</span><span class="p">[</span><span class="n">MAIN_STATE_MAX</span><span class="p">];</span>
	<span class="n">main_states_str</span><span class="p">[</span><span class="n">MAIN_STATE_MANUAL</span><span class="p">]</span>			<span class="o">=</span> <span class="s">&quot;MANUAL&quot;</span><span class="p">;</span>
	<span class="n">main_states_str</span><span class="p">[</span><span class="n">MAIN_STATE_ALTCTL</span><span class="p">]</span>			<span class="o">=</span> <span class="s">&quot;ALTCTL&quot;</span><span class="p">;</span>
	<span class="n">main_states_str</span><span class="p">[</span><span class="n">MAIN_STATE_POSCTL</span><span class="p">]</span>			<span class="o">=</span> <span class="s">&quot;POSCTL&quot;</span><span class="p">;</span>
	<span class="n">main_states_str</span><span class="p">[</span><span class="n">MAIN_STATE_AUTO_MISSION</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;AUTO_MISSION&quot;</span><span class="p">;</span>
	<span class="n">main_states_str</span><span class="p">[</span><span class="n">MAIN_STATE_AUTO_LOITER</span><span class="p">]</span>			<span class="o">=</span> <span class="s">&quot;AUTO_LOITER&quot;</span><span class="p">;</span>
	<span class="n">main_states_str</span><span class="p">[</span><span class="n">MAIN_STATE_AUTO_RTL</span><span class="p">]</span>			<span class="o">=</span> <span class="s">&quot;AUTO_RTL&quot;</span><span class="p">;</span>
	<span class="n">main_states_str</span><span class="p">[</span><span class="n">MAIN_STATE_ACRO</span><span class="p">]</span>			<span class="o">=</span> <span class="s">&quot;ACRO&quot;</span><span class="p">;</span>
	<span class="n">main_states_str</span><span class="p">[</span><span class="n">MAIN_STATE_OFFBOARD</span><span class="p">]</span>			<span class="o">=</span> <span class="s">&quot;OFFBOARD&quot;</span><span class="p">;</span>

	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arming_states_str</span><span class="p">[</span><span class="n">ARMING_STATE_MAX</span><span class="p">];</span>
	<span class="n">arming_states_str</span><span class="p">[</span><span class="n">ARMING_STATE_INIT</span><span class="p">]</span>			<span class="o">=</span> <span class="s">&quot;INIT&quot;</span><span class="p">;</span>
	<span class="n">arming_states_str</span><span class="p">[</span><span class="n">ARMING_STATE_STANDBY</span><span class="p">]</span>			<span class="o">=</span> <span class="s">&quot;STANDBY&quot;</span><span class="p">;</span>
	<span class="n">arming_states_str</span><span class="p">[</span><span class="n">ARMING_STATE_ARMED</span><span class="p">]</span>			<span class="o">=</span> <span class="s">&quot;ARMED&quot;</span><span class="p">;</span>
	<span class="n">arming_states_str</span><span class="p">[</span><span class="n">ARMING_STATE_ARMED_ERROR</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;ARMED_ERROR&quot;</span><span class="p">;</span>
	<span class="n">arming_states_str</span><span class="p">[</span><span class="n">ARMING_STATE_STANDBY_ERROR</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;STANDBY_ERROR&quot;</span><span class="p">;</span>
	<span class="n">arming_states_str</span><span class="p">[</span><span class="n">ARMING_STATE_REBOOT</span><span class="p">]</span>			<span class="o">=</span> <span class="s">&quot;REBOOT&quot;</span><span class="p">;</span>
	<span class="n">arming_states_str</span><span class="p">[</span><span class="n">ARMING_STATE_IN_AIR_RESTORE</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;IN_AIR_RESTORE&quot;</span><span class="p">;</span>

	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nav_states_str</span><span class="p">[</span><span class="n">NAVIGATION_STATE_MAX</span><span class="p">];</span>
	<span class="n">nav_states_str</span><span class="p">[</span><span class="n">NAVIGATION_STATE_MANUAL</span><span class="p">]</span>			<span class="o">=</span> <span class="s">&quot;MANUAL&quot;</span><span class="p">;</span>
	<span class="n">nav_states_str</span><span class="p">[</span><span class="n">NAVIGATION_STATE_ALTCTL</span><span class="p">]</span>			<span class="o">=</span> <span class="s">&quot;ALTCTL&quot;</span><span class="p">;</span>
	<span class="n">nav_states_str</span><span class="p">[</span><span class="n">NAVIGATION_STATE_POSCTL</span><span class="p">]</span>			<span class="o">=</span> <span class="s">&quot;POSCTL&quot;</span><span class="p">;</span>
	<span class="n">nav_states_str</span><span class="p">[</span><span class="n">NAVIGATION_STATE_AUTO_MISSION</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;AUTO_MISSION&quot;</span><span class="p">;</span>
	<span class="n">nav_states_str</span><span class="p">[</span><span class="n">NAVIGATION_STATE_AUTO_LOITER</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;AUTO_LOITER&quot;</span><span class="p">;</span>
	<span class="n">nav_states_str</span><span class="p">[</span><span class="n">NAVIGATION_STATE_AUTO_RTL</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;AUTO_RTL&quot;</span><span class="p">;</span>
	<span class="n">nav_states_str</span><span class="p">[</span><span class="n">NAVIGATION_STATE_AUTO_RTGS</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;AUTO_RTGS&quot;</span><span class="p">;</span>
	<span class="n">nav_states_str</span><span class="p">[</span><span class="n">NAVIGATION_STATE_ACRO</span><span class="p">]</span>			<span class="o">=</span> <span class="s">&quot;ACRO&quot;</span><span class="p">;</span>
	<span class="n">nav_states_str</span><span class="p">[</span><span class="n">NAVIGATION_STATE_LAND</span><span class="p">]</span>			<span class="o">=</span> <span class="s">&quot;LAND&quot;</span><span class="p">;</span>
	<span class="n">nav_states_str</span><span class="p">[</span><span class="n">NAVIGATION_STATE_DESCEND</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;DESCEND&quot;</span><span class="p">;</span>
	<span class="n">nav_states_str</span><span class="p">[</span><span class="n">NAVIGATION_STATE_TERMINATION</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;TERMINATION&quot;</span><span class="p">;</span>
	<span class="n">nav_states_str</span><span class="p">[</span><span class="n">NAVIGATION_STATE_OFFBOARD</span><span class="p">]</span>		<span class="o">=</span> <span class="s">&quot;OFFBOARD&quot;</span><span class="p">;</span>

	<span class="cm">/* pthread for slow low prio thread */</span>
	<span class="n">pthread_t</span> <span class="n">commander_low_prio_thread</span><span class="p">;</span>

	<span class="cm">/* initialize */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">led_init</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;ERROR: LED INIT FAIL&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buzzer_init</span><span class="p">()</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;ERROR: BUZZER INIT FAIL&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mavlink_fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">MAVLINK_LOG_DEVICE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* vehicle status topic */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
	<span class="n">status</span><span class="p">.</span><span class="n">condition_landed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>	<span class="c1">// initialize to safe value</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>We want to accept RC inputs as default</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="n">status</span><span class="p">.</span><span class="n">rc_input_blocked</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">main_state</span> <span class="o">=</span> <span class="n">MAIN_STATE_MANUAL</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">nav_state</span> <span class="o">=</span> <span class="n">NAVIGATION_STATE_MANUAL</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">arming_state</span> <span class="o">=</span> <span class="n">ARMING_STATE_INIT</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">hil_state</span> <span class="o">=</span> <span class="n">HIL_STATE_OFF</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">failsafe</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* neither manual nor offboard control commands have been received */</span>
	<span class="n">status</span><span class="p">.</span><span class="n">offboard_control_signal_found_once</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">rc_signal_found_once</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* mark all signals lost as long as they haven&#39;t been found */</span>
	<span class="n">status</span><span class="p">.</span><span class="n">rc_signal_lost</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">offboard_control_signal_lost</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">data_link_lost</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* set battery warning flag */</span>
	<span class="n">status</span><span class="p">.</span><span class="n">battery_warning</span> <span class="o">=</span> <span class="n">VEHICLE_BATTERY_WARNING_NONE</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">condition_battery_voltage_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>XXX for now just set sensors as initialized</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="n">status</span><span class="p">.</span><span class="n">condition_system_sensors_initialized</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">status</span><span class="p">.</span><span class="n">counter</span><span class="o">++</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>

	<span class="n">status</span><span class="p">.</span><span class="n">condition_power_input_valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">avionics_power_rail_voltage</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0f</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p>CIRCUIT BREAKERS</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="n">status</span><span class="p">.</span><span class="n">circuit_breaker_engaged_power_check</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">circuit_breaker_engaged_airspd_check</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">circuit_breaker_engaged_enginefailure_check</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">circuit_breaker_engaged_gpsfailure_check</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* publish initial state */</span>
	<span class="n">status_pub</span> <span class="o">=</span> <span class="n">orb_advertise</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_status</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status_pub</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;ERROR: orb_advertise for topic vehicle_status failed (uorb app running?).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;exiting.&quot;</span><span class="p">);</span>
		<span class="n">exit</span><span class="p">(</span><span class="n">ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* armed topic */</span>
	<span class="n">orb_advert_t</span> <span class="n">armed_pub</span><span class="p">;</span>
	<span class="cm">/* Initialize armed with all false */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">armed</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">armed</span><span class="p">));</span>

	<span class="cm">/* vehicle control mode topic */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">control_mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">control_mode</span><span class="p">));</span>
	<span class="n">orb_advert_t</span> <span class="n">control_mode_pub</span> <span class="o">=</span> <span class="n">orb_advertise</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_control_mode</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">control_mode</span><span class="p">);</span>

	<span class="n">armed_pub</span> <span class="o">=</span> <span class="n">orb_advertise</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">actuator_armed</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">armed</span><span class="p">);</span>

	<span class="cm">/* home position */</span>
	<span class="n">orb_advert_t</span> <span class="n">home_pub</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">home_position_s</span> <span class="n">home</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">home</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">home</span><span class="p">));</span>

	<span class="cm">/* init mission state, do it here to allow navigator to use stored mission even if mavlink failed to start */</span>
	<span class="n">orb_advert_t</span> <span class="n">mission_pub</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">mission_s</span> <span class="n">mission</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dm_read</span><span class="p">(</span><span class="n">DM_KEY_MISSION_STATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mission</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mission_s</span><span class="p">))</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mission_s</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mission</span><span class="p">.</span><span class="n">dataman_id</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">mission</span><span class="p">.</span><span class="n">dataman_id</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;loaded mission state: dataman_id=%d, count=%u, current=%d&quot;</span><span class="p">,</span> <span class="n">mission</span><span class="p">.</span><span class="n">dataman_id</span><span class="p">,</span> <span class="n">mission</span><span class="p">.</span><span class="n">count</span><span class="p">,</span>
			      <span class="n">mission</span><span class="p">.</span><span class="n">current_seq</span><span class="p">);</span>
			<span class="n">mavlink_log_info</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;[cmd] dataman_id=%d, count=%u, current=%d&quot;</span><span class="p">,</span>
					 <span class="n">mission</span><span class="p">.</span><span class="n">dataman_id</span><span class="p">,</span> <span class="n">mission</span><span class="p">.</span><span class="n">count</span><span class="p">,</span> <span class="n">mission</span><span class="p">.</span><span class="n">current_seq</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">missionfail</span> <span class="o">=</span> <span class="s">&quot;reading mission state failed&quot;</span><span class="p">;</span>
			<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">missionfail</span><span class="p">);</span>
			<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="n">missionfail</span><span class="p">);</span>

			<span class="cm">/* initialize mission state in dataman */</span>
			<span class="n">mission</span><span class="p">.</span><span class="n">dataman_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">mission</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">mission</span><span class="p">.</span><span class="n">current_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">dm_write</span><span class="p">(</span><span class="n">DM_KEY_MISSION_STATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DM_PERSIST_POWER_ON_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mission</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mission_s</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">mission_pub</span> <span class="o">=</span> <span class="n">orb_advertise</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">offboard_mission</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">mission</span><span class="p">);</span>
		<span class="n">orb_publish</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">offboard_mission</span><span class="p">),</span> <span class="n">mission_pub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mission</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pthread_attr_t</span> <span class="n">commander_low_prio_attr</span><span class="p">;</span>
	<span class="n">pthread_attr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commander_low_prio_attr</span><span class="p">);</span>
	<span class="n">pthread_attr_setstacksize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commander_low_prio_attr</span><span class="p">,</span> <span class="mi">2900</span><span class="p">);</span>

	<span class="k">struct</span> <span class="n">sched_param</span> <span class="n">param</span><span class="p">;</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">pthread_attr_getschedparam</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commander_low_prio_attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>

	<span class="cm">/* low priority */</span>
	<span class="n">param</span><span class="p">.</span><span class="n">sched_priority</span> <span class="o">=</span> <span class="n">SCHED_PRIORITY_DEFAULT</span> <span class="o">-</span> <span class="mi">50</span><span class="p">;</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">pthread_attr_setschedparam</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commander_low_prio_attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>
	<span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commander_low_prio_thread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">commander_low_prio_attr</span><span class="p">,</span> <span class="n">commander_low_prio_loop</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pthread_attr_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commander_low_prio_attr</span><span class="p">);</span>

	<span class="cm">/* Start monitoring loop */</span>
	<span class="kt">unsigned</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">stick_off_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">stick_on_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="kt">bool</span> <span class="n">low_battery_voltage_actions_done</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">bool</span> <span class="n">critical_battery_voltage_actions_done</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">hrt_abstime</span> <span class="n">last_idle_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hrt_abstime</span> <span class="n">start_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="kt">bool</span> <span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="kt">bool</span> <span class="n">param_init_forced</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="kt">bool</span> <span class="n">updated</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">rc_calibration_check</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">);</span>

	<span class="cm">/* Subscribe to safety topic */</span>
	<span class="kt">int</span> <span class="n">safety_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">safety</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">safety</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">safety</span><span class="p">));</span>
	<span class="n">safety</span><span class="p">.</span><span class="n">safety_switch_available</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">safety</span><span class="p">.</span><span class="n">safety_off</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Subscribe to mission result topic */</span>
	<span class="kt">int</span> <span class="n">mission_result_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">mission_result</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">mission_result_s</span> <span class="n">mission_result</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mission_result</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mission_result</span><span class="p">));</span>

	<span class="cm">/* Subscribe to manual control data */</span>
	<span class="kt">int</span> <span class="n">sp_man_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">manual_control_setpoint</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">manual_control_setpoint_s</span> <span class="n">sp_man</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp_man</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sp_man</span><span class="p">));</span>

	<span class="cm">/* Subscribe to offboard control data */</span>
	<span class="kt">int</span> <span class="n">sp_offboard_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">offboard_control_setpoint</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp_offboard</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sp_offboard</span><span class="p">));</span>

	<span class="cm">/* Subscribe to telemetry status topics */</span>
	<span class="kt">int</span> <span class="n">telemetry_subs</span><span class="p">[</span><span class="n">TELEMETRY_STATUS_ORB_ID_NUM</span><span class="p">];</span>
	<span class="kt">uint64_t</span> <span class="n">telemetry_last_heartbeat</span><span class="p">[</span><span class="n">TELEMETRY_STATUS_ORB_ID_NUM</span><span class="p">];</span>
	<span class="kt">uint64_t</span> <span class="n">telemetry_last_dl_loss</span><span class="p">[</span><span class="n">TELEMETRY_STATUS_ORB_ID_NUM</span><span class="p">];</span>
	<span class="kt">bool</span> <span class="n">telemetry_lost</span><span class="p">[</span><span class="n">TELEMETRY_STATUS_ORB_ID_NUM</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TELEMETRY_STATUS_ORB_ID_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">telemetry_subs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">telemetry_status_orb_id</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">telemetry_last_heartbeat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">telemetry_last_dl_loss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">telemetry_lost</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Subscribe to global position */</span>
	<span class="kt">int</span> <span class="n">global_position_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_global_position</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">vehicle_global_position_s</span> <span class="n">global_position</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global_position</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">global_position</span><span class="p">));</span>
	<span class="cm">/* Init EPH and EPV */</span>
	<span class="n">global_position</span><span class="p">.</span><span class="n">eph</span> <span class="o">=</span> <span class="mf">1000.0f</span><span class="p">;</span>
	<span class="n">global_position</span><span class="p">.</span><span class="n">epv</span> <span class="o">=</span> <span class="mf">1000.0f</span><span class="p">;</span>

	<span class="cm">/* Subscribe to local position data */</span>
	<span class="kt">int</span> <span class="n">local_position_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_local_position</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">vehicle_local_position_s</span> <span class="n">local_position</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local_position</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">local_position</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * The home position is set based on GPS only, to prevent a dependency between</span>
<span class="cm">	 * position estimator and commander. RAW GPS is more than good enough for a</span>
<span class="cm">	 * non-flying vehicle.</span>
<span class="cm">	 */</span>

	<span class="cm">/* Subscribe to GPS topic */</span>
	<span class="kt">int</span> <span class="n">gps_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_gps_position</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">vehicle_gps_position_s</span> <span class="n">gps_position</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gps_position</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gps_position</span><span class="p">));</span>
	<span class="n">gps_position</span><span class="p">.</span><span class="n">eph</span> <span class="o">=</span> <span class="n">FLT_MAX</span><span class="p">;</span>
	<span class="n">gps_position</span><span class="p">.</span><span class="n">epv</span> <span class="o">=</span> <span class="n">FLT_MAX</span><span class="p">;</span>

	<span class="cm">/* Subscribe to sensor topic */</span>
	<span class="kt">int</span> <span class="n">sensor_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">sensor_combined</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">sensor_combined_s</span> <span class="n">sensors</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensors</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sensors</span><span class="p">));</span>

	<span class="cm">/* Subscribe to differential pressure topic */</span>
	<span class="kt">int</span> <span class="n">diff_pres_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">differential_pressure</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">differential_pressure_s</span> <span class="n">diff_pres</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">diff_pres</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">diff_pres</span><span class="p">));</span>

	<span class="cm">/* Subscribe to command topic */</span>
	<span class="kt">int</span> <span class="n">cmd_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_command</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">vehicle_command_s</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>

	<span class="cm">/* Subscribe to parameters changed topic */</span>
	<span class="kt">int</span> <span class="n">param_changed_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">parameter_update</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">parameter_update_s</span> <span class="n">param_changed</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">param_changed</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">param_changed</span><span class="p">));</span>

	<span class="cm">/* Subscribe to battery topic */</span>
	<span class="kt">int</span> <span class="n">battery_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">battery_status</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">battery_status_s</span> <span class="n">battery</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">battery</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">battery</span><span class="p">));</span>

	<span class="cm">/* Subscribe to subsystem info topic */</span>
	<span class="kt">int</span> <span class="n">subsys_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">subsystem_info</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">subsystem_info_s</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>

	<span class="cm">/* Subscribe to position setpoint triplet */</span>
	<span class="kt">int</span> <span class="n">pos_sp_triplet_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">position_setpoint_triplet</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">position_setpoint_triplet_s</span> <span class="n">pos_sp_triplet</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pos_sp_triplet</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pos_sp_triplet</span><span class="p">));</span>

	<span class="cm">/* Subscribe to system power */</span>
	<span class="kt">int</span> <span class="n">system_power_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">system_power</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">system_power_s</span> <span class="n">system_power</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">system_power</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">system_power</span><span class="p">));</span>

	<span class="cm">/* Subscribe to actuator controls (outputs) */</span>
	<span class="kt">int</span> <span class="n">actuator_controls_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID_VEHICLE_ATTITUDE_CONTROLS</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">actuator_controls_s</span> <span class="n">actuator_controls</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">actuator_controls</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">actuator_controls</span><span class="p">));</span>

	<span class="n">control_status_leds</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">armed</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="cm">/* now initialized */</span>
	<span class="n">commander_initialized</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">thread_running</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">start_time</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>

	<span class="n">transition_result_t</span> <span class="n">arming_ret</span><span class="p">;</span>

	<span class="kt">int32_t</span> <span class="n">datalink_loss_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int32_t</span> <span class="n">datalink_loss_timeout</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="kt">float</span> <span class="n">rc_loss_timeout</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">;</span>
	<span class="kt">int32_t</span> <span class="n">datalink_regain_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Thresholds for engine failure detection */</span>
	<span class="kt">int32_t</span> <span class="n">ef_throttle_thres</span> <span class="o">=</span> <span class="mf">1.0f</span><span class="p">;</span>
	<span class="kt">int32_t</span> <span class="n">ef_current2throttle_thres</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
	<span class="kt">int32_t</span> <span class="n">ef_time_thres</span> <span class="o">=</span> <span class="mf">1000.0f</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">timestamp_engine_healthy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/**&lt; absolute time when engine was healty */</span>

	<span class="cm">/* check which state machines for changes, clear &quot;changed&quot; flag */</span>
	<span class="kt">bool</span> <span class="n">arming_state_changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">bool</span> <span class="n">main_state_changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">bool</span> <span class="n">failsafe_old</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">thread_should_exit</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mavlink_fd</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">counter</span> <span class="o">%</span> <span class="p">(</span><span class="mi">1000000</span> <span class="o">/</span> <span class="n">MAVLINK_OPEN_INTERVAL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* try to open the mavlink log device every once in a while */</span>
			<span class="n">mavlink_fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">MAVLINK_LOG_DEVICE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">arming_ret</span> <span class="o">=</span> <span class="n">TRANSITION_NOT_CHANGED</span><span class="p">;</span>


		<span class="cm">/* update parameters */</span>
		<span class="n">orb_check</span><span class="p">(</span><span class="n">param_changed_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span> <span class="o">||</span> <span class="n">param_init_forced</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">param_init_forced</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="cm">/* parameters changed */</span>
			<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">parameter_update</span><span class="p">),</span> <span class="n">param_changed_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param_changed</span><span class="p">);</span>

			<span class="cm">/* update parameters */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">param_get</span><span class="p">(</span><span class="n">_param_sys_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">system_type</span><span class="p">))</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;failed getting new system type&quot;</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="cm">/* disable manual override for all systems that rely on electronic stabilization */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">system_type</span> <span class="o">==</span> <span class="n">VEHICLE_TYPE_COAXIAL</span> <span class="o">||</span>
				    <span class="n">status</span><span class="p">.</span><span class="n">system_type</span> <span class="o">==</span> <span class="n">VEHICLE_TYPE_HELICOPTER</span> <span class="o">||</span>
				    <span class="n">status</span><span class="p">.</span><span class="n">system_type</span> <span class="o">==</span> <span class="n">VEHICLE_TYPE_TRICOPTER</span> <span class="o">||</span>
				    <span class="n">status</span><span class="p">.</span><span class="n">system_type</span> <span class="o">==</span> <span class="n">VEHICLE_TYPE_QUADROTOR</span> <span class="o">||</span>
				    <span class="n">status</span><span class="p">.</span><span class="n">system_type</span> <span class="o">==</span> <span class="n">VEHICLE_TYPE_HEXAROTOR</span> <span class="o">||</span>
				    <span class="n">status</span><span class="p">.</span><span class="n">system_type</span> <span class="o">==</span> <span class="n">VEHICLE_TYPE_OCTOROTOR</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">status</span><span class="p">.</span><span class="n">is_rotary_wing</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">status</span><span class="p">.</span><span class="n">is_rotary_wing</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* check and update system / component ID */</span>
				<span class="n">param_get</span><span class="p">(</span><span class="n">_param_system_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">system_id</span><span class="p">));</span>
				<span class="n">param_get</span><span class="p">(</span><span class="n">_param_component_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">component_id</span><span class="p">));</span>

				<span class="n">status</span><span class="p">.</span><span class="n">circuit_breaker_engaged_power_check</span> <span class="o">=</span>
					<span class="n">circuit_breaker_enabled</span><span class="p">(</span><span class="s">&quot;CBRK_SUPPLY_CHK&quot;</span><span class="p">,</span> <span class="n">CBRK_SUPPLY_CHK_KEY</span><span class="p">);</span>
				<span class="n">status</span><span class="p">.</span><span class="n">circuit_breaker_engaged_airspd_check</span> <span class="o">=</span>
					<span class="n">circuit_breaker_enabled</span><span class="p">(</span><span class="s">&quot;CBRK_AIRSPD_CHK&quot;</span><span class="p">,</span> <span class="n">CBRK_AIRSPD_CHK_KEY</span><span class="p">);</span>
				<span class="n">status</span><span class="p">.</span><span class="n">circuit_breaker_engaged_enginefailure_check</span> <span class="o">=</span>
					<span class="n">circuit_breaker_enabled</span><span class="p">(</span><span class="s">&quot;CBRK_ENGINEFAIL&quot;</span><span class="p">,</span> <span class="n">CBRK_ENGINEFAIL_KEY</span><span class="p">);</span>
				<span class="n">status</span><span class="p">.</span><span class="n">circuit_breaker_engaged_gpsfailure_check</span> <span class="o">=</span>
					<span class="n">circuit_breaker_enabled</span><span class="p">(</span><span class="s">&quot;CBRK_GPSFAIL&quot;</span><span class="p">,</span> <span class="n">CBRK_GPSFAIL_KEY</span><span class="p">);</span>

				<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

				<span class="cm">/* re-check RC calibration */</span>
				<span class="n">rc_calibration_check</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* navigation parameters */</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_takeoff_alt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">takeoff_alt</span><span class="p">);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_enable_parachute</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parachute_enabled</span><span class="p">);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_enable_datalink_loss</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">datalink_loss_enabled</span><span class="p">);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_datalink_loss_timeout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">datalink_loss_timeout</span><span class="p">);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_rc_loss_timeout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc_loss_timeout</span><span class="p">);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_datalink_regain_timeout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">datalink_regain_timeout</span><span class="p">);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_ef_throttle_thres</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ef_throttle_thres</span><span class="p">);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_ef_current2throttle_thres</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ef_current2throttle_thres</span><span class="p">);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_ef_time_thres</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ef_time_thres</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">orb_check</span><span class="p">(</span><span class="n">sp_man_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">manual_control_setpoint</span><span class="p">),</span> <span class="n">sp_man_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp_man</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">orb_check</span><span class="p">(</span><span class="n">sp_offboard_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">offboard_control_setpoint</span><span class="p">),</span> <span class="n">sp_offboard_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp_offboard</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sp_offboard</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sp_offboard</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">+</span> <span class="n">OFFBOARD_TIMEOUT</span> <span class="o">&gt;</span> <span class="n">hrt_absolute_time</span><span class="p">())</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">offboard_control_signal_lost</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">.</span><span class="n">offboard_control_signal_lost</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">offboard_control_signal_lost</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">.</span><span class="n">offboard_control_signal_lost</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TELEMETRY_STATUS_ORB_ID_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">orb_check</span><span class="p">(</span><span class="n">telemetry_subs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">telemetry_status_s</span> <span class="n">telemetry</span><span class="p">;</span>
				<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">telemetry</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">telemetry</span><span class="p">));</span>

				<span class="n">orb_copy</span><span class="p">(</span><span class="n">telemetry_status_orb_id</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">telemetry_subs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">telemetry</span><span class="p">);</span>

				<span class="cm">/* perform system checks when new telemetry link connected */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mavlink_fd</span> <span class="o">&amp;&amp;</span>
				    <span class="n">telemetry_last_heartbeat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
				    <span class="n">telemetry</span><span class="p">.</span><span class="n">heartbeat_time</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
				    <span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">telemetry</span><span class="p">.</span><span class="n">heartbeat_time</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">datalink_loss_timeout</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span> <span class="p">{</span>

					<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">rc_calibration_check</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">telemetry_last_heartbeat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">telemetry</span><span class="p">.</span><span class="n">heartbeat_time</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">orb_check</span><span class="p">(</span><span class="n">sensor_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">sensor_combined</span><span class="p">),</span> <span class="n">sensor_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sensors</span><span class="p">);</span>

			<span class="cm">/* Check if the barometer is healthy and issue a warning in the GCS if not so.</span>
<span class="cm">			 * Because the barometer is used for calculating AMSL altitude which is used to ensure</span>
<span class="cm">			 * vertical separation from other airtraffic the operator has to know when the</span>
<span class="cm">			 * barometer is inoperational.</span>
<span class="cm">			 * */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensors</span><span class="p">.</span><span class="n">baro_timestamp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">FAILSAFE_DEFAULT_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* handle the case where baro was regained */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">barometer_failure</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">status</span><span class="p">.</span><span class="n">barometer_failure</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;baro healthy&quot;</span><span class="p">);</span>
				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">barometer_failure</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">status</span><span class="p">.</span><span class="n">barometer_failure</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;baro failed&quot;</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">orb_check</span><span class="p">(</span><span class="n">diff_pres_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">differential_pressure</span><span class="p">),</span> <span class="n">diff_pres_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">diff_pres</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">orb_check</span><span class="p">(</span><span class="n">system_power_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">system_power</span><span class="p">),</span> <span class="n">system_power_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">system_power</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">system_power</span><span class="p">.</span><span class="n">timestamp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">200000</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">system_power</span><span class="p">.</span><span class="n">servo_valid</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="n">system_power</span><span class="p">.</span><span class="n">brick_valid</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="n">system_power</span><span class="p">.</span><span class="n">usb_connected</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* flying only on servo rail, this is unsafe */</span>
					<span class="n">status</span><span class="p">.</span><span class="n">condition_power_input_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">status</span><span class="p">.</span><span class="n">condition_power_input_valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* copy avionics voltage */</span>
				<span class="n">status</span><span class="p">.</span><span class="n">avionics_power_rail_voltage</span> <span class="o">=</span> <span class="n">system_power</span><span class="p">.</span><span class="n">voltage5V_v</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">check_valid</span><span class="p">(</span><span class="n">diff_pres</span><span class="p">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">DIFFPRESS_TIMEOUT</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">condition_airspeed_valid</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">status_changed</span><span class="p">);</span>

		<span class="cm">/* update safety topic */</span>
		<span class="n">orb_check</span><span class="p">(</span><span class="n">safety_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">safety</span><span class="p">),</span> <span class="n">safety_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">safety</span><span class="p">);</span>

			<span class="cm">/* disarm if safety is now on and still armed */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">hil_state</span> <span class="o">==</span> <span class="n">HIL_STATE_OFF</span> <span class="o">&amp;&amp;</span> <span class="n">safety</span><span class="p">.</span><span class="n">safety_switch_available</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">safety</span><span class="p">.</span><span class="n">safety_off</span> <span class="o">&amp;&amp;</span> <span class="n">armed</span><span class="p">.</span><span class="n">armed</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">arming_state_t</span> <span class="n">new_arming_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">arming_state</span> <span class="o">==</span> <span class="n">ARMING_STATE_ARMED</span> <span class="o">?</span> <span class="nl">ARMING_STATE_STANDBY</span> <span class="p">:</span>
								   <span class="n">ARMING_STATE_STANDBY_ERROR</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">TRANSITION_CHANGED</span> <span class="o">==</span> <span class="n">arming_state_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">safety</span><span class="p">,</span> <span class="n">new_arming_state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">armed</span><span class="p">,</span>
						<span class="nb">true</span> <span class="cm">/* fRunPreArmChecks */</span><span class="p">,</span> <span class="n">mavlink_fd</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">mavlink_log_info</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;DISARMED by safety switch&quot;</span><span class="p">);</span>
					<span class="n">arming_state_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* update global position estimate */</span>
		<span class="n">orb_check</span><span class="p">(</span><span class="n">global_position_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* position changed */</span>
			<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_global_position</span><span class="p">),</span> <span class="n">global_position_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">global_position</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* update local position estimate */</span>
		<span class="n">orb_check</span><span class="p">(</span><span class="n">local_position_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* position changed */</span>
			<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_local_position</span><span class="p">),</span> <span class="n">local_position_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local_position</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* update condition_global_position_valid */</span>
		<span class="cm">/* hysteresis for EPH/EPV */</span>
		<span class="kt">bool</span> <span class="n">eph_good</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">condition_global_position_valid</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">global_position</span><span class="p">.</span><span class="n">eph</span> <span class="o">&gt;</span> <span class="n">eph_threshold</span> <span class="o">*</span> <span class="mf">2.5f</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">eph_good</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">eph_good</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">global_position</span><span class="p">.</span><span class="n">eph</span> <span class="o">&lt;</span> <span class="n">eph_threshold</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">eph_good</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">eph_good</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">check_valid</span><span class="p">(</span><span class="n">global_position</span><span class="p">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">POSITION_TIMEOUT</span><span class="p">,</span> <span class="n">eph_good</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">condition_global_position_valid</span><span class="p">),</span>
			    <span class="o">&amp;</span><span class="n">status_changed</span><span class="p">);</span>

		<span class="cm">/* update home position */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">condition_home_position_valid</span> <span class="o">&amp;&amp;</span> <span class="n">status</span><span class="p">.</span><span class="n">condition_global_position_valid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">global_position</span><span class="p">.</span><span class="n">eph</span> <span class="o">&lt;</span> <span class="n">eph_threshold</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">global_position</span><span class="p">.</span><span class="n">epv</span> <span class="o">&lt;</span> <span class="n">epv_threshold</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">home</span><span class="p">.</span><span class="n">lat</span> <span class="o">=</span> <span class="n">global_position</span><span class="p">.</span><span class="n">lat</span><span class="p">;</span>
			<span class="n">home</span><span class="p">.</span><span class="n">lon</span> <span class="o">=</span> <span class="n">global_position</span><span class="p">.</span><span class="n">lon</span><span class="p">;</span>
			<span class="n">home</span><span class="p">.</span><span class="n">alt</span> <span class="o">=</span> <span class="n">global_position</span><span class="p">.</span><span class="n">alt</span><span class="p">;</span>

			<span class="n">home</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">local_position</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
			<span class="n">home</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">local_position</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
			<span class="n">home</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">local_position</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>

			<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;home: lat = %.7f, lon = %.7f, alt = %.2f &quot;</span><span class="p">,</span> <span class="n">home</span><span class="p">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">home</span><span class="p">.</span><span class="n">lon</span><span class="p">,</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">home</span><span class="p">.</span><span class="n">alt</span><span class="p">);</span>
			<span class="n">mavlink_log_info</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;[cmd] home: %.7f, %.7f, %.2f&quot;</span><span class="p">,</span> <span class="n">home</span><span class="p">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">home</span><span class="p">.</span><span class="n">lon</span><span class="p">,</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">home</span><span class="p">.</span><span class="n">alt</span><span class="p">);</span>

			<span class="cm">/* announce new home position */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">home_pub</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">orb_publish</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">home_position</span><span class="p">),</span> <span class="n">home_pub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">home</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">home_pub</span> <span class="o">=</span> <span class="n">orb_advertise</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">home_position</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">home</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* mark home position as set */</span>
			<span class="n">status</span><span class="p">.</span><span class="n">condition_home_position_valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">tune_positive</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* update condition_local_position_valid and condition_local_altitude_valid */</span>
		<span class="cm">/* hysteresis for EPH */</span>
		<span class="kt">bool</span> <span class="n">local_eph_good</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">condition_local_position_valid</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">local_position</span><span class="p">.</span><span class="n">eph</span> <span class="o">&gt;</span> <span class="n">eph_threshold</span> <span class="o">*</span> <span class="mf">2.5f</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">local_eph_good</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">local_eph_good</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">local_position</span><span class="p">.</span><span class="n">eph</span> <span class="o">&lt;</span> <span class="n">eph_threshold</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">local_eph_good</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">local_eph_good</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">check_valid</span><span class="p">(</span><span class="n">local_position</span><span class="p">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">POSITION_TIMEOUT</span><span class="p">,</span> <span class="n">local_position</span><span class="p">.</span><span class="n">xy_valid</span>
			    <span class="o">&amp;&amp;</span> <span class="n">local_eph_good</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">condition_local_position_valid</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">status_changed</span><span class="p">);</span>
		<span class="n">check_valid</span><span class="p">(</span><span class="n">local_position</span><span class="p">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">POSITION_TIMEOUT</span><span class="p">,</span> <span class="n">local_position</span><span class="p">.</span><span class="n">z_valid</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">condition_local_altitude_valid</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">status_changed</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">condition_local_altitude_valid</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">condition_landed</span> <span class="o">!=</span> <span class="n">local_position</span><span class="p">.</span><span class="n">landed</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">.</span><span class="n">condition_landed</span> <span class="o">=</span> <span class="n">local_position</span><span class="p">.</span><span class="n">landed</span><span class="p">;</span>
				<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">condition_landed</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;LANDED MODE&quot;</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;IN AIR MODE&quot;</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* update battery status */</span>
		<span class="n">orb_check</span><span class="p">(</span><span class="n">battery_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">battery_status</span><span class="p">),</span> <span class="n">battery_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">battery</span><span class="p">);</span>
			<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID_VEHICLE_ATTITUDE_CONTROLS</span><span class="p">,</span> <span class="n">actuator_controls_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">actuator_controls</span><span class="p">);</span>

			<span class="cm">/* only consider battery voltage if system has been running 2s and battery voltage is valid */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hrt_absolute_time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">start_time</span> <span class="o">+</span> <span class="mi">2000000</span> <span class="o">&amp;&amp;</span> <span class="n">battery</span><span class="p">.</span><span class="n">voltage_filtered_v</span> <span class="o">&gt;</span> <span class="mf">0.0f</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">.</span><span class="n">battery_voltage</span> <span class="o">=</span> <span class="n">battery</span><span class="p">.</span><span class="n">voltage_filtered_v</span><span class="p">;</span>
				<span class="n">status</span><span class="p">.</span><span class="n">battery_current</span> <span class="o">=</span> <span class="n">battery</span><span class="p">.</span><span class="n">current_a</span><span class="p">;</span>
				<span class="n">status</span><span class="p">.</span><span class="n">condition_battery_voltage_valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

				<span class="cm">/* get throttle (if armed), as we only care about energy negative throttle also counts */</span>
				<span class="kt">float</span> <span class="n">throttle</span> <span class="o">=</span> <span class="p">(</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span><span class="p">)</span> <span class="o">?</span> <span class="n">fabsf</span><span class="p">(</span><span class="n">actuator_controls</span><span class="p">.</span><span class="n">control</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">:</span> <span class="mf">0.0f</span><span class="p">;</span>
				<span class="n">status</span><span class="p">.</span><span class="n">battery_remaining</span> <span class="o">=</span> <span class="n">battery_remaining_estimate_voltage</span><span class="p">(</span><span class="n">battery</span><span class="p">.</span><span class="n">voltage_filtered_v</span><span class="p">,</span> <span class="n">battery</span><span class="p">.</span><span class="n">discharged_mah</span><span class="p">,</span>
							   <span class="n">throttle</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* update subsystem */</span>
		<span class="n">orb_check</span><span class="p">(</span><span class="n">subsys_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">subsystem_info</span><span class="p">),</span> <span class="n">subsys_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>

			<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;subsystem changed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">info</span><span class="p">.</span><span class="n">subsystem_type</span><span class="p">);</span>

			<span class="cm">/* mark / unmark as present */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">present</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">.</span><span class="n">onboard_control_sensors_present</span> <span class="o">|=</span> <span class="n">info</span><span class="p">.</span><span class="n">subsystem_type</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">.</span><span class="n">onboard_control_sensors_present</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">info</span><span class="p">.</span><span class="n">subsystem_type</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* mark / unmark as enabled */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">.</span><span class="n">onboard_control_sensors_enabled</span> <span class="o">|=</span> <span class="n">info</span><span class="p">.</span><span class="n">subsystem_type</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">.</span><span class="n">onboard_control_sensors_enabled</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">info</span><span class="p">.</span><span class="n">subsystem_type</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* mark / unmark as ok */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">.</span><span class="n">onboard_control_sensors_health</span> <span class="o">|=</span> <span class="n">info</span><span class="p">.</span><span class="n">subsystem_type</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">.</span><span class="n">onboard_control_sensors_health</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">info</span><span class="p">.</span><span class="n">subsystem_type</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* update position setpoint triplet */</span>
		<span class="n">orb_check</span><span class="p">(</span><span class="n">pos_sp_triplet_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">position_setpoint_triplet</span><span class="p">),</span> <span class="n">pos_sp_triplet_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos_sp_triplet</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">%</span> <span class="p">(</span><span class="mi">1000000</span> <span class="o">/</span> <span class="n">COMMANDER_MONITORING_INTERVAL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* compute system load */</span>
			<span class="kt">uint64_t</span> <span class="n">interval_runtime</span> <span class="o">=</span> <span class="n">system_load</span><span class="p">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">total_runtime</span> <span class="o">-</span> <span class="n">last_idle_time</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">last_idle_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">.</span><span class="n">load</span> <span class="o">=</span> <span class="mf">1.0f</span> <span class="o">-</span> <span class="p">((</span><span class="kt">float</span><span class="p">)</span><span class="n">interval_runtime</span> <span class="o">/</span> <span class="mf">1e6</span><span class="n">f</span><span class="p">);</span>        <span class="c1">//system load is time spent in non-idle</span>
			<span class="p">}</span>

			<span class="n">last_idle_time</span> <span class="o">=</span> <span class="n">system_load</span><span class="p">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">total_runtime</span><span class="p">;</span>

			<span class="cm">/* check if board is connected via USB */</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>struct stat statbuf;
on_usb_power = (stat("/dev/ttyACM0", &amp;statbuf) == 0);</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="p">}</span>

		<span class="cm">/* if battery voltage is getting lower, warn using buzzer, etc. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">condition_battery_voltage_valid</span> <span class="o">&amp;&amp;</span> <span class="n">status</span><span class="p">.</span><span class="n">battery_remaining</span> <span class="o">&lt;</span> <span class="mf">0.18f</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">low_battery_voltage_actions_done</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">low_battery_voltage_actions_done</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;LOW BATTERY, RETURN TO LAND ADVISED&quot;</span><span class="p">);</span>
			<span class="n">status</span><span class="p">.</span><span class="n">battery_warning</span> <span class="o">=</span> <span class="n">VEHICLE_BATTERY_WARNING_LOW</span><span class="p">;</span>
			<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">condition_battery_voltage_valid</span> <span class="o">&amp;&amp;</span> <span class="n">status</span><span class="p">.</span><span class="n">battery_remaining</span> <span class="o">&lt;</span> <span class="mf">0.09f</span>
			   <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">critical_battery_voltage_actions_done</span> <span class="o">&amp;&amp;</span> <span class="n">low_battery_voltage_actions_done</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* critical battery voltage, this is rather an emergency, change state machine */</span>
			<span class="n">critical_battery_voltage_actions_done</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">mavlink_log_emergency</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;CRITICAL BATTERY, LAND IMMEDIATELY&quot;</span><span class="p">);</span>
			<span class="n">status</span><span class="p">.</span><span class="n">battery_warning</span> <span class="o">=</span> <span class="n">VEHICLE_BATTERY_WARNING_CRITICAL</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">arming_ret</span> <span class="o">=</span> <span class="n">arming_state_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">safety</span><span class="p">,</span> <span class="n">ARMING_STATE_ARMED_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">armed</span><span class="p">,</span> <span class="nb">true</span> <span class="cm">/* fRunPreArmChecks */</span><span class="p">,</span>
								     <span class="n">mavlink_fd</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">arming_ret</span> <span class="o">==</span> <span class="n">TRANSITION_CHANGED</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">arming_state_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">arming_ret</span> <span class="o">=</span> <span class="n">arming_state_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">safety</span><span class="p">,</span> <span class="n">ARMING_STATE_STANDBY_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">armed</span><span class="p">,</span> <span class="nb">true</span> <span class="cm">/* fRunPreArmChecks */</span><span class="p">,</span>
								     <span class="n">mavlink_fd</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">arming_ret</span> <span class="o">==</span> <span class="n">TRANSITION_CHANGED</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">arming_state_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* End battery voltage check */</span>

		<span class="cm">/* If in INIT state, try to proceed to STANDBY state */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">arming_state</span> <span class="o">==</span> <span class="n">ARMING_STATE_INIT</span> <span class="o">&amp;&amp;</span> <span class="n">low_prio_task</span> <span class="o">==</span> <span class="n">LOW_PRIO_TASK_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* TODO: check for sensors */</span>
			<span class="n">arming_ret</span> <span class="o">=</span> <span class="n">arming_state_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">safety</span><span class="p">,</span> <span class="n">ARMING_STATE_STANDBY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">armed</span><span class="p">,</span> <span class="nb">true</span> <span class="cm">/* fRunPreArmChecks */</span><span class="p">,</span>
							     <span class="n">mavlink_fd</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">arming_ret</span> <span class="o">==</span> <span class="n">TRANSITION_CHANGED</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">arming_state_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* TODO: Add emergency stuff if sensors are lost */</span>
		<span class="p">}</span>


		<span class="cm">/*</span>
<span class="cm">		 * Check for valid position information.</span>
<span class="cm">		 *</span>
<span class="cm">		 * If the system has a valid position source from an onboard</span>
<span class="cm">		 * position estimator, it is safe to operate it autonomously.</span>
<span class="cm">		 * The flag_vector_flight_mode_ok flag indicates that a minimum</span>
<span class="cm">		 * set of position measurements is available.</span>
<span class="cm">		 */</span>

		<span class="n">orb_check</span><span class="p">(</span><span class="n">gps_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_gps_position</span><span class="p">),</span> <span class="n">gps_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gps_position</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Initialize map projection if gps is valid */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">map_projection_global_initialized</span><span class="p">()</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">gps_position</span><span class="p">.</span><span class="n">eph</span> <span class="o">&lt;</span> <span class="n">eph_threshold</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">gps_position</span><span class="p">.</span><span class="n">epv</span> <span class="o">&lt;</span> <span class="n">epv_threshold</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="n">hrt_elapsed_time</span><span class="p">((</span><span class="n">hrt_abstime</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">gps_position</span><span class="p">.</span><span class="n">timestamp_position</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e6</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* set reference for global coordinates &lt;--&gt; local coordiantes conversion and map_projection */</span>
			<span class="n">globallocalconverter_init</span><span class="p">((</span><span class="kt">double</span><span class="p">)</span><span class="n">gps_position</span><span class="p">.</span><span class="n">lat</span> <span class="o">*</span> <span class="mf">1.0e-7</span><span class="p">,</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">gps_position</span><span class="p">.</span><span class="n">lon</span> <span class="o">*</span> <span class="mf">1.0e-7</span><span class="p">,</span>
						  <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">gps_position</span><span class="p">.</span><span class="n">alt</span> <span class="o">*</span> <span class="mf">1.0e-3</span><span class="n">f</span><span class="p">,</span> <span class="n">hrt_absolute_time</span><span class="p">());</span>
		<span class="p">}</span>

		<span class="cm">/* check if GPS fix is ok */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">circuit_breaker_engaged_gpsfailure_check</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">gps_position</span><span class="p">.</span><span class="n">fix_type</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span>
		     <span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gps_position</span><span class="p">.</span><span class="n">timestamp_position</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">FAILSAFE_DEFAULT_TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* handle the case where gps was regained */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">gps_failure</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">.</span><span class="n">gps_failure</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;gps regained&quot;</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">gps_failure</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">.</span><span class="n">gps_failure</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;gps fix lost&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* start mission result check */</span>
		<span class="n">orb_check</span><span class="p">(</span><span class="n">mission_result_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">mission_result</span><span class="p">),</span> <span class="n">mission_result_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mission_result</span><span class="p">);</span>

			<span class="cm">/* Check for geofence violation */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mission_result</span><span class="p">.</span><span class="n">geofence_violated</span> <span class="o">||</span> <span class="n">mission_result</span><span class="p">.</span><span class="n">flight_termination</span><span class="p">))</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>XXX: make this configurable to select different actions (e.g. navigation modes)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>				<span class="cm">/* this will only trigger if geofence is activated via param and a geofence file is present, also there is a circuit breaker to disable the actual flight termination in the px4io driver */</span>
				<span class="n">armed</span><span class="p">.</span><span class="n">force_failsafe</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">static</span> <span class="kt">bool</span> <span class="n">flight_termination_printed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flight_termination_printed</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;Flight termination because of navigator request or geofence&quot;</span><span class="p">);</span>
					<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;GF violation: flight termination&quot;</span><span class="p">);</span>
					<span class="n">flight_termination_printed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">%</span> <span class="p">(</span><span class="mi">1000000</span> <span class="o">/</span> <span class="n">COMMANDER_MONITORING_INTERVAL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;GF violation: flight termination&quot;</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="c1">// no reset is done here on purpose, on geofence violation we want to stay in flighttermination</span>
		<span class="p">}</span>

		<span class="cm">/* RC input check */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">rc_input_blocked</span> <span class="o">&amp;&amp;</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">hrt_absolute_time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">+</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)(</span><span class="n">rc_loss_timeout</span> <span class="o">*</span> <span class="mf">1e6</span><span class="n">f</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* handle the case where RC signal was regained */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">rc_signal_found_once</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">.</span><span class="n">rc_signal_found_once</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;detected RC signal first time&quot;</span><span class="p">);</span>
				<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">rc_signal_lost</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;RC signal regained&quot;</span><span class="p">);</span>
					<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">status</span><span class="p">.</span><span class="n">rc_signal_lost</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="cm">/* check if left stick is in lower left position and we are in MANUAL or AUTO_READY mode or (ASSIST mode and landed) -&gt; disarm</span>
<span class="cm">			 * do it only for rotary wings */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">is_rotary_wing</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">arming_state</span> <span class="o">==</span> <span class="n">ARMING_STATE_ARMED</span> <span class="o">||</span> <span class="n">status</span><span class="p">.</span><span class="n">arming_state</span> <span class="o">==</span> <span class="n">ARMING_STATE_ARMED_ERROR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">main_state</span> <span class="o">==</span> <span class="n">MAIN_STATE_MANUAL</span> <span class="o">||</span> <span class="n">status</span><span class="p">.</span><span class="n">main_state</span> <span class="o">==</span> <span class="n">MAIN_STATE_ACRO</span> <span class="o">||</span> <span class="n">status</span><span class="p">.</span><span class="n">condition_landed</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">sp_man</span><span class="p">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">STICK_ON_OFF_LIMIT</span> <span class="o">&amp;&amp;</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">z</span> <span class="o">&lt;</span> <span class="mf">0.1f</span><span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">stick_off_counter</span> <span class="o">&gt;</span> <span class="n">STICK_ON_OFF_COUNTER_LIMIT</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* disarm to STANDBY if ARMED or to STANDBY_ERROR if ARMED_ERROR */</span>
					<span class="n">arming_state_t</span> <span class="n">new_arming_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">arming_state</span> <span class="o">==</span> <span class="n">ARMING_STATE_ARMED</span> <span class="o">?</span> <span class="nl">ARMING_STATE_STANDBY</span> <span class="p">:</span>
									   <span class="n">ARMING_STATE_STANDBY_ERROR</span><span class="p">);</span>
					<span class="n">arming_ret</span> <span class="o">=</span> <span class="n">arming_state_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">safety</span><span class="p">,</span> <span class="n">new_arming_state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">armed</span><span class="p">,</span> <span class="nb">true</span> <span class="cm">/* fRunPreArmChecks */</span><span class="p">,</span>
									     <span class="n">mavlink_fd</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">arming_ret</span> <span class="o">==</span> <span class="n">TRANSITION_CHANGED</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">arming_state_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="n">stick_off_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">stick_off_counter</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">stick_off_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* check if left stick is in lower right position and we&#39;re in MANUAL mode -&gt; arm */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">arming_state</span> <span class="o">==</span> <span class="n">ARMING_STATE_STANDBY</span> <span class="o">&amp;&amp;</span>
			    <span class="n">sp_man</span><span class="p">.</span><span class="n">r</span> <span class="o">&gt;</span> <span class="n">STICK_ON_OFF_LIMIT</span> <span class="o">&amp;&amp;</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">z</span> <span class="o">&lt;</span> <span class="mf">0.1f</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">stick_on_counter</span> <span class="o">&gt;</span> <span class="n">STICK_ON_OFF_COUNTER_LIMIT</span><span class="p">)</span> <span class="p">{</span>

					<span class="cm">/* we check outside of the transition function here because the requirement</span>
<span class="cm">					 * for being in manual mode only applies to manual arming actions.</span>
<span class="cm">					 * the system can be armed in auto if armed via the GCS.</span>
<span class="cm">					 */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">main_state</span> <span class="o">!=</span> <span class="n">MAIN_STATE_MANUAL</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">print_reject_arm</span><span class="p">(</span><span class="s">&quot;NOT ARMING: Switch to MANUAL mode first.&quot;</span><span class="p">);</span>

					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">arming_ret</span> <span class="o">=</span> <span class="n">arming_state_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">safety</span><span class="p">,</span> <span class="n">ARMING_STATE_ARMED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">armed</span><span class="p">,</span> <span class="nb">true</span> <span class="cm">/* fRunPreArmChecks */</span><span class="p">,</span>
										     <span class="n">mavlink_fd</span><span class="p">);</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">arming_ret</span> <span class="o">==</span> <span class="n">TRANSITION_CHANGED</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">arming_state_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>

					<span class="n">stick_on_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">stick_on_counter</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">stick_on_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">arming_ret</span> <span class="o">==</span> <span class="n">TRANSITION_CHANGED</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">arming_state</span> <span class="o">==</span> <span class="n">ARMING_STATE_ARMED</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mavlink_log_info</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;ARMED by RC&quot;</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">mavlink_log_info</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;DISARMED by RC&quot;</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">arming_state_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">arming_ret</span> <span class="o">==</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * the arming transition can be denied to a number of reasons:</span>
<span class="cm">				 *  - pre-flight check failed (sensors not ok or not calibrated)</span>
<span class="cm">				 *  - safety not disabled</span>
<span class="cm">				 *  - system not in manual mode</span>
<span class="cm">				 */</span>
				<span class="n">tune_negative</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* evaluate the main state machine according to mode switches */</span>
			<span class="n">transition_result_t</span> <span class="n">main_res</span> <span class="o">=</span> <span class="n">set_main_state_rc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp_man</span><span class="p">);</span>

			<span class="cm">/* play tune on mode change only if armed, blink LED always */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">main_res</span> <span class="o">==</span> <span class="n">TRANSITION_CHANGED</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tune_positive</span><span class="p">(</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span><span class="p">);</span>
				<span class="n">main_state_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">main_res</span> <span class="o">==</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* DENIED here indicates bug in the commander */</span>
				<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;main state transition denied&quot;</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">rc_signal_lost</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;RC SIGNAL LOST&quot;</span><span class="p">);</span>
				<span class="n">status</span><span class="p">.</span><span class="n">rc_signal_lost</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* data links check */</span>
		<span class="kt">bool</span> <span class="n">have_link</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TELEMETRY_STATUS_ORB_ID_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">telemetry_last_heartbeat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">telemetry_last_heartbeat</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">datalink_loss_timeout</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* handle the case where data link was regained,</span>
<span class="cm">				 * accept datalink as healthy only after datalink_regain_timeout seconds</span>
<span class="cm">				 * */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">telemetry_lost</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
				    <span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">telemetry_last_dl_loss</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">datalink_regain_timeout</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span> <span class="p">{</span>

					<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;data link %i regained&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
					<span class="n">telemetry_lost</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">have_link</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">telemetry_lost</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
					<span class="cm">/* telemetry was healthy also in last iteration</span>
<span class="cm">					 * we don&#39;t have to check a timeout */</span>
					<span class="n">have_link</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">telemetry_last_dl_loss</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">telemetry_lost</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;data link %i lost&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
					<span class="n">telemetry_lost</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">have_link</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* handle the case where data link was regained */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">data_link_lost</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">.</span><span class="n">data_link_lost</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">data_link_lost</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;ALL DATA LINKS LOST&quot;</span><span class="p">);</span>
				<span class="n">status</span><span class="p">.</span><span class="n">data_link_lost</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">status</span><span class="p">.</span><span class="n">data_link_lost_counter</span><span class="o">++</span><span class="p">;</span>
				<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Check engine failure</span>
<span class="cm">		 * only for fixed wing for now</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">circuit_breaker_engaged_enginefailure_check</span> <span class="o">&amp;&amp;</span>
		    <span class="n">status</span><span class="p">.</span><span class="n">is_rotary_wing</span> <span class="o">==</span> <span class="nb">false</span> <span class="o">&amp;&amp;</span>
		    <span class="n">armed</span><span class="p">.</span><span class="n">armed</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">actuator_controls</span><span class="p">.</span><span class="n">control</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ef_throttle_thres</span> <span class="o">&amp;&amp;</span>
		      <span class="n">battery</span><span class="p">.</span><span class="n">current_a</span> <span class="o">/</span> <span class="n">actuator_controls</span><span class="p">.</span><span class="n">control</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span>
		      <span class="n">ef_current2throttle_thres</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">engine_failure</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* potential failure, measure time */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">timestamp_engine_healthy</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timestamp_engine_healthy</span><span class="p">)</span> <span class="o">&gt;</span>
			    <span class="n">ef_time_thres</span> <span class="o">*</span> <span class="mf">1e6</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">engine_failure</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">.</span><span class="n">engine_failure</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;Engine Failure&quot;</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* no failure reset flag */</span>
			<span class="n">timestamp_engine_healthy</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">engine_failure</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span><span class="p">.</span><span class="n">engine_failure</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>


		<span class="cm">/* handle commands last, as the system needs to be updated to handle them */</span>
		<span class="n">orb_check</span><span class="p">(</span><span class="n">cmd_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* got command */</span>
			<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_command</span><span class="p">),</span> <span class="n">cmd_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

			<span class="cm">/* handle it */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">handle_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">safety</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">armed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">home</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">global_position</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">home_pub</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Check for failure combinations which lead to flight termination */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* At this point the data link and the gps system have been checked</span>
<span class="cm">			 * If  we are not in a manual (RC stick controlled mode)</span>
<span class="cm">			 * and both failed we want to terminate the flight */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">main_state</span> <span class="o">!=</span> <span class="n">MAIN_STATE_MANUAL</span> <span class="o">&amp;&amp;</span>
			    <span class="n">status</span><span class="p">.</span><span class="n">main_state</span> <span class="o">!=</span> <span class="n">MAIN_STATE_ACRO</span> <span class="o">&amp;&amp;</span>
			    <span class="n">status</span><span class="p">.</span><span class="n">main_state</span> <span class="o">!=</span> <span class="n">MAIN_STATE_ALTCTL</span> <span class="o">&amp;&amp;</span>
			    <span class="n">status</span><span class="p">.</span><span class="n">main_state</span> <span class="o">!=</span> <span class="n">MAIN_STATE_POSCTL</span> <span class="o">&amp;&amp;</span>
			    <span class="p">((</span><span class="n">status</span><span class="p">.</span><span class="n">data_link_lost</span> <span class="o">&amp;&amp;</span> <span class="n">status</span><span class="p">.</span><span class="n">gps_failure</span><span class="p">)</span> <span class="o">||</span>
			     <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">data_link_lost_cmd</span> <span class="o">&amp;&amp;</span> <span class="n">status</span><span class="p">.</span><span class="n">gps_failure_cmd</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">armed</span><span class="p">.</span><span class="n">force_failsafe</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">static</span> <span class="kt">bool</span> <span class="n">flight_termination_printed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flight_termination_printed</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;Flight termination because of data link loss &amp;&amp; gps failure&quot;</span><span class="p">);</span>
					<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;DL and GPS lost: flight termination&quot;</span><span class="p">);</span>
					<span class="n">flight_termination_printed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">%</span> <span class="p">(</span><span class="mi">1000000</span> <span class="o">/</span> <span class="n">COMMANDER_MONITORING_INTERVAL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;DL and GPS lost: flight termination&quot;</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="cm">/* At this point the rc signal and the gps system have been checked</span>
<span class="cm">			 * If we are in manual (controlled with RC):</span>
<span class="cm">			 * if both failed we want to terminate the flight */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">status</span><span class="p">.</span><span class="n">main_state</span> <span class="o">==</span> <span class="n">MAIN_STATE_ACRO</span> <span class="o">||</span>
			     <span class="n">status</span><span class="p">.</span><span class="n">main_state</span> <span class="o">==</span> <span class="n">MAIN_STATE_MANUAL</span> <span class="o">||</span>
			     <span class="n">status</span><span class="p">.</span><span class="n">main_state</span> <span class="o">==</span> <span class="n">MAIN_STATE_ALTCTL</span> <span class="o">||</span>
			     <span class="n">status</span><span class="p">.</span><span class="n">main_state</span> <span class="o">==</span> <span class="n">MAIN_STATE_POSCTL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">((</span><span class="n">status</span><span class="p">.</span><span class="n">rc_signal_lost</span> <span class="o">&amp;&amp;</span> <span class="n">status</span><span class="p">.</span><span class="n">gps_failure</span><span class="p">)</span> <span class="o">||</span>
			     <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">rc_signal_lost_cmd</span> <span class="o">&amp;&amp;</span> <span class="n">status</span><span class="p">.</span><span class="n">gps_failure_cmd</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">armed</span><span class="p">.</span><span class="n">force_failsafe</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">static</span> <span class="kt">bool</span> <span class="n">flight_termination_printed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flight_termination_printed</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;Flight termination because of RC signal loss &amp;&amp; gps failure&quot;</span><span class="p">);</span>
					<span class="n">flight_termination_printed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">%</span> <span class="p">(</span><span class="mi">1000000</span> <span class="o">/</span> <span class="n">COMMANDER_MONITORING_INTERVAL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;RC and GPS lost: flight termination&quot;</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>


		<span class="n">hrt_abstime</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>

		<span class="cm">/* print new state */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arming_state_changed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">mavlink_log_info</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;[cmd] arming state: %s&quot;</span><span class="p">,</span> <span class="n">arming_states_str</span><span class="p">[</span><span class="n">status</span><span class="p">.</span><span class="n">arming_state</span><span class="p">]);</span>

			<span class="cm">/* update home position on arming if at least 2s from commander start spent to avoid setting home on in-air restart */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">was_armed</span> <span class="o">&amp;&amp;</span> <span class="n">hrt_absolute_time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">start_time</span> <span class="o">+</span> <span class="mi">2000000</span> <span class="o">&amp;&amp;</span> <span class="n">status</span><span class="p">.</span><span class="n">condition_global_position_valid</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">global_position</span><span class="p">.</span><span class="n">eph</span> <span class="o">&lt;</span> <span class="n">eph_threshold</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">global_position</span><span class="p">.</span><span class="n">epv</span> <span class="o">&lt;</span> <span class="n">epv_threshold</span><span class="p">))</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>TODO remove code duplication</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>				<span class="n">home</span><span class="p">.</span><span class="n">lat</span> <span class="o">=</span> <span class="n">global_position</span><span class="p">.</span><span class="n">lat</span><span class="p">;</span>
				<span class="n">home</span><span class="p">.</span><span class="n">lon</span> <span class="o">=</span> <span class="n">global_position</span><span class="p">.</span><span class="n">lon</span><span class="p">;</span>
				<span class="n">home</span><span class="p">.</span><span class="n">alt</span> <span class="o">=</span> <span class="n">global_position</span><span class="p">.</span><span class="n">alt</span><span class="p">;</span>

				<span class="n">home</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">local_position</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
				<span class="n">home</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">local_position</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
				<span class="n">home</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">local_position</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>

				<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;home: lat = %.7f, lon = %.7f, alt = %.2f &quot;</span><span class="p">,</span> <span class="n">home</span><span class="p">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">home</span><span class="p">.</span><span class="n">lon</span><span class="p">,</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">home</span><span class="p">.</span><span class="n">alt</span><span class="p">);</span>
				<span class="n">mavlink_log_info</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;home: %.7f, %.7f, %.2f&quot;</span><span class="p">,</span> <span class="n">home</span><span class="p">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">home</span><span class="p">.</span><span class="n">lon</span><span class="p">,</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">home</span><span class="p">.</span><span class="n">alt</span><span class="p">);</span>

				<span class="cm">/* announce new home position */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">home_pub</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">orb_publish</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">home_position</span><span class="p">),</span> <span class="n">home_pub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">home</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">home_pub</span> <span class="o">=</span> <span class="n">orb_advertise</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">home_position</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">home</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="cm">/* mark home position as set */</span>
				<span class="n">status</span><span class="p">.</span><span class="n">condition_home_position_valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">arming_state_changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">was_armed</span> <span class="o">=</span> <span class="n">armed</span><span class="p">.</span><span class="n">armed</span><span class="p">;</span>

		<span class="cm">/* now set navigation state according to failsafe and main state */</span>
		<span class="kt">bool</span> <span class="n">nav_state_changed</span> <span class="o">=</span> <span class="n">set_nav_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span><span class="n">datalink_loss_enabled</span><span class="p">,</span>
						       <span class="n">mission_result</span><span class="p">.</span><span class="n">finished</span><span class="p">,</span>
						       <span class="n">mission_result</span><span class="p">.</span><span class="n">stay_in_failsafe</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>TODO handle mode changes by commands</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">main_state_changed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;main state: %s&quot;</span><span class="p">,</span> <span class="n">main_states_str</span><span class="p">[</span><span class="n">status</span><span class="p">.</span><span class="n">main_state</span><span class="p">]);</span>
			<span class="n">mavlink_log_info</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;[cmd] main state: %s&quot;</span><span class="p">,</span> <span class="n">main_states_str</span><span class="p">[</span><span class="n">status</span><span class="p">.</span><span class="n">main_state</span><span class="p">]);</span>
			<span class="n">main_state_changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">failsafe</span> <span class="o">!=</span> <span class="n">failsafe_old</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">mavlink_log_info</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;[cmd] failsafe state: %i&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">.</span><span class="n">failsafe</span><span class="p">);</span>
			<span class="n">failsafe_old</span> <span class="o">=</span> <span class="n">status</span><span class="p">.</span><span class="n">failsafe</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nav_state_changed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;nav state: %s&quot;</span><span class="p">,</span> <span class="n">nav_states_str</span><span class="p">[</span><span class="n">status</span><span class="p">.</span><span class="n">nav_state</span><span class="p">]);</span>
			<span class="n">mavlink_log_info</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;[cmd] nav state: %s&quot;</span><span class="p">,</span> <span class="n">nav_states_str</span><span class="p">[</span><span class="n">status</span><span class="p">.</span><span class="n">nav_state</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="cm">/* publish states (armed, control mode, vehicle status) at least with 5 Hz */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">%</span> <span class="p">(</span><span class="mi">200000</span> <span class="o">/</span> <span class="n">COMMANDER_MONITORING_INTERVAL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">status_changed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_control_mode</span><span class="p">();</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">t1</span><span class="p">;</span>
			<span class="n">orb_publish</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_control_mode</span><span class="p">),</span> <span class="n">control_mode_pub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control_mode</span><span class="p">);</span>

			<span class="n">status</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">t1</span><span class="p">;</span>
			<span class="n">orb_publish</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_status</span><span class="p">),</span> <span class="n">status_pub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>

			<span class="n">armed</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">t1</span><span class="p">;</span>
			<span class="n">orb_publish</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">actuator_armed</span><span class="p">),</span> <span class="n">armed_pub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">armed</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* play arming and battery warning tunes */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arm_tune_played</span> <span class="o">&amp;&amp;</span> <span class="n">armed</span><span class="p">.</span><span class="n">armed</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">safety</span><span class="p">.</span><span class="n">safety_switch_available</span> <span class="o">||</span> <span class="p">(</span><span class="n">safety</span><span class="p">.</span><span class="n">safety_switch_available</span>
							<span class="o">&amp;&amp;</span> <span class="n">safety</span><span class="p">.</span><span class="n">safety_off</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* play tune when armed */</span>
			<span class="n">set_tune</span><span class="p">(</span><span class="n">TONE_ARMING_WARNING_TUNE</span><span class="p">);</span>
			<span class="n">arm_tune_played</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">battery_warning</span> <span class="o">==</span> <span class="n">VEHICLE_BATTERY_WARNING_CRITICAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* play tune on battery critical */</span>
			<span class="n">set_tune</span><span class="p">(</span><span class="n">TONE_BATTERY_WARNING_FAST_TUNE</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">battery_warning</span> <span class="o">==</span> <span class="n">VEHICLE_BATTERY_WARNING_LOW</span> <span class="o">||</span> <span class="n">status</span><span class="p">.</span><span class="n">failsafe</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* play tune on battery warning or failsafe */</span>
			<span class="n">set_tune</span><span class="p">(</span><span class="n">TONE_BATTERY_WARNING_SLOW_TUNE</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_tune</span><span class="p">(</span><span class="n">TONE_STOP_TUNE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* reset arm_tune_played when disarmed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span> <span class="o">||</span> <span class="p">(</span><span class="n">safety</span><span class="p">.</span><span class="n">safety_switch_available</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">safety</span><span class="p">.</span><span class="n">safety_off</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">arm_tune_played</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
		<span class="n">counter</span><span class="o">++</span><span class="p">;</span>

		<span class="kt">int</span> <span class="n">blink_state</span> <span class="o">=</span> <span class="n">blink_msg_state</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">blink_state</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* blinking LED message, don&#39;t touch LEDs */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">blink_state</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* blinking LED message completed, restore normal state */</span>
				<span class="n">control_status_leds</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">armed</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* normal state */</span>
			<span class="n">control_status_leds</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">armed</span><span class="p">,</span> <span class="n">status_changed</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">usleep</span><span class="p">(</span><span class="n">COMMANDER_MONITORING_INTERVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* wait for threads to complete */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pthread_join</span><span class="p">(</span><span class="n">commander_low_prio_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">warn</span><span class="p">(</span><span class="s">&quot;join failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rgbled_set_mode</span><span class="p">(</span><span class="n">RGBLED_MODE_OFF</span><span class="p">);</span>

	<span class="cm">/* close fds */</span>
	<span class="n">led_deinit</span><span class="p">();</span>
	<span class="n">buzzer_deinit</span><span class="p">();</span>
	<span class="n">close</span><span class="p">(</span><span class="n">sp_man_sub</span><span class="p">);</span>
	<span class="n">close</span><span class="p">(</span><span class="n">sp_offboard_sub</span><span class="p">);</span>
	<span class="n">close</span><span class="p">(</span><span class="n">local_position_sub</span><span class="p">);</span>
	<span class="n">close</span><span class="p">(</span><span class="n">global_position_sub</span><span class="p">);</span>
	<span class="n">close</span><span class="p">(</span><span class="n">gps_sub</span><span class="p">);</span>
	<span class="n">close</span><span class="p">(</span><span class="n">sensor_sub</span><span class="p">);</span>
	<span class="n">close</span><span class="p">(</span><span class="n">safety_sub</span><span class="p">);</span>
	<span class="n">close</span><span class="p">(</span><span class="n">cmd_sub</span><span class="p">);</span>
	<span class="n">close</span><span class="p">(</span><span class="n">subsys_sub</span><span class="p">);</span>
	<span class="n">close</span><span class="p">(</span><span class="n">diff_pres_sub</span><span class="p">);</span>
	<span class="n">close</span><span class="p">(</span><span class="n">param_changed_sub</span><span class="p">);</span>
	<span class="n">close</span><span class="p">(</span><span class="n">battery_sub</span><span class="p">);</span>
	<span class="n">close</span><span class="p">(</span><span class="n">mission_pub</span><span class="p">);</span>

	<span class="n">thread_running</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">check_valid</span><span class="p">(</span><span class="n">hrt_abstime</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">hrt_abstime</span> <span class="n">timeout</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">valid_in</span><span class="p">,</span> <span class="kt">bool</span> <span class="o">*</span><span class="n">valid_out</span><span class="p">,</span> <span class="kt">bool</span> <span class="o">*</span><span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hrt_abstime</span> <span class="n">t</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>
	<span class="kt">bool</span> <span class="n">valid_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="n">timestamp</span> <span class="o">+</span> <span class="n">timeout</span> <span class="o">&amp;&amp;</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">timeout</span> <span class="o">&amp;&amp;</span> <span class="n">valid_in</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">valid_out</span> <span class="o">!=</span> <span class="n">valid_new</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">valid_out</span> <span class="o">=</span> <span class="n">valid_new</span><span class="p">;</span>
		<span class="o">*</span><span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">control_status_leds</span><span class="p">(</span><span class="n">vehicle_status_s</span> <span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="k">const</span> <span class="n">actuator_armed_s</span> <span class="o">*</span><span class="n">actuator_armed</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* driving rgbled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">bool</span> <span class="n">set_normal_color</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="cm">/* set mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status_local</span><span class="o">-&gt;</span><span class="n">arming_state</span> <span class="o">==</span> <span class="n">ARMING_STATE_ARMED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rgbled_set_mode</span><span class="p">(</span><span class="n">RGBLED_MODE_ON</span><span class="p">);</span>
			<span class="n">set_normal_color</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status_local</span><span class="o">-&gt;</span><span class="n">arming_state</span> <span class="o">==</span> <span class="n">ARMING_STATE_ARMED_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rgbled_set_mode</span><span class="p">(</span><span class="n">RGBLED_MODE_BLINK_FAST</span><span class="p">);</span>
			<span class="n">rgbled_set_color</span><span class="p">(</span><span class="n">RGBLED_COLOR_RED</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status_local</span><span class="o">-&gt;</span><span class="n">arming_state</span> <span class="o">==</span> <span class="n">ARMING_STATE_STANDBY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rgbled_set_mode</span><span class="p">(</span><span class="n">RGBLED_MODE_BREATHE</span><span class="p">);</span>
			<span class="n">set_normal_color</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="c1">// STANDBY_ERROR and other states</span>
			<span class="n">rgbled_set_mode</span><span class="p">(</span><span class="n">RGBLED_MODE_BLINK_NORMAL</span><span class="p">);</span>
			<span class="n">rgbled_set_color</span><span class="p">(</span><span class="n">RGBLED_COLOR_RED</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">set_normal_color</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* set color */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status_local</span><span class="o">-&gt;</span><span class="n">battery_warning</span> <span class="o">==</span> <span class="n">VEHICLE_BATTERY_WARNING_LOW</span> <span class="o">||</span> <span class="n">status_local</span><span class="o">-&gt;</span><span class="n">failsafe</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rgbled_set_color</span><span class="p">(</span><span class="n">RGBLED_COLOR_AMBER</span><span class="p">);</span>
				<span class="cm">/* VEHICLE_BATTERY_WARNING_CRITICAL handled as ARMING_STATE_ARMED_ERROR / ARMING_STATE_STANDBY_ERROR */</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status_local</span><span class="o">-&gt;</span><span class="n">condition_local_position_valid</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rgbled_set_color</span><span class="p">(</span><span class="n">RGBLED_COLOR_GREEN</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">rgbled_set_color</span><span class="p">(</span><span class="n">RGBLED_COLOR_BLUE</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_ARCH_BOARD_PX4FMU_V1</span>

	<span class="cm">/* this runs at around 20Hz, full cycle is 16 ticks = 10/16Hz */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">actuator_armed</span><span class="o">-&gt;</span><span class="n">armed</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* armed, solid */</span>
		<span class="n">led_on</span><span class="p">(</span><span class="n">LED_BLUE</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">actuator_armed</span><span class="o">-&gt;</span><span class="n">ready_to_arm</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ready to arm, blink at 1Hz */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">leds_counter</span> <span class="o">%</span> <span class="mi">20</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">led_toggle</span><span class="p">(</span><span class="n">LED_BLUE</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* not ready to arm, blink at 10Hz */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">leds_counter</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">led_toggle</span><span class="p">(</span><span class="n">LED_BLUE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#endif</span>

	<span class="cm">/* give system warnings on error LED, XXX maybe add memory usage warning too */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status_local</span><span class="o">-&gt;</span><span class="n">load</span> <span class="o">&gt;</span> <span class="mf">0.95f</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">leds_counter</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">led_toggle</span><span class="p">(</span><span class="n">LED_AMBER</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">led_off</span><span class="p">(</span><span class="n">LED_AMBER</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">leds_counter</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">transition_result_t</span>
<span class="nf">set_main_state_rc</span><span class="p">(</span><span class="k">struct</span> <span class="n">vehicle_status_s</span> <span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">manual_control_setpoint_s</span> <span class="o">*</span><span class="n">sp_man</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* set main state according to RC switches */</span>
	<span class="n">transition_result_t</span> <span class="n">res</span> <span class="o">=</span> <span class="n">TRANSITION_DENIED</span><span class="p">;</span>

	<span class="cm">/* if offboard is set allready by a mavlink command, abort */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">offboard_control_set_by_command</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">MAIN_STATE_OFFBOARD</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* offboard switch overrides main switch */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp_man</span><span class="o">-&gt;</span><span class="n">offboard_switch</span> <span class="o">==</span> <span class="n">SWITCH_POS_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">MAIN_STATE_OFFBOARD</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">print_reject_mode</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="s">&quot;OFFBOARD&quot;</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* offboard switched off or denied, check main mode switch */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sp_man</span><span class="o">-&gt;</span><span class="n">mode_switch</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="nl">SWITCH_POS_NONE</span><span class="p">:</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">TRANSITION_NOT_CHANGED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="nl">SWITCH_POS_OFF</span><span class="p">:</span>		<span class="c1">// MANUAL</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sp_man</span><span class="o">-&gt;</span><span class="n">acro_switch</span> <span class="o">==</span> <span class="n">SWITCH_POS_ON</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">MAIN_STATE_ACRO</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">MAIN_STATE_MANUAL</span><span class="p">);</span>
		<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>TRANSITION_DENIED is not possible here</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="nl">SWITCH_POS_MIDDLE</span><span class="p">:</span>		<span class="c1">// ASSIST</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sp_man</span><span class="o">-&gt;</span><span class="n">posctl_switch</span> <span class="o">==</span> <span class="n">SWITCH_POS_ON</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">MAIN_STATE_POSCTL</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// changed successfully or already in this state</span>
			<span class="p">}</span>

			<span class="n">print_reject_mode</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="s">&quot;POSCTL&quot;</span><span class="p">);</span>
		<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>fallback to ALTCTL</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">MAIN_STATE_ALTCTL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>	<span class="c1">// changed successfully or already in this mode</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sp_man</span><span class="o">-&gt;</span><span class="n">posctl_switch</span> <span class="o">!=</span> <span class="n">SWITCH_POS_ON</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">print_reject_mode</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="s">&quot;ALTCTL&quot;</span><span class="p">);</span>
		<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <p>fallback to MANUAL</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">MAIN_STATE_MANUAL</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>TRANSITION_DENIED is not possible here</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="nl">SWITCH_POS_ON</span><span class="p">:</span>			<span class="c1">// AUTO</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sp_man</span><span class="o">-&gt;</span><span class="n">return_switch</span> <span class="o">==</span> <span class="n">SWITCH_POS_ON</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">MAIN_STATE_AUTO_RTL</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// changed successfully or already in this state</span>
			<span class="p">}</span>

			<span class="n">print_reject_mode</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="s">&quot;AUTO_RTL&quot;</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>fallback to LOITER if home position not set</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">MAIN_STATE_AUTO_LOITER</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>  <span class="c1">// changed successfully or already in this state</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sp_man</span><span class="o">-&gt;</span><span class="n">loiter_switch</span> <span class="o">==</span> <span class="n">SWITCH_POS_ON</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">MAIN_STATE_AUTO_LOITER</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// changed successfully or already in this state</span>
			<span class="p">}</span>

			<span class="n">print_reject_mode</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="s">&quot;AUTO_LOITER&quot;</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">MAIN_STATE_AUTO_MISSION</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// changed successfully or already in this state</span>
			<span class="p">}</span>

			<span class="n">print_reject_mode</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="s">&quot;AUTO_MISSION&quot;</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <p>fallback to LOITER if home position not set</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">MAIN_STATE_AUTO_LOITER</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>  <span class="c1">// changed successfully or already in this state</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>fallback to POSCTL</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">MAIN_STATE_POSCTL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>  <span class="c1">// changed successfully or already in this state</span>
		<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p>fallback to ALTCTL</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">MAIN_STATE_ALTCTL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>	<span class="c1">// changed successfully or already in this state</span>
		<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <p>fallback to MANUAL</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">MAIN_STATE_MANUAL</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>TRANSITION_DENIED is not possible here</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="k">break</span><span class="p">;</span>

	<span class="k">default</span><span class="o">:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">set_control_mode</span><span class="p">()</span>
<span class="p">{</span>
	<span class="cm">/* set vehicle_control_mode according to set_navigation_state */</span>
	<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_armed</span> <span class="o">=</span> <span class="n">armed</span><span class="p">.</span><span class="n">armed</span><span class="p">;</span>
	<span class="cm">/* TODO: check this */</span>
	<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_external_manual_override_ok</span> <span class="o">=</span> <span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">is_rotary_wing</span><span class="p">;</span>
	<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_system_hil_enabled</span> <span class="o">=</span> <span class="n">status</span><span class="p">.</span><span class="n">hil_state</span> <span class="o">==</span> <span class="n">HIL_STATE_ON</span><span class="p">;</span>
	<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_offboard_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">nav_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="nl">NAVIGATION_STATE_MANUAL</span><span class="p">:</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_manual_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_auto_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rates_enabled</span> <span class="o">=</span> <span class="n">status</span><span class="p">.</span><span class="n">is_rotary_wing</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_attitude_enabled</span> <span class="o">=</span> <span class="n">status</span><span class="p">.</span><span class="n">is_rotary_wing</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_altitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_climb_rate_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_position_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_velocity_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_termination_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="nl">NAVIGATION_STATE_ACRO</span><span class="p">:</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_manual_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_auto_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rates_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_attitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_altitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_climb_rate_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_position_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_velocity_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_termination_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="nl">NAVIGATION_STATE_ALTCTL</span><span class="p">:</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_manual_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_auto_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rates_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_attitude_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_altitude_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_climb_rate_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_position_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_velocity_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_termination_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="nl">NAVIGATION_STATE_OFFBOARD</span><span class="p">:</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_manual_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_auto_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_offboard_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">sp_offboard</span><span class="p">.</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nl">OFFBOARD_CONTROL_MODE_DIRECT_RATES</span><span class="p">:</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rates_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_attitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_altitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_climb_rate_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_position_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_velocity_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="nl">OFFBOARD_CONTROL_MODE_DIRECT_ATTITUDE</span><span class="p">:</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rates_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_attitude_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_altitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_climb_rate_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_position_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_velocity_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="nl">OFFBOARD_CONTROL_MODE_DIRECT_FORCE</span><span class="p">:</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rates_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_attitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_force_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_altitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_climb_rate_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_position_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_velocity_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="nl">OFFBOARD_CONTROL_MODE_DIRECT_LOCAL_NED</span><span class="p">:</span>
		<span class="k">case</span> <span class="nl">OFFBOARD_CONTROL_MODE_DIRECT_LOCAL_OFFSET_NED</span><span class="p">:</span>
		<span class="k">case</span> <span class="nl">OFFBOARD_CONTROL_MODE_DIRECT_BODY_NED</span><span class="p">:</span>
		<span class="k">case</span> <span class="nl">OFFBOARD_CONTROL_MODE_DIRECT_BODY_OFFSET_NED</span><span class="p">:</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rates_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_attitude_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_altitude_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_climb_rate_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_position_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_velocity_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <p>XXX: the flags could depend on sp_offboard.ignore</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="k">break</span><span class="p">;</span>

		<span class="k">default</span><span class="o">:</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rates_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_attitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_altitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_climb_rate_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_position_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_velocity_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="nl">NAVIGATION_STATE_POSCTL</span><span class="p">:</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_manual_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_auto_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rates_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_attitude_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_altitude_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_climb_rate_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_position_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_velocity_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_termination_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="nl">NAVIGATION_STATE_AUTO_MISSION</span><span class="p">:</span>
	<span class="k">case</span> <span class="nl">NAVIGATION_STATE_AUTO_LOITER</span><span class="p">:</span>
	<span class="k">case</span> <span class="nl">NAVIGATION_STATE_AUTO_RTL</span><span class="p">:</span>
	<span class="k">case</span> <span class="nl">NAVIGATION_STATE_AUTO_RTGS</span><span class="p">:</span>
	<span class="k">case</span> <span class="nl">NAVIGATION_STATE_AUTO_LANDENGFAIL</span><span class="p">:</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_manual_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_auto_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rates_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_attitude_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_altitude_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_climb_rate_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_position_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_velocity_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_termination_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="nl">NAVIGATION_STATE_AUTO_LANDGPSFAIL</span><span class="p">:</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_manual_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_auto_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rates_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_attitude_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_altitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_climb_rate_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_position_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_velocity_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_termination_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="nl">NAVIGATION_STATE_LAND</span><span class="p">:</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_manual_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_auto_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rates_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_attitude_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="cm">/* in failsafe LAND mode position may be not available */</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_position_enabled</span> <span class="o">=</span> <span class="n">status</span><span class="p">.</span><span class="n">condition_local_position_valid</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_velocity_enabled</span> <span class="o">=</span> <span class="n">status</span><span class="p">.</span><span class="n">condition_local_position_valid</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_altitude_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_climb_rate_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_termination_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="nl">NAVIGATION_STATE_TERMINATION</span><span class="p">:</span>
		<span class="cm">/* disable all controllers on termination */</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_manual_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_auto_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rates_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_attitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_position_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_velocity_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_altitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_climb_rate_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_termination_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">default</span><span class="o">:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">print_reject_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">vehicle_status_s</span> <span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hrt_abstime</span> <span class="n">t</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">last_print_mode_reject_time</span> <span class="o">&gt;</span> <span class="n">PRINT_MODE_REJECT_INTERVAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">last_print_mode_reject_time</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
		<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;REJECT %s&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

		<span class="cm">/* only buzz if armed, because else we&#39;re driving people nuts indoors</span>
<span class="cm">		they really need to look at the leds as well. */</span>
		<span class="n">tune_negative</span><span class="p">(</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">print_reject_arm</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hrt_abstime</span> <span class="n">t</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">last_print_mode_reject_time</span> <span class="o">&gt;</span> <span class="n">PRINT_MODE_REJECT_INTERVAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">last_print_mode_reject_time</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
		<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="n">tune_negative</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">answer_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">vehicle_command_s</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="k">enum</span> <span class="n">VEHICLE_CMD_RESULT</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="nl">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">:</span>
		<span class="n">tune_positive</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="nl">VEHICLE_CMD_RESULT_DENIED</span><span class="p">:</span>
		<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;command denied: %u&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">command</span><span class="p">);</span>
		<span class="n">tune_negative</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="nl">VEHICLE_CMD_RESULT_FAILED</span><span class="p">:</span>
		<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;command failed: %u&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">command</span><span class="p">);</span>
		<span class="n">tune_negative</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="nl">VEHICLE_CMD_RESULT_TEMPORARILY_REJECTED</span><span class="p">:</span>
		<span class="cm">/* this needs additional hints to the user - so let other messages pass and be spoken */</span>
		<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;command temporarily rejected: %u&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">command</span><span class="p">);</span>
		<span class="n">tune_negative</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="nl">VEHICLE_CMD_RESULT_UNSUPPORTED</span><span class="p">:</span>
		<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;command unsupported: %u&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">command</span><span class="p">);</span>
		<span class="n">tune_negative</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">default</span><span class="o">:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">commander_low_prio_loop</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Set thread name */</span>
	<span class="n">prctl</span><span class="p">(</span><span class="n">PR_SET_NAME</span><span class="p">,</span> <span class="s">&quot;commander_low_prio&quot;</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>

	<span class="cm">/* Subscribe to command topic */</span>
	<span class="kt">int</span> <span class="n">cmd_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_command</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">vehicle_command_s</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>

	<span class="cm">/* wakeup source(s) */</span>
	<span class="k">struct</span> <span class="n">pollfd</span> <span class="n">fds</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="cm">/* use the gyro to pace output - XXX BROKEN if we are using the L3GD20 */</span>
	<span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fd</span> <span class="o">=</span> <span class="n">cmd_sub</span><span class="p">;</span>
	<span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">events</span> <span class="o">=</span> <span class="n">POLLIN</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">thread_should_exit</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* wait for up to 200ms for data */</span>
		<span class="kt">int</span> <span class="n">pret</span> <span class="o">=</span> <span class="n">poll</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">fds</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="mi">200</span><span class="p">);</span>

		<span class="cm">/* timed out - periodic check for thread_should_exit, etc. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* this is undesirable but not much we can do - might want to flag unhappy status */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">warn</span><span class="p">(</span><span class="s">&quot;poll error %d, %d&quot;</span><span class="p">,</span> <span class="n">pret</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* if we reach here, we have a valid command */</span>
		<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_command</span><span class="p">),</span> <span class="n">cmd_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

		<span class="cm">/* ignore commands the high-prio loop handles */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">==</span> <span class="n">VEHICLE_CMD_DO_SET_MODE</span> <span class="o">||</span>
		    <span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">==</span> <span class="n">VEHICLE_CMD_COMPONENT_ARM_DISARM</span> <span class="o">||</span>
		    <span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">==</span> <span class="n">VEHICLE_CMD_NAV_TAKEOFF</span> <span class="o">||</span>
		    <span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">==</span> <span class="n">VEHICLE_CMD_DO_SET_SERVO</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* only handle low-priority commands here */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">case</span> <span class="nl">VEHICLE_CMD_PREFLIGHT_REBOOT_SHUTDOWN</span><span class="p">:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_safe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">safety</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">armed</span><span class="p">))</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">);</span>
					<span class="n">usleep</span><span class="p">(</span><span class="mi">100000</span><span class="p">);</span>
					<span class="cm">/* reboot */</span>
					<span class="n">systemreset</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">);</span>
					<span class="n">usleep</span><span class="p">(</span><span class="mi">100000</span><span class="p">);</span>
					<span class="cm">/* reboot to bootloader */</span>
					<span class="n">systemreset</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">VEHICLE_CMD_RESULT_DENIED</span><span class="p">);</span>
				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">VEHICLE_CMD_RESULT_DENIED</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="nl">VEHICLE_CMD_PREFLIGHT_CALIBRATION</span><span class="p">:</span> <span class="p">{</span>

				<span class="kt">int</span> <span class="n">calib_ret</span> <span class="o">=</span> <span class="n">ERROR</span><span class="p">;</span>

				<span class="cm">/* try to go to INIT/PREFLIGHT arming state */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">TRANSITION_DENIED</span> <span class="o">==</span> <span class="n">arming_state_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">safety</span><span class="p">,</span> <span class="n">ARMING_STATE_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">armed</span><span class="p">,</span>
						<span class="nb">true</span> <span class="cm">/* fRunPreArmChecks */</span><span class="p">,</span> <span class="n">mavlink_fd</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">VEHICLE_CMD_RESULT_DENIED</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* gyro calibration */</span>
					<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">);</span>
					<span class="n">calib_ret</span> <span class="o">=</span> <span class="n">do_gyro_calibration</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* magnetometer calibration */</span>
					<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">);</span>
					<span class="n">calib_ret</span> <span class="o">=</span> <span class="n">do_mag_calibration</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* zero-altitude pressure calibration */</span>
					<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">VEHICLE_CMD_RESULT_DENIED</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* RC calibration */</span>
					<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">);</span>
					<span class="cm">/* disable RC control input completely */</span>
					<span class="n">status</span><span class="p">.</span><span class="n">rc_input_blocked</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">calib_ret</span> <span class="o">=</span> <span class="n">OK</span><span class="p">;</span>
					<span class="n">mavlink_log_info</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;CAL: Disabling RC IN&quot;</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* RC trim calibration */</span>
					<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">);</span>
					<span class="n">calib_ret</span> <span class="o">=</span> <span class="n">do_trim_calibration</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* accelerometer calibration */</span>
					<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">);</span>
					<span class="n">calib_ret</span> <span class="o">=</span> <span class="n">do_accel_calibration</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* airspeed calibration */</span>
					<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">);</span>
					<span class="n">calib_ret</span> <span class="o">=</span> <span class="n">do_airspeed_calibration</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* RC calibration ended - have we been in one worth confirming? */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">rc_input_blocked</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">);</span>
						<span class="cm">/* enable RC control input */</span>
						<span class="n">status</span><span class="p">.</span><span class="n">rc_input_blocked</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
						<span class="n">mavlink_log_info</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;CAL: Re-enabling RC IN&quot;</span><span class="p">);</span>
					<span class="p">}</span>

					<span class="cm">/* this always succeeds */</span>
					<span class="n">calib_ret</span> <span class="o">=</span> <span class="n">OK</span><span class="p">;</span>

				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">calib_ret</span> <span class="o">==</span> <span class="n">OK</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">tune_positive</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">tune_negative</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">arming_state_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">safety</span><span class="p">,</span> <span class="n">ARMING_STATE_STANDBY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">armed</span><span class="p">,</span> <span class="nb">true</span> <span class="cm">/* fRunPreArmChecks */</span><span class="p">,</span> <span class="n">mavlink_fd</span><span class="p">);</span>

				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="k">case</span> <span class="nl">VEHICLE_CMD_PREFLIGHT_STORAGE</span><span class="p">:</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">param_load_default</span><span class="p">();</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">OK</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">mavlink_log_info</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;[cmd] parameters loaded&quot;</span><span class="p">);</span>
						<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">);</span>

					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;#audio: parameters load ERROR&quot;</span><span class="p">);</span>

						<span class="cm">/* convenience as many parts of NuttX use negative errno */</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ret</span><span class="p">;</span>
						<span class="p">}</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;#audio: %s&quot;</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
						<span class="p">}</span>

						<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">VEHICLE_CMD_RESULT_FAILED</span><span class="p">);</span>
					<span class="p">}</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">param_save_default</span><span class="p">();</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">OK</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">mavlink_log_info</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;[cmd] parameters saved&quot;</span><span class="p">);</span>
						<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">);</span>

					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;#audio: parameters save error&quot;</span><span class="p">);</span>

						<span class="cm">/* convenience as many parts of NuttX use negative errno */</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ret</span><span class="p">;</span>
						<span class="p">}</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="n">mavlink_fd</span><span class="p">,</span> <span class="s">&quot;#audio: %s&quot;</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
						<span class="p">}</span>

						<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">VEHICLE_CMD_RESULT_FAILED</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="k">case</span> <span class="nl">VEHICLE_CMD_START_RX_PAIR</span><span class="p">:</span>
			<span class="cm">/* handled in the IO driver */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">default</span><span class="o">:</span>
			<span class="cm">/* don&#39;t answer on unsupported commands, it will be done in main loop */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* send any requested ACKs */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">confirmation</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">!=</span> <span class="n">VEHICLE_CMD_DO_SET_MODE</span>
		    <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">!=</span> <span class="n">VEHICLE_CMD_COMPONENT_ARM_DISARM</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* send acknowledge command */</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>XXX TODO</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">close</span><span class="p">(</span><span class="n">cmd_sub</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
