<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>commander.cpp</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>commander.cpp</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span><span class="cm">/****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *   Copyright (c) 2013-2018 PX4 Development Team. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> *</span>
<span class="cm"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="cm"> *    notice, this list of conditions and the following disclaimer.</span>
<span class="cm"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<span class="cm"> *    notice, this list of conditions and the following disclaimer in</span>
<span class="cm"> *    the documentation and/or other materials provided with the</span>
<span class="cm"> *    distribution.</span>
<span class="cm"> * 3. Neither the name PX4 nor the names of its contributors may be</span>
<span class="cm"> *    used to endorse or promote products derived from this software</span>
<span class="cm"> *    without specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="cm"> * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="cm"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</span>
<span class="cm"> * FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE</span>
<span class="cm"> * COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<span class="cm"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</span>
<span class="cm"> * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</span>
<span class="cm"> * OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</span>
<span class="cm"> * AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
<span class="cm"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN</span>
<span class="cm"> * ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<span class="cm"> * POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> *</span>
<span class="cm"> ****************************************************************************/</span>

<span class="cm">/**</span>
<span class="cm"> * @file commander.cpp</span>
<span class="cm"> *</span>
<span class="cm"> * Main state machine / business logic</span>
<span class="cm"> *</span>
<span class="cm"> * @TODO This application is currently in a rewrite process. Main changes:</span>
<span class="cm"> *			- Calibration routines are moved into the event system</span>
<span class="cm"> *			- Commander is rewritten as class</span>
<span class="cm"> *			- State machines will be model driven</span>
<span class="cm"> */</span>

<span class="cp">#include</span> <span class="cpf">&quot;Commander.hpp&quot;</span><span class="cp"></span>

<span class="cm">/* commander module headers */</span>
<span class="cp">#include</span> <span class="cpf">&quot;accelerometer_calibration.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;airspeed_calibration.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;arm_auth.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;baro_calibration.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;calibration_routines.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;commander_helper.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;esc_calibration.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;gyro_calibration.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;mag_calibration.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;PreflightCheck.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;px4_custom_mode.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;rc_calibration.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;state_machine_helper.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&quot;health_flag_helper.h&quot;</span><span class="cp"></span>

<span class="cm">/* PX4 headers */</span>
<span class="cp">#include</span> <span class="cpf">&lt;dataman/dataman.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;drivers/drv_hrt.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;drivers/drv_tone_alarm.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;lib/ecl/geo/geo.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;mathlib/mathlib.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;navigator/navigation.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;px4_config.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;px4_defines.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;px4_posix.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;px4_shutdown.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;px4_tasks.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;px4_time.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;circuit_breaker/circuit_breaker.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;systemlib/err.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;systemlib/hysteresis/hysteresis.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;systemlib/mavlink_log.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;parameters/param.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;cmath&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cfloat&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cstring&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/actuator_armed.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/actuator_controls.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/battery_status.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/cpuload.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/estimator_status.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/geofence_result.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/home_position.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/manual_control_setpoint.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/mavlink_log.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/mission.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/mission_result.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/offboard_control_mode.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/parameter_update.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/power_button_state.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/safety.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/subsystem_info.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/system_power.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/telemetry_status.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/vehicle_command.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/vehicle_command_ack.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/vehicle_global_position.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/vehicle_land_detected.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/vehicle_local_position.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/vehicle_status_flags.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/topics/vtol_vehicle_status.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;uORB/uORB.h&gt;</span><span class="cp"></span>

<span class="k">typedef</span> <span class="k">enum</span> <span class="n">VEHICLE_MODE_FLAG</span>
<span class="p">{</span>
	<span class="n">VEHICLE_MODE_FLAG_CUSTOM_MODE_ENABLED</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/* 0b00000001 Reserved for future use. | */</span>
	<span class="n">VEHICLE_MODE_FLAG_TEST_ENABLED</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="cm">/* 0b00000010 system has a test mode enabled. This flag is intended for temporary system tests and should not be used for stable implementations. | */</span>
	<span class="n">VEHICLE_MODE_FLAG_AUTO_ENABLED</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="cm">/* 0b00000100 autonomous mode enabled, system finds its own goal positions. Guided flag can be set or not, depends on the actual implementation. | */</span>
	<span class="n">VEHICLE_MODE_FLAG_GUIDED_ENABLED</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="cm">/* 0b00001000 guided mode enabled, system flies MISSIONs / mission items. | */</span>
	<span class="n">VEHICLE_MODE_FLAG_STABILIZE_ENABLED</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="cm">/* 0b00010000 system stabilizes electronically its attitude (and optionally position). It needs however further control inputs to move around. | */</span>
	<span class="n">VEHICLE_MODE_FLAG_HIL_ENABLED</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="cm">/* 0b00100000 hardware in the loop simulation. All motors / actuators are blocked, but internal software is full operational. | */</span>
	<span class="n">VEHICLE_MODE_FLAG_MANUAL_INPUT_ENABLED</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="cm">/* 0b01000000 remote control input is enabled. | */</span>
	<span class="n">VEHICLE_MODE_FLAG_SAFETY_ARMED</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="cm">/* 0b10000000 MAV safety set to armed. Motors are enabled / running / can start. Ready to fly. | */</span>
	<span class="n">VEHICLE_MODE_FLAG_ENUM_END</span><span class="o">=</span><span class="mi">129</span><span class="p">,</span> <span class="cm">/*  | */</span>
<span class="p">}</span> <span class="n">VEHICLE_MODE_FLAG</span><span class="p">;</span>

<span class="cm">/* Decouple update interval and hysteresis counters, all depends on intervals */</span>
<span class="k">static</span> <span class="k">constexpr</span> <span class="kt">uint64_t</span> <span class="n">COMMANDER_MONITORING_INTERVAL</span> <span class="o">=</span> <span class="mi">10</span><span class="n">_ms</span><span class="p">;</span>
<span class="cp">#define COMMANDER_MONITORING_LOOPSPERMSEC (1/(COMMANDER_MONITORING_INTERVAL/1000.0f))</span>

<span class="k">static</span> <span class="k">constexpr</span> <span class="kt">float</span> <span class="n">STICK_ON_OFF_LIMIT</span> <span class="o">=</span> <span class="mf">0.9f</span><span class="p">;</span>

<span class="k">static</span> <span class="k">constexpr</span> <span class="kt">uint64_t</span> <span class="n">OFFBOARD_TIMEOUT</span> <span class="o">=</span> <span class="mi">500</span><span class="n">_ms</span><span class="p">;</span>
<span class="k">static</span> <span class="k">constexpr</span> <span class="kt">uint64_t</span> <span class="n">HOTPLUG_SENS_TIMEOUT</span> <span class="o">=</span> <span class="mi">8</span><span class="n">_s</span><span class="p">;</span>	<span class="cm">/**&lt; wait for hotplug sensors to come online for upto 8 seconds */</span>
<span class="k">static</span> <span class="k">constexpr</span> <span class="kt">uint64_t</span> <span class="n">PRINT_MODE_REJECT_INTERVAL</span> <span class="o">=</span> <span class="mi">500</span><span class="n">_ms</span><span class="p">;</span>
<span class="k">static</span> <span class="k">constexpr</span> <span class="kt">uint64_t</span> <span class="n">INAIR_RESTART_HOLDOFF_INTERVAL</span> <span class="o">=</span> <span class="mi">500</span><span class="n">_ms</span><span class="p">;</span>

<span class="cm">/* Mavlink log uORB handle */</span>
<span class="k">static</span> <span class="n">orb_advert_t</span> <span class="n">mavlink_log_pub</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="k">static</span> <span class="n">orb_advert_t</span> <span class="n">power_button_state_pub</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>

<span class="cm">/* flags */</span>
<span class="k">static</span> <span class="k">volatile</span> <span class="kt">bool</span> <span class="n">thread_should_exit</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>	<span class="cm">/**&lt; daemon exit flag */</span>
<span class="k">static</span> <span class="k">volatile</span> <span class="kt">bool</span> <span class="n">thread_running</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>		<span class="cm">/**&lt; daemon status flag */</span>

<span class="k">static</span> <span class="n">hrt_abstime</span> <span class="n">commander_boot_timestamp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">leds_counter</span><span class="p">;</span>
<span class="cm">/* To remember when last notification was sent */</span>
<span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">last_print_mode_reject_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="n">systemlib</span><span class="o">::</span><span class="n">Hysteresis</span> <span class="n">auto_disarm_hysteresis</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">float</span> <span class="n">min_stick_change</span> <span class="o">=</span> <span class="mf">0.25f</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vehicle_status_s</span> <span class="n">status</span> <span class="o">=</span> <span class="p">{};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">battery_status_s</span> <span class="n">battery</span> <span class="o">=</span> <span class="p">{};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">actuator_armed_s</span> <span class="n">armed</span> <span class="o">=</span> <span class="p">{};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">safety_s</span> <span class="n">safety</span> <span class="o">=</span> <span class="p">{};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">vehicle_control_mode_s</span> <span class="n">control_mode</span> <span class="o">=</span> <span class="p">{};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">offboard_control_mode_s</span> <span class="n">offboard_control_mode</span> <span class="o">=</span> <span class="p">{};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">home_position_s</span> <span class="n">_home</span> <span class="o">=</span> <span class="p">{};</span>
<span class="k">static</span> <span class="kt">int32_t</span> <span class="n">_flight_mode_slots</span><span class="p">[</span><span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">MODE_SLOT_MAX</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">commander_state_s</span> <span class="n">internal_state</span> <span class="o">=</span> <span class="p">{};</span>

<span class="k">static</span> <span class="kt">uint8_t</span> <span class="n">main_state_before_rtl</span> <span class="o">=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_MAX</span><span class="p">;</span>

<span class="k">static</span> <span class="n">manual_control_setpoint_s</span> <span class="n">sp_man</span> <span class="o">=</span> <span class="p">{};</span>		<span class="c1">///&lt; the current manual control setpoint</span>
<span class="k">static</span> <span class="n">manual_control_setpoint_s</span> <span class="n">_last_sp_man</span> <span class="o">=</span> <span class="p">{};</span>	<span class="c1">///&lt; the manual control setpoint valid at the last mode switch</span>
<span class="k">static</span> <span class="kt">uint8_t</span> <span class="n">_last_sp_man_arm_switch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vtol_vehicle_status_s</span> <span class="n">vtol_status</span> <span class="o">=</span> <span class="p">{};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cpuload_s</span> <span class="n">cpuload</span> <span class="o">=</span> <span class="p">{};</span>

<span class="k">static</span> <span class="kt">bool</span> <span class="n">warning_action_on</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">bool</span> <span class="n">last_overload</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vehicle_status_flags_s</span> <span class="n">status_flags</span> <span class="o">=</span> <span class="p">{};</span>

<span class="k">static</span> <span class="kt">uint64_t</span> <span class="n">rc_signal_lost_timestamp</span><span class="p">;</span>		<span class="c1">// Time at which the RC reception was lost</span>

<span class="k">static</span> <span class="kt">uint8_t</span> <span class="n">arm_requirements</span> <span class="o">=</span> <span class="n">ARM_REQ_NONE</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">bool</span> <span class="n">_last_condition_global_position_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vehicle_land_detected_s</span> <span class="n">land_detector</span> <span class="o">=</span> <span class="p">{};</span>

<span class="k">static</span> <span class="kt">float</span> <span class="n">_eph_threshold_adj</span> <span class="o">=</span> <span class="n">INFINITY</span><span class="p">;</span>	<span class="c1">///&lt; maximum allowable horizontal position uncertainty after adjustment for flight condition</span>
<span class="k">static</span> <span class="kt">bool</span> <span class="n">_skip_pos_accuracy_check</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * The daemon app only briefly exists to start</span>
<span class="cm"> * the background job. The stack size assigned in the</span>
<span class="cm"> * Makefile does only apply to this management task.</span>
<span class="cm"> *</span>
<span class="cm"> * The actual stack size should be set in the call</span>
<span class="cm"> * to task_create().</span>
<span class="cm"> *</span>
<span class="cm"> * @ingroup apps</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="n">__EXPORT</span> <span class="kt">int</span> <span class="n">commander_main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[]);</span>

<span class="cm">/**</span>
<span class="cm"> * Print the correct usage.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">usage</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">reason</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">control_status_leds</span><span class="p">(</span><span class="n">vehicle_status_s</span> <span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="k">const</span> <span class="n">actuator_armed_s</span> <span class="o">*</span><span class="n">actuator_armed</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">changed</span><span class="p">,</span>
			 <span class="n">battery_status_s</span> <span class="o">*</span><span class="n">battery_local</span><span class="p">,</span> <span class="k">const</span> <span class="n">cpuload_s</span> <span class="o">*</span><span class="n">cpuload_local</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">get_circuit_breaker_params</span><span class="p">();</span>

<span class="kt">void</span> <span class="nf">set_control_mode</span><span class="p">();</span>

<span class="kt">bool</span> <span class="nf">stabilization_required</span><span class="p">();</span>

<span class="kt">void</span> <span class="nf">print_reject_mode</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">print_reject_arm</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">print_status</span><span class="p">();</span>

<span class="n">transition_result_t</span> <span class="nf">arm_disarm</span><span class="p">(</span><span class="kt">bool</span> <span class="n">arm</span><span class="p">,</span> <span class="n">orb_advert_t</span> <span class="o">*</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">armedBy</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * Loop that runs at a lower rate and priority for calibration and parameter tasks.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="o">*</span><span class="nf">commander_low_prio_loop</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">answer_command</span><span class="p">(</span><span class="k">const</span> <span class="n">vehicle_command_s</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">result</span><span class="p">,</span> <span class="n">orb_advert_t</span> <span class="o">&amp;</span><span class="n">command_ack_pub</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">power_button_state_notification_cb</span><span class="p">(</span><span class="n">board_power_button_state_notification_e</span> <span class="n">request</span><span class="p">)</span>
<span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>Note: this can be called from IRQ handlers, so we publish a message that will be handled
on the main thread of commander.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="n">power_button_state_s</span> <span class="n">button_state</span><span class="p">;</span>
	<span class="n">button_state</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">PWR_BUTTON_RESPONSE_SHUT_DOWN_PENDING</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nl">PWR_BUTTON_IDEL</span><span class="p">:</span>
			<span class="n">button_state</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">power_button_state_s</span><span class="o">::</span><span class="n">PWR_BUTTON_STATE_IDEL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="nl">PWR_BUTTON_DOWN</span><span class="p">:</span>
			<span class="n">button_state</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">power_button_state_s</span><span class="o">::</span><span class="n">PWR_BUTTON_STATE_DOWN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="nl">PWR_BUTTON_UP</span><span class="p">:</span>
			<span class="n">button_state</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">power_button_state_s</span><span class="o">::</span><span class="n">PWR_BUTTON_STATE_UP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="nl">PWR_BUTTON_REQUEST_SHUT_DOWN</span><span class="p">:</span>
			<span class="n">button_state</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">power_button_state_s</span><span class="o">::</span><span class="n">PWR_BUTTON_STATE_REQUEST_SHUTDOWN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">default</span><span class="o">:</span>
			<span class="n">PX4_ERR</span><span class="p">(</span><span class="s">&quot;unhandled power button state: %i&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">request</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">power_button_state_pub</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">orb_publish</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">power_button_state</span><span class="p">),</span> <span class="n">power_button_state_pub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">button_state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">PX4_ERR</span><span class="p">(</span><span class="s">&quot;power_button_state_pub not properly initialized&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">commander_main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usage</span><span class="p">(</span><span class="s">&quot;missing command&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;start&quot;</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">thread_running</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;already running&quot;</span><span class="p">);</span>
			<span class="cm">/* this is not an error */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">thread_should_exit</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">Commander</span><span class="o">::</span><span class="n">main</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>

		<span class="kt">unsigned</span> <span class="k">constexpr</span> <span class="n">max_wait_us</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="k">constexpr</span> <span class="n">max_wait_steps</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">;</span>

		<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_wait_steps</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usleep</span><span class="p">(</span><span class="n">max_wait_us</span> <span class="o">/</span> <span class="n">max_wait_steps</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">thread_running</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_wait_steps</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;stop&quot;</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">thread_running</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;commander already stopped&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">thread_should_exit</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="n">Commander</span><span class="o">::</span><span class="n">main</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>

		<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;terminated.&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* commands needing the app to run below */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">thread_running</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">commander not started&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;status&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">print_status</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;calibrate&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">calib_ret</span> <span class="o">=</span> <span class="n">OK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">&quot;mag&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">calib_ret</span> <span class="o">=</span> <span class="n">do_mag_calibration</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">&quot;accel&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">calib_ret</span> <span class="o">=</span> <span class="n">do_accel_calibration</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">&quot;gyro&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">calib_ret</span> <span class="o">=</span> <span class="n">do_gyro_calibration</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">&quot;level&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">calib_ret</span> <span class="o">=</span> <span class="n">do_level_calibration</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">&quot;esc&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">calib_ret</span> <span class="o">=</span> <span class="n">do_esc_calibration</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">armed</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">&quot;airspeed&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">calib_ret</span> <span class="o">=</span> <span class="n">do_airspeed_calibration</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;argument %s unsupported.&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">calib_ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;calibration failed, exiting.&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;missing argument&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;check&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">bool</span> <span class="n">preflight_check_res</span> <span class="o">=</span> <span class="n">Commander</span><span class="o">::</span><span class="n">preflight_check</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
		<span class="n">PX4_INFO</span><span class="p">(</span><span class="s">&quot;Preflight check: %s&quot;</span><span class="p">,</span> <span class="n">preflight_check_res</span> <span class="o">?</span> <span class="s">&quot;OK&quot;</span> <span class="o">:</span> <span class="s">&quot;FAILED&quot;</span><span class="p">);</span>

		<span class="kt">bool</span> <span class="n">prearm_check_res</span> <span class="o">=</span> <span class="n">prearm_check</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="n">battery</span><span class="p">,</span> <span class="n">safety</span><span class="p">,</span> <span class="n">arm_requirements</span><span class="p">,</span> <span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commander_boot_timestamp</span><span class="p">));</span>
		<span class="n">PX4_INFO</span><span class="p">(</span><span class="s">&quot;Prearm check: %s&quot;</span><span class="p">,</span> <span class="n">prearm_check_res</span> <span class="o">?</span> <span class="s">&quot;OK&quot;</span> <span class="o">:</span> <span class="s">&quot;FAILED&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;arm&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">TRANSITION_CHANGED</span> <span class="o">!=</span> <span class="n">arm_disarm</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;command line&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;arming failed&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;disarm&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">TRANSITION_DENIED</span> <span class="o">==</span> <span class="n">arm_disarm</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;command line&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;rejected disarm&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;takeoff&quot;</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* see if we got a home position */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status_flags</span><span class="p">.</span><span class="n">condition_local_position_valid</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">TRANSITION_DENIED</span> <span class="o">!=</span> <span class="n">arm_disarm</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;command line&quot;</span><span class="p">))</span> <span class="p">{</span>

				<span class="k">struct</span> <span class="n">vehicle_command_s</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
					<span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">(),</span>
					<span class="p">.</span><span class="n">param5</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">NAN</span><span class="p">,</span>
					<span class="p">.</span><span class="n">param6</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">NAN</span><span class="p">,</span>
					<span class="cm">/* minimum pitch */</span>
					<span class="p">.</span><span class="n">param1</span> <span class="o">=</span> <span class="n">NAN</span><span class="p">,</span>
					<span class="p">.</span><span class="n">param2</span> <span class="o">=</span> <span class="n">NAN</span><span class="p">,</span>
					<span class="p">.</span><span class="n">param3</span> <span class="o">=</span> <span class="n">NAN</span><span class="p">,</span>
					<span class="p">.</span><span class="n">param4</span> <span class="o">=</span> <span class="n">NAN</span><span class="p">,</span>
					<span class="p">.</span><span class="n">param7</span> <span class="o">=</span> <span class="n">NAN</span><span class="p">,</span>
					<span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_NAV_TAKEOFF</span><span class="p">,</span>
					<span class="p">.</span><span class="n">target_system</span> <span class="o">=</span> <span class="n">status</span><span class="p">.</span><span class="n">system_id</span><span class="p">,</span>
					<span class="p">.</span><span class="n">target_component</span> <span class="o">=</span> <span class="n">status</span><span class="p">.</span><span class="n">component_id</span>
				<span class="p">};</span>

				<span class="n">orb_advert_t</span> <span class="n">h</span> <span class="o">=</span> <span class="n">orb_advertise_queue</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_command</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">ORB_QUEUE_LENGTH</span><span class="p">);</span>
				<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">orb_unadvertise</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;arming failed&quot;</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;rejecting takeoff, no position lock yet. Please retry..&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;land&quot;</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">struct</span> <span class="n">vehicle_command_s</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">param5</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">NAN</span><span class="p">,</span>
			<span class="p">.</span><span class="n">param6</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">NAN</span><span class="p">,</span>
			<span class="cm">/* minimum pitch */</span>
			<span class="p">.</span><span class="n">param1</span> <span class="o">=</span> <span class="n">NAN</span><span class="p">,</span>
			<span class="p">.</span><span class="n">param2</span> <span class="o">=</span> <span class="n">NAN</span><span class="p">,</span>
			<span class="p">.</span><span class="n">param3</span> <span class="o">=</span> <span class="n">NAN</span><span class="p">,</span>
			<span class="p">.</span><span class="n">param4</span> <span class="o">=</span> <span class="n">NAN</span><span class="p">,</span>
			<span class="p">.</span><span class="n">param7</span> <span class="o">=</span> <span class="n">NAN</span><span class="p">,</span>
			<span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_NAV_LAND</span><span class="p">,</span>
			<span class="p">.</span><span class="n">target_system</span> <span class="o">=</span> <span class="n">status</span><span class="p">.</span><span class="n">system_id</span><span class="p">,</span>
			<span class="p">.</span><span class="n">target_component</span> <span class="o">=</span> <span class="n">status</span><span class="p">.</span><span class="n">component_id</span>
		<span class="p">};</span>

		<span class="n">orb_advert_t</span> <span class="n">h</span> <span class="o">=</span> <span class="n">orb_advertise_queue</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_command</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">ORB_QUEUE_LENGTH</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">orb_unadvertise</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;transition&quot;</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">struct</span> <span class="n">vehicle_command_s</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">param5</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">NAN</span><span class="p">,</span>
			<span class="p">.</span><span class="n">param6</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">NAN</span><span class="p">,</span>
			<span class="cm">/* transition to the other mode */</span>
			<span class="p">.</span><span class="n">param1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">float</span><span class="p">)((</span><span class="n">status</span><span class="p">.</span><span class="n">is_rotary_wing</span><span class="p">)</span> <span class="o">?</span> <span class="n">vtol_vehicle_status_s</span><span class="o">::</span><span class="nl">VEHICLE_VTOL_STATE_FW</span> <span class="p">:</span> <span class="n">vtol_vehicle_status_s</span><span class="o">::</span><span class="n">VEHICLE_VTOL_STATE_MC</span><span class="p">),</span>
			<span class="p">.</span><span class="n">param2</span> <span class="o">=</span> <span class="n">NAN</span><span class="p">,</span>
			<span class="p">.</span><span class="n">param3</span> <span class="o">=</span> <span class="n">NAN</span><span class="p">,</span>
			<span class="p">.</span><span class="n">param4</span> <span class="o">=</span> <span class="n">NAN</span><span class="p">,</span>
			<span class="p">.</span><span class="n">param7</span> <span class="o">=</span> <span class="n">NAN</span><span class="p">,</span>
			<span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_DO_VTOL_TRANSITION</span><span class="p">,</span>
			<span class="p">.</span><span class="n">target_system</span> <span class="o">=</span> <span class="n">status</span><span class="p">.</span><span class="n">system_id</span><span class="p">,</span>
			<span class="p">.</span><span class="n">target_component</span> <span class="o">=</span> <span class="n">status</span><span class="p">.</span><span class="n">component_id</span>
		<span class="p">};</span>

		<span class="n">orb_advert_t</span> <span class="n">h</span> <span class="o">=</span> <span class="n">orb_advertise_queue</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_command</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">ORB_QUEUE_LENGTH</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">orb_unadvertise</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;mode&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">uint8_t</span> <span class="n">new_main_state</span> <span class="o">=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_MAX</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">&quot;manual&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">new_main_state</span> <span class="o">=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_MANUAL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">&quot;altctl&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">new_main_state</span> <span class="o">=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_ALTCTL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">&quot;posctl&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">new_main_state</span> <span class="o">=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_POSCTL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">&quot;auto:mission&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">new_main_state</span> <span class="o">=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_MISSION</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">&quot;auto:loiter&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">new_main_state</span> <span class="o">=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_LOITER</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">&quot;auto:rtl&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">new_main_state</span> <span class="o">=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_RTL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">&quot;acro&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">new_main_state</span> <span class="o">=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_ACRO</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">&quot;offboard&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">new_main_state</span> <span class="o">=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_OFFBOARD</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">&quot;stabilized&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">new_main_state</span> <span class="o">=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_STAB</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">&quot;rattitude&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">new_main_state</span> <span class="o">=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_RATTITUDE</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">&quot;auto:takeoff&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">new_main_state</span> <span class="o">=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_TAKEOFF</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">&quot;auto:land&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">new_main_state</span> <span class="o">=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_LAND</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">&quot;auto:precland&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">new_main_state</span> <span class="o">=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_PRECLAND</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;argument %s unsupported.&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">TRANSITION_DENIED</span> <span class="o">==</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">new_main_state</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;mode change failed&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;missing argument&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;lockdown&quot;</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usage</span><span class="p">(</span><span class="s">&quot;not enough arguments, missing [on, off]&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">struct</span> <span class="n">vehicle_command_s</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">param5</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">param6</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
			<span class="cm">/* if the comparison matches for off (== 0) set 0.0f, 2.0f (on) else */</span>
			<span class="p">.</span><span class="n">param1</span> <span class="o">=</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">&quot;off&quot;</span><span class="p">)</span> <span class="o">?</span> <span class="mf">2.0f</span> <span class="o">:</span> <span class="mf">0.0f</span><span class="p">,</span> <span class="cm">/* lockdown */</span>
			<span class="p">.</span><span class="n">param2</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">,</span>
			<span class="p">.</span><span class="n">param3</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">,</span>
			<span class="p">.</span><span class="n">param4</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">,</span>
			<span class="p">.</span><span class="n">param7</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">,</span>
			<span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_DO_FLIGHTTERMINATION</span><span class="p">,</span>
			<span class="p">.</span><span class="n">target_system</span> <span class="o">=</span> <span class="n">status</span><span class="p">.</span><span class="n">system_id</span><span class="p">,</span>
			<span class="p">.</span><span class="n">target_component</span> <span class="o">=</span> <span class="n">status</span><span class="p">.</span><span class="n">component_id</span>
		<span class="p">};</span>

		<span class="n">orb_advert_t</span> <span class="n">h</span> <span class="o">=</span> <span class="n">orb_advertise_queue</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_command</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">ORB_QUEUE_LENGTH</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">orb_unadvertise</span><span class="p">(</span><span class="n">h</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usage</span><span class="p">(</span><span class="s">&quot;unrecognized command&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">usage</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">reason</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PX4_INFO</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">PX4_INFO</span><span class="p">(</span><span class="s">&quot;usage: commander {start|stop|status|calibrate|check|arm|disarm|takeoff|land|transition|mode}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">print_status</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;type: %s&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">is_rotary_wing</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;symmetric motion&quot;</span> <span class="o">:</span> <span class="s">&quot;forward motion&quot;</span><span class="p">);</span>
	<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;safety: USB enabled: %s, power state valid: %s&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">status_flags</span><span class="p">.</span><span class="n">usb_connected</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;[OK]&quot;</span> <span class="o">:</span> <span class="s">&quot;[NO]&quot;</span><span class="p">,</span>
	      <span class="p">(</span><span class="n">status_flags</span><span class="p">.</span><span class="n">condition_power_input_valid</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; [OK]&quot;</span> <span class="o">:</span> <span class="s">&quot;[NO]&quot;</span><span class="p">);</span>
	<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;home: lat = %.7f, lon = %.7f, alt = %.2f, yaw: %.2f&quot;</span><span class="p">,</span> <span class="n">_home</span><span class="p">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">_home</span><span class="p">.</span><span class="n">lon</span><span class="p">,</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">_home</span><span class="p">.</span><span class="n">alt</span><span class="p">,</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">_home</span><span class="p">.</span><span class="n">yaw</span><span class="p">);</span>
	<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;home: x = %.7f, y = %.7f, z = %.2f &quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">_home</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">_home</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">_home</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
	<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;datalink: %s %s&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">data_link_lost</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;LOST&quot;</span> <span class="o">:</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">high_latency_data_link_active</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;(high latency)&quot;</span> <span class="o">:</span> <span class="s">&quot; &quot;</span><span class="p">);</span>
	<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;main state: %d&quot;</span><span class="p">,</span> <span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span><span class="p">);</span>
	<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;nav state: %d&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">.</span><span class="n">nav_state</span><span class="p">);</span>
	<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;arming: %s&quot;</span><span class="p">,</span> <span class="n">arming_state_names</span><span class="p">[</span><span class="n">status</span><span class="p">.</span><span class="n">arming_state</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">orb_advert_t</span> <span class="n">status_pub</span><span class="p">;</span>

<span class="n">transition_result_t</span> <span class="nf">arm_disarm</span><span class="p">(</span><span class="kt">bool</span> <span class="n">arm</span><span class="p">,</span> <span class="n">orb_advert_t</span> <span class="o">*</span><span class="n">mavlink_log_pub_local</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">armedBy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">transition_result_t</span> <span class="n">arming_res</span> <span class="o">=</span> <span class="n">TRANSITION_NOT_CHANGED</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <p>Transition the armed state. By passing mavlink_log_pub to arming_state_transition it will
output appropriate error messages if the state cannot transition.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="n">arming_res</span> <span class="o">=</span> <span class="n">arming_state_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span>
					     <span class="n">battery</span><span class="p">,</span>
					     <span class="n">safety</span><span class="p">,</span>
					     <span class="n">arm</span> <span class="o">?</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="nl">ARMING_STATE_ARMED</span> <span class="p">:</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">ARMING_STATE_STANDBY</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">armed</span><span class="p">,</span>
					     <span class="nb">true</span> <span class="cm">/* fRunPreArmChecks */</span><span class="p">,</span>
					     <span class="n">mavlink_log_pub_local</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">status_flags</span><span class="p">,</span>
					     <span class="n">arm_requirements</span><span class="p">,</span>
					     <span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commander_boot_timestamp</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arming_res</span> <span class="o">==</span> <span class="n">TRANSITION_CHANGED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mavlink_log_info</span><span class="p">(</span><span class="n">mavlink_log_pub_local</span><span class="p">,</span> <span class="s">&quot;%s by %s&quot;</span><span class="p">,</span> <span class="n">arm</span> <span class="o">?</span> <span class="s">&quot;ARMED&quot;</span> <span class="o">:</span> <span class="s">&quot;DISARMED&quot;</span><span class="p">,</span> <span class="n">armedBy</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">arming_res</span> <span class="o">==</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tune_negative</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">arming_res</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">Commander</span><span class="o">::</span><span class="n">Commander</span><span class="p">()</span> <span class="o">:</span>
	<span class="n">ModuleParams</span><span class="p">(</span><span class="k">nullptr</span><span class="p">),</span>
	<span class="n">_mission_result_sub</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">mission_result</span><span class="p">)),</span>
	<span class="n">_global_position_sub</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_global_position</span><span class="p">)),</span>
	<span class="n">_local_position_sub</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_local_position</span><span class="p">)),</span>
	<span class="n">_iridiumsbd_status_sub</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">iridiumsbd_status</span><span class="p">))</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">Commander</span><span class="o">::</span><span class="n">handle_command</span><span class="p">(</span><span class="n">vehicle_status_s</span> <span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="k">const</span> <span class="n">vehicle_command_s</span><span class="o">&amp;</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">actuator_armed_s</span> <span class="o">*</span><span class="n">armed_local</span><span class="p">,</span>
		    <span class="n">home_position_s</span> <span class="o">*</span><span class="n">home</span><span class="p">,</span> <span class="n">orb_advert_t</span> <span class="o">*</span><span class="n">home_pub</span><span class="p">,</span> <span class="n">orb_advert_t</span> <span class="o">*</span><span class="n">command_ack_pub</span><span class="p">,</span> <span class="kt">bool</span> <span class="o">*</span><span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* only handle commands that are meant to be handled by this system and component */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">target_system</span> <span class="o">!=</span> <span class="n">status_local</span><span class="o">-&gt;</span><span class="n">system_id</span> <span class="o">||</span> <span class="p">((</span><span class="n">cmd</span><span class="p">.</span><span class="n">target_component</span> <span class="o">!=</span> <span class="n">status_local</span><span class="o">-&gt;</span><span class="n">component_id</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">target_component</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span> <span class="c1">// component_id 0: valid for all components</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* result of the command */</span>
	<span class="kt">unsigned</span> <span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_UNSUPPORTED</span><span class="p">;</span>

	<span class="cm">/* request to set different system mode */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_DO_REPOSITION</span><span class="p">:</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>Just switch the flight mode here, the navigator takes care of
doing something sensible with the coordinates. Its designed
to not require navigator and command to receive / process
the data at the exact same time.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      <p>Check if a mode switch had been requested</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="k">if</span> <span class="p">((((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">cmd</span><span class="p">.</span><span class="n">param2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">transition_result_t</span> <span class="n">main_ret</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_LOITER</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">main_ret</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_TEMPORARILY_REJECTED</span><span class="p">;</span>
				<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;Rejecting reposition command&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_DO_SET_MODE</span><span class="p">:</span> <span class="p">{</span>
			<span class="kt">uint8_t</span> <span class="n">base_mode</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">cmd</span><span class="p">.</span><span class="n">param1</span><span class="p">;</span>
			<span class="kt">uint8_t</span> <span class="n">custom_main_mode</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">cmd</span><span class="p">.</span><span class="n">param2</span><span class="p">;</span>
			<span class="kt">uint8_t</span> <span class="n">custom_sub_mode</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">cmd</span><span class="p">.</span><span class="n">param3</span><span class="p">;</span>

			<span class="n">transition_result_t</span> <span class="n">arming_ret</span> <span class="o">=</span> <span class="n">TRANSITION_NOT_CHANGED</span><span class="p">;</span>

			<span class="n">transition_result_t</span> <span class="n">main_ret</span> <span class="o">=</span> <span class="n">TRANSITION_NOT_CHANGED</span><span class="p">;</span>

			<span class="cm">/* set HIL state */</span>
			<span class="n">hil_state_t</span> <span class="n">new_hil_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">base_mode</span> <span class="o">&amp;</span> <span class="n">VEHICLE_MODE_FLAG_HIL_ENABLED</span><span class="p">)</span> <span class="o">?</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="nl">HIL_STATE_ON</span> <span class="p">:</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">HIL_STATE_OFF</span><span class="p">;</span>
			<span class="n">transition_result_t</span> <span class="n">hil_ret</span> <span class="o">=</span> <span class="n">hil_state_transition</span><span class="p">(</span><span class="n">new_hil_state</span><span class="p">,</span> <span class="n">status_pub</span><span class="p">,</span> <span class="n">status_local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>We ignore base_mode &amp; VEHICLE_MODE_FLAG_SAFETY_ARMED because
the command VEHICLE_CMD_COMPONENT_ARM_DISARM should be used
instead according to the latest mavlink spec.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">base_mode</span> <span class="o">&amp;</span> <span class="n">VEHICLE_MODE_FLAG_CUSTOM_MODE_ENABLED</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* use autopilot-specific mode */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">custom_main_mode</span> <span class="o">==</span> <span class="n">PX4_CUSTOM_MAIN_MODE_MANUAL</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* MANUAL */</span>
					<span class="n">main_ret</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_MANUAL</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">custom_main_mode</span> <span class="o">==</span> <span class="n">PX4_CUSTOM_MAIN_MODE_ALTCTL</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* ALTCTL */</span>
					<span class="n">main_ret</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_ALTCTL</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">custom_main_mode</span> <span class="o">==</span> <span class="n">PX4_CUSTOM_MAIN_MODE_POSCTL</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* POSCTL */</span>
					<span class="n">reset_posvel_validity</span><span class="p">(</span><span class="n">changed</span><span class="p">);</span>
					<span class="n">main_ret</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_POSCTL</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">custom_main_mode</span> <span class="o">==</span> <span class="n">PX4_CUSTOM_MAIN_MODE_AUTO</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* AUTO */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">custom_sub_mode</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">reset_posvel_validity</span><span class="p">(</span><span class="n">changed</span><span class="p">);</span>
						<span class="k">switch</span><span class="p">(</span><span class="n">custom_sub_mode</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">case</span> <span class="nl">PX4_CUSTOM_SUB_MODE_AUTO_LOITER</span><span class="p">:</span>
							<span class="n">main_ret</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_LOITER</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>
							<span class="k">break</span><span class="p">;</span>

						<span class="k">case</span> <span class="nl">PX4_CUSTOM_SUB_MODE_AUTO_MISSION</span><span class="p">:</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">status_flags</span><span class="p">.</span><span class="n">condition_auto_mission_available</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">main_ret</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_MISSION</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>
							<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
								<span class="n">main_ret</span> <span class="o">=</span> <span class="n">TRANSITION_DENIED</span><span class="p">;</span>
							<span class="p">}</span>

							<span class="k">break</span><span class="p">;</span>

						<span class="k">case</span> <span class="nl">PX4_CUSTOM_SUB_MODE_AUTO_RTL</span><span class="p">:</span>
							<span class="n">main_ret</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_RTL</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>
							<span class="k">break</span><span class="p">;</span>

						<span class="k">case</span> <span class="nl">PX4_CUSTOM_SUB_MODE_AUTO_TAKEOFF</span><span class="p">:</span>
							<span class="n">main_ret</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_TAKEOFF</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>
							<span class="k">break</span><span class="p">;</span>

						<span class="k">case</span> <span class="nl">PX4_CUSTOM_SUB_MODE_AUTO_LAND</span><span class="p">:</span>
							<span class="n">main_ret</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_LAND</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>
							<span class="k">break</span><span class="p">;</span>

						<span class="k">case</span> <span class="nl">PX4_CUSTOM_SUB_MODE_AUTO_FOLLOW_TARGET</span><span class="p">:</span>
							<span class="n">main_ret</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_FOLLOW_TARGET</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>
							<span class="k">break</span><span class="p">;</span>

						<span class="k">case</span> <span class="nl">PX4_CUSTOM_SUB_MODE_AUTO_PRECLAND</span><span class="p">:</span>
							<span class="n">main_ret</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_PRECLAND</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>
							<span class="k">break</span><span class="p">;</span>

						<span class="k">default</span><span class="o">:</span>
							<span class="n">main_ret</span> <span class="o">=</span> <span class="n">TRANSITION_DENIED</span><span class="p">;</span>
							<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;Unsupported auto mode&quot;</span><span class="p">);</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>

					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">main_ret</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_MISSION</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>
					<span class="p">}</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">custom_main_mode</span> <span class="o">==</span> <span class="n">PX4_CUSTOM_MAIN_MODE_ACRO</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* ACRO */</span>
					<span class="n">main_ret</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_ACRO</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">custom_main_mode</span> <span class="o">==</span> <span class="n">PX4_CUSTOM_MAIN_MODE_RATTITUDE</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* RATTITUDE */</span>
					<span class="n">main_ret</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_RATTITUDE</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">custom_main_mode</span> <span class="o">==</span> <span class="n">PX4_CUSTOM_MAIN_MODE_STABILIZED</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* STABILIZED */</span>
					<span class="n">main_ret</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_STAB</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">custom_main_mode</span> <span class="o">==</span> <span class="n">PX4_CUSTOM_MAIN_MODE_OFFBOARD</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">reset_posvel_validity</span><span class="p">(</span><span class="n">changed</span><span class="p">);</span>
					<span class="cm">/* OFFBOARD */</span>
					<span class="n">main_ret</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_OFFBOARD</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>
				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* use base mode */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">base_mode</span> <span class="o">&amp;</span> <span class="n">VEHICLE_MODE_FLAG_AUTO_ENABLED</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* AUTO */</span>
					<span class="n">main_ret</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_MISSION</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">base_mode</span> <span class="o">&amp;</span> <span class="n">VEHICLE_MODE_FLAG_MANUAL_INPUT_ENABLED</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">base_mode</span> <span class="o">&amp;</span> <span class="n">VEHICLE_MODE_FLAG_GUIDED_ENABLED</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* POSCTL */</span>
						<span class="n">main_ret</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_POSCTL</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">base_mode</span> <span class="o">&amp;</span> <span class="n">VEHICLE_MODE_FLAG_STABILIZE_ENABLED</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* STABILIZED */</span>
						<span class="n">main_ret</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_STAB</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="cm">/* MANUAL */</span>
						<span class="n">main_ret</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_MANUAL</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">hil_ret</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">arming_ret</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">main_ret</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_TEMPORARILY_REJECTED</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">arming_ret</span> <span class="o">==</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;Rejecting arming cmd&quot;</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_COMPONENT_ARM_DISARM</span><span class="p">:</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>Adhere to MAVLink specs, but base on knowledge that these fundamentally encode ints
for logic state parameters</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param1</span> <span class="o">+</span> <span class="mf">0.5f</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param1</span> <span class="o">+</span> <span class="mf">0.5f</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;Unsupported ARM_DISARM param: %.3f&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">cmd</span><span class="p">.</span><span class="n">param1</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

				<span class="kt">bool</span> <span class="n">cmd_arms</span> <span class="o">=</span> <span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param1</span> <span class="o">+</span> <span class="mf">0.5f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>Flick to inair restore first if this comes from an onboard system</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>				<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">source_system</span> <span class="o">==</span> <span class="n">status_local</span><span class="o">-&gt;</span><span class="n">system_id</span> <span class="o">&amp;&amp;</span> <span class="n">cmd</span><span class="p">.</span><span class="n">source_component</span> <span class="o">==</span> <span class="n">status_local</span><span class="o">-&gt;</span><span class="n">component_id</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">status</span><span class="p">.</span><span class="n">arming_state</span> <span class="o">=</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">ARMING_STATE_IN_AIR_RESTORE</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>Refuse to arm if preflight checks have failed</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>					<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">status_local</span><span class="o">-&gt;</span><span class="n">hil_state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">HIL_STATE_ON</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">status_flags</span><span class="p">.</span><span class="n">condition_system_sensors_initialized</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;Arming DENIED. Preflight checks have failed.&quot;</span><span class="p">);</span>
						<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_DENIED</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>Refuse to arm if in manual with non-zero throttle</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>					<span class="k">if</span> <span class="p">(</span><span class="n">cmd_arms</span>
					    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status_local</span><span class="o">-&gt;</span><span class="n">nav_state</span> <span class="o">==</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">NAVIGATION_STATE_MANUAL</span>
						<span class="o">||</span> <span class="n">status_local</span><span class="o">-&gt;</span><span class="n">nav_state</span> <span class="o">==</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">NAVIGATION_STATE_ACRO</span>
						<span class="o">||</span> <span class="n">status_local</span><span class="o">-&gt;</span><span class="n">nav_state</span> <span class="o">==</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">NAVIGATION_STATE_STAB</span>
						<span class="o">||</span> <span class="n">status_local</span><span class="o">-&gt;</span><span class="n">nav_state</span> <span class="o">==</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">NAVIGATION_STATE_RATTITUDE</span><span class="p">)</span>
					    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mf">0.1f</span><span class="p">))</span> <span class="p">{</span>

						<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;Arming DENIED. Manual throttle non-zero.&quot;</span><span class="p">);</span>
						<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_DENIED</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="n">transition_result_t</span> <span class="n">arming_res</span> <span class="o">=</span> <span class="n">arm_disarm</span><span class="p">(</span><span class="n">cmd_arms</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;arm/disarm component command&quot;</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">arming_res</span> <span class="o">==</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_TEMPORARILY_REJECTED</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">;</span>

					<span class="cm">/* update home position on arming if at least 500 ms from commander start spent to avoid setting home on in-air restart */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">cmd_arms</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">arming_res</span> <span class="o">==</span> <span class="n">TRANSITION_CHANGED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					    <span class="p">(</span><span class="n">hrt_absolute_time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">commander_boot_timestamp</span> <span class="o">+</span> <span class="n">INAIR_RESTART_HOLDOFF_INTERVAL</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
					    <span class="o">!</span><span class="n">home</span><span class="o">-&gt;</span><span class="n">manual_home</span><span class="p">)</span> <span class="p">{</span>

						<span class="n">set_home_position</span><span class="p">(</span><span class="o">*</span><span class="n">home_pub</span><span class="p">,</span> <span class="o">*</span><span class="n">home</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_DO_FLIGHTTERMINATION</span><span class="p">:</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param1</span> <span class="o">&gt;</span> <span class="mf">1.5f</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">armed_local</span><span class="o">-&gt;</span><span class="n">lockdown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;forcing lockdown (motors off)&quot;</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param1</span> <span class="o">&gt;</span> <span class="mf">0.5f</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>XXX update state machine?</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>				<span class="n">armed_local</span><span class="o">-&gt;</span><span class="n">force_failsafe</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;forcing failsafe (termination)&quot;</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">cmd</span><span class="p">.</span><span class="n">param2</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* reset all commanded failure modes */</span>
					<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;reset all non-flighttermination failsafe commands&quot;</span><span class="p">);</span>
				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">armed_local</span><span class="o">-&gt;</span><span class="n">force_failsafe</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">armed_local</span><span class="o">-&gt;</span><span class="n">lockdown</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;disabling failsafe and lockdown&quot;</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_DO_SET_HOME</span><span class="p">:</span> <span class="p">{</span>
			<span class="kt">bool</span> <span class="n">use_current</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">param1</span> <span class="o">&gt;</span> <span class="mf">0.5f</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">use_current</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* use current position */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">set_home_position</span><span class="p">(</span><span class="o">*</span><span class="n">home_pub</span><span class="p">,</span> <span class="o">*</span><span class="n">home</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_TEMPORARILY_REJECTED</span><span class="p">;</span>
				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">const</span> <span class="kt">double</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">param5</span><span class="p">;</span>
				<span class="k">const</span> <span class="kt">double</span> <span class="n">lon</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">param6</span><span class="p">;</span>
				<span class="k">const</span> <span class="kt">float</span> <span class="n">alt</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">param7</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">PX4_ISFINITE</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">PX4_ISFINITE</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">PX4_ISFINITE</span><span class="p">(</span><span class="n">alt</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">const</span> <span class="n">vehicle_local_position_s</span> <span class="o">&amp;</span><span class="n">local_pos</span> <span class="o">=</span> <span class="n">_local_position_sub</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">local_pos</span><span class="p">.</span><span class="n">xy_global</span> <span class="o">&amp;&amp;</span> <span class="n">local_pos</span><span class="p">.</span><span class="n">z_global</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* use specified position */</span>
						<span class="n">home</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>

						<span class="n">home</span><span class="o">-&gt;</span><span class="n">lat</span> <span class="o">=</span> <span class="n">lat</span><span class="p">;</span>
						<span class="n">home</span><span class="o">-&gt;</span><span class="n">lon</span> <span class="o">=</span> <span class="n">lon</span><span class="p">;</span>
						<span class="n">home</span><span class="o">-&gt;</span><span class="n">alt</span> <span class="o">=</span> <span class="n">alt</span><span class="p">;</span>

						<span class="n">home</span><span class="o">-&gt;</span><span class="n">manual_home</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
						<span class="n">home</span><span class="o">-&gt;</span><span class="n">valid_alt</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
						<span class="n">home</span><span class="o">-&gt;</span><span class="n">valid_hpos</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p>update local projection reference including altitude</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>						<span class="k">struct</span> <span class="n">map_projection_reference_s</span> <span class="n">ref_pos</span><span class="p">;</span>
						<span class="n">map_projection_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ref_pos</span><span class="p">,</span> <span class="n">local_pos</span><span class="p">.</span><span class="n">ref_lat</span><span class="p">,</span> <span class="n">local_pos</span><span class="p">.</span><span class="n">ref_lon</span><span class="p">);</span>
						<span class="n">map_projection_project</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ref_pos</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">home</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">home</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">);</span>
						<span class="n">home</span><span class="o">-&gt;</span><span class="n">z</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">alt</span> <span class="o">-</span> <span class="n">local_pos</span><span class="p">.</span><span class="n">ref_alt</span><span class="p">);</span>

						<span class="cm">/* announce new home position */</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">home_pub</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">orb_publish</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">home_position</span><span class="p">),</span> <span class="o">*</span><span class="n">home_pub</span><span class="p">,</span> <span class="n">home</span><span class="p">);</span>

						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="o">*</span><span class="n">home_pub</span> <span class="o">=</span> <span class="n">orb_advertise</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">home_position</span><span class="p">),</span> <span class="n">home</span><span class="p">);</span>
						<span class="p">}</span>

						<span class="cm">/* mark home position as set */</span>
						<span class="n">status_flags</span><span class="p">.</span><span class="n">condition_home_position_valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

						<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">;</span>

					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_TEMPORARILY_REJECTED</span><span class="p">;</span>
					<span class="p">}</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_DENIED</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_NAV_GUIDED_ENABLE</span><span class="p">:</span> <span class="p">{</span>
			<span class="n">transition_result_t</span> <span class="n">res</span> <span class="o">=</span> <span class="n">TRANSITION_DENIED</span><span class="p">;</span>
			<span class="k">static</span> <span class="n">main_state_t</span> <span class="n">main_state_pre_offboard</span> <span class="o">=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_MANUAL</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">!=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_OFFBOARD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">main_state_pre_offboard</span> <span class="o">=</span> <span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param1</span> <span class="o">&gt;</span> <span class="mf">0.5f</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_OFFBOARD</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">print_reject_mode</span><span class="p">(</span><span class="s">&quot;OFFBOARD&quot;</span><span class="p">);</span>
					<span class="n">status_flags</span><span class="p">.</span><span class="n">offboard_control_set_by_command</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* Set flag that offboard was set via command, main state is not overridden by rc */</span>
					<span class="n">status_flags</span><span class="p">.</span><span class="n">offboard_control_set_by_command</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* If the mavlink command is used to enable or disable offboard control:</span>
<span class="cm">				 * switch back to previous mode when disabling */</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="n">main_state_pre_offboard</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>
				<span class="n">status_flags</span><span class="p">.</span><span class="n">offboard_control_set_by_command</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_TEMPORARILY_REJECTED</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_NAV_RETURN_TO_LAUNCH</span><span class="p">:</span> <span class="p">{</span>
			<span class="cm">/* switch to RTL which ends the mission */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">TRANSITION_CHANGED</span> <span class="o">==</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_RTL</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">mavlink_and_console_log_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;Returning to launch&quot;</span><span class="p">);</span>
				<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;Return to launch denied&quot;</span><span class="p">);</span>
				<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_TEMPORARILY_REJECTED</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_NAV_TAKEOFF</span><span class="p">:</span> <span class="p">{</span>
			<span class="cm">/* ok, home set, use it to take off */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">TRANSITION_CHANGED</span> <span class="o">==</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_TAKEOFF</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_TAKEOFF</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;Takeoff denied, disarm and re-try&quot;</span><span class="p">);</span>
				<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_TEMPORARILY_REJECTED</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_NAV_LAND</span><span class="p">:</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">TRANSITION_CHANGED</span> <span class="o">==</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_LAND</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">mavlink_and_console_log_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;Landing at current position&quot;</span><span class="p">);</span>
				<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;Landing denied, land manually&quot;</span><span class="p">);</span>
				<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_TEMPORARILY_REJECTED</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_NAV_PRECLAND</span><span class="p">:</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">TRANSITION_CHANGED</span> <span class="o">==</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_PRECLAND</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">mavlink_and_console_log_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;Precision landing&quot;</span><span class="p">);</span>
				<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;Precision landing denied, land manually&quot;</span><span class="p">);</span>
				<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_TEMPORARILY_REJECTED</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_MISSION_START</span><span class="p">:</span> <span class="p">{</span>

		<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_DENIED</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>check if current mission and first item are valid</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">status_flags</span><span class="p">.</span><span class="n">condition_auto_mission_available</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>requested first mission item valid</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">PX4_ISFINITE</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param1</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param1</span> <span class="o">&lt;</span> <span class="n">_mission_result_sub</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">seq_total</span><span class="p">))</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>switch to AUTO_MISSION and ARM</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>				<span class="k">if</span> <span class="p">((</span><span class="n">TRANSITION_DENIED</span> <span class="o">!=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_MISSION</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">))</span>
					<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">TRANSITION_DENIED</span> <span class="o">!=</span> <span class="n">arm_disarm</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;mission start command&quot;</span><span class="p">)))</span> <span class="p">{</span>

					<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_TEMPORARILY_REJECTED</span><span class="p">;</span>
					<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;Mission start denied&quot;</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;Mission start denied, no valid mission&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_CONTROL_HIGH_LATENCY</span><span class="p">:</span> <span class="p">{</span>
			<span class="kt">bool</span> <span class="n">hl_exists</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ORB_MULTI_MAX_INSTANCES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">high_latency</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">hl_exists</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>if no high latency telemetry exists send a failed acknowledge</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hl_exists</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cmd_result</span> <span class="o">=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_FAILED</span><span class="p">;</span>
				<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;Control high latency failed, no hl telemetry available&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_CUSTOM_0</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_CUSTOM_1</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_CUSTOM_2</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_DO_MOUNT_CONTROL</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_DO_MOUNT_CONFIGURE</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_DO_MOUNT_CONTROL_QUAT</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_PREFLIGHT_REBOOT_SHUTDOWN</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_PREFLIGHT_CALIBRATION</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_PREFLIGHT_SET_SENSOR_OFFSETS</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_PREFLIGHT_STORAGE</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_PREFLIGHT_UAVCAN</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_PAYLOAD_PREPARE_DEPLOY</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_PAYLOAD_CONTROL_DEPLOY</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_DO_VTOL_TRANSITION</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_DO_TRIGGER_CONTROL</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_DO_DIGICAM_CONTROL</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_DO_SET_CAM_TRIGG_DIST</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_DO_SET_CAM_TRIGG_INTERVAL</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_SET_CAMERA_MODE</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_DO_CHANGE_SPEED</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_DO_LAND_START</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_DO_GO_AROUND</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_START_RX_PAIR</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_LOGGING_START</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_LOGGING_STOP</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_NAV_DELAY</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_DO_SET_ROI</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_NAV_ROI</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_DO_SET_ROI_LOCATION</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_DO_SET_ROI_WPNEXT_OFFSET</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_DO_SET_ROI_NONE</span><span class="p">:</span>
		<span class="cm">/* ignore commands that are handled by other parts of the system */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">default</span><span class="o">:</span>
		<span class="cm">/* Warn about unsupported commands, this makes sense because only commands</span>
<span class="cm">		 * to this component ID (or all) are passed by mavlink. */</span>
		<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_UNSUPPORTED</span><span class="p">,</span> <span class="o">*</span><span class="n">command_ack_pub</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_result</span> <span class="o">!=</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_UNSUPPORTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* already warned about unsupported commands in &quot;default&quot; case */</span>
		<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cmd_result</span><span class="p">,</span> <span class="o">*</span><span class="n">command_ack_pub</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm">* @brief This function initializes the home position an altitude of the vehicle. This happens first time we get a good GPS fix and each</span>
<span class="cm">*		 time the vehicle is armed with a good GPS fix.</span>
<span class="cm">**/</span>
<span class="kt">bool</span>
<span class="n">Commander</span><span class="o">::</span><span class="n">set_home_position</span><span class="p">(</span><span class="n">orb_advert_t</span> <span class="o">&amp;</span><span class="n">homePub</span><span class="p">,</span> <span class="n">home_position_s</span> <span class="o">&amp;</span><span class="n">home</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">set_alt_only_to_lpos_ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">vehicle_local_position_s</span> <span class="o">&amp;</span><span class="n">localPosition</span> <span class="o">=</span> <span class="n">_local_position_sub</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
	<span class="k">const</span> <span class="n">vehicle_global_position_s</span> <span class="o">&amp;</span><span class="n">globalPosition</span> <span class="o">=</span> <span class="n">_global_position_sub</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">set_alt_only_to_lpos_ref</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>Need global and local position fix to be able to set home</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status_flags</span><span class="p">.</span><span class="n">condition_global_position_valid</span> <span class="o">||</span> <span class="o">!</span><span class="n">status_flags</span><span class="p">.</span><span class="n">condition_local_position_valid</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>Ensure that the GPS accuracy is good enough for intializing home</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">globalPosition</span><span class="p">.</span><span class="n">eph</span> <span class="o">&gt;</span> <span class="n">_home_eph_threshold</span><span class="p">.</span><span class="n">get</span><span class="p">()</span> <span class="o">||</span> <span class="n">globalPosition</span><span class="p">.</span><span class="n">epv</span> <span class="o">&gt;</span> <span class="n">_home_epv_threshold</span><span class="p">.</span><span class="n">get</span><span class="p">())</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <p>Set home position</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="n">home</span><span class="p">.</span><span class="n">lat</span> <span class="o">=</span> <span class="n">globalPosition</span><span class="p">.</span><span class="n">lat</span><span class="p">;</span>
		<span class="n">home</span><span class="p">.</span><span class="n">lon</span> <span class="o">=</span> <span class="n">globalPosition</span><span class="p">.</span><span class="n">lon</span><span class="p">;</span>
		<span class="n">home</span><span class="p">.</span><span class="n">valid_hpos</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="n">home</span><span class="p">.</span><span class="n">alt</span> <span class="o">=</span> <span class="n">globalPosition</span><span class="p">.</span><span class="n">alt</span><span class="p">;</span>
		<span class="n">home</span><span class="p">.</span><span class="n">valid_alt</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="n">home</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">localPosition</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
		<span class="n">home</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">localPosition</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
		<span class="n">home</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">localPosition</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>

		<span class="n">home</span><span class="p">.</span><span class="n">yaw</span> <span class="o">=</span> <span class="n">localPosition</span><span class="p">.</span><span class="n">yaw</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>Play tune first time we initialize HOME</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status_flags</span><span class="p">.</span><span class="n">condition_home_position_valid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tune_home_set</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* mark home position as set */</span>
		<span class="n">status_flags</span><span class="p">.</span><span class="n">condition_home_position_valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">home</span><span class="p">.</span><span class="n">valid_alt</span> <span class="o">&amp;&amp;</span> <span class="n">localPosition</span><span class="p">.</span><span class="n">z_global</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>handle special case where we are setting only altitude using local position reference</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="n">home</span><span class="p">.</span><span class="n">alt</span> <span class="o">=</span> <span class="n">localPosition</span><span class="p">.</span><span class="n">ref_alt</span><span class="p">;</span>
		<span class="n">home</span><span class="p">.</span><span class="n">valid_alt</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">home</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>
	<span class="n">home</span><span class="p">.</span><span class="n">manual_home</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* announce new home position */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">homePub</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">orb_publish</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">home_position</span><span class="p">),</span> <span class="n">homePub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">home</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">homePub</span> <span class="o">=</span> <span class="n">orb_advertise</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">home_position</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">home</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">Commander</span><span class="o">::</span><span class="n">run</span><span class="p">()</span>
<span class="p">{</span>
	<span class="kt">bool</span> <span class="n">sensor_fail_tune_played</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">bool</span> <span class="n">arm_tune_played</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">bool</span> <span class="n">was_landed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="kt">bool</span> <span class="n">was_falling</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">bool</span> <span class="n">was_armed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <p>XXX for now just set sensors as initialized</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="n">status_flags</span><span class="p">.</span><span class="n">condition_system_sensors_initialized</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* set parameters */</span>
	<span class="n">param_t</span> <span class="n">_param_sys_type</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;MAV_TYPE&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_system_id</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;MAV_SYS_ID&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_component_id</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;MAV_COMP_ID&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_enable_datalink_loss</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;NAV_DLL_ACT&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_offboard_loss_act</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_OBL_ACT&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_offboard_loss_rc_act</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_OBL_RC_ACT&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_enable_rc_loss</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;NAV_RCL_ACT&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_datalink_loss_timeout</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_DL_LOSS_T&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_highlatencydatalink_loss_timeout</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_HLDL_LOSS_T&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_rc_loss_timeout</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_RC_LOSS_T&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_datalink_regain_timeout</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_DL_REG_T&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_highlatencydatalink_regain_timeout</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_HLDL_REG_T&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_ef_throttle_thres</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_EF_THROT&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_ef_current2throttle_thres</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_EF_C2T&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_ef_time_thres</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_EF_TIME&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_rc_in_off</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_RC_IN_MODE&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_rc_arm_hyst</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_RC_ARM_HYST&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_min_stick_change</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_RC_STICK_OV&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_geofence_action</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;GF_ACTION&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_disarm_land</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_DISARM_LAND&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_low_bat_act</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_LOW_BAT_ACT&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_offboard_loss_timeout</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_OF_LOSS_T&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_arm_without_gps</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_ARM_WO_GPS&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_arm_switch_is_button</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_ARM_SWISBTN&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_rc_override</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_RC_OVERRIDE&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_arm_mission_required</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_ARM_MIS_REQ&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_flight_uuid</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_FLIGHT_UUID&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_takeoff_finished_action</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_TAKEOFF_ACT&quot;</span><span class="p">);</span>

	<span class="n">param_t</span> <span class="n">_param_fmode_1</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_FLTMODE1&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_fmode_2</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_FLTMODE2&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_fmode_3</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_FLTMODE3&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_fmode_4</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_FLTMODE4&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_fmode_5</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_FLTMODE5&quot;</span><span class="p">);</span>
	<span class="n">param_t</span> <span class="n">_param_fmode_6</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_FLTMODE6&quot;</span><span class="p">);</span>

	<span class="cm">/* failsafe response to loss of navigation accuracy */</span>
	<span class="n">param_t</span> <span class="n">_param_posctl_nav_loss_act</span> <span class="o">=</span> <span class="n">param_find</span><span class="p">(</span><span class="s">&quot;COM_POSCTL_NAVL&quot;</span><span class="p">);</span>

	<span class="cm">/* pthread for slow low prio thread */</span>
	<span class="n">pthread_t</span> <span class="n">commander_low_prio_thread</span><span class="p">;</span>

	<span class="cm">/* initialize */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">led_init</span><span class="p">()</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PX4_WARN</span><span class="p">(</span><span class="s">&quot;LED init failed&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buzzer_init</span><span class="p">()</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PX4_WARN</span><span class="p">(</span><span class="s">&quot;Buzzer init failed&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="kt">int</span> <span class="n">power_button_state_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">power_button_state</span><span class="p">));</span>
	<span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>we need to do an initial publication to make sure uORB allocates the buffer, which cannot happen
in IRQ context.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="n">power_button_state_s</span> <span class="n">button_state</span><span class="p">;</span>
		<span class="n">button_state</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">button_state</span><span class="p">.</span><span class="n">event</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">power_button_state_pub</span> <span class="o">=</span> <span class="n">orb_advertise</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">power_button_state</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">button_state</span><span class="p">);</span>
		<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">power_button_state</span><span class="p">),</span> <span class="n">power_button_state_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">button_state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">board_register_power_state_notification_cb</span><span class="p">(</span><span class="n">power_button_state_notification_cb</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PX4_ERR</span><span class="p">(</span><span class="s">&quot;Failed to register power notification callback&quot;</span><span class="p">);</span>
	<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p>We want to accept RC inputs as default</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="n">status_flags</span><span class="p">.</span><span class="n">rc_input_blocked</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">rc_input_mode</span> <span class="o">=</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">RC_IN_MODE_DEFAULT</span><span class="p">;</span>
	<span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_MANUAL</span><span class="p">;</span>
	<span class="n">internal_state</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>
	<span class="n">status</span><span class="p">.</span><span class="n">nav_state</span> <span class="o">=</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">NAVIGATION_STATE_MANUAL</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">arming_state</span> <span class="o">=</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">ARMING_STATE_INIT</span><span class="p">;</span>

	<span class="n">status</span><span class="p">.</span><span class="n">failsafe</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* neither manual nor offboard control commands have been received */</span>
	<span class="n">status_flags</span><span class="p">.</span><span class="n">offboard_control_signal_found_once</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">status_flags</span><span class="p">.</span><span class="n">rc_signal_found_once</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* mark all signals lost as long as they haven&#39;t been found */</span>
	<span class="n">status</span><span class="p">.</span><span class="n">rc_signal_lost</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">status_flags</span><span class="p">.</span><span class="n">offboard_control_signal_lost</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">data_link_lost</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">status_flags</span><span class="p">.</span><span class="n">offboard_control_loss_timeout</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">status_flags</span><span class="p">.</span><span class="n">condition_system_hotplug_timeout</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">status</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>

	<span class="n">status_flags</span><span class="p">.</span><span class="n">condition_power_input_valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">status_flags</span><span class="p">.</span><span class="n">usb_connected</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">status_flags</span><span class="p">.</span><span class="n">rc_calibration_valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <p>CIRCUIT BREAKERS</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="n">status_flags</span><span class="p">.</span><span class="n">circuit_breaker_engaged_power_check</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">status_flags</span><span class="p">.</span><span class="n">circuit_breaker_engaged_airspd_check</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">status_flags</span><span class="p">.</span><span class="n">circuit_breaker_engaged_enginefailure_check</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">status_flags</span><span class="p">.</span><span class="n">circuit_breaker_engaged_gpsfailure_check</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">get_circuit_breaker_params</span><span class="p">();</span>

	<span class="cm">/* Set position and velocity validty to false */</span>
	<span class="n">status_flags</span><span class="p">.</span><span class="n">condition_global_position_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">status_flags</span><span class="p">.</span><span class="n">condition_local_position_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">status_flags</span><span class="p">.</span><span class="n">condition_local_velocity_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">status_flags</span><span class="p">.</span><span class="n">condition_local_altitude_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* publish initial state */</span>
	<span class="n">status_pub</span> <span class="o">=</span> <span class="n">orb_advertise</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_status</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status_pub</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;ERROR: orb_advertise for topic vehicle_status failed (uorb app running?).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;exiting.&quot;</span><span class="p">);</span>
		<span class="n">px4_task_exit</span><span class="p">(</span><span class="n">PX4_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize armed with all false */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">armed</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">armed</span><span class="p">));</span>
	<span class="cm">/* armed topic */</span>
	<span class="n">orb_advert_t</span> <span class="n">armed_pub</span> <span class="o">=</span> <span class="n">orb_advertise</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">actuator_armed</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">armed</span><span class="p">);</span>
	<span class="n">hrt_abstime</span> <span class="n">last_disarmed_timestamp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* vehicle control mode topic */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">control_mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">control_mode</span><span class="p">));</span>
	<span class="n">orb_advert_t</span> <span class="n">control_mode_pub</span> <span class="o">=</span> <span class="n">orb_advertise</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_control_mode</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">control_mode</span><span class="p">);</span>

	<span class="cm">/* home position */</span>
	<span class="n">orb_advert_t</span> <span class="n">home_pub</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_home</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_home</span><span class="p">));</span>

	<span class="cm">/* command ack */</span>
	<span class="n">orb_advert_t</span> <span class="n">command_ack_pub</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
	<span class="n">orb_advert_t</span> <span class="n">commander_state_pub</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
	<span class="n">orb_advert_t</span> <span class="n">vehicle_status_flags_pub</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>

	<span class="cm">/* init mission state, do it here to allow navigator to use stored mission even if mavlink failed to start */</span>
	<span class="n">mission_init</span><span class="p">();</span>

	<span class="cm">/* Start monitoring loop */</span>
	<span class="kt">unsigned</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stick_off_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stick_on_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="kt">bool</span> <span class="n">low_battery_voltage_actions_done</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">bool</span> <span class="n">critical_battery_voltage_actions_done</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">bool</span> <span class="n">emergency_battery_voltage_actions_done</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">bool</span> <span class="n">dangerous_battery_level_requests_poweroff</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="kt">bool</span> <span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="kt">bool</span> <span class="n">param_init_forced</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="kt">bool</span> <span class="n">updated</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Subscribe to safety topic */</span>
	<span class="kt">int</span> <span class="n">safety_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">safety</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">safety</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">safety</span><span class="p">));</span>
	<span class="n">safety</span><span class="p">.</span><span class="n">safety_switch_available</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">safety</span><span class="p">.</span><span class="n">safety_off</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Subscribe to geofence result topic */</span>
	<span class="kt">int</span> <span class="n">geofence_result_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">geofence_result</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">geofence_result_s</span> <span class="n">geofence_result</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">geofence_result</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">geofence_result</span><span class="p">));</span>

	<span class="cm">/* Subscribe to manual control data */</span>
	<span class="kt">int</span> <span class="n">sp_man_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">manual_control_setpoint</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp_man</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sp_man</span><span class="p">));</span>

	<span class="cm">/* Subscribe to offboard control data */</span>
	<span class="kt">int</span> <span class="n">offboard_control_mode_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">offboard_control_mode</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">offboard_control_mode</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">offboard_control_mode</span><span class="p">));</span>

	<span class="cm">/* Subscribe to land detector */</span>
	<span class="kt">int</span> <span class="n">land_detector_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_land_detected</span><span class="p">));</span>
	<span class="n">land_detector</span><span class="p">.</span><span class="n">landed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* Subscribe to command topic */</span>
	<span class="kt">int</span> <span class="n">cmd_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_command</span><span class="p">));</span>

	<span class="cm">/* Subscribe to parameters changed topic */</span>
	<span class="kt">int</span> <span class="n">param_changed_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">parameter_update</span><span class="p">));</span>

	<span class="cm">/* Subscribe to battery topic */</span>
	<span class="kt">int</span> <span class="n">battery_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">battery_status</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">battery</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">battery</span><span class="p">));</span>

	<span class="cm">/* Subscribe to subsystem info topic */</span>
	<span class="kt">int</span> <span class="n">subsys_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">subsystem_info</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">subsystem_info_s</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>

	<span class="cm">/* Subscribe to system power */</span>
	<span class="kt">int</span> <span class="n">system_power_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">system_power</span><span class="p">));</span>

	<span class="cm">/* Subscribe to actuator controls (outputs) */</span>
	<span class="kt">int</span> <span class="n">actuator_controls_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID_VEHICLE_ATTITUDE_CONTROLS</span><span class="p">);</span>

	<span class="cm">/* Subscribe to vtol vehicle status topic */</span>
	<span class="kt">int</span> <span class="n">vtol_vehicle_status_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vtol_vehicle_status</span><span class="p">));</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>struct vtol_vehicle_status_s vtol_status;</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vtol_status</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vtol_status</span><span class="p">));</span>
	<span class="n">vtol_status</span><span class="p">.</span><span class="n">vtol_in_rw_mode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>		<span class="c1">//default for vtol is rotary wing</span>

	<span class="cm">/* subscribe to estimator status topic */</span>
	<span class="kt">int</span> <span class="n">estimator_status_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">estimator_status</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">estimator_status_s</span> <span class="n">estimator_status</span><span class="p">;</span>

	<span class="cm">/* class variables used to check for navigation failure after takeoff */</span>
	<span class="n">hrt_abstime</span> <span class="n">time_at_takeoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// last time we were on the ground</span>
	<span class="n">hrt_abstime</span> <span class="n">time_last_innov_pass</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// last time velocity innovations passed</span>
	<span class="kt">bool</span> <span class="n">nav_test_passed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// true if the post takeoff navigation test has passed</span>
	<span class="kt">bool</span> <span class="n">nav_test_failed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="c1">// true if the post takeoff navigation test has failed</span>

	<span class="kt">int</span> <span class="n">cpuload_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">cpuload</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpuload</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cpuload</span><span class="p">));</span>

	<span class="n">control_status_leds</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">armed</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">battery</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpuload</span><span class="p">);</span>

	<span class="n">thread_running</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* update vehicle status to find out vehicle type (required for preflight checks) */</span>
	<span class="kt">int32_t</span> <span class="n">system_type</span><span class="p">;</span>
	<span class="n">param_get</span><span class="p">(</span><span class="n">_param_sys_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">system_type</span><span class="p">);</span> <span class="c1">// get system type</span>
	<span class="n">status</span><span class="p">.</span><span class="n">system_type</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">system_type</span><span class="p">;</span>
	<span class="n">status</span><span class="p">.</span><span class="n">is_rotary_wing</span> <span class="o">=</span> <span class="n">is_rotary_wing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">)</span> <span class="o">||</span> <span class="n">is_vtol</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">status</span><span class="p">.</span><span class="n">is_vtol</span> <span class="o">=</span> <span class="n">is_vtol</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">commander_boot_timestamp</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <p>initially set to failed</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="n">_last_lpos_fail_time_us</span> <span class="o">=</span> <span class="n">commander_boot_timestamp</span><span class="p">;</span>
	<span class="n">_last_gpos_fail_time_us</span> <span class="o">=</span> <span class="n">commander_boot_timestamp</span><span class="p">;</span>
	<span class="n">_last_lvel_fail_time_us</span> <span class="o">=</span> <span class="n">commander_boot_timestamp</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>Run preflight check</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="kt">int32_t</span> <span class="n">rc_in_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">param_get</span><span class="p">(</span><span class="n">_param_rc_in_off</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc_in_off</span><span class="p">);</span>

	<span class="kt">int32_t</span> <span class="n">arm_switch_is_button</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">param_get</span><span class="p">(</span><span class="n">_param_arm_switch_is_button</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arm_switch_is_button</span><span class="p">);</span>

	<span class="kt">int32_t</span> <span class="n">arm_without_gps_param</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">param_get</span><span class="p">(</span><span class="n">_param_arm_without_gps</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arm_without_gps_param</span><span class="p">);</span>
	<span class="n">arm_requirements</span> <span class="o">=</span> <span class="p">(</span><span class="n">arm_without_gps_param</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="nl">ARM_REQ_NONE</span> <span class="p">:</span> <span class="n">ARM_REQ_GPS_BIT</span><span class="p">;</span>

	<span class="kt">int32_t</span> <span class="n">arm_mission_required_param</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">param_get</span><span class="p">(</span><span class="n">_param_arm_mission_required</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arm_mission_required_param</span><span class="p">);</span>
	<span class="n">arm_requirements</span> <span class="o">|=</span> <span class="p">(</span><span class="n">arm_mission_required_param</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ARM_REQ_MISSION_BIT</span> <span class="o">|</span> <span class="n">ARM_REQ_ARM_AUTH_BIT</span><span class="p">));</span>

	<span class="n">status</span><span class="p">.</span><span class="n">rc_input_mode</span> <span class="o">=</span> <span class="n">rc_in_off</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <p>user adjustable duration required to assert arm/disarm via throttle/rudder stick</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="kt">int32_t</span> <span class="n">rc_arm_hyst</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">param_get</span><span class="p">(</span><span class="n">_param_rc_arm_hyst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc_arm_hyst</span><span class="p">);</span>
	<span class="n">rc_arm_hyst</span> <span class="o">*=</span> <span class="n">COMMANDER_MONITORING_LOOPSPERMSEC</span><span class="p">;</span>

	<span class="kt">int32_t</span> <span class="n">datalink_loss_act</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int32_t</span> <span class="n">rc_loss_act</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int32_t</span> <span class="n">datalink_loss_timeout</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="kt">int32_t</span> <span class="n">highlatencydatalink_loss_timeout</span> <span class="o">=</span> <span class="mi">120</span><span class="p">;</span>
	<span class="kt">float</span> <span class="n">rc_loss_timeout</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">;</span>
	<span class="kt">int32_t</span> <span class="n">datalink_regain_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int32_t</span> <span class="n">highlatencydatalink_regain_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">float</span> <span class="n">offboard_loss_timeout</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
	<span class="kt">int32_t</span> <span class="n">offboard_loss_act</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int32_t</span> <span class="n">offboard_loss_rc_act</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int32_t</span> <span class="n">posctl_nav_loss_act</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="kt">int32_t</span> <span class="n">geofence_action</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="kt">int32_t</span> <span class="n">flight_uuid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* RC override auto modes */</span>
	<span class="kt">int32_t</span> <span class="n">rc_override</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="kt">int32_t</span> <span class="n">takeoff_complete_act</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Thresholds for engine failure detection */</span>
	<span class="kt">float</span> <span class="n">ef_throttle_thres</span> <span class="o">=</span> <span class="mf">1.0f</span><span class="p">;</span>
	<span class="kt">float</span> <span class="n">ef_current2throttle_thres</span> <span class="o">=</span> <span class="mf">0.0f</span><span class="p">;</span>
	<span class="kt">float</span> <span class="n">ef_time_thres</span> <span class="o">=</span> <span class="mf">1000.0f</span><span class="p">;</span>
	<span class="kt">uint64_t</span> <span class="n">timestamp_engine_healthy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/**&lt; absolute time when engine was healty */</span>

	<span class="kt">int32_t</span> <span class="n">disarm_when_landed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int32_t</span> <span class="n">low_bat_action</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* check which state machines for changes, clear &quot;changed&quot; flag */</span>
	<span class="kt">bool</span> <span class="n">main_state_changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">bool</span> <span class="n">failsafe_old</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="kt">bool</span> <span class="n">have_taken_off_since_arming</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* initialize low priority thread */</span>
	<span class="n">pthread_attr_t</span> <span class="n">commander_low_prio_attr</span><span class="p">;</span>
	<span class="n">pthread_attr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commander_low_prio_attr</span><span class="p">);</span>
	<span class="n">pthread_attr_setstacksize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commander_low_prio_attr</span><span class="p">,</span> <span class="n">PX4_STACK_ADJUSTED</span><span class="p">(</span><span class="mi">3000</span><span class="p">));</span>

<span class="cp">#ifndef __PX4_QURT</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <p>This is not supported by QURT (yet).</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="k">struct</span> <span class="n">sched_param</span> <span class="n">param</span><span class="p">;</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">pthread_attr_getschedparam</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commander_low_prio_attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>

	<span class="cm">/* low priority */</span>
	<span class="n">param</span><span class="p">.</span><span class="n">sched_priority</span> <span class="o">=</span> <span class="n">SCHED_PRIORITY_DEFAULT</span> <span class="o">-</span> <span class="mi">50</span><span class="p">;</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">pthread_attr_setschedparam</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commander_low_prio_attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commander_low_prio_thread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">commander_low_prio_attr</span><span class="p">,</span> <span class="n">commander_low_prio_loop</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
	<span class="n">pthread_attr_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commander_low_prio_attr</span><span class="p">);</span>

	<span class="n">arm_auth_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">.</span><span class="n">system_id</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">should_exit</span><span class="p">())</span> <span class="p">{</span>

		<span class="n">transition_result_t</span> <span class="n">arming_ret</span> <span class="o">=</span> <span class="n">TRANSITION_NOT_CHANGED</span><span class="p">;</span>

		<span class="cm">/* update parameters */</span>
		<span class="kt">bool</span> <span class="n">params_updated</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">orb_check</span><span class="p">(</span><span class="n">param_changed_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params_updated</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">params_updated</span> <span class="o">||</span> <span class="n">param_init_forced</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* parameters changed */</span>
			<span class="k">struct</span> <span class="n">parameter_update_s</span> <span class="n">param_changed</span><span class="p">;</span>
			<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">parameter_update</span><span class="p">),</span> <span class="n">param_changed_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">param_changed</span><span class="p">);</span>

			<span class="n">updateParams</span><span class="p">();</span>

			<span class="cm">/* update parameters */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">param_get</span><span class="p">(</span><span class="n">_param_sys_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">system_type</span><span class="p">)</span> <span class="o">!=</span> <span class="n">OK</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">PX4_ERR</span><span class="p">(</span><span class="s">&quot;failed getting new system type&quot;</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">status</span><span class="p">.</span><span class="n">system_type</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">system_type</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* disable manual override for all systems that rely on electronic stabilization */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_rotary_wing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">is_vtol</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">vtol_status</span><span class="p">.</span><span class="n">vtol_in_rw_mode</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">status</span><span class="p">.</span><span class="n">is_rotary_wing</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">status</span><span class="p">.</span><span class="n">is_rotary_wing</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* set vehicle_status.is_vtol flag */</span>
				<span class="n">status</span><span class="p">.</span><span class="n">is_vtol</span> <span class="o">=</span> <span class="n">is_vtol</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>

				<span class="cm">/* check and update system / component ID */</span>
				<span class="kt">int32_t</span> <span class="n">sys_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">param_get</span><span class="p">(</span><span class="n">_param_system_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sys_id</span><span class="p">);</span>
				<span class="n">status</span><span class="p">.</span><span class="n">system_id</span> <span class="o">=</span> <span class="n">sys_id</span><span class="p">;</span>

				<span class="kt">int32_t</span> <span class="n">comp_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">param_get</span><span class="p">(</span><span class="n">_param_component_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">comp_id</span><span class="p">);</span>
				<span class="n">status</span><span class="p">.</span><span class="n">component_id</span> <span class="o">=</span> <span class="n">comp_id</span><span class="p">;</span>

				<span class="n">get_circuit_breaker_params</span><span class="p">();</span>

				<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Safety parameters */</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_enable_datalink_loss</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">datalink_loss_act</span><span class="p">);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_enable_rc_loss</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc_loss_act</span><span class="p">);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_datalink_loss_timeout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">datalink_loss_timeout</span><span class="p">);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_highlatencydatalink_loss_timeout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">highlatencydatalink_loss_timeout</span><span class="p">);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_rc_loss_timeout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc_loss_timeout</span><span class="p">);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_rc_in_off</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc_in_off</span><span class="p">);</span>
			<span class="n">status</span><span class="p">.</span><span class="n">rc_input_mode</span> <span class="o">=</span> <span class="n">rc_in_off</span><span class="p">;</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_rc_arm_hyst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc_arm_hyst</span><span class="p">);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_min_stick_change</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">min_stick_change</span><span class="p">);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_rc_override</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc_override</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      <p>percentage (* 0.01) needs to be doubled because RC total interval is 2, not 1</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="n">min_stick_change</span> <span class="o">*=</span> <span class="mf">0.02f</span><span class="p">;</span>
			<span class="n">rc_arm_hyst</span> <span class="o">*=</span> <span class="n">COMMANDER_MONITORING_LOOPSPERMSEC</span><span class="p">;</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_datalink_regain_timeout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">datalink_regain_timeout</span><span class="p">);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_highlatencydatalink_regain_timeout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">highlatencydatalink_regain_timeout</span><span class="p">);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_ef_throttle_thres</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ef_throttle_thres</span><span class="p">);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_ef_current2throttle_thres</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ef_current2throttle_thres</span><span class="p">);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_ef_time_thres</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ef_time_thres</span><span class="p">);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_geofence_action</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">geofence_action</span><span class="p">);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_disarm_land</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">disarm_when_landed</span><span class="p">);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_flight_uuid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flight_uuid</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      <p>If we update parameters the first time
make sure the hysteresis time gets set.
After that it will be set in the main state
machine based on the arming state.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">param_init_forced</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">auto_disarm_hysteresis</span><span class="p">.</span><span class="n">set_hysteresis_time_from</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="n">disarm_when_landed</span> <span class="o">*</span> <span class="mi">1</span><span class="n">_s</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_low_bat_act</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">low_bat_action</span><span class="p">);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_offboard_loss_timeout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offboard_loss_timeout</span><span class="p">);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_offboard_loss_act</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offboard_loss_act</span><span class="p">);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_offboard_loss_rc_act</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offboard_loss_rc_act</span><span class="p">);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_arm_switch_is_button</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arm_switch_is_button</span><span class="p">);</span>

			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_arm_without_gps</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arm_without_gps_param</span><span class="p">);</span>
			<span class="n">arm_requirements</span> <span class="o">=</span> <span class="p">(</span><span class="n">arm_without_gps_param</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="nl">ARM_REQ_NONE</span> <span class="p">:</span> <span class="n">ARM_REQ_GPS_BIT</span><span class="p">;</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_arm_mission_required</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arm_mission_required_param</span><span class="p">);</span>
			<span class="n">arm_requirements</span> <span class="o">|=</span> <span class="p">(</span><span class="n">arm_mission_required_param</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ARM_REQ_MISSION_BIT</span> <span class="o">|</span> <span class="n">ARM_REQ_ARM_AUTH_BIT</span><span class="p">));</span>

			<span class="cm">/* flight mode slots */</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_fmode_1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_flight_mode_slots</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_fmode_2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_flight_mode_slots</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_fmode_3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_flight_mode_slots</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_fmode_4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_flight_mode_slots</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_fmode_5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_flight_mode_slots</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_fmode_6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_flight_mode_slots</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>

			<span class="cm">/* failsafe response to loss of navigation accuracy */</span>
			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_posctl_nav_loss_act</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">posctl_nav_loss_act</span><span class="p">);</span>

			<span class="n">param_get</span><span class="p">(</span><span class="n">_param_takeoff_finished_action</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">takeoff_complete_act</span><span class="p">);</span>

			<span class="n">param_init_forced</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* handle power button state */</span>
		<span class="n">orb_check</span><span class="p">(</span><span class="n">power_button_state_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">power_button_state_s</span> <span class="n">button_state</span><span class="p">;</span>
			<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">power_button_state</span><span class="p">),</span> <span class="n">power_button_state_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">button_state</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">button_state</span><span class="p">.</span><span class="n">event</span> <span class="o">==</span> <span class="n">power_button_state_s</span><span class="o">::</span><span class="n">PWR_BUTTON_STATE_REQUEST_SHUTDOWN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">px4_shutdown_request</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">orb_check</span><span class="p">(</span><span class="n">sp_man_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">manual_control_setpoint</span><span class="p">),</span> <span class="n">sp_man_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sp_man</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">orb_check</span><span class="p">(</span><span class="n">offboard_control_mode_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">offboard_control_mode</span><span class="p">),</span> <span class="n">offboard_control_mode_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offboard_control_mode</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">offboard_control_mode</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">offboard_control_mode</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">+</span> <span class="n">OFFBOARD_TIMEOUT</span> <span class="o">&gt;</span> <span class="n">hrt_absolute_time</span><span class="p">())</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status_flags</span><span class="p">.</span><span class="n">offboard_control_signal_lost</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status_flags</span><span class="p">.</span><span class="n">offboard_control_signal_lost</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">status_flags</span><span class="p">.</span><span class="n">offboard_control_loss_timeout</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status_flags</span><span class="p">.</span><span class="n">offboard_control_signal_lost</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status_flags</span><span class="p">.</span><span class="n">offboard_control_signal_lost</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* check timer if offboard was there but now lost */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status_flags</span><span class="p">.</span><span class="n">offboard_control_loss_timeout</span> <span class="o">&amp;&amp;</span> <span class="n">offboard_control_mode</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">offboard_loss_timeout</span> <span class="o">&lt;</span> <span class="n">FLT_EPSILON</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* execute loss action immediately */</span>
					<span class="n">status_flags</span><span class="p">.</span><span class="n">offboard_control_loss_timeout</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* wait for timeout if set */</span>
					<span class="n">status_flags</span><span class="p">.</span><span class="n">offboard_control_loss_timeout</span> <span class="o">=</span> <span class="n">offboard_control_mode</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">+</span>
							<span class="n">OFFBOARD_TIMEOUT</span> <span class="o">+</span> <span class="n">offboard_loss_timeout</span> <span class="o">*</span> <span class="mf">1e6</span><span class="n">f</span> <span class="o">&lt;</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">status_flags</span><span class="p">.</span><span class="n">offboard_control_loss_timeout</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      <p>poll the telemetry status</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="n">poll_telemetry_status</span><span class="p">();</span>

		<span class="n">orb_check</span><span class="p">(</span><span class="n">system_power_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">system_power_s</span> <span class="n">system_power</span> <span class="o">=</span> <span class="p">{};</span>
			<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">system_power</span><span class="p">),</span> <span class="n">system_power_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">system_power</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">system_power</span><span class="p">.</span><span class="n">timestamp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="n">_ms</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">system_power</span><span class="p">.</span><span class="n">servo_valid</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="n">system_power</span><span class="p">.</span><span class="n">brick_valid</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="n">system_power</span><span class="p">.</span><span class="n">usb_connected</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* flying only on servo rail, this is unsafe */</span>
					<span class="n">status_flags</span><span class="p">.</span><span class="n">condition_power_input_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">status_flags</span><span class="p">.</span><span class="n">condition_power_input_valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* if the USB hardware connection went away, reboot */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status_flags</span><span class="p">.</span><span class="n">usb_connected</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">system_power</span><span class="p">.</span><span class="n">usb_connected</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/*</span>
<span class="cm">					 * apparently the USB cable went away but we are still powered,</span>
<span class="cm">					 * so lets reset to a classic non-usb state.</span>
<span class="cm">					 */</span>
					<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;USB disconnected, rebooting.&quot;</span><span class="p">)</span>
					<span class="n">usleep</span><span class="p">(</span><span class="mi">400000</span><span class="p">);</span>
					<span class="n">px4_shutdown_request</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* update safety topic */</span>
		<span class="n">orb_check</span><span class="p">(</span><span class="n">safety_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">bool</span> <span class="n">previous_safety_off</span> <span class="o">=</span> <span class="n">safety</span><span class="p">.</span><span class="n">safety_off</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">safety</span><span class="p">),</span> <span class="n">safety_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">safety</span><span class="p">)</span> <span class="o">==</span> <span class="n">PX4_OK</span><span class="p">)</span> <span class="p">{</span>

				<span class="cm">/* disarm if safety is now on and still armed */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">hil_state</span> <span class="o">==</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">HIL_STATE_OFF</span><span class="p">)</span>
				    <span class="o">&amp;&amp;</span> <span class="n">safety</span><span class="p">.</span><span class="n">safety_switch_available</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">safety</span><span class="p">.</span><span class="n">safety_off</span><span class="p">)</span> <span class="p">{</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">TRANSITION_CHANGED</span> <span class="o">==</span> <span class="n">arming_state_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="n">battery</span><span class="p">,</span> <span class="n">safety</span><span class="p">,</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">ARMING_STATE_STANDBY</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">armed</span><span class="p">,</span> <span class="nb">true</span> <span class="cm">/* fRunPreArmChecks */</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">status_flags</span><span class="p">,</span> <span class="n">arm_requirements</span><span class="p">,</span> <span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commander_boot_timestamp</span><span class="p">))</span>
					   <span class="p">)</span> <span class="p">{</span>
						<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      <p>Notify the user if the status of the safety switch changes</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>				<span class="k">if</span> <span class="p">(</span><span class="n">safety</span><span class="p">.</span><span class="n">safety_switch_available</span> <span class="o">&amp;&amp;</span> <span class="n">previous_safety_off</span> <span class="o">!=</span> <span class="n">safety</span><span class="p">.</span><span class="n">safety_off</span><span class="p">)</span> <span class="p">{</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">safety</span><span class="p">.</span><span class="n">safety_off</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">set_tune</span><span class="p">(</span><span class="n">TONE_NOTIFY_POSITIVE_TUNE</span><span class="p">);</span>

					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">tune_neutral</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
					<span class="p">}</span>

					<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* update vtol vehicle status*/</span>
		<span class="n">orb_check</span><span class="p">(</span><span class="n">vtol_vehicle_status_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* vtol status changed */</span>
			<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vtol_vehicle_status</span><span class="p">),</span> <span class="n">vtol_vehicle_status_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vtol_status</span><span class="p">);</span>
			<span class="n">status</span><span class="p">.</span><span class="n">vtol_fw_permanent_stab</span> <span class="o">=</span> <span class="n">vtol_status</span><span class="p">.</span><span class="n">fw_permanent_stab</span><span class="p">;</span>

			<span class="cm">/* Make sure that this is only adjusted if vehicle really is of type vtol */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_vtol</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      <p>Check if there has been any change while updating the flags</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>				<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">is_rotary_wing</span> <span class="o">!=</span> <span class="n">vtol_status</span><span class="p">.</span><span class="n">vtol_in_rw_mode</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">status</span><span class="p">.</span><span class="n">is_rotary_wing</span> <span class="o">=</span> <span class="n">vtol_status</span><span class="p">.</span><span class="n">vtol_in_rw_mode</span><span class="p">;</span>
					<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">in_transition_mode</span> <span class="o">!=</span> <span class="n">vtol_status</span><span class="p">.</span><span class="n">vtol_in_trans_mode</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">status</span><span class="p">.</span><span class="n">in_transition_mode</span> <span class="o">=</span> <span class="n">vtol_status</span><span class="p">.</span><span class="n">vtol_in_trans_mode</span><span class="p">;</span>
					<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">in_transition_to_fw</span> <span class="o">!=</span> <span class="n">vtol_status</span><span class="p">.</span><span class="n">in_transition_to_fw</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">status</span><span class="p">.</span><span class="n">in_transition_to_fw</span> <span class="o">=</span> <span class="n">vtol_status</span><span class="p">.</span><span class="n">in_transition_to_fw</span><span class="p">;</span>
					<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">status_flags</span><span class="p">.</span><span class="n">vtol_transition_failure</span> <span class="o">!=</span> <span class="n">vtol_status</span><span class="p">.</span><span class="n">vtol_transition_failsafe</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">status_flags</span><span class="p">.</span><span class="n">vtol_transition_failure</span> <span class="o">=</span> <span class="n">vtol_status</span><span class="p">.</span><span class="n">vtol_transition_failsafe</span><span class="p">;</span>
					<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">armed</span><span class="p">.</span><span class="n">soft_stop</span> <span class="o">!=</span> <span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">is_rotary_wing</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">armed</span><span class="p">.</span><span class="n">soft_stop</span> <span class="o">=</span> <span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">is_rotary_wing</span><span class="p">;</span>
					<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">_local_position_sub</span><span class="p">.</span><span class="n">update</span><span class="p">();</span>
		<span class="n">_global_position_sub</span><span class="p">.</span><span class="n">update</span><span class="p">();</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      <p>Set the allowable positon uncertainty based on combination of flight and estimator state
When we are in a operator demanded position control mode and are solely reliant on optical flow, do not check position error becasue it will gradually increase throughout flight and the operator will compensate for the drift</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="kt">bool</span> <span class="n">reliant_on_opt_flow</span> <span class="o">=</span> <span class="p">((</span><span class="n">estimator_status</span><span class="p">.</span><span class="n">control_mode_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">estimator_status_s</span><span class="o">::</span><span class="n">CS_OPT_FLOW</span><span class="p">))</span>
					    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">estimator_status</span><span class="p">.</span><span class="n">control_mode_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">estimator_status_s</span><span class="o">::</span><span class="n">CS_GPS</span><span class="p">))</span>
					    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">estimator_status</span><span class="p">.</span><span class="n">control_mode_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">estimator_status_s</span><span class="o">::</span><span class="n">CS_EV_POS</span><span class="p">)));</span>
		<span class="kt">bool</span> <span class="n">operator_controlled_position</span> <span class="o">=</span> <span class="p">(</span><span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_POSCTL</span><span class="p">);</span>
		<span class="n">_skip_pos_accuracy_check</span> <span class="o">=</span> <span class="n">reliant_on_opt_flow</span> <span class="o">&amp;&amp;</span> <span class="n">operator_controlled_position</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">_skip_pos_accuracy_check</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">_eph_threshold_adj</span> <span class="o">=</span> <span class="n">INFINITY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">_eph_threshold_adj</span> <span class="o">=</span> <span class="n">_eph_threshold</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
		<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      <p>Check if quality checking of position accuracy and consistency is to be performed</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="k">const</span> <span class="kt">bool</span> <span class="n">run_quality_checks</span> <span class="o">=</span> <span class="o">!</span><span class="n">status_flags</span><span class="p">.</span><span class="n">circuit_breaker_engaged_posfailure_check</span><span class="p">;</span>

		<span class="cm">/* Check estimator status for signs of bad yaw induced post takeoff navigation failure</span>
<span class="cm">		 * for a short time interval after takeoff. Fixed wing vehicles can recover using GPS heading,</span>
<span class="cm">		 * but rotary wing vehicles cannot so the position and velocity validity needs to be latched</span>
<span class="cm">		 * to false after failure to prevent flyaway crashes */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">run_quality_checks</span> <span class="o">&amp;&amp;</span> <span class="n">status</span><span class="p">.</span><span class="n">is_rotary_wing</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">bool</span> <span class="n">estimator_status_updated</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">orb_check</span><span class="p">(</span><span class="n">estimator_status_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">estimator_status_updated</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">estimator_status_updated</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">estimator_status</span><span class="p">),</span> <span class="n">estimator_status_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">estimator_status</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">arming_state</span> <span class="o">==</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">ARMING_STATE_STANDBY</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      <p>reset flags and timer</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>					<span class="n">time_at_takeoff</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>
					<span class="n">nav_test_failed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">nav_test_passed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">land_detector</span><span class="p">.</span><span class="n">landed</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      <p>record time of takeoff</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>					<span class="n">time_at_takeoff</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      <p>if nav status is unconfirmed, confirm yaw angle as passed after 30 seconds or achieving 5 m/s of speed</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>					<span class="k">const</span> <span class="kt">bool</span> <span class="n">sufficient_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">time_at_takeoff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="n">_s</span><span class="p">);</span>

					<span class="k">const</span> <span class="n">vehicle_local_position_s</span> <span class="o">&amp;</span><span class="n">lpos</span> <span class="o">=</span> <span class="n">_local_position_sub</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
					<span class="k">const</span> <span class="kt">bool</span> <span class="n">sufficient_speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">lpos</span><span class="p">.</span><span class="n">vx</span> <span class="o">*</span> <span class="n">lpos</span><span class="p">.</span><span class="n">vx</span> <span class="o">+</span> <span class="n">lpos</span><span class="p">.</span><span class="n">vy</span> <span class="o">*</span> <span class="n">lpos</span><span class="p">.</span><span class="n">vy</span> <span class="o">&gt;</span> <span class="mf">25.0f</span><span class="p">);</span>

					<span class="kt">bool</span> <span class="n">innovation_pass</span> <span class="o">=</span> <span class="n">estimator_status</span><span class="p">.</span><span class="n">vel_test_ratio</span> <span class="o">&lt;</span> <span class="mf">1.0f</span> <span class="o">&amp;&amp;</span> <span class="n">estimator_status</span><span class="p">.</span><span class="n">pos_test_ratio</span> <span class="o">&lt;</span> <span class="mf">1.0f</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nav_test_failed</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nav_test_passed</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      <p>pass if sufficient time or speed</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>							<span class="k">if</span> <span class="p">(</span><span class="n">sufficient_time</span> <span class="o">||</span> <span class="n">sufficient_speed</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">nav_test_passed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
							<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      <p>record the last time the innovation check passed</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>							<span class="k">if</span> <span class="p">(</span><span class="n">innovation_pass</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">time_last_innov_pass</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>
							<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      <p>if the innovation test has failed continuously, declare the nav as failed</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>							<span class="k">if</span> <span class="p">(</span><span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">time_last_innov_pass</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="n">_s</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">nav_test_failed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
								<span class="n">mavlink_log_emergency</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;CRITICAL NAVIGATION FAILURE - CHECK SENSOR CALIBRATION&quot;</span><span class="p">);</span>
							<span class="p">}</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* run global position accuracy checks */</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      <p>Check if quality checking of position accuracy and consistency is to be performed</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">run_quality_checks</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nav_test_failed</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status_flags</span><span class="p">.</span><span class="n">condition_global_position_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">status_flags</span><span class="p">.</span><span class="n">condition_local_position_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">status_flags</span><span class="p">.</span><span class="n">condition_local_velocity_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_skip_pos_accuracy_check</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-44'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-44'>#</a>
      </div>
      <p>use global position message to determine validity</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>					<span class="k">const</span> <span class="n">vehicle_global_position_s</span><span class="o">&amp;</span><span class="n">global_position</span> <span class="o">=</span> <span class="n">_global_position_sub</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
					<span class="n">check_posvel_validity</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="n">global_position</span><span class="p">.</span><span class="n">eph</span><span class="p">,</span> <span class="n">_eph_threshold_adj</span><span class="p">,</span> <span class="n">global_position</span><span class="p">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_last_gpos_fail_time_us</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_gpos_probation_time_us</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_flags</span><span class="p">.</span><span class="n">condition_global_position_valid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_changed</span><span class="p">);</span>
				<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-45'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-45'>#</a>
      </div>
      <p>use local position message to determine validity</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>				<span class="k">const</span> <span class="n">vehicle_local_position_s</span> <span class="o">&amp;</span><span class="n">local_position</span> <span class="o">=</span> <span class="n">_local_position_sub</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
				<span class="n">check_posvel_validity</span><span class="p">(</span><span class="n">local_position</span><span class="p">.</span><span class="n">xy_valid</span><span class="p">,</span> <span class="n">local_position</span><span class="p">.</span><span class="n">eph</span><span class="p">,</span> <span class="n">_eph_threshold_adj</span><span class="p">,</span> <span class="n">local_position</span><span class="p">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_last_lpos_fail_time_us</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_lpos_probation_time_us</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_flags</span><span class="p">.</span><span class="n">condition_local_position_valid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_changed</span><span class="p">);</span>
				<span class="n">check_posvel_validity</span><span class="p">(</span><span class="n">local_position</span><span class="p">.</span><span class="n">v_xy_valid</span><span class="p">,</span> <span class="n">local_position</span><span class="p">.</span><span class="n">evh</span><span class="p">,</span> <span class="n">_evh_threshold</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">local_position</span><span class="p">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_last_lvel_fail_time_us</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_lvel_probation_time_us</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_flags</span><span class="p">.</span><span class="n">condition_local_velocity_valid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_changed</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">((</span><span class="n">_last_condition_global_position_valid</span> <span class="o">!=</span> <span class="n">status_flags</span><span class="p">.</span><span class="n">condition_global_position_valid</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">status_flags</span><span class="p">.</span><span class="n">condition_global_position_valid</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-46'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-46'>#</a>
      </div>
      <p>If global position state changed and is now valid, set respective health flags to true. For now also assume GPS is OK if global pos is OK, but not vice versa.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="n">set_health_flags_healthy</span><span class="p">(</span><span class="n">subsystem_info_s</span><span class="o">::</span><span class="n">SUBSYSTEM_TYPE_AHRS</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="n">set_health_flags_present_healthy</span><span class="p">(</span><span class="n">subsystem_info_s</span><span class="o">::</span><span class="n">SUBSYSTEM_TYPE_GPS</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">check_valid</span><span class="p">(</span><span class="n">_local_position_sub</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">_failsafe_pos_delay</span><span class="p">.</span><span class="n">get</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1</span><span class="n">_s</span><span class="p">,</span> <span class="n">_local_position_sub</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">z_valid</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">status_flags</span><span class="p">.</span><span class="n">condition_local_altitude_valid</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">status_changed</span><span class="p">);</span>

		<span class="cm">/* Update land detector */</span>
		<span class="n">orb_check</span><span class="p">(</span><span class="n">land_detector_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_land_detected</span><span class="p">),</span> <span class="n">land_detector_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">land_detector</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-47'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-47'>#</a>
      </div>
      <p>Only take actions if armed</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">was_landed</span> <span class="o">!=</span> <span class="n">land_detector</span><span class="p">.</span><span class="n">landed</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">land_detector</span><span class="p">.</span><span class="n">landed</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">mavlink_and_console_log_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;Landing detected&quot;</span><span class="p">);</span>

					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">mavlink_and_console_log_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;Takeoff detected&quot;</span><span class="p">);</span>
						<span class="n">have_taken_off_since_arming</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-48'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-48'>#</a>
      </div>
      <p>Set all position and velocity test probation durations to takeoff value
This is a larger value to give the vehicle time to complete a failsafe landing
if faulty sensors cause loss of navigation shortly after takeoff.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>						<span class="n">_gpos_probation_time_us</span> <span class="o">=</span> <span class="n">_failsafe_pos_probation</span><span class="p">.</span><span class="n">get</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1</span><span class="n">_s</span><span class="p">;</span>
						<span class="n">_lpos_probation_time_us</span> <span class="o">=</span> <span class="n">_failsafe_pos_probation</span><span class="p">.</span><span class="n">get</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1</span><span class="n">_s</span><span class="p">;</span>
						<span class="n">_lvel_probation_time_us</span> <span class="o">=</span> <span class="n">_failsafe_pos_probation</span><span class="p">.</span><span class="n">get</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1</span><span class="n">_s</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">was_falling</span> <span class="o">!=</span> <span class="n">land_detector</span><span class="p">.</span><span class="n">freefall</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">land_detector</span><span class="p">.</span><span class="n">freefall</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">mavlink_and_console_log_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;Freefall detected&quot;</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">was_landed</span> <span class="o">=</span> <span class="n">land_detector</span><span class="p">.</span><span class="n">landed</span><span class="p">;</span>
			<span class="n">was_falling</span> <span class="o">=</span> <span class="n">land_detector</span><span class="p">.</span><span class="n">freefall</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Update hysteresis time. Use a time of factor 5 longer if we have not taken off yet. */</span>
		<span class="n">hrt_abstime</span> <span class="n">timeout_time</span> <span class="o">=</span> <span class="n">disarm_when_landed</span> <span class="o">*</span> <span class="mi">1</span><span class="n">_s</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">have_taken_off_since_arming</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">timeout_time</span> <span class="o">*=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">auto_disarm_hysteresis</span><span class="p">.</span><span class="n">set_hysteresis_time_from</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="n">timeout_time</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-49'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-49'>#</a>
      </div>
      <p>Check for auto-disarm</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span> <span class="o">&amp;&amp;</span> <span class="n">land_detector</span><span class="p">.</span><span class="n">landed</span> <span class="o">&amp;&amp;</span> <span class="n">disarm_when_landed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">auto_disarm_hysteresis</span><span class="p">.</span><span class="n">set_state_and_update</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">auto_disarm_hysteresis</span><span class="p">.</span><span class="n">set_state_and_update</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">auto_disarm_hysteresis</span><span class="p">.</span><span class="n">get_state</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">arm_disarm</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;auto disarm on land&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">warning_action_on</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-50'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-50'>#</a>
      </div>
      <p>store the last good main_state when not in an navigation
hold state</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="n">main_state_before_rtl</span> <span class="o">=</span> <span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">!=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_RTL</span>
			   <span class="o">&amp;&amp;</span> <span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">!=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_LOITER</span>
			   <span class="o">&amp;&amp;</span> <span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">!=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_LAND</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-51'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-51'>#</a>
      </div>
      <p>reset flag again when we switched out of it</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="n">warning_action_on</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">orb_check</span><span class="p">(</span><span class="n">cpuload_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">cpuload</span><span class="p">),</span> <span class="n">cpuload_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpuload</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* update battery status */</span>
		<span class="n">orb_check</span><span class="p">(</span><span class="n">battery_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">battery_status</span><span class="p">),</span> <span class="n">battery_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">battery</span><span class="p">);</span>

			<span class="cm">/* only consider battery voltage if system has been running 6s (usb most likely detected) and battery voltage is valid */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commander_boot_timestamp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="n">_s</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="n">battery</span><span class="p">.</span><span class="n">voltage_filtered_v</span> <span class="o">&gt;</span> <span class="mf">2.0f</span> <span class="o">*</span> <span class="n">FLT_EPSILON</span><span class="p">)</span> <span class="p">{</span>

				<span class="cm">/* if battery voltage is getting lower, warn using buzzer, etc. */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">battery</span><span class="p">.</span><span class="n">warning</span> <span class="o">==</span> <span class="n">battery_status_s</span><span class="o">::</span><span class="n">BATTERY_WARNING_LOW</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="n">low_battery_voltage_actions_done</span><span class="p">)</span> <span class="p">{</span>

					<span class="n">low_battery_voltage_actions_done</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;LOW BATTERY, RETURN TO LAND ADVISED&quot;</span><span class="p">);</span>

					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;LOW BATTERY, TAKEOFF DISCOURAGED&quot;</span><span class="p">);</span>
					<span class="p">}</span>

					<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">battery</span><span class="p">.</span><span class="n">warning</span> <span class="o">==</span> <span class="n">battery_status_s</span><span class="o">::</span><span class="n">BATTERY_WARNING_CRITICAL</span> <span class="o">&amp;&amp;</span>
					   <span class="o">!</span><span class="n">critical_battery_voltage_actions_done</span><span class="p">)</span> <span class="p">{</span>

					<span class="n">critical_battery_voltage_actions_done</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;CRITICAL BATTERY, SHUT SYSTEM DOWN&quot;</span><span class="p">);</span>

					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">low_bat_action</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">low_bat_action</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-52'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-52'>#</a>
      </div>
      <p>let us send the critical message even if already in RTL</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>							<span class="k">if</span> <span class="p">(</span><span class="n">TRANSITION_DENIED</span> <span class="o">!=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_RTL</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">))</span> <span class="p">{</span>
								<span class="n">warning_action_on</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
								<span class="n">mavlink_log_emergency</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;CRITICAL BATTERY, RETURNING TO LAND&quot;</span><span class="p">);</span>

							<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
								<span class="n">mavlink_log_emergency</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;CRITICAL BATTERY, RTL FAILED&quot;</span><span class="p">);</span>
							<span class="p">}</span>

						<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">low_bat_action</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">TRANSITION_DENIED</span> <span class="o">!=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_LAND</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">))</span> <span class="p">{</span>
								<span class="n">warning_action_on</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
								<span class="n">mavlink_log_emergency</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;CRITICAL BATTERY, LANDING AT CURRENT POSITION&quot;</span><span class="p">);</span>

							<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
								<span class="n">mavlink_log_emergency</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;CRITICAL BATTERY, LANDING FAILED&quot;</span><span class="p">);</span>
							<span class="p">}</span>

						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="n">mavlink_log_emergency</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;CRITICAL BATTERY, RETURN TO LAUNCH ADVISED!&quot;</span><span class="p">);</span>
						<span class="p">}</span>
					<span class="p">}</span>

					<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">battery</span><span class="p">.</span><span class="n">warning</span> <span class="o">==</span> <span class="n">battery_status_s</span><span class="o">::</span><span class="n">BATTERY_WARNING_EMERGENCY</span> <span class="o">&amp;&amp;</span>
					   <span class="o">!</span><span class="n">emergency_battery_voltage_actions_done</span><span class="p">)</span> <span class="p">{</span>

					<span class="n">emergency_battery_voltage_actions_done</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-53'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-53'>#</a>
      </div>
      <p>Request shutdown at the end of the cycle. This allows
the vehicle state to be published after emergency landing</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>						<span class="n">dangerous_battery_level_requests_poweroff</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">low_bat_action</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">low_bat_action</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">TRANSITION_CHANGED</span> <span class="o">==</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_LAND</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">))</span> <span class="p">{</span>
								<span class="n">warning_action_on</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
								<span class="n">mavlink_log_emergency</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;DANGEROUS BATTERY LEVEL, LANDING IMMEDIATELY&quot;</span><span class="p">);</span>

							<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
								<span class="n">mavlink_log_emergency</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;DANGEROUS BATTERY LEVEL, LANDING FAILED&quot;</span><span class="p">);</span>
							<span class="p">}</span>

						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="n">mavlink_log_emergency</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;DANGEROUS BATTERY LEVEL, LANDING ADVISED!&quot;</span><span class="p">);</span>
						<span class="p">}</span>
					<span class="p">}</span>

					<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* End battery voltage check */</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* update subsystem info which arrives from outside of commander*/</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">orb_check</span><span class="p">(</span><span class="n">subsys_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">subsystem_info</span><span class="p">),</span> <span class="n">subsys_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
				<span class="n">set_health_flags</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">subsystem_type</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">present</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">enabled</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">ok</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
				<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">updated</span><span class="p">);</span>

		<span class="cm">/* If in INIT state, try to proceed to STANDBY state */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status_flags</span><span class="p">.</span><span class="n">condition_calibration_enabled</span> <span class="o">&amp;&amp;</span> <span class="n">status</span><span class="p">.</span><span class="n">arming_state</span> <span class="o">==</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">ARMING_STATE_INIT</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">arming_ret</span> <span class="o">=</span> <span class="n">arming_state_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="n">battery</span><span class="p">,</span> <span class="n">safety</span><span class="p">,</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">ARMING_STATE_STANDBY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">armed</span><span class="p">,</span>
							     <span class="nb">true</span> <span class="cm">/* fRunPreArmChecks */</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_flags</span><span class="p">,</span>
							     <span class="n">arm_requirements</span><span class="p">,</span> <span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commander_boot_timestamp</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">arming_ret</span> <span class="o">==</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* do not complain if not allowed into standby */</span>
				<span class="n">arming_ret</span> <span class="o">=</span> <span class="n">TRANSITION_NOT_CHANGED</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* start mission result check */</span>
		<span class="k">const</span> <span class="k">auto</span> <span class="n">prev_mission_instance_count</span> <span class="o">=</span> <span class="n">_mission_result_sub</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">instance_count</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">_mission_result_sub</span><span class="p">.</span><span class="n">update</span><span class="p">())</span> <span class="p">{</span>
			<span class="k">const</span> <span class="n">mission_result_s</span> <span class="o">&amp;</span><span class="n">mission_result</span> <span class="o">=</span> <span class="n">_mission_result_sub</span><span class="p">.</span><span class="n">get</span><span class="p">();</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-54'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-54'>#</a>
      </div>
      <p>if mission_result is valid for the current mission</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="k">const</span> <span class="kt">bool</span> <span class="n">mission_result_ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">mission_result</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">&gt;</span> <span class="n">commander_boot_timestamp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mission_result</span><span class="p">.</span><span class="n">instance_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">status_flags</span><span class="p">.</span><span class="n">condition_auto_mission_available</span> <span class="o">=</span> <span class="n">mission_result_ok</span> <span class="o">&amp;&amp;</span> <span class="n">mission_result</span><span class="p">.</span><span class="n">valid</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mission_result_ok</span><span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">mission_failure</span> <span class="o">!=</span> <span class="n">mission_result</span><span class="p">.</span><span class="n">failure</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">status</span><span class="p">.</span><span class="n">mission_failure</span> <span class="o">=</span> <span class="n">mission_result</span><span class="p">.</span><span class="n">failure</span><span class="p">;</span>
					<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">mission_failure</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;Mission cannot be completed&quot;</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="cm">/* Only evaluate mission state if home is set */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status_flags</span><span class="p">.</span><span class="n">condition_home_position_valid</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">prev_mission_instance_count</span> <span class="o">!=</span> <span class="n">mission_result</span><span class="p">.</span><span class="n">instance_count</span><span class="p">))</span> <span class="p">{</span>

					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status_flags</span><span class="p">.</span><span class="n">condition_auto_mission_available</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* the mission is invalid */</span>
						<span class="n">tune_mission_fail</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mission_result</span><span class="p">.</span><span class="n">warning</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* the mission has a warning */</span>
						<span class="n">tune_mission_fail</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>

					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="cm">/* the mission is valid */</span>
						<span class="n">tune_mission_ok</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* start geofence result check */</span>
		<span class="n">orb_check</span><span class="p">(</span><span class="n">geofence_result_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">geofence_result</span><span class="p">),</span> <span class="n">geofence_result_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">geofence_result</span><span class="p">);</span>
		<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-55'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-55'>#</a>
      </div>
      <p>Geofence actions</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">geofence_result</span><span class="p">.</span><span class="n">geofence_action</span> <span class="o">!=</span> <span class="n">geofence_result_s</span><span class="o">::</span><span class="n">GF_ACTION_NONE</span><span class="p">))</span> <span class="p">{</span>

			<span class="k">static</span> <span class="kt">bool</span> <span class="n">geofence_loiter_on</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">static</span> <span class="kt">bool</span> <span class="n">geofence_rtl_on</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-56'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-56'>#</a>
      </div>
      <p>check for geofence violation</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">geofence_result</span><span class="p">.</span><span class="n">geofence_violated</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">static</span> <span class="n">hrt_abstime</span> <span class="n">last_geofence_violation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">const</span> <span class="n">hrt_abstime</span> <span class="n">geofence_violation_action_interval</span> <span class="o">=</span> <span class="mi">10</span><span class="n">_s</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">last_geofence_violation</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">geofence_violation_action_interval</span><span class="p">)</span> <span class="p">{</span>

					<span class="n">last_geofence_violation</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>

					<span class="k">switch</span> <span class="p">(</span><span class="n">geofence_result</span><span class="p">.</span><span class="n">geofence_action</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">case</span> <span class="p">(</span><span class="n">geofence_result_s</span><span class="o">::</span><span class="n">GF_ACTION_NONE</span><span class="p">)</span> <span class="o">:</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-57'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-57'>#</a>
      </div>
      <p>do nothing</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="k">case</span> <span class="p">(</span><span class="n">geofence_result_s</span><span class="o">::</span><span class="n">GF_ACTION_WARN</span><span class="p">)</span> <span class="o">:</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-58'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-58'>#</a>
      </div>
      <p>do nothing, mavlink critical messages are sent by navigator</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="k">case</span> <span class="p">(</span><span class="n">geofence_result_s</span><span class="o">::</span><span class="n">GF_ACTION_LOITER</span><span class="p">)</span> <span class="o">:</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">TRANSITION_CHANGED</span> <span class="o">==</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_LOITER</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">))</span> <span class="p">{</span>
								<span class="n">geofence_loiter_on</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
							<span class="p">}</span>

							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="k">case</span> <span class="p">(</span><span class="n">geofence_result_s</span><span class="o">::</span><span class="n">GF_ACTION_RTL</span><span class="p">)</span> <span class="o">:</span> <span class="p">{</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">TRANSITION_CHANGED</span> <span class="o">==</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_RTL</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">))</span> <span class="p">{</span>
								<span class="n">geofence_rtl_on</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
							<span class="p">}</span>

							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="k">case</span> <span class="p">(</span><span class="n">geofence_result_s</span><span class="o">::</span><span class="n">GF_ACTION_TERMINATE</span><span class="p">)</span> <span class="o">:</span> <span class="p">{</span>
							<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;Flight termination because of geofence&quot;</span><span class="p">);</span>
							<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;Geofence violation: flight termination&quot;</span><span class="p">);</span>
							<span class="n">armed</span><span class="p">.</span><span class="n">force_failsafe</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
							<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-59'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-59'>#</a>
      </div>
      <p>reset if no longer in LOITER or if manually switched to LOITER</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="n">geofence_loiter_on</span> <span class="o">=</span> <span class="n">geofence_loiter_on</span>
					     <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_LOITER</span><span class="p">)</span>
					     <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">loiter_switch</span> <span class="o">==</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">SWITCH_POS_OFF</span>
						 <span class="o">||</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">loiter_switch</span> <span class="o">==</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">SWITCH_POS_NONE</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-60'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-60'>#</a>
      </div>
      <p>reset if no longer in RTL or if manually switched to RTL</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="n">geofence_rtl_on</span> <span class="o">=</span> <span class="n">geofence_rtl_on</span>
					  <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_RTL</span><span class="p">)</span>
					  <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">return_switch</span> <span class="o">==</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">SWITCH_POS_OFF</span>
					      <span class="o">||</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">return_switch</span> <span class="o">==</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">SWITCH_POS_NONE</span><span class="p">);</span>

			<span class="n">warning_action_on</span> <span class="o">=</span> <span class="n">warning_action_on</span> <span class="o">||</span> <span class="p">(</span><span class="n">geofence_loiter_on</span> <span class="o">||</span> <span class="n">geofence_rtl_on</span><span class="p">);</span>
		<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-61'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-61'>#</a>
      </div>
      <p>revert geofence failsafe transition if sticks are moved and we were previously in a manual mode
but only if not in a low battery handling action</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">rc_override</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">critical_battery_voltage_actions_done</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">warning_action_on</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">main_state_before_rtl</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_MANUAL</span> <span class="o">||</span>
				 <span class="n">main_state_before_rtl</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_ALTCTL</span> <span class="o">||</span>
				 <span class="n">main_state_before_rtl</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_POSCTL</span> <span class="o">||</span>
				 <span class="n">main_state_before_rtl</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_ACRO</span> <span class="o">||</span>
				 <span class="n">main_state_before_rtl</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_RATTITUDE</span> <span class="o">||</span>
				 <span class="n">main_state_before_rtl</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_STAB</span><span class="p">)))</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-62'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-62'>#</a>
      </div>
      <p>transition to previous state if sticks are touched</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="k">if</span> <span class="p">((</span><span class="n">_last_sp_man</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">!=</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">timestamp</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">((</span><span class="n">fabsf</span><span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">_last_sp_man</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_stick_change</span><span class="p">)</span> <span class="o">||</span>
			     <span class="p">(</span><span class="n">fabsf</span><span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">_last_sp_man</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_stick_change</span><span class="p">)</span> <span class="o">||</span>
			     <span class="p">(</span><span class="n">fabsf</span><span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">_last_sp_man</span><span class="p">.</span><span class="n">z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_stick_change</span><span class="p">)</span> <span class="o">||</span>
			     <span class="p">(</span><span class="n">fabsf</span><span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">r</span> <span class="o">-</span> <span class="n">_last_sp_man</span><span class="p">.</span><span class="n">r</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_stick_change</span><span class="p">)))</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-63'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-63'>#</a>
      </div>
      <p>revert to position control in any case</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>				<span class="n">main_state_transition</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_POSCTL</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>
				<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;Autopilot off, returned control to pilot&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-64'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-64'>#</a>
      </div>
      <p>abort landing or auto or loiter if sticks are moved significantly
but only if not in a low battery handling action</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">rc_override</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">critical_battery_voltage_actions_done</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_LAND</span> <span class="o">||</span>
		     <span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_MISSION</span> <span class="o">||</span>
		     <span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_LOITER</span><span class="p">))</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-65'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-65'>#</a>
      </div>
      <p>transition to previous state if sticks are touched</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="k">if</span> <span class="p">((</span><span class="n">_last_sp_man</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">!=</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">timestamp</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">((</span><span class="n">fabsf</span><span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">_last_sp_man</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_stick_change</span><span class="p">)</span> <span class="o">||</span>
			     <span class="p">(</span><span class="n">fabsf</span><span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">_last_sp_man</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_stick_change</span><span class="p">)</span> <span class="o">||</span>
			     <span class="p">(</span><span class="n">fabsf</span><span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">_last_sp_man</span><span class="p">.</span><span class="n">z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_stick_change</span><span class="p">)</span> <span class="o">||</span>
			     <span class="p">(</span><span class="n">fabsf</span><span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">r</span> <span class="o">-</span> <span class="n">_last_sp_man</span><span class="p">.</span><span class="n">r</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">min_stick_change</span><span class="p">)))</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-66'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-66'>#</a>
      </div>
      <p>revert to position control in any case</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>				<span class="n">main_state_transition</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_POSCTL</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>
				<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;Autopilot off, returned control to pilot&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>


		<span class="cm">/* Check for mission flight termination */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span> <span class="o">&amp;&amp;</span> <span class="n">_mission_result_sub</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">flight_termination</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">status_flags</span><span class="p">.</span><span class="n">circuit_breaker_flight_termination_disabled</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">armed</span><span class="p">.</span><span class="n">force_failsafe</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">static</span> <span class="kt">bool</span> <span class="n">flight_termination_printed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flight_termination_printed</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;Geofence violation: flight termination&quot;</span><span class="p">);</span>
				<span class="n">flight_termination_printed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">%</span> <span class="p">(</span><span class="mi">1000000</span> <span class="o">/</span> <span class="n">COMMANDER_MONITORING_INTERVAL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;Flight termination active&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* RC input check */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status_flags</span><span class="p">.</span><span class="n">rc_input_blocked</span> <span class="o">&amp;&amp;</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sp_man</span><span class="p">.</span><span class="n">timestamp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">rc_loss_timeout</span> <span class="o">*</span> <span class="mi">1</span><span class="n">_s</span><span class="p">)))</span> <span class="p">{</span>

			<span class="cm">/* handle the case where RC signal was regained */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status_flags</span><span class="p">.</span><span class="n">rc_signal_found_once</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status_flags</span><span class="p">.</span><span class="n">rc_signal_found_once</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">set_health_flags</span><span class="p">(</span><span class="n">subsystem_info_s</span><span class="o">::</span><span class="n">SUBSYSTEM_TYPE_RCRECEIVER</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span> <span class="o">&amp;&amp;</span> <span class="n">status_flags</span><span class="p">.</span><span class="n">rc_calibration_valid</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
				<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">rc_signal_lost</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mavlink_log_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;MANUAL CONTROL REGAINED after %llums&quot;</span><span class="p">,</span> <span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rc_signal_lost_timestamp</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
					<span class="n">set_health_flags</span><span class="p">(</span><span class="n">subsystem_info_s</span><span class="o">::</span><span class="n">SUBSYSTEM_TYPE_RCRECEIVER</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span> <span class="o">&amp;&amp;</span> <span class="n">status_flags</span><span class="p">.</span><span class="n">rc_calibration_valid</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
					<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">status</span><span class="p">.</span><span class="n">rc_signal_lost</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="k">const</span> <span class="kt">bool</span> <span class="n">in_armed_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">arming_state</span> <span class="o">==</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">ARMING_STATE_ARMED</span><span class="p">);</span>
			<span class="k">const</span> <span class="kt">bool</span> <span class="n">arm_switch_or_button_mapped</span> <span class="o">=</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">arm_switch</span> <span class="o">!=</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">SWITCH_POS_NONE</span><span class="p">;</span>
			<span class="k">const</span> <span class="kt">bool</span> <span class="n">arm_button_pressed</span> <span class="o">=</span> <span class="n">arm_switch_is_button</span> <span class="o">==</span> <span class="mi">1</span>
							<span class="o">&amp;&amp;</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">arm_switch</span> <span class="o">==</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">SWITCH_POS_ON</span><span class="p">;</span>

			<span class="cm">/* DISARM</span>
<span class="cm">			 * check if left stick is in lower left position or arm button is pushed or arm switch has transition from arm to disarm</span>
<span class="cm">			 * and we are in MANUAL, Rattitude, or AUTO_READY mode or (ASSIST mode and landed)</span>
<span class="cm">			 * do it only for rotary wings in manual mode or fixed wing if landed.</span>
<span class="cm">			 * Disable stick-disarming if arming switch or button is mapped */</span>
			<span class="k">const</span> <span class="kt">bool</span> <span class="n">stick_in_lower_left</span> <span class="o">=</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">STICK_ON_OFF_LIMIT</span> <span class="o">&amp;&amp;</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">z</span> <span class="o">&lt;</span> <span class="mf">0.1f</span>
					<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">arm_switch_or_button_mapped</span><span class="p">;</span>
			<span class="k">const</span> <span class="kt">bool</span> <span class="n">arm_switch_to_disarm_transition</span> <span class="o">=</span>  <span class="n">arm_switch_is_button</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
					<span class="n">_last_sp_man_arm_switch</span> <span class="o">==</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">SWITCH_POS_ON</span> <span class="o">&amp;&amp;</span>
					<span class="n">sp_man</span><span class="p">.</span><span class="n">arm_switch</span> <span class="o">==</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">SWITCH_POS_OFF</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">in_armed_state</span> <span class="o">&amp;&amp;</span>
			    <span class="n">status</span><span class="p">.</span><span class="n">rc_input_mode</span> <span class="o">!=</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">RC_IN_MODE_OFF</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">is_rotary_wing</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">is_rotary_wing</span> <span class="o">&amp;&amp;</span> <span class="n">land_detector</span><span class="p">.</span><span class="n">landed</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">stick_in_lower_left</span> <span class="o">||</span> <span class="n">arm_button_pressed</span> <span class="o">||</span> <span class="n">arm_switch_to_disarm_transition</span><span class="p">))</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">!=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_MANUAL</span> <span class="o">&amp;&amp;</span>
				    <span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">!=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_ACRO</span> <span class="o">&amp;&amp;</span>
				    <span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">!=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_STAB</span> <span class="o">&amp;&amp;</span>
				    <span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">!=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_RATTITUDE</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="n">land_detector</span><span class="p">.</span><span class="n">landed</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">print_reject_arm</span><span class="p">(</span><span class="s">&quot;NOT DISARMING: Not in manual mode or landed yet.&quot;</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">stick_off_counter</span> <span class="o">==</span> <span class="n">rc_arm_hyst</span> <span class="o">&amp;&amp;</span> <span class="n">stick_on_counter</span> <span class="o">&lt;</span> <span class="n">rc_arm_hyst</span><span class="p">)</span> <span class="o">||</span> <span class="n">arm_switch_to_disarm_transition</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">arming_ret</span> <span class="o">=</span> <span class="n">arming_state_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="n">battery</span><span class="p">,</span> <span class="n">safety</span><span class="p">,</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">ARMING_STATE_STANDBY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">armed</span><span class="p">,</span>
									     <span class="nb">true</span> <span class="cm">/* fRunPreArmChecks */</span><span class="p">,</span>
									     <span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_flags</span><span class="p">,</span> <span class="n">arm_requirements</span><span class="p">,</span> <span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commander_boot_timestamp</span><span class="p">));</span>
				<span class="p">}</span>

				<span class="n">stick_off_counter</span><span class="o">++</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">arm_switch_is_button</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">arm_switch</span> <span class="o">==</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">SWITCH_POS_ON</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* do not reset the counter when holding the arm button longer than needed */</span>
				<span class="n">stick_off_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* ARM</span>
<span class="cm">			 * check if left stick is in lower right position or arm button is pushed or arm switch has transition from disarm to arm</span>
<span class="cm">			 * and we&#39;re in MANUAL mode.</span>
<span class="cm">			 * Disable stick-arming if arming switch or button is mapped */</span>
			<span class="k">const</span> <span class="kt">bool</span> <span class="n">stick_in_lower_right</span> <span class="o">=</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">r</span> <span class="o">&gt;</span> <span class="n">STICK_ON_OFF_LIMIT</span> <span class="o">&amp;&amp;</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">z</span> <span class="o">&lt;</span> <span class="mf">0.1f</span>
					<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">arm_switch_or_button_mapped</span><span class="p">;</span>
			<span class="cm">/* allow a grace period for re-arming: preflight checks don&#39;t need to pass during that time,</span>
<span class="cm">			 * for example for accidential in-air disarming */</span>
			<span class="k">const</span> <span class="kt">bool</span> <span class="n">in_arming_grace_period</span> <span class="o">=</span> <span class="n">last_disarmed_timestamp</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">last_disarmed_timestamp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="n">_s</span><span class="p">;</span>
			<span class="k">const</span> <span class="kt">bool</span> <span class="n">arm_switch_to_arm_transition</span> <span class="o">=</span> <span class="n">arm_switch_is_button</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
					<span class="n">_last_sp_man_arm_switch</span> <span class="o">==</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">SWITCH_POS_OFF</span> <span class="o">&amp;&amp;</span>
					<span class="n">sp_man</span><span class="p">.</span><span class="n">arm_switch</span> <span class="o">==</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">SWITCH_POS_ON</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">z</span> <span class="o">&lt;</span> <span class="mf">0.1f</span> <span class="o">||</span> <span class="n">in_arming_grace_period</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_armed_state</span> <span class="o">&amp;&amp;</span>
			    <span class="n">status</span><span class="p">.</span><span class="n">rc_input_mode</span> <span class="o">!=</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">RC_IN_MODE_OFF</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">stick_in_lower_right</span> <span class="o">||</span> <span class="n">arm_button_pressed</span> <span class="o">||</span> <span class="n">arm_switch_to_arm_transition</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">stick_on_counter</span> <span class="o">==</span> <span class="n">rc_arm_hyst</span> <span class="o">&amp;&amp;</span> <span class="n">stick_off_counter</span> <span class="o">&lt;</span> <span class="n">rc_arm_hyst</span><span class="p">)</span> <span class="o">||</span> <span class="n">arm_switch_to_arm_transition</span><span class="p">)</span> <span class="p">{</span>

					<span class="cm">/* we check outside of the transition function here because the requirement</span>
<span class="cm">					 * for being in manual mode only applies to manual arming actions.</span>
<span class="cm">					 * the system can be armed in auto if armed via the GCS.</span>
<span class="cm">					 */</span>

					<span class="k">if</span> <span class="p">((</span><span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">!=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_MANUAL</span><span class="p">)</span>
					    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">!=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_ACRO</span><span class="p">)</span>
					    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">!=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_STAB</span><span class="p">)</span>
					    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">!=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_ALTCTL</span><span class="p">)</span>
					    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">!=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_POSCTL</span><span class="p">)</span>
					    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">!=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_RATTITUDE</span><span class="p">)</span>
					   <span class="p">)</span> <span class="p">{</span>
						<span class="n">print_reject_arm</span><span class="p">(</span><span class="s">&quot;NOT ARMING: Switch to a manual mode first.&quot;</span><span class="p">);</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status_flags</span><span class="p">.</span><span class="n">condition_home_position_valid</span> <span class="o">&amp;&amp;</span>
						   <span class="n">geofence_action</span> <span class="o">==</span> <span class="n">geofence_result_s</span><span class="o">::</span><span class="n">GF_ACTION_RTL</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">print_reject_arm</span><span class="p">(</span><span class="s">&quot;NOT ARMING: Geofence RTL requires valid home&quot;</span><span class="p">);</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">arming_state</span> <span class="o">==</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">ARMING_STATE_STANDBY</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">arming_ret</span> <span class="o">=</span> <span class="n">arming_state_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="n">battery</span><span class="p">,</span> <span class="n">safety</span><span class="p">,</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">ARMING_STATE_ARMED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">armed</span><span class="p">,</span>
										     <span class="o">!</span><span class="n">in_arming_grace_period</span> <span class="cm">/* fRunPreArmChecks */</span><span class="p">,</span>
										     <span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_flags</span><span class="p">,</span> <span class="n">arm_requirements</span><span class="p">,</span> <span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commander_boot_timestamp</span><span class="p">));</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">arming_ret</span> <span class="o">!=</span> <span class="n">TRANSITION_CHANGED</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">usleep</span><span class="p">(</span><span class="mi">100000</span><span class="p">);</span>
							<span class="n">print_reject_arm</span><span class="p">(</span><span class="s">&quot;NOT ARMING: Preflight checks failed&quot;</span><span class="p">);</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="n">stick_on_counter</span><span class="o">++</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">arm_switch_is_button</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">arm_switch</span> <span class="o">==</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">SWITCH_POS_ON</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* do not reset the counter when holding the arm button longer than needed */</span>
				<span class="n">stick_on_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">_last_sp_man_arm_switch</span> <span class="o">=</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">arm_switch</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">arming_ret</span> <span class="o">==</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * the arming transition can be denied to a number of reasons:</span>
<span class="cm">				 *  - pre-flight check failed (sensors not ok or not calibrated)</span>
<span class="cm">				 *  - safety not disabled</span>
<span class="cm">				 *  - system not in manual mode</span>
<span class="cm">				 */</span>
				<span class="n">tune_negative</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* evaluate the main state machine according to mode switches */</span>
			<span class="kt">bool</span> <span class="n">first_rc_eval</span> <span class="o">=</span> <span class="p">(</span><span class="n">_last_sp_man</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">transition_result_t</span> <span class="n">main_res</span> <span class="o">=</span> <span class="n">set_main_state</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_changed</span><span class="p">);</span>

			<span class="cm">/* store last position lock state */</span>
			<span class="n">_last_condition_global_position_valid</span> <span class="o">=</span> <span class="n">status_flags</span><span class="p">.</span><span class="n">condition_global_position_valid</span><span class="p">;</span>

			<span class="cm">/* play tune on mode change only if armed, blink LED always */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">main_res</span> <span class="o">==</span> <span class="n">TRANSITION_CHANGED</span> <span class="o">||</span> <span class="n">first_rc_eval</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tune_positive</span><span class="p">(</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span><span class="p">);</span>
				<span class="n">main_state_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">main_res</span> <span class="o">==</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* DENIED here indicates bug in the commander */</span>
				<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;Switching to this mode is currently not possible&quot;</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* check throttle kill switch */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">kill_switch</span> <span class="o">==</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">SWITCH_POS_ON</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* set lockdown flag */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">armed</span><span class="p">.</span><span class="n">manual_lockdown</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mavlink_log_emergency</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;MANUAL KILL SWITCH ENGAGED&quot;</span><span class="p">);</span>
					<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">armed</span><span class="p">.</span><span class="n">manual_lockdown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">kill_switch</span> <span class="o">==</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">SWITCH_POS_OFF</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">armed</span><span class="p">.</span><span class="n">manual_lockdown</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mavlink_log_emergency</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;MANUAL KILL SWITCH OFF&quot;</span><span class="p">);</span>
					<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">armed</span><span class="p">.</span><span class="n">manual_lockdown</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="cm">/* no else case: do not change lockdown flag in unconfigured case */</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status_flags</span><span class="p">.</span><span class="n">rc_input_blocked</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">rc_signal_lost</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;MANUAL CONTROL LOST (at t=%llums)&quot;</span><span class="p">,</span> <span class="n">hrt_absolute_time</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
				<span class="n">status</span><span class="p">.</span><span class="n">rc_signal_lost</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">rc_signal_lost_timestamp</span> <span class="o">=</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">timestamp</span><span class="p">;</span>
				<span class="n">set_health_flags</span><span class="p">(</span><span class="n">subsystem_info_s</span><span class="o">::</span><span class="n">SUBSYSTEM_TYPE_RCRECEIVER</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
				<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-67'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-67'>#</a>
      </div>
      <p>data link checks which update the status</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="n">data_link_checks</span><span class="p">(</span><span class="n">highlatencydatalink_loss_timeout</span><span class="p">,</span> <span class="n">highlatencydatalink_regain_timeout</span><span class="p">,</span> <span class="n">datalink_loss_timeout</span><span class="p">,</span> <span class="n">datalink_regain_timeout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_changed</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-68'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-68'>#</a>
      </div>
      <p>engine failure detection
TODO: move out of commander</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="n">orb_check</span><span class="p">(</span><span class="n">actuator_controls_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Check engine failure</span>
<span class="cm">			 * only for fixed wing for now</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status_flags</span><span class="p">.</span><span class="n">circuit_breaker_engaged_enginefailure_check</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">is_rotary_wing</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">is_vtol</span> <span class="o">&amp;&amp;</span> <span class="n">armed</span><span class="p">.</span><span class="n">armed</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">actuator_controls_s</span> <span class="n">actuator_controls</span> <span class="o">=</span> <span class="p">{};</span>
				<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID_VEHICLE_ATTITUDE_CONTROLS</span><span class="p">,</span> <span class="n">actuator_controls_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">actuator_controls</span><span class="p">);</span>

				<span class="k">const</span> <span class="kt">float</span> <span class="n">throttle</span> <span class="o">=</span> <span class="n">actuator_controls</span><span class="p">.</span><span class="n">control</span><span class="p">[</span><span class="n">actuator_controls_s</span><span class="o">::</span><span class="n">INDEX_THROTTLE</span><span class="p">];</span>
				<span class="k">const</span> <span class="kt">float</span> <span class="n">current2throttle</span> <span class="o">=</span> <span class="n">battery</span><span class="p">.</span><span class="n">current_a</span> <span class="o">/</span> <span class="n">throttle</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(((</span><span class="n">throttle</span> <span class="o">&gt;</span> <span class="n">ef_throttle_thres</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">current2throttle</span> <span class="o">&lt;</span> <span class="n">ef_current2throttle_thres</span><span class="p">))</span>
				    <span class="o">||</span> <span class="n">status</span><span class="p">.</span><span class="n">engine_failure</span><span class="p">)</span> <span class="p">{</span>

					<span class="k">const</span> <span class="kt">float</span> <span class="n">elapsed</span> <span class="o">=</span> <span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timestamp_engine_healthy</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="n">f</span><span class="p">;</span>

					<span class="cm">/* potential failure, measure time */</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">timestamp_engine_healthy</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">elapsed</span> <span class="o">&gt;</span> <span class="n">ef_time_thres</span><span class="p">)</span>
					    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">engine_failure</span><span class="p">)</span> <span class="p">{</span>

						<span class="n">status</span><span class="p">.</span><span class="n">engine_failure</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
						<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

						<span class="n">PX4_ERR</span><span class="p">(</span><span class="s">&quot;Engine Failure&quot;</span><span class="p">);</span>
						<span class="n">set_health_flags</span><span class="p">(</span><span class="n">subsystem_info_s</span><span class="o">::</span><span class="n">SUBSYSTEM_TYPE_MOTORCONTROL</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* no failure reset flag */</span>
				<span class="n">timestamp_engine_healthy</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">engine_failure</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">status</span><span class="p">.</span><span class="n">engine_failure</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
					<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Reset main state to loiter or auto-mission after takeoff is completed.</span>
<span class="cm">		 * Sometimes, the mission result topic is outdated and the mission is still signaled</span>
<span class="cm">		 * as finished even though we only just started with the takeoff. Therefore, we also</span>
<span class="cm">		 * check the timestamp of the mission_result topic. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_TAKEOFF</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">_mission_result_sub</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">timestamp</span> <span class="o">&gt;</span> <span class="n">internal_state</span><span class="p">.</span><span class="n">timestamp</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="n">_mission_result_sub</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">finished</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">const</span> <span class="kt">bool</span> <span class="n">mission_available</span> <span class="o">=</span> <span class="p">(</span><span class="n">_mission_result_sub</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">timestamp</span> <span class="o">&gt;</span> <span class="n">commander_boot_timestamp</span><span class="p">)</span>
						       <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">_mission_result_sub</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">instance_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">_mission_result_sub</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">valid</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">takeoff_complete_act</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">mission_available</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">main_state_transition</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_MISSION</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">main_state_transition</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_LOITER</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* check if we are disarmed and there is a better mode to wait in */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* if there is no radio control but GPS lock the user might want to fly using</span>
<span class="cm">			 * just a tablet. Since the RC will force its mode switch setting on connecting</span>
<span class="cm">			 * we can as well just wait in a hold mode which enables tablet control.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">rc_signal_lost</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_MANUAL</span><span class="p">)</span>
			    <span class="o">&amp;&amp;</span> <span class="n">status_flags</span><span class="p">.</span><span class="n">condition_home_position_valid</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">main_state_transition</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_LOITER</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* handle commands last, as the system needs to be updated to handle them */</span>
		<span class="n">orb_check</span><span class="p">(</span><span class="n">cmd_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">vehicle_command_s</span> <span class="n">cmd</span><span class="p">;</span>

			<span class="cm">/* got command */</span>
			<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_command</span><span class="p">),</span> <span class="n">cmd_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

			<span class="cm">/* handle it */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">handle_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">armed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_home</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">home_pub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">command_ack_pub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_changed</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Check for failure combinations which lead to flight termination */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">status_flags</span><span class="p">.</span><span class="n">circuit_breaker_flight_termination_disabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* At this point the data link and the gps system have been checked</span>
<span class="cm">			 * If we are not in a manual (RC stick controlled mode)</span>
<span class="cm">			 * and both failed we want to terminate the flight */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">!=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_MANUAL</span> <span class="o">&amp;&amp;</span>
			    <span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">!=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_ACRO</span> <span class="o">&amp;&amp;</span>
			    <span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">!=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_RATTITUDE</span> <span class="o">&amp;&amp;</span>
			    <span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">!=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_STAB</span> <span class="o">&amp;&amp;</span>
			    <span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">!=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_ALTCTL</span> <span class="o">&amp;&amp;</span>
			    <span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">!=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_POSCTL</span> <span class="o">&amp;&amp;</span>
			    <span class="n">status</span><span class="p">.</span><span class="n">data_link_lost</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">armed</span><span class="p">.</span><span class="n">force_failsafe</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">static</span> <span class="kt">bool</span> <span class="n">flight_termination_printed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flight_termination_printed</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;DL and GPS lost: flight termination&quot;</span><span class="p">);</span>
					<span class="n">flight_termination_printed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">%</span> <span class="p">(</span><span class="mi">1000000</span> <span class="o">/</span> <span class="n">COMMANDER_MONITORING_INTERVAL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;DL and GPS lost: flight termination&quot;</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="cm">/* At this point the rc signal and the gps system have been checked</span>
<span class="cm">			 * If we are in manual (controlled with RC):</span>
<span class="cm">			 * if both failed we want to terminate the flight */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_ACRO</span> <span class="o">||</span>
			     <span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_RATTITUDE</span> <span class="o">||</span>
			     <span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_MANUAL</span> <span class="o">||</span>
			     <span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_STAB</span> <span class="o">||</span>
			     <span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_ALTCTL</span> <span class="o">||</span>
			     <span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_POSCTL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">status</span><span class="p">.</span><span class="n">rc_signal_lost</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">armed</span><span class="p">.</span><span class="n">force_failsafe</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">static</span> <span class="kt">bool</span> <span class="n">flight_termination_printed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flight_termination_printed</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;Flight termination because of RC signal loss and GPS failure&quot;</span><span class="p">);</span>
					<span class="n">flight_termination_printed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">counter</span> <span class="o">%</span> <span class="p">(</span><span class="mi">1000000</span> <span class="o">/</span> <span class="n">COMMANDER_MONITORING_INTERVAL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;RC and GPS lost: flight termination&quot;</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Get current timestamp */</span>
		<span class="k">const</span> <span class="n">hrt_abstime</span> <span class="n">now</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-69'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-69'>#</a>
      </div>
      <p>automatically set or update home position</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_home</span><span class="p">.</span><span class="n">manual_home</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="n">vehicle_local_position_s</span> <span class="o">&amp;</span><span class="n">local_position</span> <span class="o">=</span> <span class="n">_local_position_sub</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">was_armed</span> <span class="o">||</span> <span class="p">(</span><span class="n">was_landed</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">land_detector</span><span class="p">.</span><span class="n">landed</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commander_boot_timestamp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">INAIR_RESTART_HOLDOFF_INTERVAL</span><span class="p">))</span> <span class="p">{</span>

					<span class="cm">/* update home position on arming if at least 500 ms from commander start spent to avoid setting home on in-air restart */</span>
					<span class="n">set_home_position</span><span class="p">(</span><span class="n">home_pub</span><span class="p">,</span> <span class="n">_home</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status_flags</span><span class="p">.</span><span class="n">condition_home_position_valid</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">land_detector</span><span class="p">.</span><span class="n">landed</span> <span class="o">&amp;&amp;</span> <span class="n">local_position</span><span class="p">.</span><span class="n">xy_valid</span> <span class="o">&amp;&amp;</span> <span class="n">local_position</span><span class="p">.</span><span class="n">z_valid</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* distance from home */</span>
						<span class="kt">float</span> <span class="n">home_dist_xy</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0f</span><span class="p">;</span>
						<span class="kt">float</span> <span class="n">home_dist_z</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0f</span><span class="p">;</span>
						<span class="n">mavlink_wpm_distance_to_point_local</span><span class="p">(</span><span class="n">_home</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">_home</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">_home</span><span class="p">.</span><span class="n">z</span><span class="p">,</span>
										    <span class="n">local_position</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">local_position</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">local_position</span><span class="p">.</span><span class="n">z</span><span class="p">,</span>
										    <span class="o">&amp;</span><span class="n">home_dist_xy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">home_dist_z</span><span class="p">);</span>

						<span class="k">if</span> <span class="p">((</span><span class="n">home_dist_xy</span> <span class="o">&gt;</span> <span class="n">local_position</span><span class="p">.</span><span class="n">eph</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">home_dist_z</span> <span class="o">&gt;</span> <span class="n">local_position</span><span class="p">.</span><span class="n">epv</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>

							<span class="cm">/* update when disarmed, landed and moved away from current home position */</span>
							<span class="n">set_home_position</span><span class="p">(</span><span class="n">home_pub</span><span class="p">,</span> <span class="n">_home</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
						<span class="p">}</span>
					<span class="p">}</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* First time home position update - but only if disarmed */</span>
					<span class="n">set_home_position</span><span class="p">(</span><span class="n">home_pub</span><span class="p">,</span> <span class="n">_home</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="cm">/* Set home position altitude to EKF origin height if home is not set and the EKF has a global origin.</span>
<span class="cm">			 * This allows home atitude to be used in the calculation of height above takeoff location when GPS</span>
<span class="cm">			 * use has commenced after takeoff. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_home</span><span class="p">.</span><span class="n">valid_alt</span> <span class="o">&amp;&amp;</span> <span class="n">local_position</span><span class="p">.</span><span class="n">z_global</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_home_position</span><span class="p">(</span><span class="n">home_pub</span><span class="p">,</span> <span class="n">_home</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

			<span class="p">}</span>
		<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-70'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-70'>#</a>
      </div>
      <p>check for arming state change</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">was_armed</span> <span class="o">!=</span> <span class="n">armed</span><span class="p">.</span><span class="n">armed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// increase the flight uuid upon disarming</span>
				<span class="o">++</span><span class="n">flight_uuid</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-71'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-71'>#</a>
      </div>
      <p>no need for param notification: the only user is mavlink which reads the param upon request</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>				<span class="n">param_set_no_notification</span><span class="p">(</span><span class="n">_param_flight_uuid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flight_uuid</span><span class="p">);</span>
				<span class="n">last_disarmed_timestamp</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">was_armed</span> <span class="o">=</span> <span class="n">armed</span><span class="p">.</span><span class="n">armed</span><span class="p">;</span>

		<span class="cm">/* now set navigation state according to failsafe and main state */</span>
		<span class="kt">bool</span> <span class="n">nav_state_changed</span> <span class="o">=</span> <span class="n">set_nav_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">armed</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span>
						       <span class="p">(</span><span class="n">link_loss_actions_t</span><span class="p">)</span><span class="n">datalink_loss_act</span><span class="p">,</span>
						       <span class="n">_mission_result_sub</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">finished</span><span class="p">,</span>
						       <span class="n">_mission_result_sub</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">stay_in_failsafe</span><span class="p">,</span>
						       <span class="n">status_flags</span><span class="p">,</span>
						       <span class="n">land_detector</span><span class="p">.</span><span class="n">landed</span><span class="p">,</span>
						       <span class="p">(</span><span class="n">link_loss_actions_t</span><span class="p">)</span><span class="n">rc_loss_act</span><span class="p">,</span>
						       <span class="n">offboard_loss_act</span><span class="p">,</span>
						       <span class="n">offboard_loss_rc_act</span><span class="p">,</span>
						       <span class="n">posctl_nav_loss_act</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">failsafe</span> <span class="o">!=</span> <span class="n">failsafe_old</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">failsafe</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mavlink_log_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;Failsafe mode enabled&quot;</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">mavlink_log_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;Failsafe mode disabled&quot;</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">failsafe_old</span> <span class="o">=</span> <span class="n">status</span><span class="p">.</span><span class="n">failsafe</span><span class="p">;</span>
		<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-72'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-72'>#</a>
      </div>
      <p>TODO handle mode changes by commands</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">main_state_changed</span> <span class="o">||</span> <span class="n">nav_state_changed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">main_state_changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* publish states (armed, control_mode, vehicle_status, commander_state, vehicle_status_flags) at 1 Hz or immediately when changed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">.</span><span class="n">timestamp</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="n">_s</span> <span class="o">||</span> <span class="n">status_changed</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">set_control_mode</span><span class="p">();</span>
			<span class="n">control_mode</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>
			<span class="n">orb_publish</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_control_mode</span><span class="p">),</span> <span class="n">control_mode_pub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control_mode</span><span class="p">);</span>

			<span class="n">status</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>
			<span class="n">orb_publish</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_status</span><span class="p">),</span> <span class="n">status_pub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>

			<span class="n">armed</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>

			<span class="cm">/* set prearmed state if safety is off, or safety is not present and 5 seconds passed */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">safety</span><span class="p">.</span><span class="n">safety_switch_available</span><span class="p">)</span> <span class="p">{</span>

				<span class="cm">/* safety is off, go into prearmed */</span>
				<span class="n">armed</span><span class="p">.</span><span class="n">prearmed</span> <span class="o">=</span> <span class="n">safety</span><span class="p">.</span><span class="n">safety_off</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* safety is not present, go into prearmed</span>
<span class="cm">				 * (all output drivers should be started / unlocked last in the boot process</span>
<span class="cm">				 * when the rest of the system is fully initialized)</span>
<span class="cm">				 */</span>
				<span class="n">armed</span><span class="p">.</span><span class="n">prearmed</span> <span class="o">=</span> <span class="p">(</span><span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commander_boot_timestamp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="n">_s</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">orb_publish</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">actuator_armed</span><span class="p">),</span> <span class="n">armed_pub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">armed</span><span class="p">);</span>

			<span class="cm">/* publish internal state for logging purposes */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">commander_state_pub</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">orb_publish</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">commander_state</span><span class="p">),</span> <span class="n">commander_state_pub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">commander_state_pub</span> <span class="o">=</span> <span class="n">orb_advertise</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">commander_state</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* publish vehicle_status_flags */</span>
			<span class="n">status_flags</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">vehicle_status_flags_pub</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">orb_publish</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_status_flags</span><span class="p">),</span> <span class="n">vehicle_status_flags_pub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_flags</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">vehicle_status_flags_pub</span> <span class="o">=</span> <span class="n">orb_advertise</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_status_flags</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">status_flags</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* play arming and battery warning tunes */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arm_tune_played</span> <span class="o">&amp;&amp;</span> <span class="n">armed</span><span class="p">.</span><span class="n">armed</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">safety</span><span class="p">.</span><span class="n">safety_switch_available</span> <span class="o">||</span> <span class="p">(</span><span class="n">safety</span><span class="p">.</span><span class="n">safety_switch_available</span>
							<span class="o">&amp;&amp;</span> <span class="n">safety</span><span class="p">.</span><span class="n">safety_off</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* play tune when armed */</span>
			<span class="n">set_tune</span><span class="p">(</span><span class="n">TONE_ARMING_WARNING_TUNE</span><span class="p">);</span>
			<span class="n">arm_tune_played</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status_flags</span><span class="p">.</span><span class="n">usb_connected</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">hil_state</span> <span class="o">!=</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">HIL_STATE_ON</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">battery</span><span class="p">.</span><span class="n">warning</span> <span class="o">==</span> <span class="n">battery_status_s</span><span class="o">::</span><span class="n">BATTERY_WARNING_CRITICAL</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* play tune on battery critical */</span>
			<span class="n">set_tune</span><span class="p">(</span><span class="n">TONE_BATTERY_WARNING_FAST_TUNE</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">status</span><span class="p">.</span><span class="n">hil_state</span> <span class="o">!=</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">HIL_STATE_ON</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">battery</span><span class="p">.</span><span class="n">warning</span> <span class="o">==</span> <span class="n">battery_status_s</span><span class="o">::</span><span class="n">BATTERY_WARNING_LOW</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* play tune on battery warning */</span>
			<span class="n">set_tune</span><span class="p">(</span><span class="n">TONE_BATTERY_WARNING_SLOW_TUNE</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">failsafe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tune_failsafe</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_tune</span><span class="p">(</span><span class="n">TONE_STOP_TUNE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* reset arm_tune_played when disarmed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span> <span class="o">||</span> <span class="p">(</span><span class="n">safety</span><span class="p">.</span><span class="n">safety_switch_available</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">safety</span><span class="p">.</span><span class="n">safety_off</span><span class="p">))</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-73'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-73'>#</a>
      </div>
      <p>Notify the user that it is safe to approach the vehicle</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">arm_tune_played</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tune_neutral</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">arm_tune_played</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* play sensor failure tunes if we already waited for hotplug sensors to come up and failed */</span>
		<span class="n">status_flags</span><span class="p">.</span><span class="n">condition_system_hotplug_timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commander_boot_timestamp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">HOTPLUG_SENS_TIMEOUT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sensor_fail_tune_played</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">status_flags</span><span class="p">.</span><span class="n">condition_system_sensors_initialized</span>
						 <span class="o">&amp;&amp;</span> <span class="n">status_flags</span><span class="p">.</span><span class="n">condition_system_hotplug_timeout</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">set_tune_override</span><span class="p">(</span><span class="n">TONE_GPS_WARNING_TUNE</span><span class="p">);</span>
			<span class="n">sensor_fail_tune_played</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">counter</span><span class="o">++</span><span class="p">;</span>

		<span class="kt">int</span> <span class="n">blink_state</span> <span class="o">=</span> <span class="n">blink_msg_state</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">blink_state</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* blinking LED message, don&#39;t touch LEDs */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">blink_state</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* blinking LED message completed, restore normal state */</span>
				<span class="n">control_status_leds</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">armed</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">battery</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpuload</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* normal state */</span>
			<span class="n">control_status_leds</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">armed</span><span class="p">,</span> <span class="n">status_changed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">battery</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpuload</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">status_changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Reset the flag if disarmed. */</span>
			<span class="n">have_taken_off_since_arming</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">arm_auth_update</span><span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">params_updated</span> <span class="o">||</span> <span class="n">param_init_forced</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-74'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-74'>#</a>
      </div>
      <p>Handle shutdown request from emergency battery action</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span> <span class="o">&amp;&amp;</span> <span class="n">dangerous_battery_level_requests_poweroff</span><span class="p">){</span>
			<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;DANGEROUSLY LOW BATTERY, SHUT SYSTEM DOWN&quot;</span><span class="p">);</span>
			<span class="n">usleep</span><span class="p">(</span><span class="mi">200000</span><span class="p">);</span>
			<span class="kt">int</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="n">px4_shutdown_request</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ret_val</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;SYSTEM DOES NOT SUPPORT SHUTDOWN&quot;</span><span class="p">);</span>
				<span class="n">dangerous_battery_level_requests_poweroff</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="n">usleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">usleep</span><span class="p">(</span><span class="n">COMMANDER_MONITORING_INTERVAL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">thread_should_exit</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* wait for threads to complete */</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">pthread_join</span><span class="p">(</span><span class="n">commander_low_prio_thread</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">warn</span><span class="p">(</span><span class="s">&quot;join failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rgbled_set_color_and_mode</span><span class="p">(</span><span class="n">led_control_s</span><span class="o">::</span><span class="n">COLOR_WHITE</span><span class="p">,</span> <span class="n">led_control_s</span><span class="o">::</span><span class="n">MODE_OFF</span><span class="p">);</span>

	<span class="cm">/* close fds */</span>
	<span class="n">led_deinit</span><span class="p">();</span>
	<span class="n">buzzer_deinit</span><span class="p">();</span>
	<span class="n">px4_close</span><span class="p">(</span><span class="n">sp_man_sub</span><span class="p">);</span>
	<span class="n">px4_close</span><span class="p">(</span><span class="n">offboard_control_mode_sub</span><span class="p">);</span>
	<span class="n">px4_close</span><span class="p">(</span><span class="n">safety_sub</span><span class="p">);</span>
	<span class="n">px4_close</span><span class="p">(</span><span class="n">cmd_sub</span><span class="p">);</span>
	<span class="n">px4_close</span><span class="p">(</span><span class="n">subsys_sub</span><span class="p">);</span>
	<span class="n">px4_close</span><span class="p">(</span><span class="n">param_changed_sub</span><span class="p">);</span>
	<span class="n">px4_close</span><span class="p">(</span><span class="n">battery_sub</span><span class="p">);</span>
	<span class="n">px4_close</span><span class="p">(</span><span class="n">land_detector_sub</span><span class="p">);</span>
	<span class="n">px4_close</span><span class="p">(</span><span class="n">estimator_status_sub</span><span class="p">);</span>

	<span class="n">thread_running</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">get_circuit_breaker_params</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">status_flags</span><span class="p">.</span><span class="n">circuit_breaker_engaged_power_check</span> <span class="o">=</span> <span class="n">circuit_breaker_enabled</span><span class="p">(</span><span class="s">&quot;CBRK_SUPPLY_CHK&quot;</span><span class="p">,</span> <span class="n">CBRK_SUPPLY_CHK_KEY</span><span class="p">);</span>
	<span class="n">status_flags</span><span class="p">.</span><span class="n">circuit_breaker_engaged_usb_check</span> <span class="o">=</span> <span class="n">circuit_breaker_enabled</span><span class="p">(</span><span class="s">&quot;CBRK_USB_CHK&quot;</span><span class="p">,</span> <span class="n">CBRK_USB_CHK_KEY</span><span class="p">);</span>
	<span class="n">status_flags</span><span class="p">.</span><span class="n">circuit_breaker_engaged_airspd_check</span> <span class="o">=</span> <span class="n">circuit_breaker_enabled</span><span class="p">(</span><span class="s">&quot;CBRK_AIRSPD_CHK&quot;</span><span class="p">,</span> <span class="n">CBRK_AIRSPD_CHK_KEY</span><span class="p">);</span>
	<span class="n">status_flags</span><span class="p">.</span><span class="n">circuit_breaker_engaged_enginefailure_check</span> <span class="o">=</span> <span class="n">circuit_breaker_enabled</span><span class="p">(</span><span class="s">&quot;CBRK_ENGINEFAIL&quot;</span><span class="p">,</span> <span class="n">CBRK_ENGINEFAIL_KEY</span><span class="p">);</span>
	<span class="n">status_flags</span><span class="p">.</span><span class="n">circuit_breaker_engaged_gpsfailure_check</span> <span class="o">=</span> <span class="n">circuit_breaker_enabled</span><span class="p">(</span><span class="s">&quot;CBRK_GPSFAIL&quot;</span><span class="p">,</span> <span class="n">CBRK_GPSFAIL_KEY</span><span class="p">);</span>
	<span class="n">status_flags</span><span class="p">.</span><span class="n">circuit_breaker_flight_termination_disabled</span> <span class="o">=</span> <span class="n">circuit_breaker_enabled</span><span class="p">(</span><span class="s">&quot;CBRK_FLIGHTTERM&quot;</span><span class="p">,</span> <span class="n">CBRK_FLIGHTTERM_KEY</span><span class="p">);</span>
	<span class="n">status_flags</span><span class="p">.</span><span class="n">circuit_breaker_engaged_posfailure_check</span> <span class="o">=</span> <span class="n">circuit_breaker_enabled</span><span class="p">(</span><span class="s">&quot;CBRK_VELPOSERR&quot;</span><span class="p">,</span> <span class="n">CBRK_VELPOSERR_KEY</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">Commander</span><span class="o">::</span><span class="n">check_valid</span><span class="p">(</span><span class="k">const</span> <span class="n">hrt_abstime</span> <span class="o">&amp;</span><span class="n">timestamp</span><span class="p">,</span> <span class="k">const</span> <span class="n">hrt_abstime</span> <span class="o">&amp;</span><span class="n">timeout</span><span class="p">,</span> <span class="k">const</span> <span class="kt">bool</span> <span class="n">valid_in</span><span class="p">,</span> <span class="kt">bool</span> <span class="o">*</span><span class="n">valid_out</span><span class="p">,</span> <span class="kt">bool</span> <span class="o">*</span><span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hrt_abstime</span> <span class="n">t</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>
	<span class="kt">bool</span> <span class="n">valid_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;</span> <span class="n">timestamp</span> <span class="o">+</span> <span class="n">timeout</span> <span class="o">&amp;&amp;</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="n">timeout</span> <span class="o">&amp;&amp;</span> <span class="n">valid_in</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">valid_out</span> <span class="o">!=</span> <span class="n">valid_new</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">valid_out</span> <span class="o">=</span> <span class="n">valid_new</span><span class="p">;</span>
		<span class="o">*</span><span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">control_status_leds</span><span class="p">(</span><span class="n">vehicle_status_s</span> <span class="o">*</span><span class="n">status_local</span><span class="p">,</span> <span class="k">const</span> <span class="n">actuator_armed_s</span> <span class="o">*</span><span class="n">actuator_armed</span><span class="p">,</span>
		    <span class="kt">bool</span> <span class="n">changed</span><span class="p">,</span> <span class="n">battery_status_s</span> <span class="o">*</span><span class="n">battery_local</span><span class="p">,</span> <span class="k">const</span> <span class="n">cpuload_s</span> <span class="o">*</span><span class="n">cpuload_local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">hrt_abstime</span> <span class="n">overload_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="kt">bool</span> <span class="n">overload</span> <span class="o">=</span> <span class="p">(</span><span class="n">cpuload_local</span><span class="o">-&gt;</span><span class="n">load</span> <span class="o">&gt;</span> <span class="mf">0.80f</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cpuload_local</span><span class="o">-&gt;</span><span class="n">ram_usage</span> <span class="o">&gt;</span> <span class="mf">0.98f</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">overload_start</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">overload</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">overload_start</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">overload</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">overload_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* driving rgbled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">||</span> <span class="n">last_overload</span> <span class="o">!=</span> <span class="n">overload</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint8_t</span> <span class="n">led_mode</span> <span class="o">=</span> <span class="n">led_control_s</span><span class="o">::</span><span class="n">MODE_OFF</span><span class="p">;</span>
		<span class="kt">uint8_t</span> <span class="n">led_color</span> <span class="o">=</span> <span class="n">led_control_s</span><span class="o">::</span><span class="n">COLOR_WHITE</span><span class="p">;</span>
		<span class="kt">bool</span> <span class="n">set_normal_color</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="kt">uint64_t</span> <span class="n">overload_warn_delay</span> <span class="o">=</span> <span class="p">(</span><span class="n">status_local</span><span class="o">-&gt;</span><span class="n">arming_state</span> <span class="o">==</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">ARMING_STATE_ARMED</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span><span class="nl">_ms</span> <span class="p">:</span> <span class="mi">250</span><span class="n">_ms</span><span class="p">;</span>

		<span class="cm">/* set mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">overload</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">overload_start</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">overload_warn_delay</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">led_mode</span> <span class="o">=</span> <span class="n">led_control_s</span><span class="o">::</span><span class="n">MODE_BLINK_FAST</span><span class="p">;</span>
			<span class="n">led_color</span> <span class="o">=</span> <span class="n">led_control_s</span><span class="o">::</span><span class="n">COLOR_PURPLE</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status_local</span><span class="o">-&gt;</span><span class="n">arming_state</span> <span class="o">==</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">ARMING_STATE_ARMED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">led_mode</span> <span class="o">=</span> <span class="n">led_control_s</span><span class="o">::</span><span class="n">MODE_ON</span><span class="p">;</span>
			<span class="n">set_normal_color</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status_flags</span><span class="p">.</span><span class="n">condition_system_sensors_initialized</span> <span class="o">&amp;&amp;</span> <span class="n">status_flags</span><span class="p">.</span><span class="n">condition_system_hotplug_timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">led_mode</span> <span class="o">=</span> <span class="n">led_control_s</span><span class="o">::</span><span class="n">MODE_BLINK_FAST</span><span class="p">;</span>
			<span class="n">led_color</span> <span class="o">=</span> <span class="n">led_control_s</span><span class="o">::</span><span class="n">COLOR_RED</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status_local</span><span class="o">-&gt;</span><span class="n">arming_state</span> <span class="o">==</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">ARMING_STATE_STANDBY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">led_mode</span> <span class="o">=</span> <span class="n">led_control_s</span><span class="o">::</span><span class="n">MODE_BREATHE</span><span class="p">;</span>
			<span class="n">set_normal_color</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status_flags</span><span class="p">.</span><span class="n">condition_system_sensors_initialized</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">status_flags</span><span class="p">.</span><span class="n">condition_system_hotplug_timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">led_mode</span> <span class="o">=</span> <span class="n">led_control_s</span><span class="o">::</span><span class="n">MODE_BREATHE</span><span class="p">;</span>
			<span class="n">set_normal_color</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status_local</span><span class="o">-&gt;</span><span class="n">arming_state</span> <span class="o">==</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">ARMING_STATE_INIT</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-75'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-75'>#</a>
      </div>
      <p>if in init status it should not be in the error state</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="n">led_mode</span> <span class="o">=</span> <span class="n">led_control_s</span><span class="o">::</span><span class="n">MODE_OFF</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="c1">// STANDBY_ERROR and other states</span>
			<span class="n">led_mode</span> <span class="o">=</span> <span class="n">led_control_s</span><span class="o">::</span><span class="n">MODE_BLINK_NORMAL</span><span class="p">;</span>
			<span class="n">led_color</span> <span class="o">=</span> <span class="n">led_control_s</span><span class="o">::</span><span class="n">COLOR_RED</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">set_normal_color</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* set color */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">failsafe</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">led_color</span> <span class="o">=</span> <span class="n">led_control_s</span><span class="o">::</span><span class="n">COLOR_PURPLE</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">battery_local</span><span class="o">-&gt;</span><span class="n">warning</span> <span class="o">==</span> <span class="n">battery_status_s</span><span class="o">::</span><span class="n">BATTERY_WARNING_LOW</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">led_color</span> <span class="o">=</span> <span class="n">led_control_s</span><span class="o">::</span><span class="n">COLOR_AMBER</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">battery_local</span><span class="o">-&gt;</span><span class="n">warning</span> <span class="o">==</span> <span class="n">battery_status_s</span><span class="o">::</span><span class="n">BATTERY_WARNING_CRITICAL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">led_color</span> <span class="o">=</span> <span class="n">led_control_s</span><span class="o">::</span><span class="n">COLOR_RED</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status_flags</span><span class="p">.</span><span class="n">condition_home_position_valid</span> <span class="o">&amp;&amp;</span> <span class="n">status_flags</span><span class="p">.</span><span class="n">condition_global_position_valid</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">led_color</span> <span class="o">=</span> <span class="n">led_control_s</span><span class="o">::</span><span class="n">COLOR_GREEN</span><span class="p">;</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">led_color</span> <span class="o">=</span> <span class="n">led_control_s</span><span class="o">::</span><span class="n">COLOR_BLUE</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">led_mode</span> <span class="o">!=</span> <span class="n">led_control_s</span><span class="o">::</span><span class="n">MODE_OFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rgbled_set_color_and_mode</span><span class="p">(</span><span class="n">led_color</span><span class="p">,</span> <span class="n">led_mode</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">last_overload</span> <span class="o">=</span> <span class="n">overload</span><span class="p">;</span>

<span class="cp">#if !defined(CONFIG_ARCH_LEDS) &amp;&amp; defined(BOARD_HAS_CONTROL_STATUS_LEDS)</span>

	<span class="cm">/* this runs at around 20Hz, full cycle is 16 ticks = 10/16Hz */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">actuator_armed</span><span class="o">-&gt;</span><span class="n">armed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">failsafe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">led_off</span><span class="p">(</span><span class="n">LED_BLUE</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">leds_counter</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">led_toggle</span><span class="p">(</span><span class="n">LED_GREEN</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">led_off</span><span class="p">(</span><span class="n">LED_GREEN</span><span class="p">);</span>

			<span class="cm">/* armed, solid */</span>
			<span class="n">led_on</span><span class="p">(</span><span class="n">LED_BLUE</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">actuator_armed</span><span class="o">-&gt;</span><span class="n">ready_to_arm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">led_off</span><span class="p">(</span><span class="n">LED_BLUE</span><span class="p">);</span>

		<span class="cm">/* ready to arm, blink at 1Hz */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">leds_counter</span> <span class="o">%</span> <span class="mi">20</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">led_toggle</span><span class="p">(</span><span class="n">LED_GREEN</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">led_off</span><span class="p">(</span><span class="n">LED_BLUE</span><span class="p">);</span>

		<span class="cm">/* not ready to arm, blink at 10Hz */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">leds_counter</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">led_toggle</span><span class="p">(</span><span class="n">LED_GREEN</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#endif</span>

	<span class="cm">/* give system warnings on error LED */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">overload</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">leds_counter</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">led_toggle</span><span class="p">(</span><span class="n">LED_AMBER</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">led_off</span><span class="p">(</span><span class="n">LED_AMBER</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">leds_counter</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">transition_result_t</span>
<span class="n">Commander</span><span class="o">::</span><span class="n">set_main_state</span><span class="p">(</span><span class="k">const</span> <span class="n">vehicle_status_s</span> <span class="o">&amp;</span><span class="n">status_local</span><span class="p">,</span> <span class="kt">bool</span> <span class="o">*</span><span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">safety</span><span class="p">.</span><span class="n">override_available</span> <span class="o">&amp;&amp;</span> <span class="n">safety</span><span class="p">.</span><span class="n">override_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">set_main_state_override_on</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">changed</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">set_main_state_rc</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">changed</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">transition_result_t</span>
<span class="n">Commander</span><span class="o">::</span><span class="n">set_main_state_override_on</span><span class="p">(</span><span class="k">const</span> <span class="n">vehicle_status_s</span> <span class="o">&amp;</span><span class="n">status_local</span><span class="p">,</span> <span class="kt">bool</span> <span class="o">*</span><span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">transition_result_t</span> <span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_MANUAL</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>
	<span class="o">*</span><span class="n">changed</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">TRANSITION_CHANGED</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">transition_result_t</span>
<span class="n">Commander</span><span class="o">::</span><span class="n">set_main_state_rc</span><span class="p">(</span><span class="k">const</span> <span class="n">vehicle_status_s</span> <span class="o">&amp;</span><span class="n">status_local</span><span class="p">,</span> <span class="kt">bool</span> <span class="o">*</span><span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* set main state according to RC switches */</span>
	<span class="n">transition_result_t</span> <span class="n">res</span> <span class="o">=</span> <span class="n">TRANSITION_DENIED</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-76'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-76'>#</a>
      </div>
      <p>Note: even if status_flags.offboard_control_set_by_command is set
we want to allow rc mode change to take precidence.  This is a safety
feature, just in case offboard control goes crazy.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="cm">/* manual setpoint has not updated, do not re-evaluate it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">!</span><span class="n">_last_condition_global_position_valid</span> <span class="o">&amp;&amp;</span>
	      <span class="n">status_flags</span><span class="p">.</span><span class="n">condition_global_position_valid</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(((</span><span class="n">_last_sp_man</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">_last_sp_man</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">==</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">timestamp</span><span class="p">))</span> <span class="o">||</span>
		<span class="p">((</span><span class="n">_last_sp_man</span><span class="p">.</span><span class="n">offboard_switch</span> <span class="o">==</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">offboard_switch</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">_last_sp_man</span><span class="p">.</span><span class="n">return_switch</span> <span class="o">==</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">return_switch</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">_last_sp_man</span><span class="p">.</span><span class="n">mode_switch</span> <span class="o">==</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">mode_switch</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">_last_sp_man</span><span class="p">.</span><span class="n">acro_switch</span> <span class="o">==</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">acro_switch</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">_last_sp_man</span><span class="p">.</span><span class="n">rattitude_switch</span> <span class="o">==</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">rattitude_switch</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">_last_sp_man</span><span class="p">.</span><span class="n">posctl_switch</span> <span class="o">==</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">posctl_switch</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">_last_sp_man</span><span class="p">.</span><span class="n">loiter_switch</span> <span class="o">==</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">loiter_switch</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">_last_sp_man</span><span class="p">.</span><span class="n">mode_slot</span> <span class="o">==</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">mode_slot</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">_last_sp_man</span><span class="p">.</span><span class="n">stab_switch</span> <span class="o">==</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">stab_switch</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">_last_sp_man</span><span class="p">.</span><span class="n">man_switch</span> <span class="o">==</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">man_switch</span><span class="p">))))</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-77'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-77'>#</a>
      </div>
      <p>store the last manual control setpoint set by the pilot in a manual state
if the system now later enters an autonomous state the pilot can move
the sticks to break out of the autonomous state</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">warning_action_on</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_MANUAL</span> <span class="o">||</span>
			<span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_ALTCTL</span> <span class="o">||</span>
			<span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_POSCTL</span> <span class="o">||</span>
			<span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_ACRO</span> <span class="o">||</span>
			<span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_RATTITUDE</span> <span class="o">||</span>
			<span class="n">internal_state</span><span class="p">.</span><span class="n">main_state</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_STAB</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">_last_sp_man</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">timestamp</span><span class="p">;</span>
			<span class="n">_last_sp_man</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
			<span class="n">_last_sp_man</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
			<span class="n">_last_sp_man</span><span class="p">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">z</span><span class="p">;</span>
			<span class="n">_last_sp_man</span><span class="p">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">sp_man</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* no timestamp change or no switch change -&gt; nothing changed */</span>
		<span class="k">return</span> <span class="n">TRANSITION_NOT_CHANGED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">_last_sp_man</span> <span class="o">=</span> <span class="n">sp_man</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-78'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-78'>#</a>
      </div>
      <p>reset the position and velocity validity calculation to give the best change of being able to select
the desired mode</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="n">reset_posvel_validity</span><span class="p">(</span><span class="n">changed</span><span class="p">);</span>

	<span class="cm">/* offboard switch overrides main switch */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">offboard_switch</span> <span class="o">==</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">SWITCH_POS_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_OFFBOARD</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">print_reject_mode</span><span class="p">(</span><span class="s">&quot;OFFBOARD&quot;</span><span class="p">);</span>
			<span class="cm">/* mode rejected, continue to evaluate the main system mode */</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* changed successfully or already in this state */</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* RTL switch overrides main switch */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">return_switch</span> <span class="o">==</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">SWITCH_POS_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_RTL</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">print_reject_mode</span><span class="p">(</span><span class="s">&quot;AUTO RTL&quot;</span><span class="p">);</span>

			<span class="cm">/* fallback to LOITER if home position not set */</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_LOITER</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* changed successfully or already in this state */</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* if we get here mode was rejected, continue to evaluate the main system mode */</span>
	<span class="p">}</span>

	<span class="cm">/* Loiter switch overrides main switch */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">loiter_switch</span> <span class="o">==</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">SWITCH_POS_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_LOITER</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">print_reject_mode</span><span class="p">(</span><span class="s">&quot;AUTO HOLD&quot;</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* we know something has changed - check if we are in mode slot operation */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">mode_slot</span> <span class="o">!=</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">MODE_SLOT_NONE</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">mode_slot</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">_flight_mode_slots</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">_flight_mode_slots</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span> <span class="p">{</span>
			<span class="n">warnx</span><span class="p">(</span><span class="s">&quot;m slot overflow&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">TRANSITION_DENIED</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="kt">int</span> <span class="n">new_mode</span> <span class="o">=</span> <span class="n">_flight_mode_slots</span><span class="p">[</span><span class="n">sp_man</span><span class="p">.</span><span class="n">mode_slot</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">new_mode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* slot is unused */</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">TRANSITION_NOT_CHANGED</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">new_mode</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

			<span class="cm">/* ensure that the mode selection does not get stuck here */</span>
			<span class="kt">int</span> <span class="n">maxcount</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

			<span class="cm">/* enable the use of break */</span>
			<span class="cm">/* fallback strategies, give the user the closest mode to what he wanted */</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">TRANSITION_DENIED</span> <span class="o">&amp;&amp;</span> <span class="n">maxcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">maxcount</span><span class="o">--</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">new_mode</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_MISSION</span><span class="p">)</span> <span class="p">{</span>

					<span class="cm">/* fall back to loiter */</span>
					<span class="n">new_mode</span> <span class="o">=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_LOITER</span><span class="p">;</span>
					<span class="n">print_reject_mode</span><span class="p">(</span><span class="s">&quot;AUTO MISSION&quot;</span><span class="p">);</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">new_mode</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">new_mode</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_RTL</span><span class="p">)</span> <span class="p">{</span>

					<span class="cm">/* fall back to position control */</span>
					<span class="n">new_mode</span> <span class="o">=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_LOITER</span><span class="p">;</span>
					<span class="n">print_reject_mode</span><span class="p">(</span><span class="s">&quot;AUTO RTL&quot;</span><span class="p">);</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">new_mode</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">new_mode</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_LAND</span><span class="p">)</span> <span class="p">{</span>

					<span class="cm">/* fall back to position control */</span>
					<span class="n">new_mode</span> <span class="o">=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_LOITER</span><span class="p">;</span>
					<span class="n">print_reject_mode</span><span class="p">(</span><span class="s">&quot;AUTO LAND&quot;</span><span class="p">);</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">new_mode</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">new_mode</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_TAKEOFF</span><span class="p">)</span> <span class="p">{</span>

					<span class="cm">/* fall back to position control */</span>
					<span class="n">new_mode</span> <span class="o">=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_LOITER</span><span class="p">;</span>
					<span class="n">print_reject_mode</span><span class="p">(</span><span class="s">&quot;AUTO TAKEOFF&quot;</span><span class="p">);</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">new_mode</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">new_mode</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_FOLLOW_TARGET</span><span class="p">)</span> <span class="p">{</span>

					<span class="cm">/* fall back to position control */</span>
					<span class="n">new_mode</span> <span class="o">=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_LOITER</span><span class="p">;</span>
					<span class="n">print_reject_mode</span><span class="p">(</span><span class="s">&quot;AUTO FOLLOW&quot;</span><span class="p">);</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">new_mode</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">new_mode</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_LOITER</span><span class="p">)</span> <span class="p">{</span>

					<span class="cm">/* fall back to position control */</span>
					<span class="n">new_mode</span> <span class="o">=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_POSCTL</span><span class="p">;</span>
					<span class="n">print_reject_mode</span><span class="p">(</span><span class="s">&quot;AUTO HOLD&quot;</span><span class="p">);</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">new_mode</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">new_mode</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_POSCTL</span><span class="p">)</span> <span class="p">{</span>

					<span class="cm">/* fall back to altitude control */</span>
					<span class="n">new_mode</span> <span class="o">=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_ALTCTL</span><span class="p">;</span>
					<span class="n">print_reject_mode</span><span class="p">(</span><span class="s">&quot;POSITION CONTROL&quot;</span><span class="p">);</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">new_mode</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">new_mode</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_ALTCTL</span><span class="p">)</span> <span class="p">{</span>

					<span class="cm">/* fall back to stabilized */</span>
					<span class="n">new_mode</span> <span class="o">=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_STAB</span><span class="p">;</span>
					<span class="n">print_reject_mode</span><span class="p">(</span><span class="s">&quot;ALTITUDE CONTROL&quot;</span><span class="p">);</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">new_mode</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">new_mode</span> <span class="o">==</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_STAB</span><span class="p">)</span> <span class="p">{</span>

					<span class="cm">/* fall back to manual */</span>
					<span class="n">new_mode</span> <span class="o">=</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_MANUAL</span><span class="p">;</span>
					<span class="n">print_reject_mode</span><span class="p">(</span><span class="s">&quot;STABILIZED&quot;</span><span class="p">);</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">new_mode</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* offboard and RTL switches off or denied, check main mode switch */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">mode_switch</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="nl">SWITCH_POS_NONE</span><span class="p">:</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">TRANSITION_NOT_CHANGED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="nl">SWITCH_POS_OFF</span><span class="p">:</span>		<span class="c1">// MANUAL</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">stab_switch</span> <span class="o">==</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">SWITCH_POS_NONE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sp_man</span><span class="p">.</span><span class="n">man_switch</span> <span class="o">==</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">SWITCH_POS_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Legacy mode:</span>
<span class="cm">			 * Acro switch being used as stabilized switch in FW.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">acro_switch</span> <span class="o">==</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">SWITCH_POS_ON</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* manual mode is stabilized already for multirotors, so switch to acro</span>
<span class="cm">				 * for any non-manual mode</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">is_rotary_wing</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">is_vtol</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_ACRO</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">is_rotary_wing</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_STAB</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_MANUAL</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>
				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">rattitude_switch</span> <span class="o">==</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">SWITCH_POS_ON</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Similar to acro transitions for multirotors.  FW aircraft don&#39;t need a</span>
<span class="cm">				 * rattitude mode.*/</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">is_rotary_wing</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_RATTITUDE</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_STAB</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>
				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_MANUAL</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* New mode:</span>
<span class="cm">			 * - Acro is Acro</span>
<span class="cm">			 * - Manual is not default anymore when the manaul switch is assigned</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">man_switch</span> <span class="o">==</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">SWITCH_POS_ON</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_MANUAL</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">acro_switch</span> <span class="o">==</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">SWITCH_POS_ON</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_ACRO</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">rattitude_switch</span> <span class="o">==</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">SWITCH_POS_ON</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_RATTITUDE</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">stab_switch</span> <span class="o">==</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">SWITCH_POS_ON</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_STAB</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">man_switch</span> <span class="o">==</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">SWITCH_POS_NONE</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-79'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-79'>#</a>
      </div>
      <p>default to MANUAL when no manual switch is set</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>				<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_MANUAL</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-80'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-80'>#</a>
      </div>
      <p>default to STAB when the manual switch is assigned (but off)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>				<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_STAB</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-81'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-81'>#</a>
      </div>
      <p>TRANSITION_DENIED is not possible here</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="nl">SWITCH_POS_MIDDLE</span><span class="p">:</span>		<span class="c1">// ASSIST</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">posctl_switch</span> <span class="o">==</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">SWITCH_POS_ON</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_POSCTL</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>	<span class="c1">// changed successfully or already in this state</span>
			<span class="p">}</span>

			<span class="n">print_reject_mode</span><span class="p">(</span><span class="s">&quot;POSITION CONTROL&quot;</span><span class="p">);</span>
		<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-82'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-82'>#</a>
      </div>
      <p>fallback to ALTCTL</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_ALTCTL</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>	<span class="c1">// changed successfully or already in this mode</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sp_man</span><span class="p">.</span><span class="n">posctl_switch</span> <span class="o">!=</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="n">SWITCH_POS_ON</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">print_reject_mode</span><span class="p">(</span><span class="s">&quot;ALTITUDE CONTROL&quot;</span><span class="p">);</span>
		<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-83'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-83'>#</a>
      </div>
      <p>fallback to MANUAL</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_MANUAL</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-84'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-84'>#</a>
      </div>
      <p>TRANSITION_DENIED is not possible here</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">manual_control_setpoint_s</span><span class="o">::</span><span class="nl">SWITCH_POS_ON</span><span class="p">:</span>			<span class="c1">// AUTO</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_MISSION</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>	<span class="c1">// changed successfully or already in this state</span>
		<span class="p">}</span>

		<span class="n">print_reject_mode</span><span class="p">(</span><span class="s">&quot;AUTO MISSION&quot;</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-85'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-85'>#</a>
      </div>
      <p>fallback to LOITER if home position not set</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_AUTO_LOITER</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>  <span class="c1">// changed successfully or already in this state</span>
		<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-86'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-86'>#</a>
      </div>
      <p>fallback to POSCTL</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_POSCTL</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>  <span class="c1">// changed successfully or already in this state</span>
		<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-87'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-87'>#</a>
      </div>
      <p>fallback to ALTCTL</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_ALTCTL</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">TRANSITION_DENIED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>	<span class="c1">// changed successfully or already in this state</span>
		<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-88'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-88'>#</a>
      </div>
      <p>fallback to MANUAL</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="n">res</span> <span class="o">=</span> <span class="n">main_state_transition</span><span class="p">(</span><span class="n">status_local</span><span class="p">,</span> <span class="n">commander_state_s</span><span class="o">::</span><span class="n">MAIN_STATE_MANUAL</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">internal_state</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-89'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-89'>#</a>
      </div>
      <p>TRANSITION_DENIED is not possible here</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="k">break</span><span class="p">;</span>

	<span class="k">default</span><span class="o">:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">Commander</span><span class="o">::</span><span class="n">reset_posvel_validity</span><span class="p">(</span><span class="kt">bool</span> <span class="o">*</span><span class="n">changed</span><span class="p">)</span>
<span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-90'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-90'>#</a>
      </div>
      <p>reset all the check probation times back to the minimum value</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="n">_gpos_probation_time_us</span> <span class="o">=</span> <span class="n">POSVEL_PROBATION_MIN</span><span class="p">;</span>
	<span class="n">_lpos_probation_time_us</span> <span class="o">=</span> <span class="n">POSVEL_PROBATION_MIN</span><span class="p">;</span>
	<span class="n">_lvel_probation_time_us</span> <span class="o">=</span> <span class="n">POSVEL_PROBATION_MIN</span><span class="p">;</span>

	<span class="k">const</span> <span class="n">vehicle_local_position_s</span> <span class="o">&amp;</span><span class="n">local_position</span> <span class="o">=</span> <span class="n">_local_position_sub</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
	<span class="k">const</span> <span class="n">vehicle_global_position_s</span> <span class="o">&amp;</span><span class="n">global_position</span> <span class="o">=</span> <span class="n">_global_position_sub</span><span class="p">.</span><span class="n">get</span><span class="p">();</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-91'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-91'>#</a>
      </div>
      <p>recheck validity</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_skip_pos_accuracy_check</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">check_posvel_validity</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="n">global_position</span><span class="p">.</span><span class="n">eph</span><span class="p">,</span> <span class="n">_eph_threshold_adj</span><span class="p">,</span> <span class="n">global_position</span><span class="p">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_last_gpos_fail_time_us</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_gpos_probation_time_us</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_flags</span><span class="p">.</span><span class="n">condition_global_position_valid</span><span class="p">,</span> <span class="n">changed</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">check_posvel_validity</span><span class="p">(</span><span class="n">local_position</span><span class="p">.</span><span class="n">xy_valid</span><span class="p">,</span> <span class="n">local_position</span><span class="p">.</span><span class="n">eph</span><span class="p">,</span> <span class="n">_eph_threshold_adj</span><span class="p">,</span> <span class="n">local_position</span><span class="p">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_last_lpos_fail_time_us</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_lpos_probation_time_us</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_flags</span><span class="p">.</span><span class="n">condition_local_position_valid</span><span class="p">,</span> <span class="n">changed</span><span class="p">);</span>
	<span class="n">check_posvel_validity</span><span class="p">(</span><span class="n">local_position</span><span class="p">.</span><span class="n">v_xy_valid</span><span class="p">,</span> <span class="n">local_position</span><span class="p">.</span><span class="n">evh</span><span class="p">,</span> <span class="n">_evh_threshold</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">local_position</span><span class="p">.</span><span class="n">timestamp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_last_lvel_fail_time_us</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">_lvel_probation_time_us</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_flags</span><span class="p">.</span><span class="n">condition_local_velocity_valid</span><span class="p">,</span> <span class="n">changed</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">Commander</span><span class="o">::</span><span class="n">check_posvel_validity</span><span class="p">(</span><span class="k">const</span> <span class="kt">bool</span> <span class="n">data_valid</span><span class="p">,</span> <span class="k">const</span> <span class="kt">float</span> <span class="n">data_accuracy</span><span class="p">,</span> <span class="k">const</span> <span class="kt">float</span> <span class="n">required_accuracy</span><span class="p">,</span>
				 <span class="k">const</span> <span class="n">hrt_abstime</span> <span class="o">&amp;</span><span class="n">data_timestamp_us</span><span class="p">,</span> <span class="n">hrt_abstime</span> <span class="o">*</span><span class="n">last_fail_time_us</span><span class="p">,</span> <span class="n">hrt_abstime</span> <span class="o">*</span><span class="n">probation_time_us</span><span class="p">,</span> <span class="kt">bool</span> <span class="o">*</span><span class="n">valid_state</span><span class="p">,</span>
				 <span class="kt">bool</span> <span class="o">*</span><span class="n">validity_changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">bool</span> <span class="n">was_valid</span> <span class="o">=</span> <span class="o">*</span><span class="n">valid_state</span><span class="p">;</span>
	<span class="kt">bool</span> <span class="n">valid</span> <span class="o">=</span> <span class="n">was_valid</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-92'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-92'>#</a>
      </div>
      <p>constrain probation times</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">land_detector</span><span class="p">.</span><span class="n">landed</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">probation_time_us</span> <span class="o">=</span> <span class="n">POSVEL_PROBATION_MIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">const</span> <span class="kt">bool</span> <span class="n">data_stale</span> <span class="o">=</span> <span class="p">((</span><span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data_timestamp_us</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">_failsafe_pos_delay</span><span class="p">.</span><span class="n">get</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1</span><span class="n">_s</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">data_timestamp_us</span> <span class="o">==</span> <span class="mi">0</span><span class="p">));</span>
	<span class="k">const</span> <span class="kt">float</span> <span class="n">req_accuracy</span> <span class="o">=</span> <span class="p">(</span><span class="n">was_valid</span> <span class="o">?</span> <span class="n">required_accuracy</span> <span class="o">*</span> <span class="mf">2.5f</span> <span class="o">:</span> <span class="n">required_accuracy</span><span class="p">);</span>

	<span class="k">const</span> <span class="kt">bool</span> <span class="n">level_check_pass</span> <span class="o">=</span> <span class="n">data_valid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">data_stale</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data_accuracy</span> <span class="o">&lt;</span> <span class="n">req_accuracy</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-93'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-93'>#</a>
      </div>
      <p>Check accuracy with hysteresis in both test level and time</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">level_check_pass</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">was_valid</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-94'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-94'>#</a>
      </div>
      <p>still valid, continue to decrease probation time</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="k">const</span> <span class="kt">int64_t</span> <span class="n">probation_time_new</span> <span class="o">=</span> <span class="o">*</span><span class="n">probation_time_us</span> <span class="o">-</span> <span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="n">last_fail_time_us</span><span class="p">);</span>
			<span class="o">*</span><span class="n">probation_time_us</span> <span class="o">=</span> <span class="n">math</span><span class="o">::</span><span class="n">constrain</span><span class="p">(</span><span class="n">probation_time_new</span><span class="p">,</span> <span class="n">POSVEL_PROBATION_MIN</span><span class="p">,</span> <span class="n">POSVEL_PROBATION_MAX</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-95'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-95'>#</a>
      </div>
      <p>check if probation period has elapsed</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="n">last_fail_time_us</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">*</span><span class="n">probation_time_us</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-96'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-96'>#</a>
      </div>
      <p>level check failed</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">was_valid</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-97'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-97'>#</a>
      </div>
      <p>FAILURE! no longer valid</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-98'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-98'>#</a>
      </div>
      <p>failed again, increase probation time</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="k">const</span> <span class="kt">int64_t</span> <span class="n">probation_time_new</span> <span class="o">=</span> <span class="o">*</span><span class="n">probation_time_us</span> <span class="o">+</span> <span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="n">last_fail_time_us</span><span class="p">)</span> <span class="o">*</span> <span class="n">_failsafe_pos_gain</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
			<span class="o">*</span><span class="n">probation_time_us</span> <span class="o">=</span> <span class="n">math</span><span class="o">::</span><span class="n">constrain</span><span class="p">(</span><span class="n">probation_time_new</span><span class="p">,</span> <span class="n">POSVEL_PROBATION_MIN</span><span class="p">,</span> <span class="n">POSVEL_PROBATION_MAX</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="n">last_fail_time_us</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">was_valid</span> <span class="o">!=</span> <span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">validity_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="o">*</span><span class="n">valid_state</span> <span class="o">=</span> <span class="n">valid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">valid</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">set_control_mode</span><span class="p">()</span>
<span class="p">{</span>
	<span class="cm">/* set vehicle_control_mode according to set_navigation_state */</span>
	<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_armed</span> <span class="o">=</span> <span class="n">armed</span><span class="p">.</span><span class="n">armed</span><span class="p">;</span>
	<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_external_manual_override_ok</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">is_rotary_wing</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">is_vtol</span><span class="p">);</span>
	<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_system_hil_enabled</span> <span class="o">=</span> <span class="n">status</span><span class="p">.</span><span class="n">hil_state</span> <span class="o">==</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">HIL_STATE_ON</span><span class="p">;</span>
	<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_offboard_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">nav_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="nl">NAVIGATION_STATE_MANUAL</span><span class="p">:</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_manual_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_auto_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rates_enabled</span> <span class="o">=</span> <span class="n">stabilization_required</span><span class="p">();</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_attitude_enabled</span> <span class="o">=</span> <span class="n">stabilization_required</span><span class="p">();</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rattitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_altitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_climb_rate_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_position_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_velocity_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_acceleration_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_termination_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="nl">NAVIGATION_STATE_STAB</span><span class="p">:</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_manual_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_auto_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rates_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_attitude_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rattitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_altitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_climb_rate_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_position_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_velocity_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_acceleration_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_termination_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="nl">NAVIGATION_STATE_RATTITUDE</span><span class="p">:</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_manual_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_auto_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rates_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_attitude_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rattitude_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_altitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_climb_rate_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_position_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_velocity_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_acceleration_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_termination_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="nl">NAVIGATION_STATE_ALTCTL</span><span class="p">:</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_manual_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_auto_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rates_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_attitude_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rattitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_altitude_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_climb_rate_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_position_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_velocity_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_acceleration_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_termination_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="nl">NAVIGATION_STATE_POSCTL</span><span class="p">:</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_manual_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_auto_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rates_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_attitude_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rattitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_altitude_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_climb_rate_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_position_enabled</span> <span class="o">=</span> <span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">in_transition_mode</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_velocity_enabled</span> <span class="o">=</span> <span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">in_transition_mode</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_acceleration_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_termination_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="nl">NAVIGATION_STATE_AUTO_RTL</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="nl">NAVIGATION_STATE_AUTO_RCRECOVER</span><span class="p">:</span>
		<span class="cm">/* override is not ok for the RTL and recovery mode */</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_external_manual_override_ok</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* fallthrough */</span>
	<span class="k">case</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="nl">NAVIGATION_STATE_AUTO_FOLLOW_TARGET</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="nl">NAVIGATION_STATE_AUTO_RTGS</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="nl">NAVIGATION_STATE_AUTO_LAND</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="nl">NAVIGATION_STATE_AUTO_LANDENGFAIL</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="nl">NAVIGATION_STATE_AUTO_PRECLAND</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="nl">NAVIGATION_STATE_AUTO_MISSION</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="nl">NAVIGATION_STATE_AUTO_LOITER</span><span class="p">:</span>
	<span class="k">case</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="nl">NAVIGATION_STATE_AUTO_TAKEOFF</span><span class="p">:</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_manual_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_auto_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rates_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_attitude_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rattitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_altitude_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_climb_rate_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_position_enabled</span> <span class="o">=</span> <span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">in_transition_mode</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_velocity_enabled</span> <span class="o">=</span> <span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">in_transition_mode</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_acceleration_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_termination_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="nl">NAVIGATION_STATE_AUTO_LANDGPSFAIL</span><span class="p">:</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_manual_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_auto_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rates_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_attitude_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rattitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_altitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_climb_rate_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_position_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_velocity_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_acceleration_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_termination_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="nl">NAVIGATION_STATE_ACRO</span><span class="p">:</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_manual_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_auto_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rates_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_attitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rattitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_altitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_climb_rate_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_position_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_velocity_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_acceleration_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_termination_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="nl">NAVIGATION_STATE_DESCEND</span><span class="p">:</span>
		<span class="cm">/* TODO: check if this makes sense */</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_manual_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_auto_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rates_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_attitude_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rattitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_position_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_velocity_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_acceleration_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_altitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_climb_rate_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_termination_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="nl">NAVIGATION_STATE_TERMINATION</span><span class="p">:</span>
		<span class="cm">/* disable all controllers on termination */</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_manual_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_auto_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rates_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_attitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rattitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_position_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_velocity_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_acceleration_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_altitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_climb_rate_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_termination_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="nl">NAVIGATION_STATE_OFFBOARD</span><span class="p">:</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_manual_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_auto_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_offboard_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * The control flags depend on what is ignored according to the offboard control mode topic</span>
<span class="cm">		 * Inner loop flags (e.g. attitude) also depend on outer loop ignore flags (e.g. position)</span>
<span class="cm">		 */</span>
		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rates_enabled</span> <span class="o">=</span> <span class="o">!</span><span class="n">offboard_control_mode</span><span class="p">.</span><span class="n">ignore_bodyrate</span> <span class="o">||</span>
				<span class="o">!</span><span class="n">offboard_control_mode</span><span class="p">.</span><span class="n">ignore_attitude</span> <span class="o">||</span>
				<span class="o">!</span><span class="n">offboard_control_mode</span><span class="p">.</span><span class="n">ignore_position</span> <span class="o">||</span>
				<span class="o">!</span><span class="n">offboard_control_mode</span><span class="p">.</span><span class="n">ignore_velocity</span> <span class="o">||</span>
				<span class="o">!</span><span class="n">offboard_control_mode</span><span class="p">.</span><span class="n">ignore_acceleration_force</span><span class="p">;</span>

		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_attitude_enabled</span> <span class="o">=</span> <span class="o">!</span><span class="n">offboard_control_mode</span><span class="p">.</span><span class="n">ignore_attitude</span> <span class="o">||</span>
				<span class="o">!</span><span class="n">offboard_control_mode</span><span class="p">.</span><span class="n">ignore_position</span> <span class="o">||</span>
				<span class="o">!</span><span class="n">offboard_control_mode</span><span class="p">.</span><span class="n">ignore_velocity</span> <span class="o">||</span>
				<span class="o">!</span><span class="n">offboard_control_mode</span><span class="p">.</span><span class="n">ignore_acceleration_force</span><span class="p">;</span>

		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_rattitude_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_acceleration_enabled</span> <span class="o">=</span> <span class="o">!</span><span class="n">offboard_control_mode</span><span class="p">.</span><span class="n">ignore_acceleration_force</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">in_transition_mode</span><span class="p">;</span>

		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_velocity_enabled</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="n">offboard_control_mode</span><span class="p">.</span><span class="n">ignore_velocity</span> <span class="o">||</span>
				<span class="o">!</span><span class="n">offboard_control_mode</span><span class="p">.</span><span class="n">ignore_position</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">in_transition_mode</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_acceleration_enabled</span><span class="p">;</span>

		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_climb_rate_enabled</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="n">offboard_control_mode</span><span class="p">.</span><span class="n">ignore_velocity</span> <span class="o">||</span>
				<span class="o">!</span><span class="n">offboard_control_mode</span><span class="p">.</span><span class="n">ignore_position</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_acceleration_enabled</span><span class="p">;</span>

		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_position_enabled</span> <span class="o">=</span> <span class="o">!</span><span class="n">offboard_control_mode</span><span class="p">.</span><span class="n">ignore_position</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">in_transition_mode</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_acceleration_enabled</span><span class="p">;</span>

		<span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_altitude_enabled</span> <span class="o">=</span> <span class="p">(</span><span class="o">!</span><span class="n">offboard_control_mode</span><span class="p">.</span><span class="n">ignore_velocity</span> <span class="o">||</span>
				<span class="o">!</span><span class="n">offboard_control_mode</span><span class="p">.</span><span class="n">ignore_position</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">control_mode</span><span class="p">.</span><span class="n">flag_control_acceleration_enabled</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">default</span><span class="o">:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">bool</span>
<span class="n">stabilization_required</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">is_rotary_wing</span> <span class="o">||</span>		<span class="c1">// is a rotary wing, or</span>
		<span class="n">status</span><span class="p">.</span><span class="n">vtol_fw_permanent_stab</span> <span class="o">||</span> 	<span class="c1">// is a VTOL in fixed wing mode and stabilisation is on, or</span>
		<span class="p">(</span><span class="n">vtol_status</span><span class="p">.</span><span class="n">vtol_in_trans_mode</span> <span class="o">&amp;&amp;</span> 	<span class="c1">// is currently a VTOL transitioning AND</span>
		 <span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">is_rotary_wing</span><span class="p">));</span>	<span class="c1">// is a fixed wing, ie: transitioning back to rotary wing mode</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">print_reject_mode</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hrt_abstime</span> <span class="n">t</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">last_print_mode_reject_time</span> <span class="o">&gt;</span> <span class="n">PRINT_MODE_REJECT_INTERVAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">last_print_mode_reject_time</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
		<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;REJECT %s&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>

		<span class="cm">/* only buzz if armed, because else we&#39;re driving people nuts indoors</span>
<span class="cm">		they really need to look at the leds as well. */</span>
		<span class="n">tune_negative</span><span class="p">(</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">print_reject_arm</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hrt_abstime</span> <span class="n">t</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">last_print_mode_reject_time</span> <span class="o">&gt;</span> <span class="n">PRINT_MODE_REJECT_INTERVAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">last_print_mode_reject_time</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
		<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="n">tune_negative</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">answer_command</span><span class="p">(</span><span class="k">const</span> <span class="n">vehicle_command_s</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">result</span><span class="p">,</span> <span class="n">orb_advert_t</span> <span class="o">&amp;</span><span class="n">command_ack_pub</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">:</span>
		<span class="n">tune_positive</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_RESULT_DENIED</span><span class="p">:</span>
		<span class="n">tune_negative</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_RESULT_FAILED</span><span class="p">:</span>
		<span class="n">tune_negative</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_RESULT_TEMPORARILY_REJECTED</span><span class="p">:</span>
		<span class="n">tune_negative</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_RESULT_UNSUPPORTED</span><span class="p">:</span>
		<span class="n">tune_negative</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">default</span><span class="o">:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* publish ACK */</span>
	<span class="n">vehicle_command_ack_s</span> <span class="n">command_ack</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">result_param2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">command</span><span class="p">,</span>
		<span class="p">.</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="n">result</span><span class="p">,</span>
		<span class="p">.</span><span class="n">from_external</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
		<span class="p">.</span><span class="n">result_param1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">target_system</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">source_system</span><span class="p">,</span>
		<span class="p">.</span><span class="n">target_component</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">source_component</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">command_ack_pub</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">orb_publish</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_command_ack</span><span class="p">),</span> <span class="n">command_ack_pub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">command_ack</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">command_ack_pub</span> <span class="o">=</span> <span class="n">orb_advertise_queue</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_command_ack</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">command_ack</span><span class="p">,</span>
						      <span class="n">vehicle_command_ack_s</span><span class="o">::</span><span class="n">ORB_QUEUE_LENGTH</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="o">*</span><span class="n">commander_low_prio_loop</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Set thread name */</span>
	<span class="n">px4_prctl</span><span class="p">(</span><span class="n">PR_SET_NAME</span><span class="p">,</span> <span class="s">&quot;commander_low_prio&quot;</span><span class="p">,</span> <span class="n">px4_getpid</span><span class="p">());</span>

	<span class="cm">/* Subscribe to command topic */</span>
	<span class="kt">int</span> <span class="n">cmd_sub</span> <span class="o">=</span> <span class="n">orb_subscribe</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_command</span><span class="p">));</span>

	<span class="cm">/* command ack */</span>
	<span class="n">orb_advert_t</span> <span class="n">command_ack_pub</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>

	<span class="cm">/* wakeup source(s) */</span>
	<span class="n">px4_pollfd_struct_t</span> <span class="n">fds</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="cm">/* use the gyro to pace output - XXX BROKEN if we are using the L3GD20 */</span>
	<span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fd</span> <span class="o">=</span> <span class="n">cmd_sub</span><span class="p">;</span>
	<span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">events</span> <span class="o">=</span> <span class="n">POLLIN</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">thread_should_exit</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* wait for up to 1000ms for data */</span>
		<span class="kt">int</span> <span class="n">pret</span> <span class="o">=</span> <span class="n">px4_poll</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">fds</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span> <span class="mi">1000</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* this is undesirable but not much we can do - might want to flag unhappy status */</span>
			<span class="n">warn</span><span class="p">(</span><span class="s">&quot;commander: poll error %d, %d&quot;</span><span class="p">,</span> <span class="n">pret</span><span class="p">,</span> <span class="n">errno</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">vehicle_command_s</span> <span class="n">cmd</span><span class="p">;</span>

			<span class="cm">/* if we reach here, we have a valid command */</span>
			<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">vehicle_command</span><span class="p">),</span> <span class="n">cmd_sub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

			<span class="cm">/* ignore commands the high-prio loop or the navigator handles */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">==</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_DO_SET_MODE</span> <span class="o">||</span>
			    <span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">==</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_COMPONENT_ARM_DISARM</span> <span class="o">||</span>
			    <span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">==</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_NAV_TAKEOFF</span> <span class="o">||</span>
			    <span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">==</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_DO_SET_SERVO</span> <span class="o">||</span>
			    <span class="n">cmd</span><span class="p">.</span><span class="n">command</span> <span class="o">==</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_DO_CHANGE_SPEED</span><span class="p">)</span> <span class="p">{</span>

				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* only handle low-priority commands here */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_PREFLIGHT_REBOOT_SHUTDOWN</span><span class="p">:</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_safe</span><span class="p">(</span><span class="n">safety</span><span class="p">,</span> <span class="n">armed</span><span class="p">))</span> <span class="p">{</span>

					<span class="k">if</span> <span class="p">(((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">,</span> <span class="n">command_ack_pub</span><span class="p">);</span>
						<span class="n">usleep</span><span class="p">(</span><span class="mi">100000</span><span class="p">);</span>
						<span class="cm">/* reboot */</span>
						<span class="n">px4_shutdown_request</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">,</span> <span class="n">command_ack_pub</span><span class="p">);</span>
						<span class="n">usleep</span><span class="p">(</span><span class="mi">100000</span><span class="p">);</span>
						<span class="cm">/* shutdown */</span>
						<span class="n">px4_shutdown_request</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">,</span> <span class="n">command_ack_pub</span><span class="p">);</span>
						<span class="n">usleep</span><span class="p">(</span><span class="mi">100000</span><span class="p">);</span>
						<span class="cm">/* reboot to bootloader */</span>
						<span class="n">px4_shutdown_request</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_DENIED</span><span class="p">,</span> <span class="n">command_ack_pub</span><span class="p">);</span>
					<span class="p">}</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_DENIED</span><span class="p">,</span> <span class="n">command_ack_pub</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_PREFLIGHT_CALIBRATION</span><span class="p">:</span> <span class="p">{</span>

					<span class="kt">int</span> <span class="n">calib_ret</span> <span class="o">=</span> <span class="n">PX4_ERROR</span><span class="p">;</span>

					<span class="cm">/* try to go to INIT/PREFLIGHT arming state */</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">TRANSITION_DENIED</span> <span class="o">==</span> <span class="n">arming_state_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="n">battery</span><span class="p">,</span> <span class="n">safety</span><span class="p">,</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">ARMING_STATE_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">armed</span><span class="p">,</span>
							<span class="nb">false</span> <span class="cm">/* fRunPreArmChecks */</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_flags</span><span class="p">,</span>
							<span class="n">arm_requirements</span><span class="p">,</span> <span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commander_boot_timestamp</span><span class="p">)))</span> <span class="p">{</span>

						<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_DENIED</span><span class="p">,</span> <span class="n">command_ack_pub</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>

					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">status_flags</span><span class="p">.</span><span class="n">condition_calibration_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* gyro calibration */</span>
						<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">,</span> <span class="n">command_ack_pub</span><span class="p">);</span>
						<span class="n">calib_ret</span> <span class="o">=</span> <span class="n">do_gyro_calibration</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">);</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param1</span><span class="p">)</span> <span class="o">==</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">PREFLIGHT_CALIBRATION_TEMPERATURE_CALIBRATION</span> <span class="o">||</span>
						   <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param5</span><span class="p">)</span> <span class="o">==</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">PREFLIGHT_CALIBRATION_TEMPERATURE_CALIBRATION</span> <span class="o">||</span>
						   <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param7</span><span class="p">)</span> <span class="o">==</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">PREFLIGHT_CALIBRATION_TEMPERATURE_CALIBRATION</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* temperature calibration: handled in events module */</span>
						<span class="k">break</span><span class="p">;</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* magnetometer calibration */</span>
						<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">,</span> <span class="n">command_ack_pub</span><span class="p">);</span>
						<span class="n">calib_ret</span> <span class="o">=</span> <span class="n">do_mag_calibration</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">);</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* zero-altitude pressure calibration */</span>
						<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_DENIED</span><span class="p">,</span> <span class="n">command_ack_pub</span><span class="p">);</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* RC calibration */</span>
						<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">,</span> <span class="n">command_ack_pub</span><span class="p">);</span>
						<span class="cm">/* disable RC control input completely */</span>
						<span class="n">status_flags</span><span class="p">.</span><span class="n">rc_input_blocked</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
						<span class="n">calib_ret</span> <span class="o">=</span> <span class="n">OK</span><span class="p">;</span>
						<span class="n">mavlink_log_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;CAL: Disabling RC IN&quot;</span><span class="p">);</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* RC trim calibration */</span>
						<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">,</span> <span class="n">command_ack_pub</span><span class="p">);</span>
						<span class="n">calib_ret</span> <span class="o">=</span> <span class="n">do_trim_calibration</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">);</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* accelerometer calibration */</span>
						<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">,</span> <span class="n">command_ack_pub</span><span class="p">);</span>
						<span class="n">calib_ret</span> <span class="o">=</span> <span class="n">do_accel_calibration</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">);</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-99'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-99'>#</a>
      </div>
      <p>board offset calibration</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>						<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">,</span> <span class="n">command_ack_pub</span><span class="p">);</span>
						<span class="n">calib_ret</span> <span class="o">=</span> <span class="n">do_level_calibration</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">);</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-100'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-100'>#</a>
      </div>
      <p>TODO: param6 == 1 is deprecated, but we still accept it for a while (feb 2017)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>						<span class="cm">/* airspeed calibration */</span>
						<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">,</span> <span class="n">command_ack_pub</span><span class="p">);</span>
						<span class="n">calib_ret</span> <span class="o">=</span> <span class="n">do_airspeed_calibration</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">);</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* do esc calibration */</span>
						<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">,</span> <span class="n">command_ack_pub</span><span class="p">);</span>
						<span class="n">calib_ret</span> <span class="o">=</span> <span class="n">do_esc_calibration</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">armed</span><span class="p">);</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* RC calibration ended - have we been in one worth confirming? */</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">status_flags</span><span class="p">.</span><span class="n">rc_input_blocked</span><span class="p">)</span> <span class="p">{</span>
							<span class="cm">/* enable RC control input */</span>
							<span class="n">status_flags</span><span class="p">.</span><span class="n">rc_input_blocked</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
							<span class="n">mavlink_log_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;CAL: Re-enabling RC IN&quot;</span><span class="p">);</span>
						<span class="p">}</span>

						<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">,</span> <span class="n">command_ack_pub</span><span class="p">);</span>
						<span class="cm">/* this always succeeds */</span>
						<span class="n">calib_ret</span> <span class="o">=</span> <span class="n">OK</span><span class="p">;</span>

					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_UNSUPPORTED</span><span class="p">,</span> <span class="n">command_ack_pub</span><span class="p">);</span>
					<span class="p">}</span>

					<span class="n">status_flags</span><span class="p">.</span><span class="n">condition_calibration_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">calib_ret</span> <span class="o">==</span> <span class="n">OK</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">tune_positive</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>

						<span class="n">Commander</span><span class="o">::</span><span class="n">preflight_check</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>

						<span class="n">arming_state_transition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="n">battery</span><span class="p">,</span> <span class="n">safety</span><span class="p">,</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">ARMING_STATE_STANDBY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">armed</span><span class="p">,</span>
									<span class="nb">false</span> <span class="cm">/* fRunPreArmChecks */</span><span class="p">,</span>
									<span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_flags</span><span class="p">,</span> <span class="n">arm_requirements</span><span class="p">,</span> <span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commander_boot_timestamp</span><span class="p">));</span>

					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">tune_negative</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
					<span class="p">}</span>

					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

			<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_PREFLIGHT_STORAGE</span><span class="p">:</span> <span class="p">{</span>

					<span class="k">if</span> <span class="p">(((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">param_load_default</span><span class="p">();</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">OK</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">mavlink_log_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;settings loaded&quot;</span><span class="p">);</span>
							<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">,</span> <span class="n">command_ack_pub</span><span class="p">);</span>

						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;settings load ERROR&quot;</span><span class="p">);</span>

							<span class="cm">/* convenience as many parts of NuttX use negative errno */</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ret</span><span class="p">;</span>
							<span class="p">}</span>

							<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;ERROR: %s&quot;</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
							<span class="p">}</span>

							<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_FAILED</span><span class="p">,</span> <span class="n">command_ack_pub</span><span class="p">);</span>
						<span class="p">}</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

<span class="cp">#ifdef __PX4_QURT</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-101'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-101'>#</a>
      </div>
      <p>TODO FIXME: on snapdragon the save happens too early when the params
are not set yet. We therefore need to wait some time first.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>						<span class="n">usleep</span><span class="p">(</span><span class="mi">1000000</span><span class="p">);</span>
<span class="cp">#endif</span>

						<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">param_save_default</span><span class="p">();</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">OK</span><span class="p">)</span> <span class="p">{</span>
							<span class="cm">/* do not spam MAVLink, but provide the answer / green led mechanism */</span>
							<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">,</span> <span class="n">command_ack_pub</span><span class="p">);</span>

						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;settings save error&quot;</span><span class="p">);</span>

							<span class="cm">/* convenience as many parts of NuttX use negative errno */</span>
							<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ret</span><span class="p">;</span>
							<span class="p">}</span>

							<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
								<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;ERROR: %s&quot;</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
							<span class="p">}</span>

							<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_FAILED</span><span class="p">,</span> <span class="n">command_ack_pub</span><span class="p">);</span>
						<span class="p">}</span>

					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="kt">int</span><span class="p">)(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>

						<span class="cm">/* reset parameters and save empty file */</span>
						<span class="n">param_reset_all</span><span class="p">();</span>

						<span class="cm">/* do not spam MAVLink, but provide the answer / green led mechanism */</span>
						<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;onboard parameters reset&quot;</span><span class="p">);</span>
						<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">,</span> <span class="n">command_ack_pub</span><span class="p">);</span>
					<span class="p">}</span>

					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

			<span class="k">case</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="nl">VEHICLE_CMD_START_RX_PAIR</span><span class="p">:</span>
				<span class="cm">/* just ack, implementation handled in the IO driver */</span>
				<span class="n">answer_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">vehicle_command_s</span><span class="o">::</span><span class="n">VEHICLE_CMD_RESULT_ACCEPTED</span><span class="p">,</span> <span class="n">command_ack_pub</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">default</span><span class="o">:</span>
				<span class="cm">/* don&#39;t answer on unsupported commands, it will be done in main loop */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">px4_close</span><span class="p">(</span><span class="n">cmd_sub</span><span class="p">);</span>

	<span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">Commander</span><span class="o">::</span><span class="n">custom_command</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">print_usage</span><span class="p">(</span><span class="s">&quot;unknown command&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">Commander</span><span class="o">::</span><span class="n">print_usage</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PX4_WARN</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">Commander</span><span class="o">::</span><span class="n">task_spawn</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="n">_task_id</span> <span class="o">=</span> <span class="n">px4_task_spawn_cmd</span><span class="p">(</span><span class="s">&quot;commander&quot;</span><span class="p">,</span>
				      <span class="n">SCHED_DEFAULT</span><span class="p">,</span>
				      <span class="n">SCHED_PRIORITY_DEFAULT</span> <span class="o">+</span> <span class="mi">40</span><span class="p">,</span>
				      <span class="mi">3250</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">px4_main_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">run_trampoline</span><span class="p">,</span>
				      <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="p">)</span><span class="n">argv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_task_id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_task_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">Commander</span> <span class="o">*</span><span class="n">Commander</span><span class="o">::</span><span class="n">instantiate</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="n">Commander</span> <span class="o">*</span><span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Commander</span><span class="p">();</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-102'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-102'>#</a>
      </div>
      <p>XXX remove this once this is a class member</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>	<span class="n">status</span> <span class="o">=</span> <span class="p">{};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">instance</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&quot;--hil&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">instance</span><span class="o">-&gt;</span><span class="n">enable_hil</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">instance</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Commander</span><span class="o">::</span><span class="n">enable_hil</span><span class="p">()</span>
<span class="p">{</span>
	<span class="n">status</span><span class="p">.</span><span class="n">hil_state</span> <span class="o">=</span> <span class="n">vehicle_status_s</span><span class="o">::</span><span class="n">HIL_STATE_ON</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Commander</span><span class="o">::</span><span class="n">mission_init</span><span class="p">()</span>
<span class="p">{</span>
	<span class="cm">/* init mission state, do it here to allow navigator to use stored mission even if mavlink failed to start */</span>
	<span class="n">mission_s</span> <span class="n">mission</span> <span class="o">=</span> <span class="p">{};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dm_read</span><span class="p">(</span><span class="n">DM_KEY_MISSION_STATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mission</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mission_s</span><span class="p">))</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mission_s</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mission</span><span class="p">.</span><span class="n">dataman_id</span> <span class="o">==</span> <span class="n">DM_KEY_WAYPOINTS_OFFBOARD_0</span> <span class="o">||</span> <span class="n">mission</span><span class="p">.</span><span class="n">dataman_id</span> <span class="o">==</span> <span class="n">DM_KEY_WAYPOINTS_OFFBOARD_1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mission</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">PX4_INFO</span><span class="p">(</span><span class="s">&quot;Mission #%d loaded, %u WPs, curr: %d&quot;</span><span class="p">,</span> <span class="n">mission</span><span class="p">.</span><span class="n">dataman_id</span><span class="p">,</span> <span class="n">mission</span><span class="p">.</span><span class="n">count</span><span class="p">,</span> <span class="n">mission</span><span class="p">.</span><span class="n">current_seq</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">PX4_ERR</span><span class="p">(</span><span class="s">&quot;reading mission state failed&quot;</span><span class="p">);</span>

			<span class="cm">/* initialize mission state in dataman */</span>
			<span class="n">mission</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>
			<span class="n">mission</span><span class="p">.</span><span class="n">dataman_id</span> <span class="o">=</span> <span class="n">DM_KEY_WAYPOINTS_OFFBOARD_0</span><span class="p">;</span>
			<span class="n">dm_write</span><span class="p">(</span><span class="n">DM_KEY_MISSION_STATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DM_PERSIST_POWER_ON_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mission</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mission_s</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">orb_advert_t</span> <span class="n">mission_pub</span> <span class="o">=</span> <span class="n">orb_advertise</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">mission</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">mission</span><span class="p">);</span>
		<span class="n">orb_unadvertise</span><span class="p">(</span><span class="n">mission_pub</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">Commander</span><span class="o">::</span><span class="n">preflight_check</span><span class="p">(</span><span class="kt">bool</span> <span class="n">report</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">bool</span> <span class="n">checkGNSS</span> <span class="o">=</span> <span class="p">(</span><span class="n">arm_requirements</span> <span class="o">&amp;</span> <span class="n">ARM_REQ_GPS_BIT</span><span class="p">);</span>

	<span class="kt">bool</span> <span class="n">success</span> <span class="o">=</span> <span class="n">Preflight</span><span class="o">::</span><span class="n">preflightCheck</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">status_flags</span><span class="p">,</span> <span class="n">checkGNSS</span><span class="p">,</span> <span class="n">report</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span>
			<span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commander_boot_timestamp</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status_flags</span><span class="p">.</span><span class="n">condition_system_sensors_initialized</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">success</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Commander</span><span class="o">::</span><span class="n">poll_telemetry_status</span><span class="p">()</span>
<span class="p">{</span>
	<span class="kt">bool</span> <span class="n">updated</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ORB_MULTI_MAX_INSTANCES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">subscriber</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">subscriber</span> <span class="o">=</span> <span class="n">orb_subscribe_multi</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">telemetry_status</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">orb_check</span><span class="p">(</span><span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">subscriber</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">updated</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">telemetry_status_s</span> <span class="n">telemetry</span> <span class="o">=</span> <span class="p">{};</span>
			<span class="n">orb_copy</span><span class="p">(</span><span class="n">ORB_ID</span><span class="p">(</span><span class="n">telemetry_status</span><span class="p">),</span> <span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">subscriber</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">telemetry</span><span class="p">);</span>

			<span class="cm">/* perform system checks when new telemetry link connected */</span>
			<span class="k">if</span> <span class="p">(</span><span class="cm">/* we first connect a link or re-connect a link after loosing it or haven&#39;t yet reported anything */</span>
				<span class="p">(</span><span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">last_heartbeat</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">last_heartbeat</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="n">_s</span><span class="p">)</span>
				 <span class="o">||</span> <span class="o">!</span><span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">preflight_checks_reported</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="cm">/* and this link has a communication partner */</span>
				<span class="p">(</span><span class="n">telemetry</span><span class="p">.</span><span class="n">heartbeat_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="cm">/* and it is still connected */</span>
				<span class="p">(</span><span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">telemetry</span><span class="p">.</span><span class="n">heartbeat_time</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="n">_s</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="cm">/* and the system is not already armed (and potentially flying) */</span>
				<span class="o">!</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span><span class="p">)</span> <span class="p">{</span>

				<span class="cm">/* flag the checks as reported for this link when we actually report them */</span>
				<span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">preflight_checks_reported</span> <span class="o">=</span> <span class="n">status_flags</span><span class="p">.</span><span class="n">condition_system_hotplug_timeout</span><span class="p">;</span>

				<span class="n">preflight_check</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-103'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-103'>#</a>
      </div>
      <p>Provide feedback on mission state</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>				<span class="k">const</span> <span class="n">mission_result_s</span> <span class="o">&amp;</span><span class="n">mission_result</span> <span class="o">=</span> <span class="n">_mission_result_sub</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">mission_result</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">&gt;</span> <span class="n">commander_boot_timestamp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">status_flags</span><span class="p">.</span><span class="n">condition_system_hotplug_timeout</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">mission_result</span><span class="p">.</span><span class="n">instance_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mission_result</span><span class="p">.</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>

					<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;Planned mission fails check. Please upload again.&quot;</span><span class="p">);</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-104'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-104'>#</a>
      </div>
      <p>set_health_flags(subsystem_info_s::SUBSYSTEM_TYPE_MISSION, true, true, false, status); // TODO</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-105'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-105'>#</a>
      </div>
      <p>set_health_flags(subsystem_info_s::SUBSYSTEM_TYPE_MISSION, true, true, true, status); // TODO</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>				<span class="p">}</span>
			<span class="p">}</span>

			<span class="cm">/* set (and don&#39;t reset) telemetry via USB as active once a MAVLink connection is up */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">telemetry</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">telemetry_status_s</span><span class="o">::</span><span class="n">TELEMETRY_STATUS_RADIO_TYPE_USB</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status_flags</span><span class="p">.</span><span class="n">usb_connected</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* set latency type of the telemetry connection */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">telemetry</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">telemetry_status_s</span><span class="o">::</span><span class="n">TELEMETRY_STATUS_RADIO_TYPE_IRIDIUM</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">high_latency</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">high_latency</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">telemetry</span><span class="p">.</span><span class="n">heartbeat_time</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">last_heartbeat</span> <span class="o">&lt;</span> <span class="n">telemetry</span><span class="p">.</span><span class="n">heartbeat_time</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">last_heartbeat</span> <span class="o">=</span> <span class="n">telemetry</span><span class="p">.</span><span class="n">heartbeat_time</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-106'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-106'>#</a>
      </div>
      <p>for iridium telemetry use the iridiumsbd_status to update the heartbeat</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">high_latency</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">_iridiumsbd_status_sub</span><span class="p">.</span><span class="n">update</span><span class="p">())</span> <span class="p">{</span>
				<span class="k">const</span> <span class="n">hrt_abstime</span> <span class="n">isbd_timestamp</span> <span class="o">=</span> <span class="n">_iridiumsbd_status_sub</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">last_heartbeat</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">isbd_timestamp</span> <span class="o">&gt;</span> <span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">last_heartbeat</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">last_heartbeat</span> <span class="o">=</span> <span class="n">isbd_timestamp</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Commander</span><span class="o">::</span><span class="n">data_link_checks</span><span class="p">(</span><span class="kt">int32_t</span> <span class="n">highlatencydatalink_loss_timeout</span><span class="p">,</span> <span class="kt">int32_t</span> <span class="n">highlatencydatalink_regain_timeout</span><span class="p">,</span>
				 <span class="kt">int32_t</span> <span class="n">datalink_loss_timeout</span><span class="p">,</span> <span class="kt">int32_t</span> <span class="n">datalink_regain_timeout</span><span class="p">,</span> <span class="kt">bool</span> <span class="o">*</span><span class="n">status_changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* data links check */</span>
	<span class="kt">bool</span> <span class="n">have_link</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">bool</span> <span class="n">high_latency_link_exists</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">bool</span> <span class="n">have_low_latency_link</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int32_t</span> <span class="n">dl_loss_timeout_local</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int32_t</span> <span class="n">dl_regain_timeout_local</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ORB_MULTI_MAX_INSTANCES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">high_latency</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">high_latency_link_exists</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">high_latency_data_link_active</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dl_loss_timeout_local</span> <span class="o">=</span> <span class="n">highlatencydatalink_loss_timeout</span><span class="p">;</span>
				<span class="n">dl_regain_timeout_local</span> <span class="o">=</span> <span class="n">highlatencydatalink_regain_timeout</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-107'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-107'>#</a>
      </div>
      <p>if the high latency link is inactive we do not want to accidentally detect it as an active link</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>				<span class="n">dl_loss_timeout_local</span> <span class="o">=</span> <span class="n">INT32_MIN</span><span class="p">;</span>
				<span class="n">dl_regain_timeout_local</span> <span class="o">=</span> <span class="n">INT32_MAX</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dl_loss_timeout_local</span> <span class="o">=</span> <span class="n">datalink_loss_timeout</span><span class="p">;</span>
			<span class="n">dl_regain_timeout_local</span> <span class="o">=</span> <span class="n">datalink_regain_timeout</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">last_heartbeat</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">last_heartbeat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">dl_loss_timeout_local</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* handle the case where data link was gained first time or regained,</span>
<span class="cm">			 * accept datalink as healthy only after datalink_regain_timeout seconds</span>
<span class="cm">			 * */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lost</span> <span class="o">&amp;&amp;</span>
			    <span class="n">hrt_elapsed_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">last_dl_loss</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">dl_regain_timeout_local</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">)</span> <span class="p">{</span>

				<span class="cm">/* report a regain */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">last_dl_loss</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mavlink_and_console_log_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;data link #%i regained&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">last_dl_loss</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* new link */</span>
				<span class="p">}</span>

				<span class="cm">/* got link again or new */</span>
				<span class="o">*</span><span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

				<span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lost</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">have_link</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">high_latency</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">have_low_latency_link</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lost</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* telemetry was healthy also in last iteration</span>
<span class="cm">				 * we don&#39;t have to check a timeout */</span>
				<span class="n">have_link</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">high_latency</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">have_low_latency_link</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lost</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* only reset the timestamp to a different time on state change */</span>
				<span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">last_dl_loss</span>  <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>

				<span class="n">mavlink_and_console_log_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;data link #%i lost&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lost</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">have_link</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* handle the case where data link was regained */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">data_link_lost</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span><span class="p">.</span><span class="n">data_link_lost</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="o">*</span><span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">high_latency_data_link_active</span> <span class="o">&amp;&amp;</span> <span class="n">have_low_latency_link</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-108'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-108'>#</a>
      </div>
      <p>regained a low latency telemetry link, deactivate the high latency link
to avoid transmitting unnecessary data over that link</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="n">status</span><span class="p">.</span><span class="n">high_latency_data_link_active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="o">*</span><span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;LOW LATENCY DATA LINKS REGAINED, DEACTIVATING HIGH LATENCY LINK&quot;</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">high_latency_link_exists</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">high_latency_data_link_active</span> <span class="o">&amp;&amp;</span> <span class="n">armed</span><span class="p">.</span><span class="n">armed</span><span class="p">)</span> <span class="p">{</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-109'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-109'>#</a>
      </div>
      <p>low latency telemetry lost and high latency link existing</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="n">status</span><span class="p">.</span><span class="n">high_latency_data_link_active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="o">*</span><span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-110'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-110'>#</a>
      </div>
      <p>set heartbeat to current time for high latency so that the first message can be transmitted</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>			<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ORB_MULTI_MAX_INSTANCES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">high_latency</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">_telemetry</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">last_heartbeat</span> <span class="o">=</span> <span class="n">hrt_absolute_time</span><span class="p">();</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">data_link_lost</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;ALL LOW LATENCY DATA LINKS LOST, ACTIVATING HIGH LATENCY LINK&quot;</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;ACTIVATING AVAILABLE HIGH LATENCY LINK&quot;</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">data_link_lost</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">armed</span><span class="p">.</span><span class="n">armed</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mavlink_log_critical</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mavlink_log_pub</span><span class="p">,</span> <span class="s">&quot;ALL DATA LINKS LOST&quot;</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">status</span><span class="p">.</span><span class="n">data_link_lost</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">status</span><span class="p">.</span><span class="n">data_link_lost_counter</span><span class="o">++</span><span class="p">;</span>
			<span class="o">*</span><span class="n">status_changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
