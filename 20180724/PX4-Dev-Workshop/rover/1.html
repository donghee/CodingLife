<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-08-19 목 11:04 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PX4 and ROS Programming Day 1</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Donghee Park" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://gongzhitaao.org/orgcss/org.css"/>
<style type="text/css">img {  width: auto ;  max-width: 100% ;  height: auto ;} </style>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "left",
        displayIndent: "5em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "Neo-Euler"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "Neo-Euler"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "left",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">PX4 and ROS Programming Day 1</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org981adf7">1. 수업</a></li>
<li><a href="#org909fbed">2. UGV 제어 소프트웨어 소개 및 설치</a></li>
<li><a href="#org0d77b8c">3. Ardupilot 소개</a>
<ul>
<li><a href="#org1f1bb0e">3.1. Ardupilot 구조 소개</a></li>
</ul>
</li>
<li><a href="#org06587c7">4. Linux 사용하기</a></li>
<li><a href="#org4dcbee2">5. PX4 개발환경 구성 (+ROS)</a></li>
<li><a href="#orgf19c30f">6. PX4 Firmware Build</a>
<ul>
<li><a href="#org0d71b23">6.1. PX4 v.10.1 다운로드</a></li>
<li><a href="#org861e4b9">6.2. Gazebo 실행</a></li>
<li><a href="#org624522c">6.3. QGroundControl 사용</a></li>
</ul>
</li>
<li><a href="#org08bcbe9">7. ROS 프로그래밍</a>
<ul>
<li><a href="#org3b41b10">7.1. ROS</a></li>
<li><a href="#org32855f8">7.2. ROS Nodes and Topics</a>
<ul>
<li><a href="#orgbbdddad">7.2.1. ROS Master Process</a></li>
<li><a href="#org443b070">7.2.2. Topics</a></li>
<li><a href="#org7c86965">7.2.3. Publish and Subscribe</a></li>
</ul>
</li>
<li><a href="#org7f2fa90">7.3. ROS Message Passing</a></li>
<li><a href="#org0615461">7.4. ROS Services</a>
<ul>
<li><a href="#org39a33e9">7.4.1. 예시: 카메라 이미지 얻기</a></li>
</ul>
</li>
<li><a href="#org629566c">7.5. ROS Turtlesim</a>
<ul>
<li><a href="#org2d2838c">7.5.1. Turtlesim 실행하기</a></li>
<li><a href="#org43dd563">7.5.2. Turtlesim 노드 목록</a></li>
<li><a href="#orgad0e728">7.5.3. Turtlesim 토픽 목록</a></li>
<li><a href="#org9f0ff32">7.5.4. Turtlesim 토픽 정보</a></li>
<li><a href="#orgf25ffc7">7.5.5. Turtlesim 메시지 정보</a></li>
<li><a href="#org42f45c1">7.5.6. Turtlesim Echo a Topic</a></li>
<li><a href="#org8b0ca27">7.5.7. <code>rqt_graph</code></a></li>
</ul>
</li>
<li><a href="#org1492c93">7.6. MavROS</a>
<ul>
<li><a href="#org2b340ab">7.6.1. MavROS 설치 및 실행 (이미 자동설치됨, 안해도됨)</a></li>
</ul>
</li>
<li><a href="#orgfb5017d">7.7. Gazebo 실행</a></li>
</ul>
</li>
<li><a href="#org15d91cc">8. ROS 노드 관리</a>
<ul>
<li><a href="#orga5aca36">8.1. ROS 노드 실행 및 관리</a></li>
<li><a href="#org6f90e66">8.2. ROS 노드 명령 실행하기. (MAVROS 위주)</a>
<ul>
<li><a href="#org3706e9c">8.2.1. Subscribe</a></li>
<li><a href="#org410261b">8.2.2. Services</a></li>
<li><a href="#orgd501dff">8.2.3. Publish</a></li>
<li><a href="#org420f5cc">8.2.4. 실습</a></li>
<li><a href="#org5c0c8a1">8.2.5. 유용한 mavros 명령(노드) 모음</a></li>
</ul>
</li>
<li><a href="#org41d4ed6">8.3. 토픽 레코드: rosbag</a></li>
<li><a href="#orgcca399f">8.4. 참고</a></li>
</ul>
</li>
<li><a href="#org0513f9b">9. ROS 노드 만들기</a>
<ul>
<li><a href="#orgf9a837a">9.1. 새로운 노드 만들기</a>
<ul>
<li><a href="#orgafdbcb9">9.1.1. 패키지 만들기</a></li>
<li><a href="#org6aef764">9.1.2. 노드 코드 작성</a></li>
<li><a href="#org5f4125e">9.1.3. 패키지 빌드</a></li>
<li><a href="#orge662ac0">9.1.4. 패키지 노드 실행</a></li>
<li><a href="#orgfe56a94">9.1.5. 해보기: /mavros/state 읽어서 1초마다 비행 mode 한번씩 출력</a></li>
<li><a href="#org55eecb2">9.1.6. 해보기 결과:</a></li>
</ul>
</li>
<li><a href="#orgf09255c">9.2. 새로운 노드 만들기: 드론 이륙 착륙</a></li>
<li><a href="#org8cd1834">9.3. 새로운 노드 만들기: <code>offb_node</code></a>
<ul>
<li><a href="#orga45970d">9.3.1. launch 파일을 이용하여 노드 한번에 실행 (옵션)</a></li>
</ul>
</li>
<li><a href="#orgd3ec23e">9.4. 새로운 노드 만들기: <code>circle</code></a>
<ul>
<li><a href="#orgfa3476a">9.4.1. 해보기: 원의 너비와 속도를 바꾸어 보자. 힌트 (wn, r)</a></li>
</ul>
</li>
<li><a href="#orgc31951e">9.5. 과제: 키보드로 OFFBOARD 모드 제어하기</a></li>
<li><a href="#org6b3fb43">9.6. 참고</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org981adf7" class="outline-2">
<h2 id="org981adf7"><span class="section-number-2">1</span> 수업</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>목표: UGV 제어 소프트웨어에 대해 이해할 수 있고, 프로그래밍 환경을 구축할 수 있다.</li>
<li>교재: <a href="https://learn.dronemap.io/">https://learn.dronemap.io/</a></li>
<li>코치: 박동희 dongheepark@gmail.com</li>
</ul>
</div>
</div>

<div id="outline-container-org909fbed" class="outline-2">
<h2 id="org909fbed"><span class="section-number-2">2</span> UGV 제어 소프트웨어 소개 및 설치</h2>
<div class="outline-text-2" id="text-2">
<ol class="org-ol">
<li>워크숍 소개, 참가자 소개</li>

<li>Ardupilot Rover 소개, ROS 소개</li>

<li>Linux 사용하기</li>
</ol>
</div>
</div>

<div id="outline-container-org0d77b8c" class="outline-2">
<h2 id="org0d77b8c"><span class="section-number-2">3</span> Ardupilot 소개</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li><a href="https://ardupilot.org">https://ardupilot.org</a>
<ul class="org-ul">
<li>Open Source Autopilot: GPLv3</li>
<li>160만줄 (2021년)</li>
<li>Multi copter, plane, rover, helicopter, antenna tracker</li>
<li>MAVLink, MAVProxy</li>
<li>Ground Stations(Mission Planner)</li>
<li><a href="https://github.com/ardupilot/ardupilot">https://github.com/ardupilot/ardupilot</a></li>
</ul></li>
</ul>
</div>

<div id="outline-container-org1f1bb0e" class="outline-3">
<h3 id="org1f1bb0e"><span class="section-number-3">3.1</span> Ardupilot 구조 소개</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li><code>AP_HAL</code></li>
<li>하드웨어 추상 레이어.</li>
<li>다양한 OS와 CPU에 포팅</li>
<li>HAL에서 최소한의 하드웨어 연결 인터페이스(포팅이 쉽다)
<ul class="org-ul">
<li>AP<sub>HAL</sub><sub>AVR</sub>, AP<sub>HAL</sub><sub>SITL</sub>, AP<sub>HAL</sub><sub>PX4</sub>, AP<sub>HAL</sub><sub>Flymaple</sub> AP<sub>HAL</sub><sub>VRBrain</sub> AP<sub>HAL</sub><sub>Linux</sub> AP<sub>HAL</sub><sub>Empty</sub></li>
</ul></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org06587c7" class="outline-2">
<h2 id="org06587c7"><span class="section-number-2">4</span> Linux 사용하기</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>Ubuntu 20.04 설치</li>
<li>주요 명령어 소개(파일 조작, 프로그램설치, 쉘스크립트, git)</li>
</ul>

<p>
ls: 파일 또는 디렉토리의 목록을 출력
</p>
<pre class="example">
ls
ls -al
</pre>

<p>
cd: 디렉토리 이동
</p>
<pre class="example">
cd ~
cd ~/Downloads
</pre>

<p>
pwd: 현재 디렉토리 출력
</p>
<pre class="example">
pwd
</pre>

<p>
mkdir: 디렉토리 생성
</p>
<pre class="example">
mkdir tmp
</pre>

<p>
rm: 파일 또는 디렉토리 지우기
</p>
<pre class="example">
rm -rf tmp
</pre>

<p>
cat: 파일 입력 또는 출력
</p>
<pre class="example">
cat ~/.bashrc
cat &gt; ~/.hello.c
</pre>

<p>
cp: 파일 또는 디렉토리 복사
</p>
<pre class="example">
cp hello.c world.c
</pre>

<p>
chmod: 파일의 퍼미션 지정
</p>
<pre class="example">
chmod +x hello
</pre>

<p>
wget: url에서 파일 다운로드
</p>
<pre class="example">
wget https://google.com
</pre>

<p>
source: 현재 쉘에서 파일을 읽고 실행
</p>
<pre class="example">
source ~/.bashrc
</pre>
</div>
</div>


<div id="outline-container-org4dcbee2" class="outline-2">
<h2 id="org4dcbee2"><span class="section-number-2">5</span> PX4 개발환경 구성 (+ROS)</h2>
<div class="outline-text-2" id="text-5">
<p>
<a href="https://dev.px4.io/master/en/setup/dev_env_linux_ubuntu.html">https://dev.px4.io/master/en/setup/dev_env_linux_ubuntu.html</a>
</p>

<pre class="example">
cd ~
wget https://raw.githubusercontent.com/PX4/Devguide/master/build_scripts/ubuntu_sim_ros_melodic.sh
chmod +x ubuntu_sim_ros_melodic.sh
./ubuntu_sim_ros_melodic.sh
</pre>
</div>
</div>

<div id="outline-container-orgf19c30f" class="outline-2">
<h2 id="orgf19c30f"><span class="section-number-2">6</span> PX4 Firmware Build</h2>
<div class="outline-text-2" id="text-6">
<ul class="org-ul">
<li><a href="https://dev.px4.io">https://dev.px4.io</a></li>
<li>Gazebo 사용하기</li>
<li>Qgroundcontrol</li>
</ul>
</div>

<div id="outline-container-org0d71b23" class="outline-3">
<h3 id="org0d71b23"><span class="section-number-3">6.1</span> PX4 v.10.1 다운로드</h3>
<div class="outline-text-3" id="text-6-1">
<pre class="example">
cd ~
git clone https://github.com/PX4/Firmware.git --recursive
cd ~/Firmware
bash ./Tools/setup/ubuntu.sh
git checkout v1.10.1
git submodule update --init --recursive
</pre>
</div>
</div>

<div id="outline-container-org861e4b9" class="outline-3">
<h3 id="org861e4b9"><span class="section-number-3">6.2</span> Gazebo 실행</h3>
<div class="outline-text-3" id="text-6-2">
<pre class="example">
cd ~/Firmware
make px4_sitl gazebo
</pre>
</div>
</div>

<div id="outline-container-org624522c" class="outline-3">
<h3 id="org624522c"><span class="section-number-3">6.3</span> QGroundControl 사용</h3>
<div class="outline-text-3" id="text-6-3">
<p>
다운로드: <a href="https://docs.qgroundcontrol.com/en/getting_started/download_and_install.html">https://docs.qgroundcontrol.com/en/getting_started/download_and_install.html</a>
</p>

<p>
QGroundControl 다운로드 및 실행
</p>
<pre class="example">
sudo usermod -a -G dialout $USER
sudo apt-get remove modemmanager -y
sudo apt install gstreamer1.0-plugins-bad gstreamer1.0-libav gstreamer1.0-gl -y

cd ~/Downloads
chmod +x ./QGroundControl.AppImage
./QGroundControl.AppImage
</pre>
</div>
</div>
</div>


<div id="outline-container-org08bcbe9" class="outline-2">
<h2 id="org08bcbe9"><span class="section-number-2">7</span> ROS 프로그래밍</h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-org3b41b10" class="outline-3">
<h3 id="org3b41b10"><span class="section-number-3">7.1</span> ROS</h3>
<div class="outline-text-3" id="text-7-1">
<ul class="org-ul">
<li>Robot Operating System: 로봇 빌드에 사용되는 라이브러리 어플리케이션 모음 <a href="http://www.ros.org/">http://www.ros.org/</a></li>
<li>목표: 로봇을 만들때 기존의 재활용 하고 공유하자.</li>
<li>History:
<ul class="org-ul">
<li>2000s: Standford Artificial intelligence</li>
<li>2007: Willow Garage</li>
<li>2013: Open Source Robotics Foundation</li>
</ul></li>
<li>사용 분야: Drone, Kinematic ARMS(로봇암), Wheeled(바퀴), Bi-pedal(이족)</li>
</ul>
</div>
</div>

<div id="outline-container-org32855f8" class="outline-3">
<h3 id="org32855f8"><span class="section-number-3">7.2</span> ROS Nodes and Topics</h3>
<div class="outline-text-3" id="text-7-2">
<div class="org-src-container">
<pre class="src src-dot">digraph {
  rankdir=LR
  graph [fontname="MS Gothic"];
  node [shape=rect, color="#40e0d0"]
  edge [fontname="MS Gothic"];
  label = "Robot Communication Sequence";
  "Perception" -&gt; "Dicesion Making";
  "Dicesion Making" -&gt; "Actuation";
}
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="orgd1eb05a"></a>Perception: Sense<br />
<div class="outline-text-5" id="text-7-2-0-1">
<ul class="org-ul">
<li>Sensor Fusion</li>
<li>Filtering</li>
<li>Localization</li>
</ul>
</div>
</li>

<li><a id="org2df2d07"></a>Dicesion Making: Decide<br />
<div class="outline-text-5" id="text-7-2-0-2">
<ul class="org-ul">
<li>Path Planning</li>
<li>Prediction</li>
<li>Behavior Planning</li>
</ul>
</div>
</li>

<li><a id="orge53cb3d"></a>Actuation: Act<br />
<div class="outline-text-5" id="text-7-2-0-3">
<ul class="org-ul">
<li>PID Control</li>
<li>Model Predictive Control</li>
</ul>
</div>
</li>
</ol>

<div id="outline-container-orgbbdddad" class="outline-4">
<h4 id="orgbbdddad"><span class="section-number-4">7.2.1</span> ROS Master Process</h4>
<div class="outline-text-4" id="text-7-2-1">
<p>
노드 관리
</p>

<div class="org-src-container">
<pre class="src src-dot">digraph {
  graph [fontname="MS Gothic"];
  node [shape=box, color="#40e0d0"]
  edge [fontname="MS Gothic"];
  label = "ROS Master Process";

  subgraph cluster_perception {
    node [shape=rect, style="rounded"]
    label = "Perception";
    Camera;
    "Wheel Encoder";
    "Positon Estimator";
  }

  subgraph cluster_dicesion_making {
    node [shape=rect, style="rounded"]
    label = "Dicesion Making";
    "Behavior Execution";
  }

  subgraph cluster_actuation {
    node [shape=rect, style="rounded"]
    label = "Actuation";
    "Motor Control";
  }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org443b070" class="outline-4">
<h4 id="org443b070"><span class="section-number-4">7.2.2</span> Topics</h4>
<div class="outline-text-4" id="text-7-2-2">
<p>
노드간 통신 인터페이스. 구독 발행의 이름
</p>

<div class="org-src-container">
<pre class="src src-dot">digraph {
  rankdir=LR
  node [color="#40e0d0"]
  edge [fontname="MS Gothic"];
  node1 [label= ""]
  node2 [label= ""]

  node1 -&gt; node2 [label="/topic_name"];
}

</pre>
</div>
</div>
</div>

<div id="outline-container-org7c86965" class="outline-4">
<h4 id="org7c86965"><span class="section-number-4">7.2.3</span> Publish and Subscribe</h4>
<div class="outline-text-4" id="text-7-2-3">
<p>
발행과 구독. 신문/잡지 발행 구독에 비유
</p>

<div class="org-src-container">
<pre class="src src-dot">digraph {
  rankdir=LR
  node [color="#40e0d0"]
  edge [fontname="MS Gothic"];
  label = "      PUBLISH           SUBSCRIBER";
  node1 [label= ""]
  node2 [label= ""]

  node1 -&gt; node2
  node2 -&gt; node1
}
</pre>
</div>

<p>
실제 예제
</p>

<div class="org-src-container">
<pre class="src src-dot">digraph {
  node [color="#40e0d0"]
  edge [fontname="MS Gothic"];

  "Wheel Encoder" -&gt; "Positon Estimator" [label="/wheel_encoder\lrotation"]
  "Behavior Executor" -&gt; "Motor Controller" [label="/motor_controller\lvelocity_cmd"]
  "Camera" -&gt; "Behavior Executor" [label="/camera_images\limage"]
  "Positon Estimator" -&gt; "Behavior Executor" [label="/position_estimate\lpose"]
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org7f2fa90" class="outline-3">
<h3 id="org7f2fa90"><span class="section-number-3">7.3</span> ROS Message Passing</h3>
<div class="outline-text-3" id="text-7-3">
<p>
메시지: 노드간 통신할때 이동하는 실제 데이터
</p>
<ul class="org-ul">
<li>메시지는 텍스트로 구성. 메시지를 이해하기 쉽다.</li>
</ul>

<p>
미리 정의된 메시지 타입 :
</p>
<ul class="org-ul">
<li><a href="http://wiki.ros.org/common_msgs">http://wiki.ros.org/common_msgs</a></li>
<li><a href="https://github.com/ros/common_msgs">https://github.com/ros/common_msgs</a></li>
</ul>
</div>
</div>

<div id="outline-container-org0615461" class="outline-3">
<h3 id="org0615461"><span class="section-number-3">7.4</span> ROS Services</h3>
<div class="outline-text-3" id="text-7-4">
<ul class="org-ul">
<li>Request-Response, 1:1 통신</li>
<li>PubSub이 필요 없는 경우 사용, 요청 할때만 데이터가 제공. 네트워크 부하가 적다.</li>
</ul>
</div>

<div id="outline-container-org39a33e9" class="outline-4">
<h4 id="org39a33e9"><span class="section-number-4">7.4.1</span> 예시: 카메라 이미지 얻기</h4>
<div class="outline-text-4" id="text-7-4-1">
<div class="org-src-container">
<pre class="src src-dot">digraph {
  rankdir=LR;
  node [color="#40e0d0"];
  edge [fontname="MS Gothic"];
  label = "Publicate and Subscribe";

  "Camera" -&gt; "Behavior Executor" [label="/camera_images\limage"]
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-dot">digraph {
  rankdir=LR;
  node [color="#40e0d0"];
  edge [fontname="MS Gothic", style=dotted];
  label = "Request-Response";


  "Behavior Executor" -&gt; "Camera" [label="/capture_image\lrequest: exposure time"]
  "Camera" -&gt; "Behavior Executor" [label="\nresponse: image"]
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org629566c" class="outline-3">
<h3 id="org629566c"><span class="section-number-3">7.5</span> ROS Turtlesim</h3>
<div class="outline-text-3" id="text-7-5">
<p>
Turtle
</p>


<div id="org980ca07" class="figure">
<p><img src="https://i.imgur.com/0r46gFH.png" alt="0r46gFH.png" />
</p>
</div>
</div>

<div id="outline-container-org2d2838c" class="outline-4">
<h4 id="org2d2838c"><span class="section-number-4">7.5.1</span> Turtlesim 실행하기</h4>
<div class="outline-text-4" id="text-7-5-1">

<div id="orgd7f6081" class="figure">
<p><img src="https://d17h27t6h515a5.cloudfront.net/topher/2017/March/58d9820b_running-turtlesim/running-turtlesim.png" alt="running-turtlesim.png" />
</p>
</div>


<ol class="org-ol">
<li>환경 변수 설정</li>
</ol>

<div class="org-src-container">
<pre class="src src-sh">source /opt/ros/melodic/setup.bash
</pre>
</div>

<ol class="org-ol">
<li>roscore 실행
<ul class="org-ul">
<li>roscore: Master + rosout + parameter server
<ul class="org-ul">
<li>Master: 네임 서비스</li>
<li>rosout: stdout/stderr 로깅</li>
<li>parameter server: 파라미터 저장 서버</li>
</ul></li>
</ul></li>
</ol>

<div class="org-src-container">
<pre class="src src-sh">roscore
</pre>
</div>

<ol class="org-ol">
<li>turtlesim 패키지의 <code>turtlesim_node</code> 실행</li>
</ol>
<div class="org-src-container">
<pre class="src src-sh">rosrun turtlesim turtlesim_node
</pre>
</div>

<ol class="org-ol">
<li>turtlesim 패키지의 <code>turtle_teleop_key</code> 실행</li>
</ol>
<div class="org-src-container">
<pre class="src src-sh">rosrun turtlesim turtle_teleop_key
</pre>
</div>
</div>
</div>

<div id="outline-container-org43dd563" class="outline-4">
<h4 id="org43dd563"><span class="section-number-4">7.5.2</span> Turtlesim 노드 목록</h4>
<div class="outline-text-4" id="text-7-5-2">
<div class="org-src-container">
<pre class="src src-sh">rosnode list
</pre>
</div>

<p>
/rosout : ROS 메시지 로깅.
</p>
</div>
</div>

<div id="outline-container-orgad0e728" class="outline-4">
<h4 id="orgad0e728"><span class="section-number-4">7.5.3</span> Turtlesim 토픽 목록</h4>
<div class="outline-text-4" id="text-7-5-3">
<div class="org-src-container">
<pre class="src src-sh">rostopic list
</pre>
</div>
</div>
</div>

<div id="outline-container-org9f0ff32" class="outline-4">
<h4 id="org9f0ff32"><span class="section-number-4">7.5.4</span> Turtlesim 토픽 정보</h4>
<div class="outline-text-4" id="text-7-5-4">
<div class="org-src-container">
<pre class="src src-sh">rostopic info /turtle1/cmd_vel

</pre>
</div>
</div>
</div>

<div id="outline-container-orgf25ffc7" class="outline-4">
<h4 id="orgf25ffc7"><span class="section-number-4">7.5.5</span> Turtlesim 메시지 정보</h4>
<div class="outline-text-4" id="text-7-5-5">
<div class="org-src-container">
<pre class="src src-sh">$ rosmsg info geometry_msgs/Twist
geometry_msgs/Vector3 linear
  float64 x
  float64 y
  float64 z
geometry_msgs/Vector3 angular
  float64 x
  float64 y
  float64 z
</pre>
</div>

<p>
or
</p>

<div class="org-src-container">
<pre class="src src-sh">rosed geometry_msgs Twist.msg
</pre>
</div>
</div>
</div>

<div id="outline-container-org42f45c1" class="outline-4">
<h4 id="org42f45c1"><span class="section-number-4">7.5.6</span> Turtlesim Echo a Topic</h4>
<div class="outline-text-4" id="text-7-5-6">
<p>
디버깅시 편리
</p>

<div class="org-src-container">
<pre class="src src-sh">rostopic echo /turtle1/cmd_vel
</pre>
</div>
</div>
</div>

<div id="outline-container-org8b0ca27" class="outline-4">
<h4 id="org8b0ca27"><span class="section-number-4">7.5.7</span> <code>rqt_graph</code></h4>
<div class="outline-text-4" id="text-7-5-7">
<div class="org-src-container">
<pre class="src src-sh">rqt_graph
</pre>
</div>


<div id="org4659d38" class="figure">
<p><img src="http://wiki.ros.org/rqt_graph?action=AttachFile&amp;do=get&amp;target=snap_rqt_graph_moveit_demo.png" alt="rqt_graph?action=AttachFile&amp;do=get&amp;target=snap_rqt_graph_moveit_demo.png" />
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org1492c93" class="outline-3">
<h3 id="org1492c93"><span class="section-number-3">7.6</span> MavROS</h3>
<div class="outline-text-3" id="text-7-6">
<p>
<a href="http://wiki.ros.org/mavros">http://wiki.ros.org/mavros</a> mavlink ros wrapper
</p>


<div id="org5337f43" class="figure">
<p><img src="https://i.imgur.com/9z8DEIn.png" alt="9z8DEIn.png" />
</p>
</div>
</div>

<div id="outline-container-org2b340ab" class="outline-4">
<h4 id="org2b340ab"><span class="section-number-4">7.6.1</span> MavROS 설치 및 실행 (이미 자동설치됨, 안해도됨)</h4>
<div class="outline-text-4" id="text-7-6-1">
<div class="org-src-container">
<pre class="src src-sh">
## Create catkin workspace (ROS build system)
mkdir -p ~/catkin_ws/src
cd ~/catkin_ws

## Install dependencies
sudo apt-get install python-wstool python-rosinstall-generator python-catkin-tools -y

## Initialise wstool
wstool init ~/catkin_ws/src

## Build MAVROS
### Get source (upstream - released)
rosinstall_generator --upstream mavros --rosdistro kinetic | tee /tmp/mavros.rosinstall
### Get latest released mavlink package
rosinstall_generator mavlink --rosdistro kinetic | tee -a /tmp/mavros.rosinstall
### Setup workspace &amp; install deps
wstool merge -t src /tmp/mavros.rosinstall
wstool update -t src
rosdep install --from-paths src --ignore-src --rosdistro kinetic -y

### Install GeographicLib datasets
./src/mavros/mavros/scripts/install_geographiclib_datasets.sh

### Build source
catkin build

### source setup.bash
source devel/setup.bash

</pre>
</div>

<p>
환경변수 설정: workspace
</p>

<pre class="example">
cd ~/catkin_ws
source devel/setup.bash
</pre>

<p>
<code>mavros_node</code> 실행
</p>

<div class="org-src-container">
<pre class="src src-sh">rosrun mavros mavros_node _fcu_url:="udp://:14540@127.0.0.1:14557" _gcs_url:="udp://@127.0.0.1"
</pre>
</div>

<p>
<code>mavros_node</code> 실행 (roslaunch 사용하는 방법)
</p>
<div class="org-src-container">
<pre class="src src-sh"># px4.launch 이용하여 mavros node 실행. fcu ip주소는 127.0.0.1 ip주소를 바꾸면 다른 컴퓨터의 fcu도 연결 가능.
cd ~/catkin_ws
roslaunch mavros px4.launch fcu_url:="udp://:14540@127.0.0.1:14557" _gcs_url:"udp://@127.0.0.1"
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgfb5017d" class="outline-3">
<h3 id="orgfb5017d"><span class="section-number-3">7.7</span> Gazebo 실행</h3>
<div class="outline-text-3" id="text-7-7">
<p>
시뮬레이터의 홈 위치(위도 경도 해발고도) 지정
</p>

<div class="org-src-container">
<pre class="src src-sh">export PX4_HOME_LAT=35.9012382
export PX4_HOME_LON=128.854495337
export PX4_HOME_ALT=71

cd ~/Firmware
make px4_sitl gazebo
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-org15d91cc" class="outline-2">
<h2 id="org15d91cc"><span class="section-number-2">8</span> ROS 노드 관리</h2>
<div class="outline-text-2" id="text-8">
</div>
<div id="outline-container-orga5aca36" class="outline-3">
<h3 id="orga5aca36"><span class="section-number-3">8.1</span> ROS 노드 실행 및 관리</h3>
<div class="outline-text-3" id="text-8-1">
</div>
<ol class="org-ol">
<li><a id="org248a0b2"></a>ROS Core 노드 실행<br />
<div class="outline-text-5" id="text-8-1-0-1">
<div class="org-src-container">
<pre class="src src-sh">roscore
</pre>
</div>
</div>
</li>

<li><a id="org59512e0"></a>MAVROS 노드 실행<br />
<div class="outline-text-5" id="text-8-1-0-2">
<div class="org-src-container">
<pre class="src src-sh">rosrun mavros mavros_node _fcu_url:="udp://:14540@127.0.0.1:14557" _gcs_url:="udp://@127.0.0.1"
</pre>
</div>
</div>
</li>

<li><a id="org1c86e44"></a>토픽 목록<br />
<div class="outline-text-5" id="text-8-1-0-3">
<div class="org-src-container">
<pre class="src src-sh">rostopic list
</pre>
</div>
</div>
</li>

<li><a id="org8273c71"></a>토픽 내용 보기<br />
<ol class="org-ol">
<li><a id="org8dcbc81"></a>메시지 타입 보기<br />
<div class="outline-text-6" id="text-8-1-0-4-1">
<div class="org-src-container">
<pre class="src src-sh">rostopic info /mavros/state
</pre>
</div>

<p>
타입 내부 보기
</p>
<div class="org-src-container">
<pre class="src src-sh">rostopic type /mavros/state | rosmsg show
</pre>
</div>
</div>
</li>

<li><a id="org427f19e"></a>메시지 내용<br />
<div class="outline-text-6" id="text-8-1-0-4-2">
<div class="org-src-container">
<pre class="src src-sh">rostopic echo /mavros/state
</pre>
</div>
</div>
</li>

<li><a id="org97ab84f"></a>토픽 publish 주기 보기<br />
<div class="outline-text-6" id="text-8-1-0-4-3">
<div class="org-src-container">
<pre class="src src-sh">rostopic hz /mavros/state
</pre>
</div>
</div>
</li>

<li><a id="org5e0efa6"></a>실행 노드 확인<br />
<div class="outline-text-6" id="text-8-1-0-4-4">
<div class="org-src-container">
<pre class="src src-sh">rqt_graph
</pre>
</div>
</div>
</li>
</ol>
</li>
</ol>
</div>

<div id="outline-container-org6f90e66" class="outline-3">
<h3 id="org6f90e66"><span class="section-number-3">8.2</span> ROS 노드 명령 실행하기. (MAVROS 위주)</h3>
<div class="outline-text-3" id="text-8-2">
<p>
<a href="http://wiki.ros.org/ROS/Tutorials/UnderstandingTopics">http://wiki.ros.org/ROS/Tutorials/UnderstandingTopics</a>
</p>
</div>

<div id="outline-container-org3706e9c" class="outline-4">
<h4 id="org3706e9c"><span class="section-number-4">8.2.1</span> Subscribe</h4>
<div class="outline-text-4" id="text-8-2-1">
<div class="org-src-container">
<pre class="src src-sh">rostopic echo [topic]
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="org02890be"></a><code>STATE</code><br />
<div class="outline-text-5" id="text-8-2-1-1">
<div class="org-src-container">
<pre class="src src-sh">rostopic echo /mavros/state
</pre>
</div>
</div>
</li>

<li><a id="org442c15d"></a><code>LOCAL_POSITION</code> 확인<br />
<div class="outline-text-5" id="text-8-2-1-2">
<div class="org-src-container">
<pre class="src src-sh">rostopic echo /mavros/local_position/pose
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org410261b" class="outline-4">
<h4 id="org410261b"><span class="section-number-4">8.2.2</span> Services</h4>
<div class="outline-text-4" id="text-8-2-2">
<p>
서비스 목록
</p>

<div class="org-src-container">
<pre class="src src-sh">rosservice list
</pre>
</div>

<p>
서비스 실행(call) 하기
</p>

<div class="org-src-container">
<pre class="src src-sh">rosservice call [topic] [msg_type] [args]
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="org73147a4"></a><code>SET_MODE</code><br />
<div class="outline-text-5" id="text-8-2-2-1">
<div class="org-src-container">
<pre class="src src-sh"># https://github.com/mavlink/mavros/blob/master/mavros_msgs/srv/SetMode.srv
# http://wiki.ros.org/mavros/CustomModes
# Manual Mode
rosservice call /mavros/set_mode "base_mode: 64
custom_mode: ''"

rosservice call /mavros/set_mode "base_mode: 0
custom_mode: 'MANUAL'"

rosservice call /mavros/set_mode "base_mode: 0
custom_mode: 'POSCTL'"

rosservice call /mavros/set_mode "base_mode: 0
custom_mode: 'OFFBOARD'"

rosservice call /mavros/set_mode "base_mode: 0
custom_mode: 'AUTO.LAND'"
</pre>
</div>
</div>
</li>

<li><a id="org05653c8"></a><code>ARMING</code><br />
<div class="outline-text-5" id="text-8-2-2-2">
<div class="org-src-container">
<pre class="src src-sh">rosservice call /mavros/cmd/arming "value: true"
</pre>
</div>
</div>
</li>

<li><a id="orgca16882"></a><code>TAKEOFF</code><br />
<div class="outline-text-5" id="text-8-2-2-3">
<div class="org-src-container">
<pre class="src src-sh">rosservice call /mavros/cmd/takeoff "{min_pitch: 0.0, yaw: 0.0, latitude: 47.3977508, longitude: 8.5456074, altitude: 2.5}"
</pre>
</div>
</div>
</li>

<li><a id="org42d86a9"></a><code>Land</code><br />
<div class="outline-text-5" id="text-8-2-2-4">
<div class="org-src-container">
<pre class="src src-sh">rosservice call /mavros/cmd/land "{min_pitch: 0.0, yaw: 0.0, latitude: 47.3977508, longitude: 8.5456074, altitude: 0.0}"
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-orgd501dff" class="outline-4">
<h4 id="orgd501dff"><span class="section-number-4">8.2.3</span> Publish</h4>
<div class="outline-text-4" id="text-8-2-3">
<div class="org-src-container">
<pre class="src src-sh">rostopic pub [topic] [msg_type] [args]
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="orgb6f2a12"></a><code>SETPOINT_POSITION</code><br />
<div class="outline-text-5" id="text-8-2-3-1">
<p>
OFFBOARD 모드에서 동작
</p>

<div class="org-src-container">
<pre class="src src-sh">rostopic pub -r 10 /mavros/setpoint_position/local geometry_msgs/PoseStamped "header:
  auto
pose:
  position:
    x: 5.0
    y: 0.0
    z: 1.0
  orientation:
    x: 0.0
    y: 0.0
    z: 0.0
    w: 0.0"
</pre>
</div>
</div>
</li>

<li><a id="org108d0d6"></a><code>SETPOINT_VELOCITY</code><br />
<div class="outline-text-5" id="text-8-2-3-2">
<p>
OFFBOARD 모드에서 동작
</p>

<div class="org-src-container">
<pre class="src src-sh">rostopic pub -r 10 /mavros/setpoint_velocity/cmd_vel geometry_msgs/TwistStamped "{header: auto, twist: {linear: {x: 10.0, y: 0.0, z: 0.0}, angular: {x: 0.0, y: 0.0, z: 0.0}}}"
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org420f5cc" class="outline-4">
<h4 id="org420f5cc"><span class="section-number-4">8.2.4</span> 실습</h4>
<div class="outline-text-4" id="text-8-2-4">
<p>
준비: 순서대로 실행
</p>
<ul class="org-ul">
<li>Gazebo 실행: <code>cd ~/Firmware; make px4_sitl gazebo</code></li>
<li>PC의 MAVROS를 PC(127.0.0.1)의 Gazebo와 연결 <code>rosrun mavros mavros_node _fcu_url:="udp://:14540@127.0.0.1:14557" _gcs_url:="udp://@127.0.0.1"</code> <br />
또는 Raspberry PI의 MAVROS를 PC(192.168.88.53)의 Gazebo와 연결. Raspberry PI에서 다음 명령을 실행 <code>roslaunch mavros px4.launch fcu_url:="udp://:14540@192.168.88.53:14557" gcs_url:="udp://@192.168.88.53"</code></li>
<li>QGroundControl 실행: PX4 Parameter <code>COM_OF_LOSS_T</code> 파라미터 15초로 바꾸기. Failsafe timeout을 15초로 바꾸어야 커맨드라인에서 드론을 조정하기 편하다.</li>
</ul>

<p>
<br />
</p>

<p>
해보기: 커맨드 라인에서 다음 명령을 수행하여, QGroundControl에 아래와 같은 자취를 남겨보자.
</p>
<ul class="org-ul">
<li>1. ARM</li>
<li>2. TAKEOFF 하고. (옵션)</li>
<li>3. 현재 위치를 지정한다.  <code>/mavros/setpoint_position</code> 이용하여, (0,0,0) 위치를 10hz로 지정</li>
<li>3-1. MODE 변환. OFFBOARD</li>
<li>4. 20m 간격으로 정사각형을 따라 움직인다. <code>/mavros/setpoint_position</code> 이용</li>
<li>5. HOME 자리에 오면 LAND 한다.</li>
<li>6. DISARM</li>
</ul>


<div id="org7a63022" class="figure">
<p><img src="https://i.imgur.com/4IjvTca.png" alt="4IjvTca.png" />
</p>
</div>

<p>
더해보기: 드론의 머리방향이 진행 방향을 향하도록 하자.
</p>

<ul class="org-ul">
<li>Body 3-2-1 순서 오일러-&gt;쿼터니언 변환</li>
</ul>

\begin{align}
\begin{bmatrix}
x \\
y \\
z \\
w \\
\end{bmatrix}
& =
\begin{bmatrix}
\cos (\phi /2) \cos (\theta /2) \cos (\psi /2) +  \sin (\phi /2) \sin (\theta /2) \sin (\psi /2) \\
\sin (\phi /2) \cos (\theta /2) \cos (\psi /2) -  \cos (\phi /2) \sin (\theta /2) \sin (\psi /2) \\
\cos (\phi /2) \sin (\theta /2) \cos (\psi /2) +  \sin (\phi /2) \cos (\theta /2) \sin (\psi /2) \\
\cos (\phi /2) \cos (\theta /2) \sin (\psi /2) -  \sin (\phi /2) \sin (\theta /2) \cos (\psi /2) \\
\end{bmatrix} \\
\end{align}

<p>
변환 코드(python): <a href="https://gist.github.com/donghee/e3b4fa8ec789cec0e287bf3b91ddb79e">https://gist.github.com/donghee/e3b4fa8ec789cec0e287bf3b91ddb79e</a>
</p>
</div>
</div>

<div id="outline-container-org5c0c8a1" class="outline-4">
<h4 id="org5c0c8a1"><span class="section-number-4">8.2.5</span> 유용한 mavros 명령(노드) 모음</h4>
<div class="outline-text-4" id="text-8-2-5">
<p>
mavros 패키지의 mavsafety 노드: arm, disarm, safetyarea
</p>

<pre class="example">
rosrun mavros mavsafety arm
</pre>

<p>
mavcmd 노드:
</p>

<p>
예시: takeoff from current position (10도 각도 피치, 90도 방향 보고, 5m 위로 takeoff)
</p>
<pre class="example">
rosrun mavros mavcmd takeoffcur 10 90 5
</pre>

<p>
예시: home 지정(RTL 위치, 위도 35.9012382 경도 128.85449537 해발고도 71m)
google earth: <a href="https://earth.google.com/web/search/35.9012382+128.85449537">https://earth.google.com/web/search/35.9012382+128.85449537</a>
</p>
<pre class="example">
rosrun mavros mavcmd sethome 35.9012382 128.854495337 71
</pre>

<p>
mavsetp 노드: setpoint 한번 보내기 (setpoint 테스트용, position, velocity, acceleration 가능)
</p>

<p>
예시: x=1m, y=1m, z=1m, yaw=90도 setpoint 보내기
</p>
<pre class="example">
rosrun mavros mavsetp local -p 1 1 2 90
</pre>

<p>
mavsys 노드: change mode
</p>
<pre class="example">
rosrun mavros mavsys mode -c OFFBOARD
</pre>

<p>
mavparam 노드: parameter set, get, load, dump
</p>

<p>
예시: 파라미터 덤프
</p>
<pre class="example">
rosrun mavros mavparam dump /tmp/params
</pre>

<p>
mavftp 노드: px4의 파일 시스템 접근
</p>

<p>
예시: 로그 다운로드
</p>
<pre class="example">
rosrun mavros mavftp download log/2020-08-03/14_37_15.ul
</pre>
</div>
</div>
</div>


<div id="outline-container-org41d4ed6" class="outline-3">
<h3 id="org41d4ed6"><span class="section-number-3">8.3</span> 토픽 레코드: rosbag</h3>
<div class="outline-text-3" id="text-8-3">
<p>
리뷰할때 유용
</p>

<p>
토픽 저장하기
</p>
<pre class="example">
rostopic list -v
mkdir ~/bagfiles
cd ~/bagfiles
rosbag record -O iris_default_1 /mavros/local_position/pose
rosbag info iris_default_1.bag
rqt_bag
</pre>
</div>
</div>

<div id="outline-container-orgcca399f" class="outline-3">
<h3 id="orgcca399f"><span class="section-number-3">8.4</span> 참고</h3>
<div class="outline-text-3" id="text-8-4">
<ul class="org-ul">
<li><a href="https://github.com/mavlink/mavros/tree/master/mavros">https://github.com/mavlink/mavros/tree/master/mavros</a></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org0513f9b" class="outline-2">
<h2 id="org0513f9b"><span class="section-number-2">9</span> ROS 노드 만들기</h2>
<div class="outline-text-2" id="text-9">
</div>
<div id="outline-container-orgf9a837a" class="outline-3">
<h3 id="orgf9a837a"><span class="section-number-3">9.1</span> 새로운 노드 만들기</h3>
<div class="outline-text-3" id="text-9-1">
</div>
<div id="outline-container-orgafdbcb9" class="outline-4">
<h4 id="orgafdbcb9"><span class="section-number-4">9.1.1</span> 패키지 만들기</h4>
<div class="outline-text-4" id="text-9-1-1">
<div class="org-src-container">
<pre class="src src-sh">source ~/catkin_ws/devel/setup.bash
cd ~/catkin_ws/src
catkin_create_pkg drone_control mavros sensor_msgs roscpp rospy
</pre>
</div>
</div>
</div>

<div id="outline-container-org6aef764" class="outline-4">
<h4 id="org6aef764"><span class="section-number-4">9.1.2</span> 노드 코드 작성</h4>
<div class="outline-text-4" id="text-9-1-2">
<p>
<code>~/catkin_ws/src/drone_control/src/drone_state.cpp</code>
</p>
<div class="org-src-container">
<pre class="src src-c++">#include "ros/ros.h"
#include "sensor_msgs/Imu.h"

void imuDataCallback(const sensor_msgs::Imu::ConstPtr&amp; msg){
  ROS_INFO("\nlinear acceleration\
      \nx: [%f]\ny:[%f]\nz:[%f]", msg-&gt;linear_acceleration.x,
      msg-&gt;linear_acceleration.y, msg-&gt;linear_acceleration.z);
}

int main(int argc, char **argv){
  ros::init(argc, argv, "drone_state");
  ros::NodeHandle nh;
  ros::Subscriber sub = nh.subscribe("/mavros/imu/data", 1000, imuDataCallback);
  ros::spin();
  return 0;
}
</pre>
</div>

<p>
빌드 스크립트 추가
</p>

<p>
<code>~/catkin_ws/src/drone_control/CMakeLists.txt</code> 파일 끝에 다음 3줄 추가
</p>

<div class="org-src-container">
<pre class="src src-cmake">include_directories(include ${catkin_INCLUDE_DIRS})
add_executable(drone_state src/drone_state.cpp)
target_link_libraries(drone_state ${catkin_LIBRARIES})
</pre>
</div>

<p>
환경 변수 다시 로드!
</p>
<div class="org-src-container">
<pre class="src src-sh">source ~/catkin_ws/devel/setup.bash
</pre>
</div>
</div>
</div>

<div id="outline-container-org5f4125e" class="outline-4">
<h4 id="org5f4125e"><span class="section-number-4">9.1.3</span> 패키지 빌드</h4>
<div class="outline-text-4" id="text-9-1-3">
<div class="org-src-container">
<pre class="src src-sh">cd ~/catkin_ws
catkin build
</pre>
</div>
</div>
</div>

<div id="outline-container-orge662ac0" class="outline-4">
<h4 id="orge662ac0"><span class="section-number-4">9.1.4</span> 패키지 노드 실행</h4>
<div class="outline-text-4" id="text-9-1-4">
<p>
<code>drone_control</code> 패키지의 <code>drone_state</code> 노드 실행
</p>
<div class="org-src-container">
<pre class="src src-sh">rosrun drone_control drone_state
</pre>
</div>
</div>
</div>


<div id="outline-container-orgfe56a94" class="outline-4">
<h4 id="orgfe56a94"><span class="section-number-4">9.1.5</span> 해보기: /mavros/state 읽어서 1초마다 비행 mode 한번씩 출력</h4>
<div class="outline-text-4" id="text-9-1-5">
<ul class="org-ul">
<li><code>/mavros/state</code> 타입 체크하여 헤더 include</li>
</ul>

<div class="org-src-container">
<pre class="src src-c++">
#include "ros/ros.h"
#include "mavros_msgs/State.h"

void droneStateCallback(const mavros_msgs::State::ConstPtr&amp; msg){
  ROS_INFO("\nDrone mode: %s", msg-&gt;mode.c_str());
}

int main(int argc, char **argv){
  ros::init(argc, argv, "drone_state");
  ros::NodeHandle nh;
  ros::Subscriber sub = nh.subscribe("/mavros/state", 1000, droneStateCallback);
  ros::spin();
  return 0;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org55eecb2" class="outline-4">
<h4 id="org55eecb2"><span class="section-number-4">9.1.6</span> 해보기 결과:</h4>
<div class="outline-text-4" id="text-9-1-6">
<div class="org-src-container">
<pre class="src src-c++">$ rosrun drone_control drone_state
[ INFO] [1539297808.077868114]:
Drone mode: OFFBOARD
[ INFO] [1539297808.525173697]:
Drone mode: OFFBOARD
[ INFO] [1539297809.565387356]:
Drone mode: OFFBOARD
</pre>
</div>

<p>
<code>rqt_graph</code>
</p>


<div id="org13a740d" class="figure">
<p><img src="https://i.imgur.com/CGHQVwc.png" alt="CGHQVwc.png" />
</p>
</div>
</div>
</div>
</div>


<div id="outline-container-orgf09255c" class="outline-3">
<h3 id="orgf09255c"><span class="section-number-3">9.2</span> 새로운 노드 만들기: 드론 이륙 착륙</h3>
<div class="outline-text-3" id="text-9-2">
<div class="org-src-container">
<pre class="src src-dot">digraph {
  rankdir=LR
  graph [fontname="NanumSquare"];
  node [shape=rect, color="#40e0d0"]
  edge [style=dashed, fontname="NanumSquare"];
  node1 [label= "/takeoff_and_land"]
  node2 [label= "/mavros"]

  node1 -&gt; node2 [label="1. /mavros/cmd/arming"];
  node1 -&gt; node2 [label="2. /mavros/cmd/takeoff"];
  node1 -&gt; node2 [label="3. /mavros/cmd/land"];
}
</pre>
</div>

<p>
<code>drone_control</code> 패키지에 <code>takeoff_and_land</code> 노드를 만들어 보자.
</p>

<p>
2.5m 이륙후 10초 있다가 착륙
</p>

<p>
<code>~/catkin_ws/src/drone_control/src/takeoff_and_land.cpp</code>
</p>
<div class="org-src-container">
<pre class="src src-c++">#include &lt;cstdlib&gt;

#include &lt;ros/ros.h&gt;
#include &lt;mavros_msgs/CommandBool.h&gt;
#include &lt;mavros_msgs/CommandTOL.h&gt;
#include &lt;mavros_msgs/SetMode.h&gt;

#include &lt;geometry_msgs/PoseStamped.h&gt;

int main(int argc, char **argv)
{

    int rate = 20;

    ros::init(argc, argv, "takeoff_and_land");
    ros::NodeHandle n;

    ros::Rate r(rate);

    ///////////////////ARM//////////////////////
    ros::ServiceClient arming_client = n.serviceClient&lt;mavros_msgs::CommandBool&gt;("/mavros/cmd/arming");
    mavros_msgs::CommandBool arm_cmd;
    arm_cmd.request.value = true;

    if (arming_client.call(arm_cmd) &amp;&amp; arm_cmd.response.success)
    {
	ROS_INFO("Vehicle armed");
    } else {
	ROS_ERROR("Failed arming or disarming");
    }

    /////////////////TAKEOFF////////////////////
    ros::ServiceClient takeoff_client = n.serviceClient&lt;mavros_msgs::CommandTOL&gt;("/mavros/cmd/takeoff");
    mavros_msgs::CommandTOL takeoff_cmd;
    takeoff_cmd.request.altitude = 10;
    takeoff_cmd.request.latitude = 47.3977508;
    takeoff_cmd.request.longitude = 8.5456074;
    takeoff_cmd.request.min_pitch = 0;
    takeoff_cmd.request.yaw = 0;
    if(takeoff_client.call(takeoff_cmd) &amp;&amp; takeoff_cmd.response.success){
	ROS_INFO("Okay Takeoff");
    }else{
	ROS_ERROR("Failed Takeoff");
    }

    /////////////////DO STUFF///////////////////
    sleep(10);


    ///////////////////LAND/////////////////////
    ros::ServiceClient land_client = n.serviceClient&lt;mavros_msgs::CommandTOL&gt;("/mavros/cmd/land");
    mavros_msgs::CommandTOL land_cmd;
    land_cmd.request.altitude = 0;
    land_cmd.request.latitude = 47.3977508;
    land_cmd.request.longitude = 8.5456074;
    land_cmd.request.min_pitch = 0;
    land_cmd.request.yaw = 0;
    if(land_client.call(land_cmd) &amp;&amp; land_cmd.response.success){
	ROS_INFO("Okay Land");
    }else{
	ROS_ERROR("Failed Land");
    }

    while (n.ok())
    {
      ros::spinOnce();
      r.sleep();
    }

    return 0;

}
</pre>
</div>

<p>
<code>\~/catkin_ws/src/drone_control/CMakeLists.txt</code> 파일 끝에 다음 2줄 추가
</p>

<div class="org-src-container">
<pre class="src src-cmake">add_executable(takeoff_and_land src/takeoff_and_land.cpp)
target_link_libraries(takeoff_and_land ${catkin_LIBRARIES})
</pre>
</div>

<ul class="org-ul">
<li>컴파일: <code>cd ~/catkin_ws; source devel/setup.bash; catkin build</code></li>
<li>실행: <code>rosrun drone_control takeoff_and_land</code></li>
</ul>
</div>
</div>

<div id="outline-container-org8cd1834" class="outline-3">
<h3 id="org8cd1834"><span class="section-number-3">9.3</span> 새로운 노드 만들기: <code>offb_node</code></h3>
<div class="outline-text-3" id="text-9-3">
<p>
<code>drone_control</code> 패키지에 <code>offb_node</code> 노드를 만들어 보자.
</p>

<p>
2m 이륙.
</p>

<div class="org-src-container">
<pre class="src src-c++">/**
 * @file offb_node.cpp
 * @brief Offboard control example node, written with MAVROS version 0.19.x, PX4 Pro Flight
 * Stack and tested in Gazebo SITL
 */

#include &lt;ros/ros.h&gt;
#include &lt;geometry_msgs/PoseStamped.h&gt;
#include &lt;mavros_msgs/CommandBool.h&gt;
#include &lt;mavros_msgs/SetMode.h&gt;
#include &lt;mavros_msgs/State.h&gt;

mavros_msgs::State current_state;
void state_cb(const mavros_msgs::State::ConstPtr&amp; msg){
    current_state = *msg;
}

int main(int argc, char **argv)
{
    ros::init(argc, argv, "offb_node");
    ros::NodeHandle nh;

    ros::Subscriber state_sub = nh.subscribe&lt;mavros_msgs::State&gt;
	    ("mavros/state", 10, state_cb);
    ros::Publisher local_pos_pub = nh.advertise&lt;geometry_msgs::PoseStamped&gt;
	    ("mavros/setpoint_position/local", 10);
    ros::ServiceClient arming_client = nh.serviceClient&lt;mavros_msgs::CommandBool&gt;
	    ("mavros/cmd/arming");
    ros::ServiceClient set_mode_client = nh.serviceClient&lt;mavros_msgs::SetMode&gt;
	    ("mavros/set_mode");

    //the setpoint publishing rate MUST be faster than 2Hz
    ros::Rate rate(20.0);

    // wait for FCU connection
    while(ros::ok() &amp;&amp; !current_state.connected){
	ros::spinOnce();
	rate.sleep();
    }

    geometry_msgs::PoseStamped pose;
    pose.pose.position.x = 0;
    pose.pose.position.y = 0;
    pose.pose.position.z = 2;

    //send a few setpoints before starting
    for(int i = 100; ros::ok() &amp;&amp; i &gt; 0; --i){
	local_pos_pub.publish(pose);
	ros::spinOnce();
	rate.sleep();
    }

    mavros_msgs::SetMode offb_set_mode;
    offb_set_mode.request.custom_mode = "OFFBOARD";

    mavros_msgs::CommandBool arm_cmd;
    arm_cmd.request.value = true;

    ros::Time last_request = ros::Time::now();

    while(ros::ok()){
	if( current_state.mode != "OFFBOARD" &amp;&amp;
	    (ros::Time::now() - last_request &gt; ros::Duration(5.0))){
	    if( set_mode_client.call(offb_set_mode) &amp;&amp;
		offb_set_mode.response.mode_sent){
		ROS_INFO("Offboard enabled");
	    }
	    last_request = ros::Time::now();
	} else {
	    if( !current_state.armed &amp;&amp;
		(ros::Time::now() - last_request &gt; ros::Duration(5.0))){
		if( arming_client.call(arm_cmd) &amp;&amp;
		    arm_cmd.response.success){
		    ROS_INFO("Vehicle armed");
		}
		last_request = ros::Time::now();
	    }
	}

	local_pos_pub.publish(pose);

	ros::spinOnce();
	rate.sleep();
    }

    return 0;
}
</pre>
</div>

<ul class="org-ul">
<li>실행: <code>rosrun drone_control offb_node</code></li>
</ul>
</div>

<div id="outline-container-orga45970d" class="outline-4">
<h4 id="orga45970d"><span class="section-number-4">9.3.1</span> launch 파일을 이용하여 노드 한번에 실행 (옵션)</h4>
<div class="outline-text-4" id="text-9-3-1">
<p>
roscore, gazebo, mavros, offb<sub>node</sub> 노드를 한번에 실행하기 위해서 roslaunch를 이용해보자.
</p>

<p>
<code>~/catkin_ws/src/drone_control/launch/offb_node.launch</code> 파일에 다음 내용 추가
</p>
<pre class="example">
&lt;launch&gt;
    &lt;node name="offb_node" pkg="drone_control" type="offb_node"/&gt;
    &lt;include file="$(find px4)/launch/mavros_posix_sitl.launch"&gt;
      &lt;arg name="vehicle" value="iris"/&gt;
    &lt;/include&gt;
&lt;/launch&gt;
</pre>

<p>
<code>~/.bashrc</code> 파일의 끝에 다음 내용을 추가
환경 변수 추가
</p>
<pre class="example">
PX4_SRC_DIR=$HOME/Firmware
source $PX4_SRC_DIR/Tools/setup_gazebo.bash $PX4_SRC_DIR $PX4_SRC_DIR/build/px4_sitl_default &gt; /dev/null
export ROS_PACKAGE_PATH=$ROS_PACKAGE_PATH:$PX4_SRC_DIR:$PX4_SRC_DIR/Tools/sitl_gazebo
</pre>

<div class="org-src-container">
<pre class="src src-sh">source ~/.bashrc
catkin build
</pre>
</div>

<div class="org-src-container">
<pre class="src src-sh">roslaunch drone_control offb_node.launch
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-orgd3ec23e" class="outline-3">
<h3 id="orgd3ec23e"><span class="section-number-3">9.4</span> 새로운 노드 만들기: <code>circle</code></h3>
<div class="outline-text-3" id="text-9-4">
<p>
출처: <a href="https://github.com/Jaeyoung-Lim/modudculab_ros/blob/master/src/pub_setpoints_traj.cpp">https://github.com/Jaeyoung-Lim/modudculab_ros/blob/master/src/pub_setpoints_traj.cpp</a>
</p>

<pre class="example">
/**
 * @file circle.cpp
 * @brief offboard example node, written with mavros version 0.14.2, px4 flight
 * stack and tested in Gazebo SITL
 */

#include &lt;ros/ros.h&gt;
#include &lt;geometry_msgs/PoseStamped.h&gt;
#include &lt;mavros_msgs/CommandBool.h&gt;
#include &lt;mavros_msgs/SetMode.h&gt;
#include &lt;mavros_msgs/State.h&gt;
#include "math.h"

double r;
double theta;
double count=0.0;
double wn;

mavros_msgs::State current_state;
void state_cb(const mavros_msgs::State::ConstPtr&amp; msg){
    current_state = *msg;
}

int main(int argc, char **argv)
{
    ros::init(argc, argv, "circle");
    ros::NodeHandle nh;

    ros::Subscriber state_sub = nh.subscribe&lt;mavros_msgs::State&gt;
	    ("mavros/state", 10, state_cb);
    ros::Publisher local_pos_pub = nh.advertise&lt;geometry_msgs::PoseStamped&gt;
	    ("mavros/setpoint_position/local", 10);
    ros::ServiceClient arming_client = nh.serviceClient&lt;mavros_msgs::CommandBool&gt;
	    ("mavros/cmd/arming");
    ros::ServiceClient set_mode_client = nh.serviceClient&lt;mavros_msgs::SetMode&gt;
	    ("mavros/set_mode");

    //the setpoint publishing rate MUST be faster than 2Hz
    ros::Rate rate(20.0);


    nh.param("pub_setpoints_traj/wn", wn, 1.0);
    nh.param("pub_setpoints_traj/r", r, 1.0);
    // wait for FCU connection
    while(ros::ok() &amp;&amp; current_state.connected){
	ros::spinOnce();
	rate.sleep();
    }

    geometry_msgs::PoseStamped pose;
    pose.pose.position.x = 0;
    pose.pose.position.y = 0;
    pose.pose.position.z = 2;

    //send a few setpoints before starting
    for(int i = 100; ros::ok() &amp;&amp; i &gt; 0; --i){
	local_pos_pub.publish(pose);
	ros::spinOnce();
	rate.sleep();
    }

    mavros_msgs::SetMode offb_set_mode;
    offb_set_mode.request.custom_mode = "OFFBOARD";

    mavros_msgs::CommandBool arm_cmd;
    arm_cmd.request.value = true;
j
    ros::Time last_request = ros::Time::now();

    while(ros::ok()){
	if( current_state.mode != "OFFBOARD" &amp;&amp;
	    (ros::Time::now() - last_request &gt; ros::Duration(5.0))){
	    if( set_mode_client.call(offb_set_mode) &amp;&amp;
		offb_set_mode.response.mode_sent){
		ROS_INFO("Offboard enabled");
	    }
	    last_request = ros::Time::now();
	} else {
	    if( !current_state.armed &amp;&amp;
		(ros::Time::now() - last_request &gt; ros::Duration(5.0))){
		if( arming_client.call(arm_cmd) &amp;&amp;
		    arm_cmd.response.success){
		    ROS_INFO("Vehicle armed");
		}
		last_request = ros::Time::now();
	    }
	}

	theta = wn*count*0.05;

	pose.pose.position.x = r*sin(theta);
	pose.pose.position.y = r*cos(theta);
	pose.pose.position.z = 2;

	count++;

	local_pos_pub.publish(pose);
	ros::spinOnce();
	rate.sleep();
    }

    return 0;
}
</pre>

<ul class="org-ul">
<li>실행: <code>rosrun drone_control circle</code></li>
</ul>
</div>
<div id="outline-container-orgfa3476a" class="outline-4">
<h4 id="orgfa3476a"><span class="section-number-4">9.4.1</span> 해보기: 원의 너비와 속도를 바꾸어 보자. 힌트 (wn, r)</h4>
</div>
</div>

<div id="outline-container-orgc31951e" class="outline-3">
<h3 id="orgc31951e"><span class="section-number-3">9.5</span> 과제: 키보드로 OFFBOARD 모드 제어하기</h3>
<div class="outline-text-3" id="text-9-5">
<ul class="org-ul">
<li><code>offb_node</code> 코드를 참고하여, 키보드로 x,y,z 위치를 제어하여 보자.</li>
<li>참고: <a href="http://wiki.ros.org/teleop_twist_keyboard_cpp">http://wiki.ros.org/teleop_twist_keyboard_cpp</a></li>
</ul>
</div>
</div>

<div id="outline-container-org6b3fb43" class="outline-3">
<h3 id="org6b3fb43"><span class="section-number-3">9.6</span> 참고</h3>
<div class="outline-text-3" id="text-9-6">
<ul class="org-ul">
<li><a href="https://github.com/mavlink/mavros/tree/master/mavros">https://github.com/mavlink/mavros/tree/master/mavros</a></li>
<li><a href="https://github.com/Jaeyoung-Lim/modudculab_ros/blob/master/src/pub_setpoints_traj.cpp">https://github.com/Jaeyoung-Lim/modudculab_ros/blob/master/src/pub_setpoints_traj.cpp</a></li>
</ul>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Donghee Park</p>
<p class="date">Created: 2021-08-19 목 11:04</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
